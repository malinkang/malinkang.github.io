<!DOCTYPE html>
<html><head>
<title>Android Bitmap使用</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="stylesheet" href="https://malinkang.cn/scss/journal.min.56b67b8b01d7cd1015ed14414fd2fc33ebfb2e8413dcbc47c5cd734544c92cd7.css" integrity="sha256-VrZ7iwHXzRAV7RRBT9L8M&#43;v7LoQT3LxHxc1zRUTJLNc=" media="screen">



<link rel="stylesheet" href="https://malinkang.cn/scss/dark-mode.min.5a2bbd1758c83affd639a91fbfd5cc681b1a5574df99442825c444dd40504b13.css" integrity="sha256-Wiu9F1jIOv/WOakfv9XMaBsaVXTfmUQoJcRE3UBQSxM=" media="screen">


<script src="https://malinkang.cn//js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>

<script src="https://malinkang.cn//js/table.js"></script>




<script src="https://malinkang.cn//js/toc.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: 'd84786eae9edb9e6521b',
  clientSecret: 'a30a17b679a15e85b8f257eec4231d5b286e1b58',
  repo: 'malinkang.github.io',
  owner: 'malinkang',
  admin: ['malinkang'],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>






</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://malinkang.cn/">
    
        <div class="nav-title">
            Malinkang‘s Blog
        </div>
        
        <div class="nav-subtitle">
            人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://android.malinkang.cn">
                Android笔记
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://kotlin.malinkang.cn">
                Kotlin笔记
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	This is a customized copyright.
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#bitmap%e5%8d%a0%e7%94%a8%e5%86%85%e5%ad%98%e8%ae%a1%e7%ae%97" v-on:click="closeDrawer" id="bitmap占用内存计算-nav">
										 Bitmap占用内存计算
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%8f%82%e8%80%83" v-on:click="closeDrawer" id="参考-nav">
										 参考
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://android.malinkang.cn">
                    Android笔记
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://kotlin.malinkang.cn">
                    Kotlin笔记
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#bitmap%e5%8d%a0%e7%94%a8%e5%86%85%e5%ad%98%e8%ae%a1%e7%ae%97" v-on:click="closeDrawer" id="bitmap占用内存计算-nav">
										 Bitmap占用内存计算
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%8f%82%e8%80%83" v-on:click="closeDrawer" id="参考-nav">
										 参考
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://malinkang.cn/">
            Malinkang‘s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://malinkang.cn/">
        <div class="single-column-header-title">Malinkang‘s Blog</div>
        
        <div class="single-column-header-subtitle">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    Android Bitmap使用
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2016-06-24 13:52
                        </time>
                        

                        

                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    <!-- raw HTML omitted -->
<h3 id="bitmap占用内存计算">Bitmap占用内存计算</h3>
<p>Android的Bitmap对象提供了方法<code>getByteCount</code>来获取Bitmap的字节数。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getByteCount</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// int result permits bitmaps up to 46,340 x 46,340
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> getRowBytes<span style="color:#f92672">()</span> <span style="color:#f92672">*</span> getHeight<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p><code>getRowBytes()</code>方法用来获取每行的字节数，内部调用一个native方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getRowBytes</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mRecycled<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Called getRowBytes() on a recycle()&#39;d bitmap! This is undefined behavior!&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> nativeRowBytes<span style="color:#f92672">(</span>mFinalizer<span style="color:#f92672">.</span><span style="color:#a6e22e">mNativeBitmap</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>接下来我们继续通过查看<a href="https://github.com/android/platform_frameworks_base/blob/master/core/jni/android/graphics/Bitmap.cpp">Bitmap.cpp</a>的源码可以找到<code>nativeRowBytes</code>方法的实现。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> jint <span style="color:#a6e22e">Bitmap_rowBytes</span><span style="color:#f92672">(</span>JNIEnv<span style="color:#f92672">*</span> env<span style="color:#f92672">,</span> jobject<span style="color:#f92672">,</span> jlong bitmapHandle<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
     SkBitmap<span style="color:#f92672">*</span> bitmap <span style="color:#f92672">=</span> reinterpret_cast<span style="color:#f92672">&lt;</span>SkBitmap<span style="color:#f92672">*&gt;(</span>bitmapHandle<span style="color:#f92672">)</span>
     <span style="color:#66d9ef">return</span> static_cast<span style="color:#f92672">&lt;</span>jint<span style="color:#f92672">&gt;(</span>bitmap<span style="color:#f92672">-&gt;</span>rowBytes<span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这样我们就会发现Bitmap本质上是一个SkBitmap。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">size_t SkBitmap<span style="color:#f92672">::</span>ComputeRowBytes<span style="color:#f92672">(</span>Config c<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> width<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> SkColorTypeMinRowBytes<span style="color:#f92672">(</span>SkBitmapConfigToColorType<span style="color:#f92672">(</span>c<span style="color:#f92672">),</span> width<span style="color:#f92672">);</span>
 <span style="color:#f92672">}</span>
</code></pre></div><p><a href="https://github.com/android/platform_external_skia/blob/ba7d93fad9b248bedd11999f509044575f7781f3/include/core/SkImageInfo.h">SkImageInfo.h</a>中<code>SkColorTypeBytesPerPixel </code>方法用来获取每像素的字节数。我们发现ARGB_8888（也就是我们最常用的 Bitmap 的格式）的一个像素占用 4byte，那么 rowBytes 实际上就是 4*width bytes。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">SkColorTypeBytesPerPixel</span><span style="color:#f92672">(</span>SkColorType ct<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> uint8_t gSize<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    0<span style="color:#f92672">,</span>  <span style="color:#75715e">// Unknown
</span><span style="color:#75715e"></span>    1<span style="color:#f92672">,</span>  <span style="color:#75715e">// Alpha_8
</span><span style="color:#75715e"></span>    2<span style="color:#f92672">,</span>  <span style="color:#75715e">// RGB_565
</span><span style="color:#75715e"></span>    2<span style="color:#f92672">,</span>  <span style="color:#75715e">// ARGB_4444
</span><span style="color:#75715e"></span>    4<span style="color:#f92672">,</span>  <span style="color:#75715e">// RGBA_8888
</span><span style="color:#75715e"></span>    4<span style="color:#f92672">,</span>  <span style="color:#75715e">// BGRA_8888
</span><span style="color:#75715e"></span>    1<span style="color:#f92672">,</span>  <span style="color:#75715e">// kIndex_8
</span><span style="color:#75715e"></span>  <span style="color:#f92672">};</span>
  SK_COMPILE_ASSERT<span style="color:#f92672">(</span>SK_ARRAY_COUNT<span style="color:#f92672">(</span>gSize<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#f92672">(</span>size_t<span style="color:#f92672">)(</span>kLastEnum_SkColorType <span style="color:#f92672">+</span> 1<span style="color:#f92672">),</span>
                size_mismatch_with_SkColorType_enum<span style="color:#f92672">);</span>

   SkASSERT<span style="color:#f92672">((</span>size_t<span style="color:#f92672">)</span>ct <span style="color:#f92672">&lt;</span> SK_ARRAY_COUNT<span style="color:#f92672">(</span>gSize<span style="color:#f92672">));</span>
   <span style="color:#66d9ef">return</span> gSize<span style="color:#f92672">[</span>ct<span style="color:#f92672">];</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">//获取每行的byte数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> inline size_t <span style="color:#a6e22e">SkColorTypeMinRowBytes</span><span style="color:#f92672">(</span>SkColorType ct<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> width<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> width <span style="color:#f92672">*</span> SkColorTypeBytesPerPixel<span style="color:#f92672">(</span>ct<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>那么一张图片640x824的图片在内存中占用的大小就是：</p>
<pre><code>640x824x4=2109440
</code></pre><p>然而实际上我们把一张640x824图片放在<code>drawable-xhdpi</code>目录下运行在Nexus5手机上获得的大小为4746240差不多是我们上面计算出来的两倍。这是因为图片占用的尺寸会受存放位置和手机屏幕密度影响。</p>
<p>我们读取的是 drawable 目录下面的图片，用的是 decodeResource 方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Bitmap <span style="color:#a6e22e">decodeResource</span><span style="color:#f92672">(</span>Resources res<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> id<span style="color:#f92672">,</span> Options opts<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Bitmap bm <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        InputStream is <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> 
        
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> TypedValue value <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TypedValue<span style="color:#f92672">();</span>
            is <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span><span style="color:#a6e22e">openRawResource</span><span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>

            bm <span style="color:#f92672">=</span> decodeResourceStream<span style="color:#f92672">(</span>res<span style="color:#f92672">,</span> value<span style="color:#f92672">,</span> is<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> opts<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">/*  do nothing.
</span><span style="color:#75715e">                If the exception happened on open, bm will be null.
</span><span style="color:#75715e">                If it happened on close, bm is still valid.
</span><span style="color:#75715e">            */</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>is <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> is<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// Ignore
</span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>bm <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> opts <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> opts<span style="color:#f92672">.</span><span style="color:#a6e22e">inBitmap</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Problem decoding into existing bitmap&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> bm<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>decodeResource内部调用 Resource.openRawResource 方法来读取图片资源，这个方法调用完成之后会对 TypedValue 进行赋值，其中包含了原始资源的 density 等信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Bitmap <span style="color:#a6e22e">decodeResourceStream</span><span style="color:#f92672">(</span>Resources res<span style="color:#f92672">,</span> TypedValue value<span style="color:#f92672">,</span>
            InputStream is<span style="color:#f92672">,</span> Rect pad<span style="color:#f92672">,</span> Options opts<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>opts <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            opts <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Options<span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>opts<span style="color:#f92672">.</span><span style="color:#a6e22e">inDensity</span> <span style="color:#f92672">==</span> 0 <span style="color:#f92672">&amp;&amp;</span> value <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> density <span style="color:#f92672">=</span> value<span style="color:#f92672">.</span><span style="color:#a6e22e">density</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>density <span style="color:#f92672">==</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">DENSITY_DEFAULT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                opts<span style="color:#f92672">.</span><span style="color:#a6e22e">inDensity</span> <span style="color:#f92672">=</span> DisplayMetrics<span style="color:#f92672">.</span><span style="color:#a6e22e">DENSITY_DEFAULT</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>density <span style="color:#f92672">!=</span> TypedValue<span style="color:#f92672">.</span><span style="color:#a6e22e">DENSITY_NONE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//这里density的值如果对应资源目录为xhdpi的话，就是320
</span><span style="color:#75715e"></span>                opts<span style="color:#f92672">.</span><span style="color:#a6e22e">inDensity</span> <span style="color:#f92672">=</span> density<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>opts<span style="color:#f92672">.</span><span style="color:#a6e22e">inTargetDensity</span> <span style="color:#f92672">==</span> 0 <span style="color:#f92672">&amp;&amp;</span> res <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//获取手机屏幕密度 Nexus5的屏幕密度为480
</span><span style="color:#75715e"></span>            opts<span style="color:#f92672">.</span><span style="color:#a6e22e">inTargetDensity</span> <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span><span style="color:#a6e22e">getDisplayMetrics</span><span style="color:#f92672">().</span><span style="color:#a6e22e">densityDpi</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> decodeStream<span style="color:#f92672">(</span>is<span style="color:#f92672">,</span> pad<span style="color:#f92672">,</span> opts<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>原始资源的 density 其实取决于资源存放的目录（比如 xhdpi 对应的是320）。这里还有一个目标密度即是屏幕密度。</p>
<p>紧接着，用到了一个native方法<code>nativeDecodeStream</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> jobject <span style="color:#a6e22e">doDecode</span><span style="color:#f92672">(</span>JNIEnv<span style="color:#f92672">*</span> env<span style="color:#f92672">,</span> SkStreamRewindable<span style="color:#f92672">*</span> stream<span style="color:#f92672">,</span> jobject padding<span style="color:#f92672">,</span> jobject options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

<span style="color:#f92672">......</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>env<span style="color:#f92672">-&gt;</span>GetBooleanField<span style="color:#f92672">(</span>options<span style="color:#f92672">,</span> gOptions_scaledFieldID<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> density <span style="color:#f92672">=</span> env<span style="color:#f92672">-&gt;</span>GetIntField<span style="color:#f92672">(</span>options<span style="color:#f92672">,</span> gOptions_densityFieldID<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> targetDensity <span style="color:#f92672">=</span> env<span style="color:#f92672">-&gt;</span>GetIntField<span style="color:#f92672">(</span>options<span style="color:#f92672">,</span> gOptions_targetDensityFieldID<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> screenDensity <span style="color:#f92672">=</span> env<span style="color:#f92672">-&gt;</span>GetIntField<span style="color:#f92672">(</span>options<span style="color:#f92672">,</span> gOptions_screenDensityFieldID<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>density <span style="color:#f92672">!=</span> 0 <span style="color:#f92672">&amp;&amp;</span> targetDensity <span style="color:#f92672">!=</span> 0 <span style="color:#f92672">&amp;&amp;</span> density <span style="color:#f92672">!=</span> screenDensity<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//目标密度/原始资源密度 得到一个缩放比
</span><span style="color:#75715e"></span>            scale <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">float</span><span style="color:#f92672">)</span> targetDensity <span style="color:#f92672">/</span> density<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">const</span> bool willScale <span style="color:#f92672">=</span> scale <span style="color:#f92672">!=</span> 1<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">;</span>
<span style="color:#f92672">......</span>
SkBitmap decodingBitmap<span style="color:#f92672">;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>decoder<span style="color:#f92672">-&gt;</span>decode<span style="color:#f92672">(</span>stream<span style="color:#f92672">,</span> <span style="color:#f92672">&amp;</span>decodingBitmap<span style="color:#f92672">,</span> prefColorType<span style="color:#f92672">,</span>decodeMode<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">return</span> nullObjectReturn<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;decoder-&gt;decode returned false&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">//这里这个deodingBitmap就是解码出来的bitmap，大小是图片原始的大小
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> scaledWidth <span style="color:#f92672">=</span> decodingBitmap<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">int</span> scaledHeight <span style="color:#f92672">=</span> decodingBitmap<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>willScale <span style="color:#f92672">&amp;&amp;</span> decodeMode <span style="color:#f92672">!=</span> SkImageDecoder<span style="color:#f92672">::</span>kDecodeBounds_Mode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="color:#75715e">//根据缩放比得到缩放后的宽和高
</span><span style="color:#75715e"></span>    scaledWidth <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">(</span>scaledWidth <span style="color:#f92672">*</span> scale <span style="color:#f92672">+</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5f</span><span style="color:#f92672">);</span>
    scaledHeight <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">(</span>scaledHeight <span style="color:#f92672">*</span> scale <span style="color:#f92672">+</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">5f</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>willScale<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
<span style="color:#75715e">//与原始宽高比 计算一个缩放比
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">float</span> sx <span style="color:#f92672">=</span> scaledWidth <span style="color:#f92672">/</span> <span style="color:#66d9ef">float</span><span style="color:#f92672">(</span>decodingBitmap<span style="color:#f92672">.</span><span style="color:#a6e22e">width</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">float</span> sy <span style="color:#f92672">=</span> scaledHeight <span style="color:#f92672">/</span> <span style="color:#66d9ef">float</span><span style="color:#f92672">(</span>decodingBitmap<span style="color:#f92672">.</span><span style="color:#a6e22e">height</span><span style="color:#f92672">());</span>

    <span style="color:#75715e">// TODO: avoid copying when scaled size equals decodingBitmap size
</span><span style="color:#75715e"></span>    SkColorType colorType <span style="color:#f92672">=</span> colorTypeForScaledOutput<span style="color:#f92672">(</span>decodingBitmap<span style="color:#f92672">.</span><span style="color:#a6e22e">colorType</span><span style="color:#f92672">());</span>
    <span style="color:#75715e">// FIXME: If the alphaType is kUnpremul and the image has alpha, the
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// colors may not be correct, since Skia does not yet support drawing
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// to/from unpremultiplied bitmaps.
</span><span style="color:#75715e"></span>    outputBitmap<span style="color:#f92672">-&gt;</span>setInfo<span style="color:#f92672">(</span>SkImageInfo<span style="color:#f92672">::</span>Make<span style="color:#f92672">(</span>scaledWidth<span style="color:#f92672">,</span> scaledHeight<span style="color:#f92672">,</span>
            colorType<span style="color:#f92672">,</span> decodingBitmap<span style="color:#f92672">.</span><span style="color:#a6e22e">alphaType</span><span style="color:#f92672">()));</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>outputBitmap<span style="color:#f92672">-&gt;</span>allocPixels<span style="color:#f92672">(</span>outputAllocator<span style="color:#f92672">,</span> NULL<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> nullObjectReturn<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;allocation failed for scaled bitmap&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// If outputBitmap&#39;s pixels are newly allocated by Java, there is no need
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// to erase to 0, since the pixels were initialized to 0.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outputAllocator <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span>javaAllocator<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        outputBitmap<span style="color:#f92672">-&gt;</span>eraseColor<span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    SkPaint paint<span style="color:#f92672">;</span>
    paint<span style="color:#f92672">.</span><span style="color:#a6e22e">setFilterLevel</span><span style="color:#f92672">(</span>SkPaint<span style="color:#f92672">::</span>kLow_FilterLevel<span style="color:#f92672">);</span>

    SkCanvas <span style="color:#a6e22e">canvas</span><span style="color:#f92672">(*</span>outputBitmap<span style="color:#f92672">);</span>
    <span style="color:#75715e">// Canvas 按照比例缩放
</span><span style="color:#75715e"></span>    canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">scale</span><span style="color:#f92672">(</span>sx<span style="color:#f92672">,</span> sy<span style="color:#f92672">);</span>
    <span style="color:#75715e">//绘制bitmap
</span><span style="color:#75715e"></span>    canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawBitmap</span><span style="color:#f92672">(</span>decodingBitmap<span style="color:#f92672">,</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0f</span><span style="color:#f92672">,</span> <span style="color:#f92672">&amp;</span>paint<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#f92672">......</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>相应的注释已经写在代码里了，所以我们存放在xhdpi目录下的640x824的图片在Nexus5手机上占用的内存计算如下。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">scaledWidth <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)(</span>640x480<span style="color:#f92672">/</span>320<span style="color:#f92672">+</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">5</span><span style="color:#f92672">)=</span> 960<span style="color:#f92672">;</span>
scaleHeight <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)(</span>824x480<span style="color:#f92672">/</span>320<span style="color:#f92672">+</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">5</span><span style="color:#f92672">)=</span> 1236<span style="color:#f92672">;</span>
960x1236x4 <span style="color:#f92672">=</span> 4<span style="color:#f92672">,</span>746<span style="color:#f92672">,</span>240 
</code></pre></div><p>得到的值和我们通过代码获取到的值一致。</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="http://hukai.me/android-training-course-in-chinese/graphics/displaying-bitmaps/index.html">高效显示Bitmap</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=403263974&amp;idx=1&amp;sn=b0315addbc47f3c38e65d9c633a12cd6&amp;scene=23&amp;srcid=0624JmL3K1ZcheyD1vKrnPe4#rd">Android 开发绕不过的坑：你的 Bitmap 究竟占多大内存？</a></li>
<li><a href="http://anany.me/2015/10/15/bitmap1/">Android Bitmap 优化(1) - 图片压缩</a></li>
<li><a href="http://blog.csdn.net/guolin_blog/article/details/50727753">Android drawable微技巧，你所不知道的drawable的那些细节</a></li>
<li><a href="https://medium.com/@duhroach/reducing-png-file-size-8473480d0476#.9u2detoc5">Reducing PNG file Size</a></li>
<li><a href="https://github.com/xitu/gold-miner/blob/master/TODO/reducing-jpg-file-size.md">Reducing PNG file Size译文</a></li>
<li><a href="http://jayfeng.com/2016/03/22/Android-Bitmap%E9%9D%A2%E9%9D%A2%E8%A7%82/">Android Bitmap面面观</a></li>
</ul>
                    
                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2016-06-24</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://malinkang.cn/posts/java-threadpool/">
                    Next<br>Java线程池
                </a>
                
                
                
                <a class="older-posts" href="https://malinkang.cn/posts/android-studio-template/">
                    Previous<br>创建 Android Studio Template
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>





            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	This is a customized copyright.
	</div>
    	</div>
    <script src="https://malinkang.cn//js/journal.js"></script>
    </body>
</html>
