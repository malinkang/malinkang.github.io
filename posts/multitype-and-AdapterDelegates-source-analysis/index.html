<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="MultiType和AdapterDelegates源码分析" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="MultiType和AdapterDelegates两个库都是对RecyclerView的Adapter进行封装的库，可以快速实现多种布局类型的RecyclerView。两个库的核心思想都是封装一个实体我们暂时命名为ItemViewBinder，用来提供布局资源和绑定数据。对于多种类型的Adapter存在多个ItemViewBinder对象，如AItemViewBinder、BItemViewBinder，我们可以使用一个集合来存放这些ItemViewBinder此外，还需要建立viewtype和绑定实体之间的一一对应关系，在onCreateViewHolder和onBindViewHolder中通过viewtype来获取对应的ItemViewBinder类实现提供布局资源和数据绑定。下面我们来分别看看两个库的实现方式。" /><meta property="og:description" content="MultiType和AdapterDelegates两个库都是对RecyclerView的Adapter进行封装的库，可以快速实现多种布局类型的RecyclerView。两个库的核心思想都是封装一个实体我们暂时命名为ItemViewBinder，用来提供布局资源和绑定数据。对于多种类型的Adapter存在多个ItemViewBinder对象，如AItemViewBinder、BItemViewBinder，我们可以使用一个集合来存放这些ItemViewBinder此外，还需要建立viewtype和绑定实体之间的一一对应关系，在onCreateViewHolder和onBindViewHolder中通过viewtype来获取对应的ItemViewBinder类实现提供布局资源和数据绑定。下面我们来分别看看两个库的实现方式。" /><link rel="canonical" href="https://malinkang.cn/posts/multitype-and-AdapterDelegates-source-analysis/" /><meta property="og:url" content="https://malinkang.cn/posts/multitype-and-AdapterDelegates-source-analysis/" /><meta property="og:site_name" content="malinkang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-11-03T17:03:48+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MultiType和AdapterDelegates源码分析" /><meta name="twitter:site" content="@malinkang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"MultiType和AdapterDelegates两个库都是对RecyclerView的Adapter进行封装的库，可以快速实现多种布局类型的RecyclerView。两个库的核心思想都是封装一个实体我们暂时命名为ItemViewBinder，用来提供布局资源和绑定数据。对于多种类型的Adapter存在多个ItemViewBinder对象，如AItemViewBinder、BItemViewBinder，我们可以使用一个集合来存放这些ItemViewBinder此外，还需要建立viewtype和绑定实体之间的一一对应关系，在onCreateViewHolder和onBindViewHolder中通过viewtype来获取对应的ItemViewBinder类实现提供布局资源和数据绑定。下面我们来分别看看两个库的实现方式。","headline":"MultiType和AdapterDelegates源码分析","dateModified":"2021-05-28T10:48:44+08:00","url":"https://malinkang.cn/posts/multitype-and-AdapterDelegates-source-analysis/","datePublished":"2017-11-03T17:03:48+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://malinkang.cn/posts/multitype-and-AdapterDelegates-source-analysis/"},"@context":"https://schema.org"}</script><title>MultiType和AdapterDelegates源码分析 | malinkang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="malinkang"><meta name="application-name" content="malinkang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">malinkang</a></div><div class="site-subtitle font-italic">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/malinkang" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/malinkang" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['linkang.ma','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>MultiType和AdapterDelegates源码分析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>MultiType和AdapterDelegates源码分析</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> malinkang </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Nov 3, 2017, 5:03 PM +0800" prep="on" > Nov 3, 2017 <i class="unloaded">2017-11-03T17:03:48+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, May 28, 2021, 10:48 AM +0800" prefix="Updated " > May 28 <i class="unloaded">2021-05-28T10:48:44+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4032 words">22 min</span></div></div><div class="post-content"><p><a href="https://github.com/drakeet/MultiType">MultiType</a>和<a href="https://github.com/sockeqwe/AdapterDelegates">AdapterDelegates</a>两个库都是对<code class="language-plaintext highlighter-rouge">RecyclerView</code>的<code class="language-plaintext highlighter-rouge">Adapter</code>进行封装的库，可以快速实现多种布局类型的<code class="language-plaintext highlighter-rouge">RecyclerView</code>。两个库的核心思想都是封装一个实体我们暂时命名为<code class="language-plaintext highlighter-rouge">ItemViewBinder</code>，用来提供布局资源和绑定数据。对于多种类型的Adapter存在多个<code class="language-plaintext highlighter-rouge">ItemViewBinder</code>对象，如<code class="language-plaintext highlighter-rouge">AItemViewBinder</code>、<code class="language-plaintext highlighter-rouge">BItemViewBinder</code>，我们可以使用一个集合来存放这些<code class="language-plaintext highlighter-rouge">ItemViewBinder</code>此外，还需要建立viewtype和绑定实体之间的一一对应关系，在<code class="language-plaintext highlighter-rouge">onCreateViewHolder</code>和<code class="language-plaintext highlighter-rouge">onBindViewHolder</code>中通过viewtype来获取对应的<code class="language-plaintext highlighter-rouge">ItemViewBinder</code>类实现提供布局资源和数据绑定。下面我们来分别看看两个库的实现方式。</p><h3 id="multitype">MultiType</h3><p>MultiType的<code class="language-plaintext highlighter-rouge">ItemViewBinder</code>类就是封装的实体类。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ItemViewBinder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">VH</span> <span class="kd">extends</span> <span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="nd">@NonNull</span> <span class="no">VH</span> <span class="nf">onCreateViewHolder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">ViewGroup</span> <span class="n">parent</span><span class="o">);</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">onBindViewHolder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="no">VH</span> <span class="n">holder</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="no">T</span> <span class="n">item</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><p>TypePool用来存放多个<code class="language-plaintext highlighter-rouge">ItemViewBinder</code>类，并绑定数据的Model类型实现viewtype和<code class="language-plaintext highlighter-rouge">ItemViewBinder</code>一一对应的关系。TypePool是一个接口，MultiTypePool是他的直接子类。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
</pre><td class="rouge-code"><pre>   <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiTypePool</span> <span class="kd">implements</span> <span class="nc">TypePool</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nd">@NonNull</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span><span class="o">;</span> <span class="c1">//用来存放model的Class</span>
    <span class="kd">private</span> <span class="nd">@NonNull</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemViewBinder</span><span class="o">&lt;?,</span> <span class="o">?&gt;&gt;</span> <span class="n">binders</span><span class="o">;</span> <span class="c1">//存放ItemViewBinder</span>
    <span class="kd">private</span> <span class="nd">@NonNull</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Linker</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">linkers</span><span class="o">;</span><span class="c1">//对于相同的model类型，可能有多个布局这时候需要自己提供viewtype</span>


    <span class="cm">/**
     * Constructs a MultiTypePool with default lists.
     */</span>
    <span class="kd">public</span> <span class="nf">MultiTypePool</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">binders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">linkers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Constructs a MultiTypePool with default lists and a specified initial capacity.
     *
     * @param initialCapacity the initial capacity of the list
     */</span>
    <span class="kd">public</span> <span class="nf">MultiTypePool</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">binders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">linkers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Constructs a MultiTypePool with specified lists.
     *
     * @param classes the list for classes
     * @param binders the list for binders
     * @param linkers the list for linkers
     */</span>
    <span class="kd">public</span> <span class="nf">MultiTypePool</span><span class="o">(</span>
        <span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemViewBinder</span><span class="o">&lt;?,</span> <span class="o">?&gt;&gt;</span> <span class="n">binders</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Linker</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">linkers</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">classes</span> <span class="o">=</span> <span class="n">classes</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">binders</span> <span class="o">=</span> <span class="n">binders</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">linkers</span> <span class="o">=</span> <span class="n">linkers</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span>
        <span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">ItemViewBinder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">binder</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">Linker</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">linker</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">classes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="n">binders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">binder</span><span class="o">);</span>
        <span class="n">linkers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">linker</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unregister</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">removed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">classes</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="n">binders</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="n">linkers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="n">removed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">removed</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">classes</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//获取索引</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">firstIndexOf</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">classes</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">classes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getClass</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">classes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nd">@NonNull</span> <span class="nc">ItemViewBinder</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">getItemViewBinder</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">binders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nd">@NonNull</span> <span class="nc">Linker</span><span class="o">&lt;?&gt;</span> <span class="n">getLinker</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">linkers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>


</pre></table></code></div></div><p>MultiTypeAdapter：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
</pre><td class="rouge-code"><pre>
<span class="cm">/**
 * @author drakeet
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiTypeAdapter</span> <span class="kd">extends</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">Adapter</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TAG</span> <span class="o">=</span> <span class="s">"MultiTypeAdapter"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">items</span><span class="o">;</span> <span class="c1">//使用集合存放各种类型的数据</span>
    <span class="kd">private</span> <span class="nd">@NonNull</span> <span class="nc">TypePool</span> <span class="n">typePool</span><span class="o">;</span>


    <span class="cm">/**
     * Constructs a MultiTypeAdapter with an empty items list.
     */</span>
    <span class="kd">public</span> <span class="nf">MultiTypeAdapter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">());</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Constructs a MultiTypeAdapter with a items list.
     *
     * @param items the items list
     */</span>
    <span class="kd">public</span> <span class="nf">MultiTypeAdapter</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">items</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MultiTypePool</span><span class="o">());</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Constructs a MultiTypeAdapter with a items list and an initial capacity of TypePool.
     *
     * @param items the items list
     * @param initialCapacity the initial capacity of TypePool
     */</span>
    <span class="kd">public</span> <span class="nf">MultiTypeAdapter</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">items</span><span class="o">,</span> <span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">items</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MultiTypePool</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">));</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Constructs a MultiTypeAdapter with a items list and a TypePool.
     *
     * @param items the items list
     * @param pool the type pool
     */</span>
    <span class="kd">public</span> <span class="nf">MultiTypeAdapter</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">items</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">TypePool</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">typePool</span> <span class="o">=</span> <span class="n">pool</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Registers a type class and its item view binder. If you have registered the class,
     * it will override the original binder(s). Note that the method is non-thread-safe
     * so that you should not use it in concurrent operation.
     * &lt;p&gt;
     * Note that the method should not be called after
     * {@link RecyclerView#setAdapter(RecyclerView.Adapter)}, or you have to call the setAdapter
     * again.
     * &lt;/p&gt;
     *
     * @param clazz the class of a item
     * @param binder the item view binder
     * @param &lt;T&gt; the item data type
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">ItemViewBinder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">binder</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkAndRemoveAllTypesIfNeeded</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="n">register</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">binder</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DefaultLinker</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;());</span>
    <span class="o">}</span>


    <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span>
        <span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">ItemViewBinder</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">binder</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">Linker</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">linker</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">typePool</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">binder</span><span class="o">,</span> <span class="n">linker</span><span class="o">);</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">adapter</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Registers a type class to multiple item view binders. If you have registered the
     * class, it will override the original binder(s). Note that the method is non-thread-safe
     * so that you should not use it in concurrent operation.
     * &lt;p&gt;
     * Note that the method should not be called after
     * {@link RecyclerView#setAdapter(RecyclerView.Adapter)}, or you have to call the setAdapter
     * again.
     * &lt;/p&gt;
     *
     * @param clazz the class of a item
     * @param &lt;T&gt; the item data type
     * @return {@link OneToManyFlow} for setting the binders
     * @see #register(Class, ItemViewBinder)
     */</span>
    <span class="nd">@CheckResult</span>
    <span class="kd">public</span> <span class="nd">@NonNull</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">OneToManyFlow</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">register</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkAndRemoveAllTypesIfNeeded</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">OneToManyBuilder</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Registers all of the contents in the specified type pool. If you have registered a
     * class, it will override the original binder(s). Note that the method is non-thread-safe
     * so that you should not use it in concurrent operation.
     * &lt;p&gt;
     * Note that the method should not be called after
     * {@link RecyclerView#setAdapter(RecyclerView.Adapter)}, or you have to call the setAdapter
     * again.
     * &lt;/p&gt;
     *
     * @param pool type pool containing contents to be added to this adapter inner pool
     * @see #register(Class, ItemViewBinder)
     * @see #register(Class)
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerAll</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="kd">final</span> <span class="nc">TypePool</span> <span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">registerWithoutChecking</span><span class="o">(</span>
                <span class="n">pool</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="n">i</span><span class="o">),</span>
                <span class="n">pool</span><span class="o">.</span><span class="na">getItemViewBinder</span><span class="o">(</span><span class="n">i</span><span class="o">),</span>
                <span class="n">pool</span><span class="o">.</span><span class="na">getLinker</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
            <span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Sets and updates the items atomically and safely. It is recommended to use this method
     * to update the items with a new wrapper list or consider using {@link CopyOnWriteArrayList}.
     *
     * &lt;p&gt;Note: If you want to refresh the list views after setting items, you should
     * call {@link RecyclerView.Adapter#notifyDataSetChanged()} by yourself.&lt;/p&gt;
     *
     * @param items the new items list
     * @since v2.4.1
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setItems</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">getItems</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">items</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Set the TypePool to hold the types and view binders.
     *
     * @param typePool the TypePool implementation
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTypePool</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">TypePool</span> <span class="n">typePool</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">typePool</span> <span class="o">=</span> <span class="n">typePool</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="nd">@NonNull</span> <span class="nc">TypePool</span> <span class="nf">getTypePool</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">typePool</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getItemViewType</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span> <span class="c1">//获取item</span>
        <span class="k">return</span> <span class="nf">indexInTypesOf</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">item</span><span class="o">);</span> <span class="c1">//</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ViewHolder</span> <span class="nf">onCreateViewHolder</span><span class="o">(</span><span class="nc">ViewGroup</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">indexViewType</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">LayoutInflater</span> <span class="n">inflater</span> <span class="o">=</span> <span class="nc">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getContext</span><span class="o">());</span>
        <span class="nc">ItemViewBinder</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">typePool</span><span class="o">.</span><span class="na">getItemViewBinder</span><span class="o">(</span><span class="n">indexViewType</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">binder</span><span class="o">.</span><span class="na">onCreateViewHolder</span><span class="o">(</span><span class="n">inflater</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * This method is deprecated and unused. You should not call this method.
     * &lt;p&gt;
     * If you need to call the binding, use {@link RecyclerView.Adapter#onBindViewHolder(ViewHolder,
     * int, List)} instead.
     * &lt;/p&gt;
     *
     * @param holder The ViewHolder which should be updated to represent the contents of the
     * item at the given position in the data set.
     * @param position The position of the item within the adapter's data set.
     * @throws IllegalAccessError By default.
     * @deprecated Call {@link RecyclerView.Adapter#onBindViewHolder(ViewHolder, int, List)}
     * instead.
     */</span>
    <span class="nd">@Override</span> <span class="nd">@Deprecated</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onBindViewHolder</span><span class="o">(</span><span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">onBindViewHolder</span><span class="o">(</span><span class="n">holder</span><span class="o">,</span> <span class="n">position</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">());</span>
    <span class="o">}</span>


    <span class="nd">@Override</span> <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onBindViewHolder</span><span class="o">(</span><span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">payloads</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="nc">ItemViewBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">typePool</span><span class="o">.</span><span class="na">getItemViewBinder</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getItemViewType</span><span class="o">());</span>
        <span class="n">binder</span><span class="o">.</span><span class="na">onBindViewHolder</span><span class="o">(</span><span class="n">holder</span><span class="o">,</span> <span class="n">item</span><span class="o">,</span> <span class="n">payloads</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getItemCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">items</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Called to return the stable ID for the item, and passes the event to its associated binder.
     *
     * @param position Adapter position to query
     * @return the stable ID of the item at position
     * @see ItemViewBinder#getItemId(Object)
     * @see RecyclerView.Adapter#setHasStableIds(boolean)
     * @since v3.2.0
     */</span>
    <span class="nd">@Override</span> <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">long</span> <span class="nf">getItemId</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">itemViewType</span> <span class="o">=</span> <span class="n">getItemViewType</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="nc">ItemViewBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">typePool</span><span class="o">.</span><span class="na">getItemViewBinder</span><span class="o">(</span><span class="n">itemViewType</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">binder</span><span class="o">.</span><span class="na">getItemId</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Called when a view created by this adapter has been recycled, and passes the event to its
     * associated binder.
     *
     * @param holder The ViewHolder for the view being recycled
     * @see RecyclerView.Adapter#onViewRecycled(ViewHolder)
     * @see ItemViewBinder#onViewRecycled(ViewHolder)
     */</span>
    <span class="nd">@Override</span> <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onViewRecycled</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getRawBinderByViewHolder</span><span class="o">(</span><span class="n">holder</span><span class="o">).</span><span class="na">onViewRecycled</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Called by the RecyclerView if a ViewHolder created by this Adapter cannot be recycled
     * due to its transient state, and passes the event to its associated item view binder.
     *
     * @param holder The ViewHolder containing the View that could not be recycled due to its
     * transient state.
     * @return True if the View should be recycled, false otherwise. Note that if this method
     * returns &lt;code&gt;true&lt;/code&gt;, RecyclerView &lt;em&gt;will ignore&lt;/em&gt; the transient state of
     * the View and recycle it regardless. If this method returns &lt;code&gt;false&lt;/code&gt;,
     * RecyclerView will check the View's transient state again before giving a final decision.
     * Default implementation returns false.
     * @see RecyclerView.Adapter#onFailedToRecycleView(ViewHolder)
     * @see ItemViewBinder#onFailedToRecycleView(ViewHolder)
     */</span>
    <span class="nd">@Override</span> <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">onFailedToRecycleView</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getRawBinderByViewHolder</span><span class="o">(</span><span class="n">holder</span><span class="o">).</span><span class="na">onFailedToRecycleView</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Called when a view created by this adapter has been attached to a window, and passes the
     * event to its associated item view binder.
     *
     * @param holder Holder of the view being attached
     * @see RecyclerView.Adapter#onViewAttachedToWindow(ViewHolder)
     * @see ItemViewBinder#onViewAttachedToWindow(ViewHolder)
     */</span>
    <span class="nd">@Override</span> <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onViewAttachedToWindow</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getRawBinderByViewHolder</span><span class="o">(</span><span class="n">holder</span><span class="o">).</span><span class="na">onViewAttachedToWindow</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Called when a view created by this adapter has been detached from its window, and passes
     * the event to its associated item view binder.
     *
     * @param holder Holder of the view being detached
     * @see RecyclerView.Adapter#onViewDetachedFromWindow(ViewHolder)
     * @see ItemViewBinder#onViewDetachedFromWindow(ViewHolder)
     */</span>
    <span class="nd">@Override</span> <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onViewDetachedFromWindow</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getRawBinderByViewHolder</span><span class="o">(</span><span class="n">holder</span><span class="o">).</span><span class="na">onViewDetachedFromWindow</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="nd">@NonNull</span> <span class="nc">ItemViewBinder</span> <span class="nf">getRawBinderByViewHolder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">typePool</span><span class="o">.</span><span class="na">getItemViewBinder</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getItemViewType</span><span class="o">());</span>
    <span class="o">}</span>

<span class="c1">//这样写不存在问题吗？待验证。如果第一个有linker返回索引的0+1 第二个没有linker索引刚好是1 岂不是有问题？？</span>
    <span class="kt">int</span> <span class="nf">indexInTypesOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">Object</span> <span class="n">item</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BinderNotFoundException</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">typePool</span><span class="o">.</span><span class="na">firstIndexOf</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
            <span class="nc">Linker</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">linker</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Linker</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">typePool</span><span class="o">.</span><span class="na">getLinker</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">index</span> <span class="o">+</span> <span class="n">linker</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">item</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">BinderNotFoundException</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkAndRemoveAllTypesIfNeeded</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">typePool</span><span class="o">.</span><span class="na">unregister</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"You have registered the "</span> <span class="o">+</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" type. "</span> <span class="o">+</span>
                <span class="s">"It will override the original binder(s)."</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="cm">/** A safe register method base on the TypePool's safety for TypePool. */</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerWithoutChecking</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Class</span> <span class="n">clazz</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">ItemViewBinder</span> <span class="n">binder</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">Linker</span> <span class="n">linker</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkAndRemoveAllTypesIfNeeded</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="n">register</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">binder</span><span class="o">,</span> <span class="n">linker</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="adapterdelegate">AdapterDelegate</h3><p>AdapterDelegate的封装实体类为<code class="language-plaintext highlighter-rouge">AdapterDelegate</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
</pre><td class="rouge-code"><pre><span class="cm">/**
 * This delegate provide method to hook in this delegate to {@link RecyclerView.Adapter} lifecycle.
 * This "hook in" mechanism is provided by {@link AdapterDelegatesManager} and that is the
 * component
 * you have to use.
 *
 * @param &lt;T&gt; The type of the data source
 * @author Hannes Dorfmann
 * @since 1.0
 */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AdapterDelegate</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="cm">/**
   * Called to determine whether this AdapterDelegate is the responsible for the given data
   * element.
   *
   * @param items The data source of the Adapter
   * @param position The position in the datasource
   * @return true, if this item is responsible,  otherwise false
   */</span>
  <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">isForViewType</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="no">T</span> <span class="n">items</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">);</span>

  <span class="cm">/**
   * Creates the  {@link RecyclerView.ViewHolder} for the given data source item
   *
   * @param parent The ViewGroup parent of the given datasource
   * @return The new instantiated {@link RecyclerView.ViewHolder}
   */</span>
  <span class="nd">@NonNull</span> <span class="kd">abstract</span> <span class="kd">protected</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="nf">onCreateViewHolder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewGroup</span> <span class="n">parent</span><span class="o">);</span>

  <span class="cm">/**
   * Called to bind the {@link RecyclerView.ViewHolder} to the item of the datas source set
   *
   * @param items The data source
   * @param position The position in the datasource
   * @param holder The {@link RecyclerView.ViewHolder} to bind
   * @param payloads A non-null list of merged payloads. Can be empty list if requires full update.
   */</span>
  <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">onBindViewHolder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="no">T</span> <span class="n">items</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span>
      <span class="nd">@NonNull</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">payloads</span><span class="o">);</span>

  <span class="cm">/**
   * Called when a view created by this adapter has been recycled.
   *
   * &lt;p&gt;A view is recycled when a {@link RecyclerView.LayoutManager} decides that it no longer
   * needs to be attached to its parent {@link RecyclerView}. This can be because it has
   * fallen out of visibility or a set of cached views represented by views still
   * attached to the parent RecyclerView. If an item view has large or expensive data
   * bound to it such as large bitmaps, this may be a good place to release those
   * resources.&lt;/p&gt;
   * &lt;p&gt;
   * RecyclerView calls this method right before clearing ViewHolder's internal data and
   * sending it to RecycledViewPool. This way, if ViewHolder was holding valid information
   * before being recycled, you can call {@link RecyclerView.ViewHolder#getAdapterPosition()} to
   * get
   * its adapter position.
   *
   * @param viewHolder The ViewHolder for the view being recycled
   */</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onViewRecycled</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="n">viewHolder</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Called by the RecyclerView if a ViewHolder created by this Adapter cannot be recycled
   * due to its transient state. Upon receiving this callback, Adapter can clear the
   * animation(s) that effect the View's transient state and return &lt;code&gt;true&lt;/code&gt; so that
   * the View can be recycled. Keep in mind that the View in question is already removed from
   * the RecyclerView.
   * &lt;p&gt;
   * In some cases, it is acceptable to recycle a View although it has transient state. Most
   * of the time, this is a case where the transient state will be cleared in
   * {@link RecyclerView.Adapter#onBindViewHolder(RecyclerView.ViewHolder, int)} call when View is
   * rebound to a new position.
   * For this reason, RecyclerView leaves the decision to the Adapter and uses the return
   * value of this method to decide whether the View should be recycled or not.
   * &lt;p&gt;
   * Note that when all animations are created by {@link RecyclerView.ItemAnimator}, you
   * should never receive this callback because RecyclerView keeps those Views as children
   * until their animations are complete. This callback is useful when children of the item
   * views create animations which may not be easy to implement using an {@link
   * RecyclerView.ItemAnimator}.
   * &lt;p&gt;
   * You should &lt;em&gt;never&lt;/em&gt; fix this issue by calling
   * &lt;code&gt;holder.itemView.setHasTransientState(false);&lt;/code&gt; unless you've previously called
   * &lt;code&gt;holder.itemView.setHasTransientState(true);&lt;/code&gt;. Each
   * &lt;code&gt;View.setHasTransientState(true)&lt;/code&gt; call must be matched by a
   * &lt;code&gt;View.setHasTransientState(false)&lt;/code&gt; call, otherwise, the state of the View
   * may become inconsistent. You should always prefer to end or cancel animations that are
   * triggering the transient state instead of handling it manually.
   *
   * @param holder The ViewHolder containing the View that could not be recycled due to its
   * transient state.
   * @return True if the View should be recycled, false otherwise. Note that if this method
   * returns &lt;code&gt;true&lt;/code&gt;, RecyclerView &lt;em&gt;will ignore&lt;/em&gt; the transient state of
   * the View and recycle it regardless. If this method returns &lt;code&gt;false&lt;/code&gt;,
   * RecyclerView will check the View's transient state again before giving a final decision.
   * Default implementation returns false.
   */</span>
  <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">onFailedToRecycleView</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Called when a view created by this adapter has been attached to a window.
   *
   * &lt;p&gt;This can be used as a reasonable signal that the view is about to be seen
   * by the user. If the adapter previously freed any resources in
   * {@link RecyclerView.Adapter#onViewDetachedFromWindow(RecyclerView.ViewHolder)
   * onViewDetachedFromWindow}
   * those resources should be restored here.&lt;/p&gt;
   *
   * @param holder Holder of the view being attached
   */</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onViewAttachedToWindow</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Called when a view created by this adapter has been detached from its window.
   *
   * &lt;p&gt;Becoming detached from the window is not necessarily a permanent condition;
   * the consumer of an Adapter's views may choose to cache views offscreen while they
   * are not visible, attaching an detaching them as appropriate.&lt;/p&gt;
   *
   * @param holder Holder of the view being detached
   */</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onViewDetachedFromWindow</span><span class="o">(</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>AdapterDelegatesManager用来存储AdapterDelegate和建立与viewtype的对应关系。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre><td class="rouge-code"><pre>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdapterDelegatesManager</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="c1">//...</span>
	  <span class="cm">/**
   * Map for ViewType to AdapterDelegate
   */</span>
<span class="c1">//使用Map建立	  ViewType和adapter的对应关系</span>
<span class="kd">protected</span> <span class="nc">SparseArrayCompat</span><span class="o">&lt;</span><span class="nc">AdapterDelegate</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">delegates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SparseArrayCompat</span><span class="o">();</span>
<span class="c1">//....</span>

<span class="kd">public</span> <span class="nc">AdapterDelegatesManager</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">addDelegate</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">AdapterDelegate</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// algorithm could be improved since there could be holes,</span>
    <span class="c1">// but it's very unlikely that we reach Integer.MAX_VALUE and run out of unused indexes</span>
    <span class="kt">int</span> <span class="n">viewType</span> <span class="o">=</span> <span class="n">delegates</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="c1">//在上面情况下会走这里？</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">delegates</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">viewType</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">viewType</span><span class="o">++;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">viewType</span> <span class="o">==</span> <span class="no">FALLBACK_DELEGATE_VIEW_TYPE</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
            <span class="s">"Oops, we are very close to Integer.MAX_VALUE. It seems that there are no more free and unused view type integers left to add another AdapterDelegate."</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">addDelegate</span><span class="o">(</span><span class="n">viewType</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">delegate</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
  <span class="cm">/**
   * Adds an {@link AdapterDelegate}.
   *
   * @param viewType The viewType id
   * @param allowReplacingDelegate if true, you allow to replacing the given delegate any previous
   * delegate for the same view type. if false, you disallow and a {@link IllegalArgumentException}
   * will be thrown if you try to replace an already registered {@link AdapterDelegate} for the
   * same view type.
   * @param delegate The delegate to add
   * @throws IllegalArgumentException if &lt;b&gt;allowReplacingDelegate&lt;/b&gt;  is false and an {@link
   * AdapterDelegate} is already added (registered)
   * with the same ViewType.
   * @throws IllegalArgumentException if viewType is {@link #FALLBACK_DELEGATE_VIEW_TYPE} which is
   * reserved
   * @see #addDelegate(AdapterDelegate)
   * @see #addDelegate(int, AdapterDelegate)
   * @see #setFallbackDelegate(AdapterDelegate)
   */</span>
  <span class="kd">public</span> <span class="nc">AdapterDelegatesManager</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">addDelegate</span><span class="o">(</span><span class="kt">int</span> <span class="n">viewType</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowReplacingDelegate</span><span class="o">,</span>
      <span class="nd">@NonNull</span> <span class="nc">AdapterDelegate</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">delegate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">"AdapterDelegate is null!"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">viewType</span> <span class="o">==</span> <span class="no">FALLBACK_DELEGATE_VIEW_TYPE</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"The view type = "</span>
          <span class="o">+</span> <span class="no">FALLBACK_DELEGATE_VIEW_TYPE</span>
          <span class="o">+</span> <span class="s">" is reserved for fallback adapter delegate (see setFallbackDelegate() ). Please use another view type."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">allowReplacingDelegate</span> <span class="o">&amp;&amp;</span> <span class="n">delegates</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">viewType</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
          <span class="s">"An AdapterDelegate is already registered for the viewType = "</span>
              <span class="o">+</span> <span class="n">viewType</span>
              <span class="o">+</span> <span class="s">". Already registered AdapterDelegate is "</span>
              <span class="o">+</span> <span class="n">delegates</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">viewType</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="n">delegates</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">viewType</span><span class="o">,</span> <span class="n">delegate</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>
    <span class="cm">/**
   * Must be called from {@link RecyclerView.Adapter#getItemViewType(int)}. Internally it scans all
   * the registered {@link AdapterDelegate} and picks the right one to return the ViewType integer.
   *
   * @param items Adapter's data source
   * @param position the position in adapters data source
   * @return the ViewType (integer). Returns {@link #FALLBACK_DELEGATE_VIEW_TYPE} in case that the
   * fallback adapter delegate should be used
   * @throws NullPointerException if no {@link AdapterDelegate} has been found that is
   * responsible for the given data element in data set (No {@link AdapterDelegate} for the given
   * ViewType)
   * @throws NullPointerException if items is null
   */</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getItemViewType</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="no">T</span> <span class="n">items</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">items</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">"Items datasource is null!"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">delegatesCount</span> <span class="o">=</span> <span class="n">delegates</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="c1">//遍历所有的delegate </span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delegatesCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">AdapterDelegate</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">delegate</span> <span class="o">=</span> <span class="n">delegates</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="c1">//根据类型判断 获取key</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">isForViewType</span><span class="o">(</span><span class="n">items</span><span class="o">,</span> <span class="n">position</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">delegates</span><span class="o">.</span><span class="na">keyAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span> 
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">fallbackDelegate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">FALLBACK_DELEGATE_VIEW_TYPE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span>
        <span class="s">"No AdapterDelegate added that matches position="</span> <span class="o">+</span> <span class="n">position</span> <span class="o">+</span> <span class="s">" in data source"</span><span class="o">);</span>
  <span class="o">}</span>

</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MultiType和AdapterDelegates源码分析 - malinkang&url=https://malinkang.cn/posts/multitype-and-AdapterDelegates-source-analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MultiType和AdapterDelegates源码分析 - malinkang&u=https://malinkang.cn/posts/multitype-and-AdapterDelegates-source-analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=MultiType和AdapterDelegates源码分析 - malinkang&url=https://malinkang.cn/posts/multitype-and-AdapterDelegates-source-analysis/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dagger-guide/">Dagger使用指南</a><li><a href="/posts/understanding-the-jvm-runtime-data-areas/">《深入理解JVM》第2章Java内存区域与内存溢出异常</a><li><a href="/posts/understanding-the-jvm-garbage-collection/">《深入理解JVM》第3章垃圾收集器</a><li><a href="/posts/understanding-the-jvm-class-file-structure/">《深入理解JVM》第6章类文件结构</a><li><a href="/posts/understanding-the-jvm-class-loader/">《深入理解JVM》第7章虚拟机类加载机制</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/deskclock-analysis/"><div class="card-body"> <span class="timeago small" > Jan 19 <i class="unloaded">2021-01-19T17:21:04+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>系统闹钟源码分析</h3><div class="text-muted small"><p> 核心类 UI部分 DeskClock：主界面，由ViewPager实现。 DeskClockFragment：首页四个Fragment的基类。 AlarmClockFragment：闹钟Fragment ClockFragment：时钟Fragment StopwatchFragment：秒表Fragm...</p></div></div></a></div><div class="card"> <a href="/posts/bound-services/"><div class="card-body"> <span class="timeago small" > Dec 15, 2020 <i class="unloaded">2020-12-15T03:18:41+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>绑定服务</h3><div class="text-muted small"><p> 绑定服务是 Service 类的实现，可让其他应用与其进行绑定和交互。如要为服务提供绑定，您必须实现 onBind() 回调方法。该方法会返回 IBinder 对象，该对象定义的编程接口可供客户端用来与服务进行交互。 客户端通过调用 bindService() 绑定到服务。调用时，它必须提供 ServiceConnection 的实现，后者会监控与服务的连接。bindService() 的...</p></div></div></a></div><div class="card"> <a href="/posts/workmanager-source-analysis/"><div class="card-body"> <span class="timeago small" > Dec 8, 2020 <i class="unloaded">2020-12-08T04:40:56+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WorkManager源码分析</h3><div class="text-muted small"><p> WorkManager WorkManger是一个单例对象, 但是从例子代码中没有看的调用初始化的地方。通过文档可知 WorkManager有两种初始化方式: 应用启动之后, 它自己自动初始化 按需初始化, 到了需要用到的地方才初始化。可以避免初始化影响应用的启动速度。 自动初始化 WorkManagerInitializer继承ContentProvider。在应用启动...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/signing-android-app/" class="btn btn-outline-primary" prompt="Older"><p>签署Android应用</p></a> <a href="/posts/linux-command/" class="btn btn-outline-primary" prompt="Newer"><p>常用Linux命令</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//malinkang-cn.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'MultiType和AdapterDelegates源码分析'; this.page.url = 'https://malinkang.cn/posts/multitype-and-AdapterDelegates-source-analysis/'; this.page.identifier = '/posts/multitype-and-AdapterDelegates-source-analysis/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/malinkang">malinkang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://malinkang.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
