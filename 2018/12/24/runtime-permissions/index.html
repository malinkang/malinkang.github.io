<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android运行时权限 | 马林康的博客</title><meta name="author" content="马林康"><meta name="copyright" content="马林康"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="权限的作用是保护 Android 用户的隐私。Android 应用必须请求权限才能访问敏感的用户数据（例如联系人和短信）以及某些系统功能（例如相机和互联网）。系统可能会自动授予权限，也可能会提示用户批准请求，具体取决于访问的功能。 Android 安全架构的设计主旨是：在默认情况下，任何应用都没有权限执行会对其他应用、操作系统或用户带来不利影响的任何操作。这包括读取或写入用户的私有数据（例如联系人">
<meta property="og:type" content="article">
<meta property="og:title" content="Android运行时权限">
<meta property="og:url" content="https://malinkang.cn/2018/12/24/runtime-permissions/index.html">
<meta property="og:site_name" content="马林康的博客">
<meta property="og:description" content="权限的作用是保护 Android 用户的隐私。Android 应用必须请求权限才能访问敏感的用户数据（例如联系人和短信）以及某些系统功能（例如相机和互联网）。系统可能会自动授予权限，也可能会提示用户批准请求，具体取决于访问的功能。 Android 安全架构的设计主旨是：在默认情况下，任何应用都没有权限执行会对其他应用、操作系统或用户带来不利影响的任何操作。这包括读取或写入用户的私有数据（例如联系人">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2018-12-24T12:25:35.000Z">
<meta property="article:modified_time" content="2020-12-25T03:17:55.690Z">
<meta property="article:author" content="马林康">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://malinkang.cn/2018/12/24/runtime-permissions/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-25 11:17:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 笔记</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener" href="https://leetcode.malinkang.cn/"><i class="fa-fw fas fa-link"></i><span> LeetCode解题</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">马林康的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 笔记</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener" href="https://leetcode.malinkang.cn/"><i class="fa-fw fas fa-link"></i><span> LeetCode解题</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Android运行时权限</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-12-24T12:25:35.000Z" title="发表于 2018-12-24 20:25:35">2018-12-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-12-25T03:17:55.690Z" title="更新于 2020-12-25 11:17:55">2020-12-25</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>权限的作用是保护 Android 用户的隐私。Android 应用必须请求权限才能访问敏感的用户数据（例如联系人和短信）以及某些系统功能（例如相机和互联网）。系统可能会自动授予权限，也可能会提示用户批准请求，具体取决于访问的功能。</p>
<p>Android 安全架构的设计主旨是：在默认情况下，任何应用都没有权限执行会对其他应用、操作系统或用户带来不利影响的任何操作。这包括读取或写入用户的私有数据（例如联系人或电子邮件）、读取或写入其他应用的文件、执行网络访问、使设备保持唤醒状态等。</p>
<h2 id="权限审批"><a href="#权限审批" class="headerlink" title="权限审批"></a>权限审批</h2><p>应用必须通过在<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/manifest-intro?hl=zh-cn">应用清单</a>中添加 <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/uses-permission-element?hl=zh-cn"><code>&lt;uses-permission&gt;</code></a> 标记来公开所需的权限。例如，需要发送短信的应用会在清单中添加以下代码行：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">package</span>=<span class="string">&quot;com.example.snazzyapp&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.SEND_SMS&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果您的应用在清单中列出普通权限（即不会给用户隐私或设备操作带来太大风险的权限），系统会自动将这些权限授予应用。</p>
<p>如果您的应用在清单中列出危险权限（即可能影响用户隐私或设备正常操作的权限），如上面的 <code>SEND_SMS</code> 权限，必须由用户明确同意授予这些权限。</p>
<h3 id="危险权限的请求提示"><a href="#危险权限的请求提示" class="headerlink" title="危险权限的请求提示"></a>危险权限的请求提示</h3><p>仅危险权限需要用户同意。Android 请求用户授予危险权限的方式取决于用户设备上搭载的 Android 版本和应用的目标系统版本。</p>
<h4 id="运行时请求（Android-6-0-及更高版本）"><a href="#运行时请求（Android-6-0-及更高版本）" class="headerlink" title="运行时请求（Android 6.0 及更高版本）"></a>运行时请求（Android 6.0 及更高版本）</h4><p>如果设备搭载的是 Android 6.0（API 级别 23）或更高版本，并且应用的 <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/uses-sdk-element?hl=zh-cn#target"><code>targetSdkVersion</code></a> 是 23 或更高版本，用户在安装时不会收到任何应用权限的通知。您的应用必须在运行时请求用户授予危险权限。当应用请求权限时，用户会看到一个系统对话框（如图 1 左图所示），告知用户应用正在尝试访问的权限组。该对话框包括<strong>拒绝</strong>和<strong>允许</strong>按钮。</p>
<p>如果用户拒绝权限请求，当应用下次请求该权限时，该对话框将包含一个复选框，选中它即表示用户不想再收到权限提示（请参阅图 1 右图）。</p>
<p><img src="https://developer.android.com/images/permissions/runtime_permission_request_2x.png?hl=zh-cn" alt="**图 1.** 初始权限对话框（左）和包含关闭进一步请求的选项的二次权限请求（右）"></p>
<p>如果用户选中<strong>不再询问</strong>复选框并点按<strong>拒绝</strong>，当您以后尝试请求相同权限时，系统不会再提示用户。</p>
<p>即使用户授予应用所请求的权限，您也不能指望始终拥有该权限。用户也可以选择在系统设置中逐一启用和停用权限。您应始终在运行时检查并请求权限，以防发生运行时错误 (<code>SecurityException</code>)。</p>
<h4 id="安装时请求（Android-5-1-1-及更低版本）"><a href="#安装时请求（Android-5-1-1-及更低版本）" class="headerlink" title="安装时请求（Android 5.1.1 及更低版本）"></a>安装时请求（Android 5.1.1 及更低版本）</h4><p>如果设备搭载的是 Android 5.1.1（API 级别 22）或更低版本，或者应用在任何版本的 Android 上运行时其 <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/uses-sdk-element?hl=zh-cn#target"><code>targetSdkVersion</code></a> 是 22 或更低版本，系统将在安装时自动请求用户向应用授予所有危险权限（请参见图 2）。</p>
<p><img src="https://developer.android.com/images/permissions/install_time_permissions_dialog_2x.png?hl=zh-cn" alt="**图 2.** 安装时权限对话框"></p>
<p>如果用户点击<strong>接受</strong>，系统将授予应用请求的所有权限。如果用户拒绝权限请求，系统将取消安装应用。</p>
<h2 id="保护级别"><a href="#保护级别" class="headerlink" title="保护级别"></a>保护级别</h2><p>权限分为几个保护级别。保护级别影响着是否需要运行时权限请求。</p>
<p>有三种保护级别会影响第三方应用：普通、签名和危险权限。如需查看特定权限所拥有的保护级别，请访问<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn">权限 API 参考页面</a>。</p>
<h3 id="普通权限"><a href="#普通权限" class="headerlink" title="普通权限"></a>普通权限</h3><p>普通权限涵盖以下情况：应用需要访问其沙盒外部的数据或资源，但对用户隐私或其他应用的操作带来的风险很小。例如，设置时区的权限就是普通权限。</p>
<p>如果应用在清单中声明需要普通权限，系统会在安装时自动向应用授予该权限。系统不会提示用户授予普通权限，用户也无法撤消这些权限。</p>
<h3 id="签名权限"><a href="#签名权限" class="headerlink" title="签名权限"></a>签名权限</h3><p>系统在安装时授予这些应用权限，但仅会在尝试使用某权限的应用签名证书为定义该权限的同一证书时才会授予。</p>
<h3 id="危险权限"><a href="#危险权限" class="headerlink" title="危险权限"></a>危险权限</h3><p>危险权限涵盖以下情况：应用需要的数据或资源涉及用户隐私信息，或者可能对用户存储的数据或其他应用的操作产生影响。例如，能够读取用户的联系人属于危险权限。如果应用声明其需要危险权限，必须由用户向应用明确授予该权限。在用户批准该权限之前，应用无法提供依赖于该权限的功能。</p>
<h2 id="特殊权限"><a href="#特殊权限" class="headerlink" title="特殊权限"></a>特殊权限</h2><p>有几项权限的行为与普通权限及危险权限都不同。<code>SYSTEM_ALERT_WINDOW</code> 和 <code>WRITE_SETTINGS</code> 特别敏感，因此大多数应用不应该使用它们。</p>
<p>在大多数情况下，应用必须在清单中声明 <code>SYSTEM_ALERT_WINDOW</code> 权限，并发送请求用户授权的 intent。系统将向用户显示详细管理屏幕，以响应该 intent。</p>
<p>从 Android 11（API 级别 30）开始，调用 <code>ACTION_MANAGE_OVERLAY_PERMISSION</code> intent 操作的应用不能指定软件包。当应用调用包含此 intent 操作的 intent 时，必须由用户先选择想要授予或撤消哪些应用的权限。此行为可以让权限的授予更有目的性，从而达到保护用户的目的。</p>
<h2 id="检查权限"><a href="#检查权限" class="headerlink" title="检查权限"></a>检查权限</h2><p>如果应用需要一项危险权限，那么每次执行需要该权限的操作时，您都必须检查是否具有该权限。在<code> Android 6.0</code>（API 级别 23）及更高版本中，用户可以随时从任何应用撤消危险权限。</p>
<h3 id="确定应用是否已获得权限"><a href="#确定应用是否已获得权限" class="headerlink" title="确定应用是否已获得权限"></a>确定应用是否已获得权限</h3><p>如需检查用户是否已向您的应用授予特定权限，请将该权限传入 <code>ContextCompat.checkSelfPermission()</code>方法。根据您的应用是否具有相应权限，此方法会返回 <code>PERMISSION_GRANTED</code>或 <code>PERMISSION_DENIED</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ContextCompat.checkSelfPermission(<span class="keyword">this</span>,Manifest.permission.READ_PHONE_STATE) ==  PackageManager.PERMISSION_DENIED) &#123;</span><br><span class="line">    <span class="comment">//权限被拒</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="说明您的应用为何需要获取权限"><a href="#说明您的应用为何需要获取权限" class="headerlink" title="说明您的应用为何需要获取权限"></a>说明您的应用为何需要获取权限</h3><p>如果 <code>ContextCompat.checkSelfPermission()</code> 方法返回 <code>PERMISSION_DENIED</code>，请调用 <code>shouldShowRequestPermissionRationale()</code>。如果此方法返回 <code>true</code>，请向用户显示指导界面。请在此界面中说明用户希望启用的功能为何需要特定权限。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户授权成功或者点击禁止不再询问时返回false</span></span><br><span class="line">ActivityCompat.shouldShowRequestPermissionRationale(<span class="keyword">this</span>, Manifest.permission.READ_PHONE_STATE)</span><br></pre></td></tr></table></figure>

<h3 id="请求权限"><a href="#请求权限" class="headerlink" title="请求权限"></a>请求权限</h3><p>用户查看指导界面后或者 <code>shouldShowRequestPermissionRationale()</code> 的返回值表明您这次不需要显示指导界面后，您可以请求权限。用户会看到系统权限对话框，并可在其中选择是否向您的应用授予特定权限。</p>
<p>按照历来的做法，您可以在权限请求过程中<strong>自行管理请求代码</strong>，并将此请求代码包含在您的权限回调逻辑中。另一种选择是使用 AndroidX 库中包含的 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/activity/result/contract/ActivityResultContracts.RequestPermission?hl=zh-cn"><code>RequestPermission</code></a> 协定类，您可在其中<strong>允许系统代为管理权限请求代码</strong>。由于使用 <code>RequestPermission</code> 协定类可简化逻辑，因此，<strong>建议您尽可能使用该方法</strong>。</p>
<h4 id="允许系统管理权限请求代码"><a href="#允许系统管理权限请求代码" class="headerlink" title="允许系统管理权限请求代码"></a>允许系统管理权限请求代码</h4><p>如需允许系统管理与权限请求相关联的请求代码，请在您模块的 <code>build.gradle</code> 文件中<a target="_blank" rel="noopener" href="https://developer.android.com/jetpack/androidx/releases/activity?hl=zh-cn#declaring_dependencies">添加 <code>androidx.activity</code> 库的依赖项</a>。请使用该库的 1.2.0 版或更高版本。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&quot;androidx.activity:activity-ktx:1.2.0-beta01&quot;</span></span><br><span class="line">  	<span class="comment">// 不依赖会报错 https://stackoverflow.com/questions/62771948/new-result-api-error-can-only-use-lower-16-bits-for-requestcode</span></span><br><span class="line">    implementation <span class="string">&#x27;androidx.fragment:fragment-ktx:1.3.0-beta01&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，您可以使用以下某个类：</p>
<ul>
<li>如需请求一项权限，请使用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/activity/result/contract/ActivityResultContracts.RequestPermission?hl=zh-cn"><code>RequestPermission</code></a>。</li>
<li>如需同时请求多项权限，请使用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/activity/result/contract/ActivityResultContracts.RequestMultiplePermissions?hl=zh-cn"><code>RequestMultiplePermissions</code></a>。</li>
</ul>
<p>以下步骤显示了如何使用 <code>RequestPermission</code> 协定类。使用 <code>RequestMultiplePermissions</code> 协定类的流程几乎与此相同。</p>
<ol>
<li><p>在 Activity 或 Fragment 的初始化逻辑中，将 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/activity/result/ActivityResultCallback?hl=zh-cn"><code>ActivityResultCallback</code></a> 的实现传入对 <code>registerForActivityResult()</code> 的调用。<code>ActivityResultCallback</code> 定义应用如何处理用户对权限请求的响应。保留对 <code>registerForActivityResult()</code>（类型为 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/activity/result/ActivityResultLauncher?hl=zh-cn"><code>ActivityResultLauncher</code></a>）的返回值的引用。</p>
</li>
<li><p>如需在必要时显示系统权限对话框，请对您在上一步中保存的 <code>ActivityResultLauncher</code> 实例调用 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/activity/result/ActivityResultLauncher?hl=zh-cn#launch(I)"><code>launch()</code></a> 方法。</p>
<p>调用 <code>launch()</code> 之后，系统会显示系统权限对话框。当用户做出选择后，系统会异步调用您在上一步中定义的 <code>ActivityResultCallback</code> 实现。</p>
</li>
</ol>
<p>以下代码段展示了如何处理权限响应：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register the permissions callback, which handles the user&#x27;s response to the</span></span><br><span class="line"><span class="comment">// system permissions dialog. Save the return value, an instance of</span></span><br><span class="line"><span class="comment">// ActivityResultLauncher. You can use either a val, as shown in this snippet,</span></span><br><span class="line"><span class="comment">// or a lateinit var in your onAttach() or onCreate() method.</span></span><br><span class="line"><span class="keyword">val</span> requestPermissionLauncher =</span><br><span class="line">    registerForActivityResult(RequestPermission()</span><br><span class="line">    ) &#123; isGranted: <span class="built_in">Boolean</span> -&gt;</span><br><span class="line">        <span class="keyword">if</span> (isGranted) &#123;</span><br><span class="line">            <span class="comment">// Permission is granted. Continue the action or workflow in your</span></span><br><span class="line">            <span class="comment">// app.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Explain to the user that the feature is unavailable because the</span></span><br><span class="line">            <span class="comment">// features requires a permission that the user has denied. At the</span></span><br><span class="line">            <span class="comment">// same time, respect the user&#x27;s decision. Don&#x27;t link to system</span></span><br><span class="line">            <span class="comment">// settings in an effort to convince the user to change their</span></span><br><span class="line">            <span class="comment">// decision.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>以下代码段演示了检查权限并根据需要向用户请求权限的建议流程：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">when</span> &#123;</span><br><span class="line">    ContextCompat.checkSelfPermission(</span><br><span class="line">            CONTEXT,</span><br><span class="line">            Manifest.permission.REQUESTED_PERMISSION</span><br><span class="line">            ) == PackageManager.PERMISSION_GRANTED -&gt; &#123;</span><br><span class="line">        <span class="comment">// You can use the API that requires the permission.</span></span><br><span class="line">    &#125;</span><br><span class="line">    shouldShowRequestPermissionRationale(...) -&gt; &#123;</span><br><span class="line">        <span class="comment">// In an educational UI, explain to the user why your app requires this</span></span><br><span class="line">        <span class="comment">// permission for a specific feature to behave as expected. In this UI,</span></span><br><span class="line">        <span class="comment">// include a &quot;cancel&quot; or &quot;no thanks&quot; button that allows the user to</span></span><br><span class="line">        <span class="comment">// continue using your app without granting the permission.</span></span><br><span class="line">        showInContextUI(...)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">        <span class="comment">// You can directly ask for the permission.</span></span><br><span class="line">        <span class="comment">// The registered ActivityResultCallback gets the result of this request.</span></span><br><span class="line">        requestPermissionLauncher.launch(</span><br><span class="line">                Manifest.permission.REQUESTED_PERMISSION)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自行管理权限请求代码"><a href="#自行管理权限请求代码" class="headerlink" title="自行管理权限请求代码"></a>自行管理权限请求代码</h4><p>作为<a target="_blank" rel="noopener" href="https://developer.android.com/training/permissions/requesting?hl=zh-cn#allow-system-manage-request-code">允许系统管理权限请求代码</a>的替代方法，您可以自行管理权限请求代码。为此，请在对 <code>requestPermissions()</code> 的调用中添加请求代码。</p>
<p>以下代码段演示了如何使用请求代码来请求权限：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">when</span> &#123;</span><br><span class="line">    ContextCompat.checkSelfPermission(</span><br><span class="line">            CONTEXT,</span><br><span class="line">            Manifest.permission.REQUESTED_PERMISSION</span><br><span class="line">            ) == PackageManager.PERMISSION_GRANTED -&gt; &#123;</span><br><span class="line">        <span class="comment">// You can use the API that requires the permission.</span></span><br><span class="line">        performAction(...)</span><br><span class="line">    &#125;</span><br><span class="line">    ActivityCompat.shouldShowRequestPermissionRationale(...) -&gt; &#123;</span><br><span class="line">        <span class="comment">// In an educational UI, explain to the user why your app requires this</span></span><br><span class="line">        <span class="comment">// permission for a specific feature to behave as expected. In this UI,</span></span><br><span class="line">        <span class="comment">// include a &quot;cancel&quot; or &quot;no thanks&quot; button that allows the user to</span></span><br><span class="line">        <span class="comment">// continue using your app without granting the permission.</span></span><br><span class="line">        showInContextUI(...)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">        <span class="comment">// You can directly ask for the permission.</span></span><br><span class="line">        ActivityCompat.requestPermissions(CONTEXT,</span><br><span class="line">                arrayOf(Manifest.permission.REQUESTED_PERMISSION),</span><br><span class="line">                REQUEST_CODE)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当用户响应系统权限对话框后，系统就会调用应用的 <code>onRequestPermissionsResult()</code> 实现。系统会传入用户对权限对话框的响应以及您定义的请求代码，如以下代码段所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onRequestPermissionsResult</span><span class="params">(requestCode: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        permissions: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;, grantResults: <span class="type">IntArray</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">when</span> (requestCode) &#123;</span><br><span class="line">        PERMISSION_REQUEST_CODE -&gt; &#123;</span><br><span class="line">            <span class="comment">// If request is cancelled, the result arrays are empty.</span></span><br><span class="line">            <span class="keyword">if</span> ((grantResults.isNotEmpty() &amp;&amp;</span><br><span class="line">                    grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED)) &#123;</span><br><span class="line">                <span class="comment">// Permission is granted. Continue the action or workflow</span></span><br><span class="line">                <span class="comment">// in your app.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Explain to the user that the feature is unavailable because</span></span><br><span class="line">                <span class="comment">// the features requires a permission that the user has denied.</span></span><br><span class="line">                <span class="comment">// At the same time, respect the user&#x27;s decision. Don&#x27;t link to</span></span><br><span class="line">                <span class="comment">// system settings in an effort to convince the user to change</span></span><br><span class="line">                <span class="comment">// their decision.</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add other &#x27;when&#x27; lines to check for other</span></span><br><span class="line">        <span class="comment">// permissions this app might request.</span></span><br><span class="line">        <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">            <span class="comment">// Ignore all other requests.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单次授权"><a href="#单次授权" class="headerlink" title="单次授权"></a>单次授权</h2><p>从 <strong>Android 11（API 级别 30）</strong>开始，每当您的应用请求与位置、麦克风或相机相关的权限时，面向用户的权限对话框都会包含<strong>仅限这一次</strong>选项，如图 1 所示。如果用户在对话框中选择此选项，系统会向应用授予临时的单次授权。</p>
<p><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/leetcode/one-time-prompt.svg" alt="在该对话框中有三个按钮，“仅限这一次”选项是其中的第二个按钮。"></p>
<p>然后，应用可以在一段时间内访问相关数据，具体时间取决于应用的行为和用户的操作：</p>
<ul>
<li>当应用的 Activity 可见时，应用可以访问相关数据。</li>
<li>如果用户将应用转为后台运行，应用可以在短时间内继续访问相关数据。</li>
<li>如果您在 Activity 可见时启动了一项前台服务，并且用户随后将您的应用转到后台，那么您的应用可以继续访问相关数据，直到该前台服务停止。</li>
<li>如果用户撤消单次授权（例如在系统设置中撤消），无论您是否启动了前台服务，应用都无法访问相关数据。与任何权限一样，如果用户撤消了应用的单次授权，应用进程就会终止。</li>
</ul>
<p>当用户下次打开应用并且应用中的某项功能请求访问位置信息、麦克风或摄像头时，系统会再次提示用户授予权限。</p>
<h2 id="自动重置未使用的应用的权限"><a href="#自动重置未使用的应用的权限" class="headerlink" title="自动重置未使用的应用的权限"></a>自动重置未使用的应用的权限</h2><p>如果应用以 Android 11（API 级别 30）或更高版本为目标平台并且数月未使用，系统会通过自动重置用户已授予应用的运行时敏感权限保护用户数据。此操作与用户在系统设置中查看权限并将应用的访问权限级别更改为<strong>拒绝</strong>的做法效果一样。</p>
<p>如果应用遵循了有关<a target="_blank" rel="noopener" href="https://developer.android.com/training/permissions/requesting?hl=zh-cn">在运行时请求权限</a>的最佳做法，那么您不必对应用进行任何更改。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/permissions/overview?hl=zh-cn">权限概览</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/permissions/declaring?hl=zh-cn">声明应用权限</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/permissions/requesting?hl=zh-cn">请求应用权限</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/permissions/usage-notes?hl=zh-cn">应用权限最佳做法</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/permissions/default-handlers?hl=zh-cn">仅在默认处理程序中使用的权限</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/permissions/defining?hl=zh-cn">定义自定义应用权限</a></li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/android/permissions-samples">permissions-samples</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tbruyelle/RxPermissions">RxPermissions</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/permissions-dispatcher/PermissionsDispatcher">PermissionsDispatcher</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/googlesamples/easypermissions">easypermissions</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">马林康</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://malinkang.cn/2018/12/24/runtime-permissions/">https://malinkang.cn/2018/12/24/runtime-permissions/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://malinkang.cn" target="_blank">马林康的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/24/arouter-source-analysis/"><img class="prev-cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/泰坦尼克号.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ARouter源码分析</div></div></a></div><div class="next-post pull-right"><a href="/2017/07/25/retrofit-source-analysis/"><img class="next-cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/飞屋环游记.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Retrofit源码分析</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">马林康</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/malinkang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://twitter.com/maliinkang" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="https://weibo.com/maliinkang" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="https://instagram.com/maliinkang" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E5%AE%A1%E6%89%B9"><span class="toc-number">1.</span> <span class="toc-text">权限审批</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B1%E9%99%A9%E6%9D%83%E9%99%90%E7%9A%84%E8%AF%B7%E6%B1%82%E6%8F%90%E7%A4%BA"><span class="toc-number">1.1.</span> <span class="toc-text">危险权限的请求提示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E8%AF%B7%E6%B1%82%EF%BC%88Android-6-0-%E5%8F%8A%E6%9B%B4%E9%AB%98%E7%89%88%E6%9C%AC%EF%BC%89"><span class="toc-number">1.1.1.</span> <span class="toc-text">运行时请求（Android 6.0 及更高版本）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%97%B6%E8%AF%B7%E6%B1%82%EF%BC%88Android-5-1-1-%E5%8F%8A%E6%9B%B4%E4%BD%8E%E7%89%88%E6%9C%AC%EF%BC%89"><span class="toc-number">1.1.2.</span> <span class="toc-text">安装时请求（Android 5.1.1 及更低版本）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E7%BA%A7%E5%88%AB"><span class="toc-number">2.</span> <span class="toc-text">保护级别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%9D%83%E9%99%90"><span class="toc-number">2.1.</span> <span class="toc-text">普通权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%90%8D%E6%9D%83%E9%99%90"><span class="toc-number">2.2.</span> <span class="toc-text">签名权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B1%E9%99%A9%E6%9D%83%E9%99%90"><span class="toc-number">2.3.</span> <span class="toc-text">危险权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%9D%83%E9%99%90"><span class="toc-number">3.</span> <span class="toc-text">特殊权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%9D%83%E9%99%90"><span class="toc-number">4.</span> <span class="toc-text">检查权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E5%BA%94%E7%94%A8%E6%98%AF%E5%90%A6%E5%B7%B2%E8%8E%B7%E5%BE%97%E6%9D%83%E9%99%90"><span class="toc-number">4.1.</span> <span class="toc-text">确定应用是否已获得权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E%E6%82%A8%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%BA%E4%BD%95%E9%9C%80%E8%A6%81%E8%8E%B7%E5%8F%96%E6%9D%83%E9%99%90"><span class="toc-number">4.2.</span> <span class="toc-text">说明您的应用为何需要获取权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%9D%83%E9%99%90"><span class="toc-number">4.3.</span> <span class="toc-text">请求权限</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%81%E8%AE%B8%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%9D%83%E9%99%90%E8%AF%B7%E6%B1%82%E4%BB%A3%E7%A0%81"><span class="toc-number">4.3.1.</span> <span class="toc-text">允许系统管理权限请求代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E8%A1%8C%E7%AE%A1%E7%90%86%E6%9D%83%E9%99%90%E8%AF%B7%E6%B1%82%E4%BB%A3%E7%A0%81"><span class="toc-number">4.3.2.</span> <span class="toc-text">自行管理权限请求代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E6%AC%A1%E6%8E%88%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text">单次授权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%87%8D%E7%BD%AE%E6%9C%AA%E4%BD%BF%E7%94%A8%E7%9A%84%E5%BA%94%E7%94%A8%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-number">6.</span> <span class="toc-text">自动重置未使用的应用的权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">8.</span> <span class="toc-text">代码</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/31/good-bye-2020/" title="再见2020"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="再见2020"/></a><div class="content"><a class="title" href="/2020/12/31/good-bye-2020/" title="再见2020">再见2020</a><time datetime="2020-12-31T07:27:48.000Z" title="发表于 2020-12-31 15:27:48">2020-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/14/bound-services/" title="绑定服务"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="绑定服务"/></a><div class="content"><a class="title" href="/2020/12/14/bound-services/" title="绑定服务">绑定服务</a><time datetime="2020-12-14T11:18:41.000Z" title="发表于 2020-12-14 19:18:41">2020-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/07/workmanager-source-analysis/" title="WorkManager源码分析"><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/指环王.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WorkManager源码分析"/></a><div class="content"><a class="title" href="/2020/12/07/workmanager-source-analysis/" title="WorkManager源码分析">WorkManager源码分析</a><time datetime="2020-12-07T12:40:56.000Z" title="发表于 2020-12-07 20:40:56">2020-12-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/02/butterknife-source-analysis/" title="ButterKnife源码分析"><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/疯狂动物城.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ButterKnife源码分析"/></a><div class="content"><a class="title" href="/2020/12/02/butterknife-source-analysis/" title="ButterKnife源码分析">ButterKnife源码分析</a><time datetime="2020-12-02T08:37:06.000Z" title="发表于 2020-12-02 16:37:06">2020-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/27/rxjava-source-analysis/" title="RxJava源码分析"><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/罗马假日.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RxJava源码分析"/></a><div class="content"><a class="title" href="/2020/11/27/rxjava-source-analysis/" title="RxJava源码分析">RxJava源码分析</a><time datetime="2020-11-27T15:47:34.000Z" title="发表于 2020-11-27 23:47:34">2020-11-27</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2014 - 2021 By 马林康</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://malinkang.cn/2018/12/24/runtime-permissions/'
    this.page.identifier = '2018/12/24/runtime-permissions/'
    this.page.title = 'Android运行时权限'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://malinkang.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>