<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Retrofit源码分析" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="Retrofit源码分析" /><meta property="og:description" content="Retrofit源码分析" /><link rel="canonical" href="https://malinkang.cn/posts/retrofit-source-analysis/" /><meta property="og:url" content="https://malinkang.cn/posts/retrofit-source-analysis/" /><meta property="og:site_name" content="malinkang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-07-26T04:07:22+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Retrofit源码分析" /><meta name="twitter:site" content="@malinkang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Retrofit源码分析","headline":"Retrofit源码分析","dateModified":"2021-07-07T14:54:59+08:00","url":"https://malinkang.cn/posts/retrofit-source-analysis/","datePublished":"2017-07-26T04:07:22+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://malinkang.cn/posts/retrofit-source-analysis/"},"@context":"https://schema.org"}</script><title>Retrofit源码分析 | malinkang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="malinkang"><meta name="application-name" content="malinkang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">malinkang</a></div><div class="site-subtitle font-italic">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/malinkang" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/malinkang" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['linkang.ma','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Retrofit源码分析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Retrofit源码分析</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> malinkang </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 26, 2017, 4:07 AM +0800" prep="on" > Jul 26, 2017 <i class="unloaded">2017-07-26T04:07:22+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 7, 2021, 2:54 PM +0800" prefix="Updated " > Jul 7 <i class="unloaded">2021-07-07T14:54:59+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5598 words">31 min</span></div></div><div class="post-content"><h1 id="retrofit源码分析">Retrofit源码分析</h1><h2 id="流程分析">流程分析</h2><p><code class="language-plaintext highlighter-rouge">Retrofit</code>执行流程可以分为两部分：</p><ul><li>创建<code class="language-plaintext highlighter-rouge">ServiceMethod</code>。<li>调用<code class="language-plaintext highlighter-rouge">ServiceMethod</code>的<code class="language-plaintext highlighter-rouge">invoke()</code>。</ul><p>下图中，黑线部分是创建<code class="language-plaintext highlighter-rouge">ServiceMethod</code>的过程，红线部分是<code class="language-plaintext highlighter-rouge">invoke()</code>的调用过程。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/Retrofit流程.png" alt="Retrofit流程" /></p><p><code class="language-plaintext highlighter-rouge">ServiceMethod</code>创建过程：</p><ol><li>通过动态代理，获取到我们定义的接口里的所有<code class="language-plaintext highlighter-rouge">Method</code>，调用<code class="language-plaintext highlighter-rouge">ServiceMethod</code>的静态方法<code class="language-plaintext highlighter-rouge">parseAnnotations</code>创建<code class="language-plaintext highlighter-rouge">ServiceMethod</code>。<li><code class="language-plaintext highlighter-rouge">ServiceMethod</code>调用<code class="language-plaintext highlighter-rouge">RequestFactory</code>的静态方法<code class="language-plaintext highlighter-rouge">parseAnnotations</code>创建<code class="language-plaintext highlighter-rouge">RequestFactory</code>。<li><code class="language-plaintext highlighter-rouge">RequestFactory</code>解析每个方法上参数注解信息并封装到<code class="language-plaintext highlighter-rouge">ParameterHandler</code>中。<li><code class="language-plaintext highlighter-rouge">ServiceMethod</code>调用<code class="language-plaintext highlighter-rouge">HttpServiceMethod</code>的静态方法<code class="language-plaintext highlighter-rouge">parseAnnotations</code>。<li><code class="language-plaintext highlighter-rouge">parseAnnotations</code>从<code class="language-plaintext highlighter-rouge">Retrofit</code>中获取<code class="language-plaintext highlighter-rouge">CallAdapter</code>，并创建<code class="language-plaintext highlighter-rouge">CallAdapted</code>。</ol><p><code class="language-plaintext highlighter-rouge">ServiceMethod</code>的<code class="language-plaintext highlighter-rouge">invoke()</code>执行流程：</p><ol><li>调用<code class="language-plaintext highlighter-rouge">ServiceMethod</code>的<code class="language-plaintext highlighter-rouge">invoke()</code>。<code class="language-plaintext highlighter-rouge">invoke()</code>会调用<code class="language-plaintext highlighter-rouge">CallAdapted</code>的<code class="language-plaintext highlighter-rouge">invoke()</code>。<li><code class="language-plaintext highlighter-rouge">CallAdapted</code>的<code class="language-plaintext highlighter-rouge">invoke()</code>创建<code class="language-plaintext highlighter-rouge">OkHttpCall</code>，并调用<code class="language-plaintext highlighter-rouge">CallAdapter</code>的<code class="language-plaintext highlighter-rouge">adapt()</code>。<li><code class="language-plaintext highlighter-rouge">CallAdapter</code>调用<code class="language-plaintext highlighter-rouge">OkHttpCall</code>的<code class="language-plaintext highlighter-rouge">enqueue()</code>。<li><code class="language-plaintext highlighter-rouge">OKHttpCall</code>调用<code class="language-plaintext highlighter-rouge">RequestFactory</code>的<code class="language-plaintext highlighter-rouge">create()</code>方法构建<code class="language-plaintext highlighter-rouge">Request</code>。<li><code class="language-plaintext highlighter-rouge">OkHtppCall</code>执行网络请求。</ol><h2 id="retrofit">Retrofit</h2><p><code class="language-plaintext highlighter-rouge">Retrofit</code>类是<code class="language-plaintext highlighter-rouge">Retrofit</code>的入口类。使用<code class="language-plaintext highlighter-rouge">Builder</code>设计模式，允许配置不同的参数。</p><h3 id="builder类">Builder类</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Platform</span> <span class="n">platform</span><span class="o">;</span> <span class="c1">//平台</span>
  <span class="kd">private</span> <span class="nd">@Nullable</span> <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">Factory</span> <span class="n">callFactory</span><span class="o">;</span> <span class="c1">//设置OkHttp的Call.Factory</span>
  <span class="kd">private</span> <span class="nd">@Nullable</span> <span class="nc">HttpUrl</span> <span class="n">baseUrl</span><span class="o">;</span> 
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Converter</span><span class="o">.</span><span class="na">Factory</span><span class="o">&gt;</span> <span class="n">converterFactories</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span><span class="c1">//ConverterFactory集合</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CallAdapter</span><span class="o">.</span><span class="na">Factory</span><span class="o">&gt;</span> <span class="n">callAdapterFactories</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span><span class="c1">//CallAdapterFactory集合</span>
  <span class="kd">private</span> <span class="nd">@Nullable</span> <span class="nc">Executor</span> <span class="n">callbackExecutor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">validateEagerly</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="build">build()</h3><p>在<code class="language-plaintext highlighter-rouge">Builder</code>的<code class="language-plaintext highlighter-rouge">build()</code>会判断是否配置参数，如果没有配置，会添加一些默认参数。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">Retrofit</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//判断url是否是空</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">baseUrl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Base URL required."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//判断callFactory是空 直接创建一个OkHttpClient</span>
    <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">Factory</span> <span class="n">callFactory</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">callFactory</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">callFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">callFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OkHttpClient</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nc">Executor</span> <span class="n">callbackExecutor</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">callbackExecutor</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">callbackExecutor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">callbackExecutor</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="na">defaultCallbackExecutor</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CallAdapter</span><span class="o">.</span><span class="na">Factory</span><span class="o">&gt;</span> <span class="n">callAdapterFactories</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">callAdapterFactories</span><span class="o">);</span>
    <span class="n">callAdapterFactories</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">platform</span><span class="o">.</span><span class="na">defaultCallAdapterFactories</span><span class="o">(</span><span class="n">callbackExecutor</span><span class="o">));</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Converter</span><span class="o">.</span><span class="na">Factory</span><span class="o">&gt;</span> <span class="n">converterFactories</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span>
            <span class="mi">1</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">converterFactories</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="n">platform</span><span class="o">.</span><span class="na">defaultConverterFactoriesSize</span><span class="o">());</span>
    <span class="c1">//添加内置的转换器</span>
    <span class="n">converterFactories</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BuiltInConverters</span><span class="o">());</span>
    <span class="n">converterFactories</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">converterFactories</span><span class="o">);</span>
    <span class="n">converterFactories</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">platform</span><span class="o">.</span><span class="na">defaultConverterFactories</span><span class="o">());</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">Retrofit</span><span class="o">(</span>
        <span class="n">callFactory</span><span class="o">,</span>
        <span class="n">baseUrl</span><span class="o">,</span>
        <span class="n">unmodifiableList</span><span class="o">(</span><span class="n">converterFactories</span><span class="o">),</span>
        <span class="n">unmodifiableList</span><span class="o">(</span><span class="n">callAdapterFactories</span><span class="o">),</span>
        <span class="n">callbackExecutor</span><span class="o">,</span>
        <span class="n">validateEagerly</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="create">create()</h3><p><code class="language-plaintext highlighter-rouge">create()</code>会创建传入<code class="language-plaintext highlighter-rouge">Class</code>的代理类。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">create</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//校验传入的Class</span>
  <span class="n">validateServiceInterface</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
  <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span>
      <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
          <span class="n">service</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
          <span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="o">{</span><span class="n">service</span><span class="o">},</span>
          <span class="k">new</span> <span class="nf">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Platform</span> <span class="n">platform</span> <span class="o">=</span> <span class="nc">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="c1">//获取平台</span>
            <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">emptyArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nd">@Nullable</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
              <span class="c1">// If the method is a method from Object then defer to normal invocation.</span>
              <span class="c1">//如果是Object中声明的方法，就调用当前InvocationHandler对应的方法</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()</span> <span class="o">==</span> <span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">args</span> <span class="o">:</span> <span class="n">emptyArgs</span><span class="o">;</span>
              <span class="k">return</span> <span class="n">platform</span><span class="o">.</span><span class="na">isDefaultMethod</span><span class="o">(</span><span class="n">method</span><span class="o">)</span>
                  <span class="o">?</span> <span class="n">platform</span><span class="o">.</span><span class="na">invokeDefaultMethod</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
                  <span class="o">:</span> <span class="n">loadServiceMethod</span><span class="o">(</span><span class="n">method</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
            <span class="o">}</span>
          <span class="o">});</span>
<span class="o">}</span>
</pre></table></code></div></div><p>为了避免相同的<code class="language-plaintext highlighter-rouge">Method</code>多次创建<code class="language-plaintext highlighter-rouge">ServiceMethod</code>，会将创建的<code class="language-plaintext highlighter-rouge">ServiceMethod</code>存入缓存中，如果缓存中没有则才重新创建。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nc">ServiceMethod</span><span class="o">&lt;?&gt;</span> <span class="n">loadServiceMethod</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">ServiceMethod</span><span class="o">&lt;?&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">serviceMethodCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="kd">synchronized</span> <span class="o">(</span><span class="n">serviceMethodCache</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">serviceMethodCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="nc">ServiceMethod</span><span class="o">.</span><span class="na">parseAnnotations</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>
      <span class="n">serviceMethodCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="servicemethod">ServiceMethod</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/ServiceMethod.png" alt="ServiceMethod类的继承关系" /></p><p><code class="language-plaintext highlighter-rouge">ServiceMethod</code>有两个方法：</p><ul><li><code class="language-plaintext highlighter-rouge">parseAnnotations()</code> 负责解析注解。<li><code class="language-plaintext highlighter-rouge">invoke()</code>会被<code class="language-plaintext highlighter-rouge">InvocationHandler</code>的<code class="language-plaintext highlighter-rouge">invoke()</code>方法调用。</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ServiceMethod</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ServiceMethod</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">parseAnnotations</span><span class="o">(</span><span class="nc">Retrofit</span> <span class="n">retrofit</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//创建RequestFactory</span>
    <span class="nc">RequestFactory</span> <span class="n">requestFactory</span> <span class="o">=</span> <span class="nc">RequestFactory</span><span class="o">.</span><span class="na">parseAnnotations</span><span class="o">(</span><span class="n">retrofit</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>
    <span class="c1">//获取方法返回类型</span>
    <span class="nc">Type</span> <span class="n">returnType</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getGenericReturnType</span><span class="o">();</span>
    <span class="c1">//校验返回值类型</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Utils</span><span class="o">.</span><span class="na">hasUnresolvableType</span><span class="o">(</span><span class="n">returnType</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span>
          <span class="n">method</span><span class="o">,</span>
          <span class="s">"Method return type must not include a type variable or wildcard: %s"</span><span class="o">,</span>
          <span class="n">returnType</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">returnType</span> <span class="o">==</span> <span class="kt">void</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="s">"Service methods cannot return void."</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="k">return</span> <span class="nc">HttpServiceMethod</span><span class="o">.</span><span class="na">parseAnnotations</span><span class="o">(</span><span class="n">retrofit</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">requestFactory</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">abstract</span> <span class="nd">@Nullable</span> <span class="no">T</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="httpservicemethod">HttpServiceMethod</h2><h3 id="parseannotations">parseAnnotations()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre><td class="rouge-code"><pre><span class="kd">static</span> <span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">ReturnT</span><span class="o">&gt;</span> <span class="nc">HttpServiceMethod</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">ReturnT</span><span class="o">&gt;</span> <span class="nf">parseAnnotations</span><span class="o">(</span>
    <span class="nc">Retrofit</span> <span class="n">retrofit</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">RequestFactory</span> <span class="n">requestFactory</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//判断是否是挂起函数</span>
  <span class="kt">boolean</span> <span class="n">isKotlinSuspendFunction</span> <span class="o">=</span> <span class="n">requestFactory</span><span class="o">.</span><span class="na">isKotlinSuspendFunction</span><span class="o">;</span>
  <span class="kt">boolean</span> <span class="n">continuationWantsResponse</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="kt">boolean</span> <span class="n">continuationBodyNullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="c1">//获取方法上的注解</span>
  <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">();</span>
  <span class="nc">Type</span> <span class="n">adapterType</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">isKotlinSuspendFunction</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//挂起函数</span>
    <span class="nc">Type</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getGenericParameterTypes</span><span class="o">();</span>
    <span class="nc">Type</span> <span class="n">responseType</span> <span class="o">=</span>
        <span class="nc">Utils</span><span class="o">.</span><span class="na">getParameterLowerBound</span><span class="o">(</span>
            <span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="nc">ParameterizedType</span><span class="o">)</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">getRawType</span><span class="o">(</span><span class="n">responseType</span><span class="o">)</span> <span class="o">==</span> <span class="nc">Response</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="n">responseType</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Unwrap the actual body type from Response&lt;T&gt;.</span>
      <span class="n">responseType</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">getParameterUpperBound</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="nc">ParameterizedType</span><span class="o">)</span> <span class="n">responseType</span><span class="o">);</span>
      <span class="n">continuationWantsResponse</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// TODO figure out if type is nullable or not</span>
      <span class="c1">// Metadata metadata = method.getDeclaringClass().getAnnotation(Metadata.class)</span>
      <span class="c1">// Find the entry for method</span>
      <span class="c1">// Determine if return type is nullable or not</span>
    <span class="o">}</span>

    <span class="n">adapterType</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">ParameterizedTypeImpl</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="nc">Call</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">responseType</span><span class="o">);</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="nc">SkipCallbackExecutorImpl</span><span class="o">.</span><span class="na">ensurePresent</span><span class="o">(</span><span class="n">annotations</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">adapterType</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getGenericReturnType</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="c1">//获取CallAdapter</span>
  <span class="nc">CallAdapter</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">ReturnT</span><span class="o">&gt;</span> <span class="n">callAdapter</span> <span class="o">=</span>
      <span class="n">createCallAdapter</span><span class="o">(</span><span class="n">retrofit</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">adapterType</span><span class="o">,</span> <span class="n">annotations</span><span class="o">);</span>
  <span class="c1">//获取CallAdapter的返回类型</span>
  <span class="nc">Type</span> <span class="n">responseType</span> <span class="o">=</span> <span class="n">callAdapter</span><span class="o">.</span><span class="na">responseType</span><span class="o">();</span>
  <span class="c1">//如果返回类型是okhttp3.Response</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">responseType</span> <span class="o">==</span> <span class="n">okhttp3</span><span class="o">.</span><span class="na">Response</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span>
        <span class="n">method</span><span class="o">,</span>
        <span class="s">"'"</span>
            <span class="o">+</span> <span class="n">getRawType</span><span class="o">(</span><span class="n">responseType</span><span class="o">).</span><span class="na">getName</span><span class="o">()</span>
            <span class="o">+</span> <span class="s">"' is not a valid response body type. Did you mean ResponseBody?"</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="k">if</span> <span class="o">(</span><span class="n">responseType</span> <span class="o">==</span> <span class="nc">Response</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="s">"Response must include generic type (e.g., Response&lt;String&gt;)"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// TODO support Unit for Kotlin?</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">requestFactory</span><span class="o">.</span><span class="na">httpMethod</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"HEAD"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Void</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">responseType</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="s">"HEAD method must use Void as response type."</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//获取Converter</span>
  <span class="nc">Converter</span><span class="o">&lt;</span><span class="nc">ResponseBody</span><span class="o">,</span> <span class="nc">ResponseT</span><span class="o">&gt;</span> <span class="n">responseConverter</span> <span class="o">=</span>
      <span class="n">createResponseConverter</span><span class="o">(</span><span class="n">retrofit</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">responseType</span><span class="o">);</span>

  <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">Factory</span> <span class="n">callFactory</span> <span class="o">=</span> <span class="n">retrofit</span><span class="o">.</span><span class="na">callFactory</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">isKotlinSuspendFunction</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//创建CallAdapted</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">CallAdapted</span><span class="o">&lt;&gt;(</span><span class="n">requestFactory</span><span class="o">,</span> <span class="n">callFactory</span><span class="o">,</span> <span class="n">responseConverter</span><span class="o">,</span> <span class="n">callAdapter</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">continuationWantsResponse</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.</span>
    <span class="k">return</span> <span class="o">(</span><span class="nc">HttpServiceMethod</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">ReturnT</span><span class="o">&gt;)</span>
        <span class="k">new</span> <span class="nc">SuspendForResponse</span><span class="o">&lt;&gt;(</span>
            <span class="n">requestFactory</span><span class="o">,</span>
            <span class="n">callFactory</span><span class="o">,</span>
            <span class="n">responseConverter</span><span class="o">,</span>
            <span class="o">(</span><span class="nc">CallAdapter</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">Call</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">&gt;&gt;)</span> <span class="n">callAdapter</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">//noinspection unchecked Kotlin compiler guarantees ReturnT to be Object.</span>
    <span class="k">return</span> <span class="o">(</span><span class="nc">HttpServiceMethod</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">ReturnT</span><span class="o">&gt;)</span>
        <span class="k">new</span> <span class="nc">SuspendForBody</span><span class="o">&lt;&gt;(</span>
            <span class="n">requestFactory</span><span class="o">,</span>
            <span class="n">callFactory</span><span class="o">,</span>
            <span class="n">responseConverter</span><span class="o">,</span>
            <span class="o">(</span><span class="nc">CallAdapter</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">Call</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">&gt;&gt;)</span> <span class="n">callAdapter</span><span class="o">,</span>
            <span class="n">continuationBodyNullable</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="createcalladapter">createCallAdapter()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">ReturnT</span><span class="o">&gt;</span> <span class="nc">CallAdapter</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">ReturnT</span><span class="o">&gt;</span> <span class="nf">createCallAdapter</span><span class="o">(</span>
    <span class="nc">Retrofit</span> <span class="n">retrofit</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">returnType</span><span class="o">,</span> <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="c1">//noinspection unchecked</span>
    <span class="c1">//调用Retrofit的callAdapter方法</span>
    <span class="k">return</span> <span class="o">(</span><span class="nc">CallAdapter</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">,</span> <span class="nc">ReturnT</span><span class="o">&gt;)</span> <span class="n">retrofit</span><span class="o">.</span><span class="na">callAdapter</span><span class="o">(</span><span class="n">returnType</span><span class="o">,</span> <span class="n">annotations</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Wide exception range because factories are user code.</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="s">"Unable to create call adapter for %s"</span><span class="o">,</span> <span class="n">returnType</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="retrofitcalladapter">Retrofit#callAdapter()</h3><p><code class="language-plaintext highlighter-rouge">nextCallAdapter()</code>方法会遍历所有的<code class="language-plaintext highlighter-rouge">CallAdapter</code>，获取到合适的直接返回。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">CallAdapter</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">callAdapter</span><span class="o">(</span><span class="nc">Type</span> <span class="n">returnType</span><span class="o">,</span> <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">nextCallAdapter</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">returnType</span><span class="o">,</span> <span class="n">annotations</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="nc">CallAdapter</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">nextCallAdapter</span><span class="o">(</span>
    <span class="nd">@Nullable</span> <span class="nc">CallAdapter</span><span class="o">.</span><span class="na">Factory</span> <span class="n">skipPast</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">returnType</span><span class="o">,</span> <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">returnType</span><span class="o">,</span> <span class="s">"returnType == null"</span><span class="o">);</span>
  <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">annotations</span><span class="o">,</span> <span class="s">"annotations == null"</span><span class="o">);</span>
  <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">callAdapterFactories</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">skipPast</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">callAdapterFactories</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">CallAdapter</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">callAdapterFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">returnType</span><span class="o">,</span> <span class="n">annotations</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">adapter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">adapter</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">//构建错误信息</span>
  <span class="nc">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">StringBuilder</span><span class="o">(</span><span class="s">"Could not locate call adapter for "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">returnType</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">".\n"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">skipPast</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"  Skipped:"</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">start</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n   * "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">callAdapterFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"  Tried:"</span><span class="o">);</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">callAdapterFactories</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n   * "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">callAdapterFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="createresponseconverter">createResponseConverter()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">&gt;</span> <span class="nc">Converter</span><span class="o">&lt;</span><span class="nc">ResponseBody</span><span class="o">,</span> <span class="nc">ResponseT</span><span class="o">&gt;</span> <span class="nf">createResponseConverter</span><span class="o">(</span>
    <span class="nc">Retrofit</span> <span class="n">retrofit</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">responseType</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">();</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">retrofit</span><span class="o">.</span><span class="na">responseBodyConverter</span><span class="o">(</span><span class="n">responseType</span><span class="o">,</span> <span class="n">annotations</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Wide exception range because factories are user code.</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="s">"Unable to create converter for %s"</span><span class="o">,</span> <span class="n">responseType</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="retrofitnextresponsebodyconverter">Retrofit#nextResponseBodyConverter()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Converter</span><span class="o">&lt;</span><span class="nc">ResponseBody</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nf">nextResponseBodyConverter</span><span class="o">(</span>
    <span class="nd">@Nullable</span> <span class="nc">Converter</span><span class="o">.</span><span class="na">Factory</span> <span class="n">skipPast</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">,</span> <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="s">"type == null"</span><span class="o">);</span>
  <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">annotations</span><span class="o">,</span> <span class="s">"annotations == null"</span><span class="o">);</span>
  <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">converterFactories</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">skipPast</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">converterFactories</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">Converter</span><span class="o">&lt;</span><span class="nc">ResponseBody</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">converter</span> <span class="o">=</span>
        <span class="n">converterFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">responseBodyConverter</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">annotations</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">converter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//noinspection unchecked</span>
      <span class="k">return</span> <span class="o">(</span><span class="nc">Converter</span><span class="o">&lt;</span><span class="nc">ResponseBody</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;)</span> <span class="n">converter</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="nc">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">StringBuilder</span><span class="o">(</span><span class="s">"Could not locate ResponseBody converter for "</span><span class="o">)</span>
          <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">type</span><span class="o">)</span>
          <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">".\n"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">skipPast</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"  Skipped:"</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">start</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n   * "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">converterFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"  Tried:"</span><span class="o">);</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">converterFactories</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n   * "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">converterFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="invoke">invoke()</h3><p><code class="language-plaintext highlighter-rouge">HttpServiceMethod</code>的<code class="language-plaintext highlighter-rouge">invoke()</code>会创建<code class="language-plaintext highlighter-rouge">Call</code>，然后调用<code class="language-plaintext highlighter-rouge">adapt()</code>。<code class="language-plaintext highlighter-rouge">adapt()</code>是抽象的，具体实现在它的子类中。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">final</span> <span class="nd">@Nullable</span> <span class="nc">ReturnT</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//创建OkHttpCall</span>
  <span class="nc">Call</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">&gt;</span> <span class="n">call</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OkHttpCall</span><span class="o">&lt;&gt;(</span><span class="n">requestFactory</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">callFactory</span><span class="o">,</span> <span class="n">responseConverter</span><span class="o">);</span>
  <span class="c1">//调用adapt方法 </span>
  <span class="k">return</span> <span class="nf">adapt</span><span class="o">(</span><span class="n">call</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">CallAdapted</code>的<code class="language-plaintext highlighter-rouge">adapt()</code>调用<code class="language-plaintext highlighter-rouge">CallAdapter</code>的<code class="language-plaintext highlighter-rouge">adapt()</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="nc">ReturnT</span> <span class="nf">adapt</span><span class="o">(</span><span class="nc">Call</span><span class="o">&lt;</span><span class="nc">ResponseT</span><span class="o">&gt;</span> <span class="n">call</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">callAdapter</span><span class="o">.</span><span class="na">adapt</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="requestfactory">RequestFactory</h2><p><code class="language-plaintext highlighter-rouge">RequestFactory</code>负责获取<code class="language-plaintext highlighter-rouge">Method</code>上的注解信息，并装成成<code class="language-plaintext highlighter-rouge">Request</code>。</p><h3 id="parseannotations-1">parseAnnotations()</h3><p><code class="language-plaintext highlighter-rouge">parseAnnotations()</code>方法会创建一个<code class="language-plaintext highlighter-rouge">Builder</code>，然后调用<code class="language-plaintext highlighter-rouge">build()</code>方法创建<code class="language-plaintext highlighter-rouge">RequestFactory</code>实例。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">static</span> <span class="nc">RequestFactory</span> <span class="nf">parseAnnotations</span><span class="o">(</span><span class="nc">Retrofit</span> <span class="n">retrofit</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">Builder</span><span class="o">(</span><span class="n">retrofit</span><span class="o">,</span> <span class="n">method</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="builder">Builder</h3><p><code class="language-plaintext highlighter-rouge">Builder</code>类是<code class="language-plaintext highlighter-rouge">RequestFactory</code>的内部类，负责构建<code class="language-plaintext highlighter-rouge">RequestFactory</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span><span class="o">{</span>
  <span class="c1">//构造函数</span>
  <span class="nc">Builder</span><span class="o">(</span><span class="nc">Retrofit</span> <span class="n">retrofit</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
  	<span class="k">this</span><span class="o">.</span><span class="na">retrofit</span> <span class="o">=</span> <span class="n">retrofit</span><span class="o">;</span>
  	<span class="k">this</span><span class="o">.</span><span class="na">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
  	<span class="k">this</span><span class="o">.</span><span class="na">methodAnnotations</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">();</span><span class="c1">//获取方法上的注解 数组</span>
  	<span class="k">this</span><span class="o">.</span><span class="na">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getGenericParameterTypes</span><span class="o">();</span> <span class="c1">//获取参数 </span>
    <span class="c1">//二维数组 方法有多个参数 每个参数上可能有多个注解所以返回值是一个二维数组</span>
    <span class="c1">//获取参数上的注解</span>
  	<span class="k">this</span><span class="o">.</span><span class="na">parameterAnnotationsArray</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterAnnotations</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="build-1">build()</h3><p><code class="language-plaintext highlighter-rouge">build()</code>会解析方法上的注解和参数上的注解。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="nc">RequestFactory</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">//遍历方法上的注解调用parseMethodAnnotation解析方法上的注解</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">Annotation</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">methodAnnotations</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parseMethodAnnotation</span><span class="o">(</span><span class="n">annotation</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//调用完parseMethodAnnotation 会为httpMethod赋值</span>
  <span class="c1">//如果httpMethod为空直接抛出异常</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">httpMethod</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="s">"HTTP method annotation is required (e.g., @GET, @POST, etc.)."</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">hasBody</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isMultipart</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span>
          <span class="n">method</span><span class="o">,</span>
          <span class="s">"Multipart can only be specified on HTTP methods with request body (e.g., @POST)."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isFormEncoded</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span>
          <span class="n">method</span><span class="o">,</span>
          <span class="s">"FormUrlEncoded can only be specified on HTTP methods with "</span>
              <span class="o">+</span> <span class="s">"request body (e.g., @POST)."</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">//参数个数</span>
  <span class="kt">int</span> <span class="n">parameterCount</span> <span class="o">=</span> <span class="n">parameterAnnotationsArray</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
  <span class="c1">//创建一个ParameterHandler数组 </span>
  <span class="n">parameterHandlers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ParameterHandler</span><span class="o">&lt;?&gt;[</span><span class="n">parameterCount</span><span class="o">];</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">lastParameter</span> <span class="o">=</span> <span class="n">parameterCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">parameterCount</span><span class="o">;</span> <span class="n">p</span><span class="o">++)</span> <span class="o">{</span>
    <span class="c1">//调用parseParameter方法解析参数 并创建一个ParameterHandler为parameterHandlers赋值</span>
    <span class="n">parameterHandlers</span><span class="o">[</span><span class="n">p</span><span class="o">]</span> <span class="o">=</span>
        <span class="n">parseParameter</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="n">p</span><span class="o">],</span> <span class="n">parameterAnnotationsArray</span><span class="o">[</span><span class="n">p</span><span class="o">],</span> <span class="n">p</span> <span class="o">==</span> <span class="n">lastParameter</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">relativeUrl</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gotUrl</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="s">"Missing either @%s URL or @Url parameter."</span><span class="o">,</span> <span class="n">httpMethod</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">isFormEncoded</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isMultipart</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hasBody</span> <span class="o">&amp;&amp;</span> <span class="n">gotBody</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="s">"Non-body HTTP method cannot contain @Body."</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">isFormEncoded</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gotField</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="s">"Form-encoded method must contain at least one @Field."</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">isMultipart</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gotPart</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="s">"Multipart method must contain at least one @Part."</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//创建RequestFactory</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">RequestFactory</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="parsemethodannotation">parseMethodAnnotation()</h3><p><code class="language-plaintext highlighter-rouge">parseMethodAnnotation()</code>负责解析方法上的注解。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseMethodAnnotation</span><span class="o">(</span><span class="nc">Annotation</span> <span class="n">annotation</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="no">DELETE</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parseHttpMethodAndPath</span><span class="o">(</span><span class="s">"DELETE"</span><span class="o">,</span> <span class="o">((</span><span class="no">DELETE</span><span class="o">)</span> <span class="n">annotation</span><span class="o">).</span><span class="na">value</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="no">GET</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parseHttpMethodAndPath</span><span class="o">(</span><span class="s">"GET"</span><span class="o">,</span> <span class="o">((</span><span class="no">GET</span><span class="o">)</span> <span class="n">annotation</span><span class="o">).</span><span class="na">value</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="no">HEAD</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parseHttpMethodAndPath</span><span class="o">(</span><span class="s">"HEAD"</span><span class="o">,</span> <span class="o">((</span><span class="no">HEAD</span><span class="o">)</span> <span class="n">annotation</span><span class="o">).</span><span class="na">value</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">Void</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">responseType</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="s">"HEAD method must use Void as response type."</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="no">PATCH</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parseHttpMethodAndPath</span><span class="o">(</span><span class="s">"PATCH"</span><span class="o">,</span> <span class="o">((</span><span class="no">PATCH</span><span class="o">)</span> <span class="n">annotation</span><span class="o">).</span><span class="na">value</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="no">POST</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parseHttpMethodAndPath</span><span class="o">(</span><span class="s">"POST"</span><span class="o">,</span> <span class="o">((</span><span class="no">POST</span><span class="o">)</span> <span class="n">annotation</span><span class="o">).</span><span class="na">value</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="no">PUT</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parseHttpMethodAndPath</span><span class="o">(</span><span class="s">"PUT"</span><span class="o">,</span> <span class="o">((</span><span class="no">PUT</span><span class="o">)</span> <span class="n">annotation</span><span class="o">).</span><span class="na">value</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="no">OPTIONS</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parseHttpMethodAndPath</span><span class="o">(</span><span class="s">"OPTIONS"</span><span class="o">,</span> <span class="o">((</span><span class="no">OPTIONS</span><span class="o">)</span> <span class="n">annotation</span><span class="o">).</span><span class="na">value</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="no">HTTP</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">HTTP</span> <span class="n">http</span> <span class="o">=</span> <span class="o">(</span><span class="no">HTTP</span><span class="o">)</span> <span class="n">annotation</span><span class="o">;</span>
    <span class="n">parseHttpMethodAndPath</span><span class="o">(</span><span class="n">http</span><span class="o">.</span><span class="na">method</span><span class="o">(),</span> <span class="n">http</span><span class="o">.</span><span class="na">path</span><span class="o">(),</span> <span class="n">http</span><span class="o">.</span><span class="na">hasBody</span><span class="o">());</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="n">retrofit2</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">Headers</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">headersToParse</span> <span class="o">=</span> <span class="o">((</span><span class="n">retrofit2</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">Headers</span><span class="o">)</span> <span class="n">annotation</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">headersToParse</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="s">"@Headers annotation is empty."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//解析请求头</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">parseHeaders</span><span class="o">(</span><span class="n">headersToParse</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="nc">Multipart</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isFormEncoded</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="s">"Only one encoding annotation is allowed."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">isMultipart</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="nc">FormUrlEncoded</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isMultipart</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span><span class="s">"Only one encoding annotation is allowed."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">isFormEncoded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="parsehttpmethodandpath">parseHttpMethodAndPath()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseHttpMethodAndPath</span><span class="o">(</span><span class="nc">String</span> <span class="n">httpMethod</span><span class="o">,</span> <span class="nc">String</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">hasBody</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//如果httpMethod不为null 直接抛出异常</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">httpMethod</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span>
        <span class="n">method</span><span class="o">,</span>
        <span class="s">"Only one HTTP method is allowed. Found: %s and %s."</span><span class="o">,</span>
        <span class="k">this</span><span class="o">.</span><span class="na">httpMethod</span><span class="o">,</span>
        <span class="n">httpMethod</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">this</span><span class="o">.</span><span class="na">httpMethod</span> <span class="o">=</span> <span class="n">httpMethod</span><span class="o">;</span> <span class="c1">//赋值</span>
  <span class="k">this</span><span class="o">.</span><span class="na">hasBody</span> <span class="o">=</span> <span class="n">hasBody</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">//注解内值为空直接返回</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// Get the relative URL path and existing query string, if present.</span>
  <span class="kt">int</span> <span class="n">question</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">'?'</span><span class="o">);</span>
  <span class="c1">//url中包含? 并且?不是最后一位</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">question</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">question</span> <span class="o">&lt;</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Ensure the query string does not have any named parameters.</span>
    <span class="nc">String</span> <span class="n">queryParams</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">question</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="nc">Matcher</span> <span class="n">queryParamMatcher</span> <span class="o">=</span> <span class="no">PARAM_URL_REGEX</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">queryParams</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">queryParamMatcher</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="nf">methodError</span><span class="o">(</span>
          <span class="n">method</span><span class="o">,</span>
          <span class="s">"URL query string \"%s\" must not have replace block. "</span>
              <span class="o">+</span> <span class="s">"For dynamic query parameters use @Query."</span><span class="o">,</span>
          <span class="n">queryParams</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">//获取url</span>
  <span class="k">this</span><span class="o">.</span><span class="na">relativeUrl</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
  <span class="c1">//解析url中的参数</span>
  <span class="k">this</span><span class="o">.</span><span class="na">relativeUrlParamNames</span> <span class="o">=</span> <span class="n">parsePathParameters</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="parseparameter">parseParameter()</h3><p><code class="language-plaintext highlighter-rouge">parseParameter()</code>负责解析参数。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nd">@Nullable</span> <span class="nc">ParameterHandler</span><span class="o">&lt;?&gt;</span> <span class="n">parseParameter</span><span class="o">(</span>
    <span class="kt">int</span> <span class="n">p</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">parameterType</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowContinuation</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">ParameterHandler</span><span class="o">&lt;?&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">annotations</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Annotation</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//解析参数上的注解</span>
      <span class="nc">ParameterHandler</span><span class="o">&lt;?&gt;</span> <span class="n">annotationAction</span> <span class="o">=</span>
          <span class="n">parseParameterAnnotation</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">parameterType</span><span class="o">,</span> <span class="n">annotations</span><span class="o">,</span> <span class="n">annotation</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">annotationAction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">continue</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="nf">parameterError</span><span class="o">(</span>
            <span class="n">method</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="s">"Multiple Retrofit annotations found, only one allowed."</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">annotationAction</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">allowContinuation</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Utils</span><span class="o">.</span><span class="na">getRawType</span><span class="o">(</span><span class="n">parameterType</span><span class="o">)</span> <span class="o">==</span> <span class="nc">Continuation</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">isKotlinSuspendFunction</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoClassDefFoundError</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">throw</span> <span class="nf">parameterError</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="s">"No Retrofit annotation found."</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="parseparameterannotation">parseParameterAnnotation()</h3><p><code class="language-plaintext highlighter-rouge">parseParameterAnnotation()</code>比较长，总体的解析操作都大同小异，我这里只解析<code class="language-plaintext highlighter-rouge">@Query</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">ParameterHandler</span><span class="o">&lt;?&gt;</span> <span class="n">parseParameterAnnotation</span><span class="o">(</span>
        <span class="kt">int</span> <span class="n">p</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">,</span> <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="o">,</span> <span class="nc">Annotation</span> <span class="n">annotation</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="nc">Query</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//校验</span>
    <span class="n">validateResolvableType</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
    <span class="c1">//获取注解</span>
    <span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Query</span><span class="o">)</span> <span class="n">annotation</span><span class="o">;</span>
    <span class="c1">//获取注解的值</span>
    <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
    <span class="c1">//是否编码</span>
    <span class="kt">boolean</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">encoded</span><span class="o">();</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rawParameterType</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">getRawType</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="n">gotQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Iterable</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">rawParameterType</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">type</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="nf">parameterError</span><span class="o">(</span>
            <span class="n">method</span><span class="o">,</span>
            <span class="n">p</span><span class="o">,</span>
            <span class="n">rawParameterType</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span>
                <span class="o">+</span> <span class="s">" must include generic type (e.g., "</span>
                <span class="o">+</span> <span class="n">rawParameterType</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span>
                <span class="o">+</span> <span class="s">"&lt;String&gt;)"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nc">ParameterizedType</span> <span class="n">parameterizedType</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ParameterizedType</span><span class="o">)</span> <span class="n">type</span><span class="o">;</span>
      <span class="nc">Type</span> <span class="n">iterableType</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">getParameterUpperBound</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">parameterizedType</span><span class="o">);</span>
      <span class="c1">//获取Converter</span>
      <span class="nc">Converter</span><span class="o">&lt;?,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">converter</span> <span class="o">=</span> <span class="n">retrofit</span><span class="o">.</span><span class="na">stringConverter</span><span class="o">(</span><span class="n">iterableType</span><span class="o">,</span> <span class="n">annotations</span><span class="o">);</span>
      <span class="c1">//创建ParameterHandler 并调用iterable()方法</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">ParameterHandler</span><span class="o">.</span><span class="na">Query</span><span class="o">&lt;&gt;(</span><span class="n">name</span><span class="o">,</span> <span class="n">converter</span><span class="o">,</span> <span class="n">encoded</span><span class="o">).</span><span class="na">iterable</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">rawParameterType</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">arrayComponentType</span> <span class="o">=</span> <span class="n">boxIfPrimitive</span><span class="o">(</span><span class="n">rawParameterType</span><span class="o">.</span><span class="na">getComponentType</span><span class="o">());</span>
      <span class="nc">Converter</span><span class="o">&lt;?,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">converter</span> <span class="o">=</span>
          <span class="n">retrofit</span><span class="o">.</span><span class="na">stringConverter</span><span class="o">(</span><span class="n">arrayComponentType</span><span class="o">,</span> <span class="n">annotations</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">ParameterHandler</span><span class="o">.</span><span class="na">Query</span><span class="o">&lt;&gt;(</span><span class="n">name</span><span class="o">,</span> <span class="n">converter</span><span class="o">,</span> <span class="n">encoded</span><span class="o">).</span><span class="na">array</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">Converter</span><span class="o">&lt;?,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">converter</span> <span class="o">=</span> <span class="n">retrofit</span><span class="o">.</span><span class="na">stringConverter</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">annotations</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">ParameterHandler</span><span class="o">.</span><span class="na">Query</span><span class="o">&lt;&gt;(</span><span class="n">name</span><span class="o">,</span> <span class="n">converter</span><span class="o">,</span> <span class="n">encoded</span><span class="o">);</span>
    <span class="o">}</span>
 <span class="o">}</span>
<span class="o">}</span>
 
</pre></table></code></div></div><h3 id="parameterhandler">ParameterHandler</h3><p><code class="language-plaintext highlighter-rouge">ParameterHandler</code>是一个抽象类，有多个子类。<code class="language-plaintext highlighter-rouge">ParameterHandler</code>包含三个方法<code class="language-plaintext highlighter-rouge">iterable()</code>和<code class="language-plaintext highlighter-rouge">apply()</code>和<code class="language-plaintext highlighter-rouge">array()</code>。<code class="language-plaintext highlighter-rouge">apply()</code>方法是一个抽象方法，具体的实现在其子类中。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="nc">RequestBuilder</span> <span class="n">builder</span><span class="o">,</span> <span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

  <span class="kd">final</span> <span class="nc">ParameterHandler</span><span class="o">&lt;</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="nf">iterable</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">ParameterHandler</span><span class="o">&lt;</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
      <span class="nd">@Override</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="nc">RequestBuilder</span> <span class="n">builder</span><span class="o">,</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">values</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">values</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// Skip null values.</span>

        <span class="k">for</span> <span class="o">(</span><span class="no">T</span> <span class="n">value</span> <span class="o">:</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">ParameterHandler</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">builder</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">};</span>
  <span class="o">}</span>

  <span class="kd">final</span> <span class="nc">ParameterHandler</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">array</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">ParameterHandler</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@Override</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="nc">RequestBuilder</span> <span class="n">builder</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">values</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">values</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// Skip null values.</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nc">Array</span><span class="o">.</span><span class="na">getLength</span><span class="o">(</span><span class="n">values</span><span class="o">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="c1">//noinspection unchecked</span>
          <span class="nc">ParameterHandler</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">builder</span><span class="o">,</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="nc">Array</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">values</span><span class="o">,</span> <span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">};</span>
  <span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">apply()</code>的实现：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Query</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">ParameterHandler</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Converter</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">valueConverter</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">encoded</span><span class="o">;</span>
  <span class="nc">Query</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Converter</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">valueConverter</span><span class="o">,</span> <span class="kt">boolean</span> 
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"name == null"</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">valueConverter</span> <span class="o">=</span> <span class="n">valueConverter</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">encoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="nc">RequestBuilder</span> <span class="n">builder</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="no">IOE</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// Skip null values.</span>
    <span class="nc">String</span> <span class="n">queryValue</span> <span class="o">=</span> <span class="n">valueConverter</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">queryValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// Skip converted but null val</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addQueryParam</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">queryValue</span><span class="o">,</span> <span class="n">encoded</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="create-1">create()</h3><p><code class="language-plaintext highlighter-rouge">RequestFactory</code>的<code class="language-plaintext highlighter-rouge">create()</code>方法会遍历<code class="language-plaintext highlighter-rouge">ParameterHandler</code>数组，构建<code class="language-plaintext highlighter-rouge">Request</code>。该方法会被<code class="language-plaintext highlighter-rouge">OKHttpCall</code>调用。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="n">okhttp3</span><span class="o">.</span><span class="na">Request</span> <span class="nf">create</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="c1">// It is an error to invoke a method with the wrong arg types.</span>
  <span class="nc">ParameterHandler</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;[]</span> <span class="n">handlers</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ParameterHandler</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;[])</span> <span class="n">parameterHandlers</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">argumentCount</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">argumentCount</span> <span class="o">!=</span> <span class="n">handlers</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
        <span class="s">"Argument count ("</span>
            <span class="o">+</span> <span class="n">argumentCount</span>
            <span class="o">+</span> <span class="s">") doesn't match expected count ("</span>
            <span class="o">+</span> <span class="n">handlers</span><span class="o">.</span><span class="na">length</span>
            <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nc">RequestBuilder</span> <span class="n">requestBuilder</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">RequestBuilder</span><span class="o">(</span>
          <span class="n">httpMethod</span><span class="o">,</span>
          <span class="n">baseUrl</span><span class="o">,</span>
          <span class="n">relativeUrl</span><span class="o">,</span>
          <span class="n">headers</span><span class="o">,</span>
          <span class="n">contentType</span><span class="o">,</span>
          <span class="n">hasBody</span><span class="o">,</span>
          <span class="n">isFormEncoded</span><span class="o">,</span>
          <span class="n">isMultipart</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">isKotlinSuspendFunction</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// The Continuation is the last parameter and the handlers array contains null at that index.</span>
    <span class="n">argumentCount</span><span class="o">--;</span>
  <span class="o">}</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">argumentList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">argumentCount</span><span class="o">);</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">argumentCount</span><span class="o">;</span> <span class="n">p</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">argumentList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="n">p</span><span class="o">]);</span>
    <span class="n">handlers</span><span class="o">[</span><span class="n">p</span><span class="o">].</span><span class="na">apply</span><span class="o">(</span><span class="n">requestBuilder</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">p</span><span class="o">]);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">requestBuilder</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">tag</span><span class="o">(</span><span class="nc">Invocation</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Invocation</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">argumentList</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="okhttpcall">OkHttpCall</h2><p><code class="language-plaintext highlighter-rouge">OkHttpCall</code>继承自<code class="language-plaintext highlighter-rouge">Call</code>。<code class="language-plaintext highlighter-rouge">Call</code>是一个接口，提供了如下方法：</p><div class="table-wrapper"><table><thead><tr><th>方法名<th>方法说明<tbody><tr><td><code class="language-plaintext highlighter-rouge">Response&lt;T&gt; execute();</code><td>执行异步请求<tr><td><code class="language-plaintext highlighter-rouge">void enqueue(Callback&lt;T&gt; callback);</code><td>执行同步请求<tr><td><code class="language-plaintext highlighter-rouge">void cancel();</code><td>取消请求</table></div><h3 id="构造函数">构造函数</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nc">OkHttpCall</span><span class="o">(</span>
    <span class="nc">RequestFactory</span> <span class="n">requestFactory</span><span class="o">,</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span><span class="c1">//接口中定义的参数</span>
    <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span><span class="o">.</span><span class="na">Factory</span> <span class="n">callFactory</span><span class="o">,</span>
    <span class="nc">Converter</span><span class="o">&lt;</span><span class="nc">ResponseBody</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">responseConverter</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">requestFactory</span> <span class="o">=</span> <span class="n">requestFactory</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">callFactory</span> <span class="o">=</span> <span class="n">callFactory</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">responseConverter</span> <span class="o">=</span> <span class="n">responseConverter</span><span class="o">;</span><span class="c1">//转换器</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="execute">execute()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span> <span class="n">call</span><span class="o">;</span>
  <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">executed</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">"Already executed."</span><span class="o">);</span>
    <span class="n">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">getRawCall</span><span class="o">();</span><span class="c1">//获取okhttp3.Call</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">canceled</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">call</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="c1">//解析返回值</span>
  <span class="k">return</span> <span class="nf">parseResponse</span><span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">execute</span><span class="o">());</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="getrawcall">getRawCall()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span> <span class="nf">getRawCall</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span> <span class="n">call</span> <span class="o">=</span> <span class="n">rawCall</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">call</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">call</span><span class="o">;</span>
  <span class="c1">// Re-throw previous failures if this isn't the first attempt.</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">creationFailure</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">creationFailure</span> <span class="k">instanceof</span> <span class="nc">IOException</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="o">(</span><span class="nc">IOException</span><span class="o">)</span> <span class="n">creationFailure</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">creationFailure</span> <span class="k">instanceof</span> <span class="nc">RuntimeException</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="o">(</span><span class="nc">RuntimeException</span><span class="o">)</span> <span class="n">creationFailure</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="o">(</span><span class="nc">Error</span><span class="o">)</span> <span class="n">creationFailure</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">// Create and remember either the success or the failure.</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">rawCall</span> <span class="o">=</span> <span class="n">createRawCall</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="o">|</span> <span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">throwIfFatal</span><span class="o">(</span><span class="n">e</span><span class="o">);</span> <span class="c1">// Do not assign a fatal error to creationFailure.</span>
    <span class="n">creationFailure</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="createrawcall">createRawCall()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span> <span class="nf">createRawCall</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="c1">//调用RequestFactory的create方法创建Request</span>
  <span class="c1">//调用CallFactory的newCall方法创建okhttp3.Call</span>
  <span class="n">okhttp3</span><span class="o">.</span><span class="na">Call</span> <span class="n">call</span> <span class="o">=</span> <span class="n">callFactory</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">requestFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">call</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">"Call.Factory returned null."</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">call</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="parseresponse">parseResponse()</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">parseResponse</span><span class="o">(</span><span class="n">okhttp3</span><span class="o">.</span><span class="na">Response</span> <span class="n">rawResponse</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="nc">ResponseBody</span> <span class="n">rawBody</span> <span class="o">=</span> <span class="n">rawResponse</span><span class="o">.</span><span class="na">body</span><span class="o">();</span>
  <span class="c1">// Remove the body's source (the only stateful object) so we can pass the response along.</span>
  <span class="n">rawResponse</span> <span class="o">=</span>
      <span class="n">rawResponse</span>
          <span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
          <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="k">new</span> <span class="nc">NoContentResponseBody</span><span class="o">(</span><span class="n">rawBody</span><span class="o">.</span><span class="na">contentType</span><span class="o">(),</span> <span class="n">rawBody</span><span class="o">.</span><span class="na">contentLength</span><span class="o">()))</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">rawResponse</span><span class="o">.</span><span class="na">code</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span> <span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">300</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// Buffer the entire body to avoid future I/O.</span>
      <span class="nc">ResponseBody</span> <span class="n">bufferedBody</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="n">rawBody</span><span class="o">);</span>
      <span class="k">return</span> <span class="nc">Response</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">bufferedBody</span><span class="o">,</span> <span class="n">rawResponse</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">rawBody</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">204</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">205</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">rawBody</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="k">return</span> <span class="nc">Response</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">rawResponse</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nc">ExceptionCatchingResponseBody</span> <span class="n">catchingBody</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExceptionCatchingResponseBody</span><span class="o">(</span><span class="n">rawBody</span><span class="o">);</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="no">T</span> <span class="n">body</span> <span class="o">=</span> <span class="n">responseConverter</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">catchingBody</span><span class="o">);</span> <span class="c1">//调用converter的convert方法解析json</span>
    <span class="k">return</span> <span class="nc">Response</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="n">rawResponse</span><span class="o">);</span> <span class="c1">//解析的body赋值给Response的Body</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// If the underlying source threw an exception, propagate that rather than indicating it was</span>
    <span class="c1">// a runtime exception.</span>
    <span class="n">catchingBody</span><span class="o">.</span><span class="na">throwIfCaught</span><span class="o">();</span>
    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="calladapter">CallAdapter</h2><p>RxJavaCallAdapterFactory</p><p>Single类和Observable对象类似，只不过Single只能发送单个值，并且Single只能发出一个错误或成功的值，不能发送onComplete通知。</p><p>Single的just方法。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Single</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">just</span><span class="o">(</span><span class="kd">final</span> <span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">ScalarSynchronousSingle</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nc">Single</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nc">Single</span><span class="o">.</span><span class="na">OnSubscribe</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="nc">SingleSubscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">singleSubscriber</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//SingleSubscriber没有onComplete方法</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></table></code></div></div><p>Completable也和Observable类似，但是Completable不发送值，值发送错误和完成。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nc">Completable</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nc">Completable</span><span class="o">.</span><span class="na">CompletableOnSubscribe</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="nc">Completable</span><span class="o">.</span><span class="na">CompletableSubscriber</span> <span class="n">completableSubscriber</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//CompletableSubscriber 没有onNext方法</span>
    <span class="o">}</span>
<span class="o">});</span>
</pre></table></code></div></div><p>当我们的请求不需要处理返回值的时候我们可以让该请求返回Completable。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RxJavaCallAdapterFactory</span> <span class="kd">extends</span> <span class="nc">CallAdapter</span><span class="o">.</span><span class="na">Factory</span> <span class="o">{</span>
  <span class="cm">/**
   * Returns an instance which creates synchronous observables that do not operate on any scheduler
   * by default.
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">RxJavaCallAdapterFactory</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">RxJavaCallAdapterFactory</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Returns an instance which creates synchronous observables that
   * {@linkplain Observable#subscribeOn(Scheduler) subscribe on} {@code scheduler} by default.
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">RxJavaCallAdapterFactory</span> <span class="nf">createWithScheduler</span><span class="o">(</span><span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">scheduler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">(</span><span class="s">"scheduler == null"</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">RxJavaCallAdapterFactory</span><span class="o">(</span><span class="n">scheduler</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nf">RxJavaCallAdapterFactory</span><span class="o">(</span><span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">CallAdapter</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">get</span><span class="o">(</span><span class="nc">Type</span> <span class="n">returnType</span><span class="o">,</span> <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span><span class="o">,</span> <span class="nc">Retrofit</span> <span class="n">retrofit</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rawType</span> <span class="o">=</span> <span class="n">getRawType</span><span class="o">(</span><span class="n">returnType</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">isSingle</span> <span class="o">=</span> <span class="n">rawType</span> <span class="o">==</span> <span class="nc">Single</span><span class="o">.</span><span class="na">class</span><span class="o">;</span><span class="c1">//判断返回值是否是Single.class</span>
    <span class="kt">boolean</span> <span class="n">isCompletable</span> <span class="o">=</span> <span class="s">"rx.Completable"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">rawType</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rawType</span> <span class="o">!=</span> <span class="nc">Observable</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isSingle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isCompletable</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isCompletable</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">RxJavaCallAdapter</span><span class="o">(</span><span class="nc">Void</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">scheduler</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="n">isResult</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">isBody</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Type</span> <span class="n">responseType</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!(</span><span class="n">returnType</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">isSingle</span> <span class="o">?</span> <span class="s">"Single"</span> <span class="o">:</span> <span class="s">"Observable"</span><span class="o">;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" return type must be parameterized"</span>
          <span class="o">+</span> <span class="s">" as "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"&lt;Foo&gt; or "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"&lt;? extends Foo&gt;"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">Type</span> <span class="n">observableType</span> <span class="o">=</span> <span class="n">getParameterUpperBound</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="nc">ParameterizedType</span><span class="o">)</span> <span class="n">returnType</span><span class="o">);</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rawObservableType</span> <span class="o">=</span> <span class="n">getRawType</span><span class="o">(</span><span class="n">observableType</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rawObservableType</span> <span class="o">==</span> <span class="nc">Response</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">observableType</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Response must be parameterized"</span>
            <span class="o">+</span> <span class="s">" as Response&lt;Foo&gt; or Response&lt;? extends Foo&gt;"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">responseType</span> <span class="o">=</span> <span class="n">getParameterUpperBound</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="nc">ParameterizedType</span><span class="o">)</span> <span class="n">observableType</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">rawObservableType</span> <span class="o">==</span> <span class="nc">Result</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">observableType</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Result must be parameterized"</span>
            <span class="o">+</span> <span class="s">" as Result&lt;Foo&gt; or Result&lt;? extends Foo&gt;"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">responseType</span> <span class="o">=</span> <span class="n">getParameterUpperBound</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="nc">ParameterizedType</span><span class="o">)</span> <span class="n">observableType</span><span class="o">);</span>
      <span class="n">isResult</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">responseType</span> <span class="o">=</span> <span class="n">observableType</span><span class="o">;</span>
      <span class="n">isBody</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">RxJavaCallAdapter</span><span class="o">(</span><span class="n">responseType</span><span class="o">,</span> <span class="n">scheduler</span><span class="o">,</span> <span class="n">isResult</span><span class="o">,</span> <span class="n">isBody</span><span class="o">,</span> <span class="n">isSingle</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>RxJavaCallAdapter的adapt方法</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre> <span class="nd">@Override</span> <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">adapt</span><span class="o">(</span><span class="nc">Call</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">OnSubscribe</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;&gt;</span> <span class="n">callFunc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CallOnSubscribe</span><span class="o">&lt;&gt;(</span><span class="n">call</span><span class="o">);</span><span class="c1">//创建CallOnSubscribe</span>

    <span class="c1">//获取OnSubscribe对象</span>
    <span class="nc">OnSubscribe</span><span class="o">&lt;?&gt;</span> <span class="n">func</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isResult</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">func</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ResultOnSubscribe</span><span class="o">&lt;&gt;(</span><span class="n">callFunc</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isBody</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">func</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BodyOnSubscribe</span><span class="o">&lt;&gt;(</span><span class="n">callFunc</span><span class="o">);</span>

    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">func</span> <span class="o">=</span> <span class="n">callFunc</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Observable</span><span class="o">&lt;?&gt;</span> <span class="n">observable</span> <span class="o">=</span> <span class="nc">Observable</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">func</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">scheduler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">observable</span> <span class="o">=</span> <span class="n">observable</span><span class="o">.</span><span class="na">subscribeOn</span><span class="o">(</span><span class="n">scheduler</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isSingle</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">observable</span><span class="o">.</span><span class="na">toSingle</span><span class="o">();</span><span class="c1">//Observable转换为Single</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isCompletable</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">CompletableHelper</span><span class="o">.</span><span class="na">toCompletable</span><span class="o">(</span><span class="n">observable</span><span class="o">);</span><span class="c1">//Observable转换为Completable</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">observable</span><span class="o">;</span>
  <span class="o">}</span>
</pre></table></code></div></div><p>CallOnSubscribe</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">CallOnSubscribe</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">OnSubscribe</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Call</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">originalCall</span><span class="o">;</span>

  <span class="nc">CallOnSubscribe</span><span class="o">(</span><span class="nc">Call</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">originalCall</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">originalCall</span> <span class="o">=</span> <span class="n">originalCall</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="nc">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Since Call is a one-shot type, clone it for each new subscriber.</span>
    <span class="nc">Call</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">call</span> <span class="o">=</span> <span class="n">originalCall</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span><span class="c1">//clone 了原来的 call，因为 okhttp3.Call 是只能用一次的，所以每次都是新 clone 一个进行网络请求；</span>
    <span class="nc">CallArbiter</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">arbiter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CallArbiter</span><span class="o">&lt;&gt;(</span><span class="n">call</span><span class="o">,</span> <span class="n">subscriber</span><span class="o">);</span>
    <span class="n">subscriber</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">arbiter</span><span class="o">);</span>
    <span class="n">subscriber</span><span class="o">.</span><span class="na">setProducer</span><span class="o">(</span><span class="n">arbiter</span><span class="o">);</span><span class="c1">//调用producer的request方法</span>
    <span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">response</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span><span class="c1">//调用OkHttpCall的execute()方法返回Response</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Exceptions</span><span class="o">.</span><span class="na">throwIfFatal</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
      <span class="n">arbiter</span><span class="o">.</span><span class="na">emitError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span><span class="c1">//发送错误</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">arbiter</span><span class="o">.</span><span class="na">emitResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span><span class="c1">//发送response</span>
  <span class="o">}</span>

  <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CallArbiter</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AtomicInteger</span> <span class="kd">implements</span> <span class="nc">Subscription</span><span class="o">,</span> <span class="nc">Producer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">STATE_WAITING</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">STATE_REQUESTED</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">STATE_HAS_RESPONSE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">STATE_TERMINATED</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Call</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">call</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">subscriber</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">response</span><span class="o">;</span>

    <span class="nc">CallArbiter</span><span class="o">(</span><span class="nc">Call</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">call</span><span class="o">,</span> <span class="nc">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="no">STATE_WAITING</span><span class="o">);</span>

      <span class="k">this</span><span class="o">.</span><span class="na">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">subscriber</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unsubscribe</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">call</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isUnsubscribed</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">call</span><span class="o">.</span><span class="na">isCanceled</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">request</span><span class="o">(</span><span class="kt">long</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">get</span><span class="o">();</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nl">STATE_WAITING:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSet</span><span class="o">(</span><span class="no">STATE_WAITING</span><span class="o">,</span> <span class="no">STATE_REQUESTED</span><span class="o">))</span> <span class="o">{</span>
              <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span> <span class="c1">// State transition failed. Try again.</span>

          <span class="k">case</span> <span class="nl">STATE_HAS_RESPONSE:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSet</span><span class="o">(</span><span class="no">STATE_HAS_RESPONSE</span><span class="o">,</span> <span class="no">STATE_TERMINATED</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">deliverResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
              <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span> <span class="c1">// State transition failed. Try again.</span>

          <span class="k">case</span> <span class="nl">STATE_REQUESTED:</span>
          <span class="k">case</span> <span class="nl">STATE_TERMINATED:</span>
            <span class="k">return</span><span class="o">;</span> <span class="c1">// Nothing to do.</span>

          <span class="k">default</span><span class="o">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unknown state: "</span> <span class="o">+</span> <span class="n">state</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">emitResponse</span><span class="o">(</span><span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">get</span><span class="o">();</span><span class="c1">//获取当前值</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nl">STATE_WAITING:</span>
            <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSet</span><span class="o">(</span><span class="no">STATE_WAITING</span><span class="o">,</span> <span class="no">STATE_HAS_RESPONSE</span><span class="o">))</span> <span class="o">{</span><span class="c1">//如果当前值==STATE_WAITING,设置值为STATE_HAS_RESPONSE</span>
              <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span> <span class="c1">//状态改变失败重试</span>

          <span class="k">case</span> <span class="nl">STATE_REQUESTED:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSet</span><span class="o">(</span><span class="no">STATE_REQUESTED</span><span class="o">,</span> <span class="no">STATE_TERMINATED</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">deliverResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
              <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span> <span class="c1">// State transition failed. Try again.</span>

          <span class="k">case</span> <span class="nl">STATE_HAS_RESPONSE:</span>
          <span class="k">case</span> <span class="nl">STATE_TERMINATED:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">AssertionError</span><span class="o">();</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unknown state: "</span> <span class="o">+</span> <span class="n">state</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">deliverResponse</span><span class="o">(</span><span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isUnsubscribed</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">subscriber</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Exceptions</span><span class="o">.</span><span class="na">throwIfFatal</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">subscriber</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">inner</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Exceptions</span><span class="o">.</span><span class="na">throwIfFatal</span><span class="o">(</span><span class="n">inner</span><span class="o">);</span>
          <span class="nc">CompositeException</span> <span class="n">composite</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CompositeException</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">inner</span><span class="o">);</span>
          <span class="nc">RxJavaPlugins</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getErrorHandler</span><span class="o">().</span><span class="na">handleError</span><span class="o">(</span><span class="n">composite</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span><span class="c1">//发送完成</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Exceptions</span><span class="o">.</span><span class="na">throwIfFatal</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="nc">RxJavaPlugins</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getErrorHandler</span><span class="o">().</span><span class="na">handleError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">emitError</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">set</span><span class="o">(</span><span class="no">STATE_TERMINATED</span><span class="o">);</span>

      <span class="k">if</span> <span class="o">(!</span><span class="n">isUnsubscribed</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">subscriber</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">inner</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Exceptions</span><span class="o">.</span><span class="na">throwIfFatal</span><span class="o">(</span><span class="n">inner</span><span class="o">);</span>
          <span class="nc">CompositeException</span> <span class="n">composite</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CompositeException</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">inner</span><span class="o">);</span>
          <span class="nc">RxJavaPlugins</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getErrorHandler</span><span class="o">().</span><span class="na">handleError</span><span class="o">(</span><span class="n">composite</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>BodyOnSubscribe</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">BodyOnSubscribe</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">OnSubscribe</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">OnSubscribe</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">upstream</span><span class="o">;</span>

  <span class="nc">BodyOnSubscribe</span><span class="o">(</span><span class="nc">OnSubscribe</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">upstream</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">upstream</span> <span class="o">=</span> <span class="n">upstream</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="nc">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">upstream</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="k">new</span> <span class="nc">BodySubscriber</span><span class="o">&lt;&gt;(</span><span class="n">subscriber</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BodySubscriber</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="nc">Response</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">R</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="o">;</span>
    <span class="cm">/** Indicates whether a terminal event has been sent to {@link #subscriber}. */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">subscriberTerminated</span><span class="o">;</span>

    <span class="nc">BodySubscriber</span><span class="o">(</span><span class="nc">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">R</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">subscriber</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">subscriber</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="nc">Response</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">isSuccessful</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">());</span><span class="c1">//获取response的body</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">subscriberTerminated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="nc">Throwable</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpException</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">subscriber</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">inner</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Exceptions</span><span class="o">.</span><span class="na">throwIfFatal</span><span class="o">(</span><span class="n">inner</span><span class="o">);</span>
          <span class="nc">CompositeException</span> <span class="n">composite</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CompositeException</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">inner</span><span class="o">);</span>
          <span class="nc">RxJavaPlugins</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getErrorHandler</span><span class="o">().</span><span class="na">handleError</span><span class="o">(</span><span class="n">composite</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">subscriberTerminated</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">throwable</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// This should never happen! onNext handles and forwards errors automatically.</span>
        <span class="nc">Throwable</span> <span class="n">broken</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AssertionError</span><span class="o">(</span>
            <span class="s">"This should never happen! Report as a Retrofit bug with the full stacktrace."</span><span class="o">);</span>
        <span class="c1">//noinspection UnnecessaryInitCause Two-arg AssertionError constructor is 1.7+ only.</span>
        <span class="n">broken</span><span class="o">.</span><span class="na">initCause</span><span class="o">(</span><span class="n">throwable</span><span class="o">);</span>
        <span class="nc">RxJavaPlugins</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getErrorHandler</span><span class="o">().</span><span class="na">handleError</span><span class="o">(</span><span class="n">broken</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">subscriberTerminated</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="更多阅读">更多阅读</h2><ul><li><p><a href="https://square.github.io/retrofit/">官方文档</a></p><li><p><a href="http://blog.piasy.com/2016/06/25/Understand-Retrofit/">拆轮子系列：拆 Retrofit</a></p><li><p><a href="https://www.jianshu.com/p/45cb536be2f4">Retrofit分析-漂亮的解耦套路</a></p><li><p><a href="https://www.jianshu.com/p/fb8d21978e38">Retrofit分析-经典设计模式案例</a></p></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-tag no-text-decoration" >源码分析</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Retrofit源码分析 - malinkang&url=https://malinkang.cn/posts/retrofit-source-analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Retrofit源码分析 - malinkang&u=https://malinkang.cn/posts/retrofit-source-analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Retrofit源码分析 - malinkang&url=https://malinkang.cn/posts/retrofit-source-analysis/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dagger-guide/">Dagger使用指南</a><li><a href="/posts/understanding-the-jvm-runtime-data-areas/">《深入理解JVM》第2章Java内存区域与内存溢出异常</a><li><a href="/posts/understanding-the-jvm-garbage-collection/">《深入理解JVM》第3章垃圾收集器</a><li><a href="/posts/understanding-the-jvm-class-file-structure/">《深入理解JVM》第6章类文件结构</a><li><a href="/posts/understanding-the-jvm-class-loader/">《深入理解JVM》第7章虚拟机类加载机制</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/arouter-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 24, 2020 <i class="unloaded">2020-11-24T19:14:29+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ARouter源码分析</h3><div class="text-muted small"><p> ARouter原理如下 编译期，会扫描@Route注解，将注解里的信息封装成一个RouteMeta对象。并生成一个辅助类ARouter$$Group$$groupName，groupName即分组的名字，这也意味着同一个group只会生成一个辅助类。该类继承自IRouteGroup，有一个loadInto()方法。在运行时，调用loadInto()方法，将@Route中的path作为k...</p></div></div></a></div><div class="card"> <a href="/posts/okhttp-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 26, 2020 <i class="unloaded">2020-11-26T04:01:47+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Okhttp源码分析</h3><div class="text-muted small"><p> Okhttp基本流程分析 基本流程 创建RequestBody 创建Request 创建OkhttpClient 调用newCall创建Call对象 执行异步或同步操作。 创建Socket连接 发送请求并处理返回结果 创建RequestBody RequestBody主要通过writeTo方法将请求内容写入到BufferedSink。RequestBo...</p></div></div></a></div><div class="card"> <a href="/posts/okio-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 26, 2020 <i class="unloaded">2020-11-26T04:07:14+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Okio源码分析</h3><div class="text-muted small"><p></p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/generated-binding-classes/" class="btn btn-outline-primary" prompt="Older"><p>生成绑定类</p></a> <a href="/posts/kotlin-lambda-md/" class="btn btn-outline-primary" prompt="Newer"><p>Kotlin 高阶函数和lambda表达式</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//malinkang-cn.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Retrofit源码分析'; this.page.url = 'https://malinkang.cn/posts/retrofit-source-analysis/'; this.page.identifier = '/posts/retrofit-source-analysis/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/malinkang">malinkang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://malinkang.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
