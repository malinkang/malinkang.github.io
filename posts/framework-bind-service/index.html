<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="bindService流程分析" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="ContextWrapper" /><meta property="og:description" content="ContextWrapper" /><link rel="canonical" href="https://malinkang.cn/posts/framework-bind-service/" /><meta property="og:url" content="https://malinkang.cn/posts/framework-bind-service/" /><meta property="og:site_name" content="malinkang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-01T03:18:41+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="bindService流程分析" /><meta name="twitter:site" content="@malinkang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"ContextWrapper","headline":"bindService流程分析","dateModified":"2020-03-01T03:18:41+08:00","url":"https://malinkang.cn/posts/framework-bind-service/","datePublished":"2020-03-01T03:18:41+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://malinkang.cn/posts/framework-bind-service/"},"@context":"https://schema.org"}</script><title>bindService流程分析 | malinkang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="malinkang"><meta name="application-name" content="malinkang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">malinkang</a></div><div class="site-subtitle font-italic">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/malinkang" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/malinkang" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['linkang.ma','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>bindService流程分析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>bindService流程分析</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> malinkang </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 1, 2020, 3:18 AM +0800" prep="on" > Mar 1, 2020 <i class="unloaded">2020-03-01T03:18:41+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5335 words">29 min</span></div></div><div class="post-content"><h2 id="contextwrapper">ContextWrapper</h2><h3 id="bindservice">bindService</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/android/content/ContextWrapper.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">bindService</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">service</span><span class="o">,</span> <span class="nc">ServiceConnection</span> <span class="n">conn</span><span class="o">,</span><span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">mBase</span><span class="o">.</span><span class="na">bindService</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">conn</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="contextimpl">ContextImpl</h2><h3 id="bindservice-1">bindService</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/android/app/ContextImpl.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">bindService</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">service</span><span class="o">,</span> <span class="nc">ServiceConnection</span> <span class="n">conn</span><span class="o">,</span><span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">warnIfCallingFromSystemProcess</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">bindServiceCommon</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">conn</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">mMainThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">(),</span>
            <span class="nc">Process</span><span class="o">.</span><span class="na">myUserHandle</span><span class="o">());</span>
<span class="o">}</span>

</pre></table></code></div></div><h3 id="bindservicecommon">bindServiceCommon</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">LoadedApk</span> <span class="n">mPackageInfo</span><span class="o">;</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">bindServiceCommon</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">service</span><span class="o">,</span> <span class="nc">ServiceConnection</span> <span class="n">conn</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="nc">Handler</span>
            <span class="n">handler</span><span class="o">,</span> <span class="nc">UserHandle</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">IServiceConnection</span> <span class="n">sd</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">conn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"connection is null"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mPackageInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//获取的是内部静态类InnerConnection</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">mPackageInfo</span><span class="o">.</span><span class="na">getServiceDispatcher</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">getOuterContext</span><span class="o">(),</span> <span class="n">handler</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Not supported in system context"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">validateServiceIntent</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">IBinder</span> <span class="n">token</span> <span class="o">=</span> <span class="n">getActivityToken</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">flags</span><span class="o">&amp;</span><span class="no">BIND_AUTO_CREATE</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mPackageInfo</span> <span class="o">!=</span> <span class="kc">null</span>
                <span class="o">&amp;&amp;</span> <span class="n">mPackageInfo</span><span class="o">.</span><span class="na">getApplicationInfo</span><span class="o">().</span><span class="na">targetSdkVersion</span>
                <span class="o">&lt;</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">ICE_CREAM_SANDWICH</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="no">BIND_WAIVE_PRIORITY</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">service</span><span class="o">.</span><span class="na">prepareToLeaveProcess</span><span class="o">(</span><span class="k">this</span><span class="o">);</span> 
        <span class="c1">//调用AMP bindService</span>
        <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="nc">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">bindService</span><span class="o">(</span>
            <span class="n">mMainThread</span><span class="o">.</span><span class="na">getApplicationThread</span><span class="o">(),</span> <span class="n">getActivityToken</span><span class="o">(),</span> <span class="n">service</span><span class="o">,</span>
            <span class="n">service</span><span class="o">.</span><span class="na">resolveTypeIfNeeded</span><span class="o">(</span><span class="n">getContentResolver</span><span class="o">()),</span>
            <span class="n">sd</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">getOpPackageName</span><span class="o">(),</span> <span class="n">user</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span>
                    <span class="s">"Not allowed to bind to service "</span> <span class="o">+</span> <span class="n">service</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="loadedapk">LoadedApk</h2><h3 id="getservicedispatcher">getServiceDispatcher</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/android/app/LoadedApk.java</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">,</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">ServiceConnection</span><span class="o">,</span> <span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span><span class="o">&gt;&gt;</span> <span class="n">mServices</span>
        <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">,</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">ServiceConnection</span><span class="o">,</span> <span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span><span class="o">&gt;&gt;();</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="nc">IServiceConnection</span> <span class="nf">getServiceDispatcher</span><span class="o">(</span><span class="nc">ServiceConnection</span> <span class="n">c</span><span class="o">,</span>
            <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Handler</span> <span class="n">handler</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
  <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mServices</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span> <span class="n">sd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">ServiceConnection</span><span class="o">,</span> <span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sd</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">sd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceDispatcher</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span><span class="c1">//创建ServiceDispatcher</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">ServiceConnection</span><span class="o">,</span> <span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span><span class="o">&gt;();</span>
              <span class="n">mServices</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">sd</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">sd</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="c1">//调用ServiceDispatcher的getIServiceConnection获取IServiceConnection</span>
      <span class="k">return</span> <span class="n">sd</span><span class="o">.</span><span class="na">getIServiceConnection</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="servicedispatcher">ServiceDispatcher</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/android/app/LoadedApk.java</span>
<span class="nc">ServiceDispatcher</span><span class="o">(</span><span class="nc">ServiceConnection</span> <span class="n">conn</span><span class="o">,</span>
                <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Handler</span> <span class="n">activityThread</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mIServiceConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InnerConnection</span><span class="o">(</span><span class="k">this</span><span class="o">);</span> <span class="c1">//创建</span>
    <span class="n">mConnection</span> <span class="o">=</span> <span class="n">conn</span><span class="o">;</span> <span class="c1">//传递进来的</span>
    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="n">mActivityThread</span> <span class="o">=</span> <span class="n">activityThread</span><span class="o">;</span>
    <span class="n">mLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceConnectionLeaked</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="n">mLocation</span><span class="o">.</span><span class="na">fillInStackTrace</span><span class="o">();</span>
    <span class="n">mFlags</span> <span class="o">=</span> <span class="n">flags</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="getiserviceconnection">getIServiceConnection</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nc">IServiceConnection</span> <span class="nf">getIServiceConnection</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">mIServiceConnection</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="innerconnection">InnerConnection</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">InnerConnection</span> <span class="kd">extends</span> <span class="nc">IServiceConnection</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span><span class="o">&gt;</span> <span class="n">mDispatcher</span><span class="o">;</span>

    <span class="nc">InnerConnection</span><span class="o">(</span><span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span> <span class="n">sd</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mDispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span><span class="o">&gt;(</span><span class="n">sd</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
        <span class="nc">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">mDispatcher</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sd</span><span class="o">.</span><span class="na">connected</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span> <span class="c1">//调用传入的ServiceDispatcher的connected方法</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="connected">connected</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">connected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mActivityThread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mActivityThread</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="nc">RunConnection</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">doConnected</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="runconnection">RunConnection</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RunConnection</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="nc">RunConnection</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">,</span> <span class="kt">int</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mName</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="n">mService</span> <span class="o">=</span> <span class="n">service</span><span class="o">;</span>
        <span class="n">mCommand</span> <span class="o">=</span> <span class="n">command</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mCommand</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">doConnected</span><span class="o">(</span><span class="n">mName</span><span class="o">,</span> <span class="n">mService</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mCommand</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">doDeath</span><span class="o">(</span><span class="n">mName</span><span class="o">,</span> <span class="n">mService</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="nc">ComponentName</span> <span class="n">mName</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">IBinder</span> <span class="n">mService</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">mCommand</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="doconnected">doConnected</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doConnected</span><span class="o">(</span><span class="nc">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ServiceDispatcher</span><span class="o">.</span><span class="na">ConnectionInfo</span> <span class="n">old</span><span class="o">;</span>
    <span class="nc">ServiceDispatcher</span><span class="o">.</span><span class="na">ConnectionInfo</span> <span class="n">info</span><span class="o">;</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mForgotten</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// We unbound before receiving the connection; ignore</span>
            <span class="c1">// any connection received.</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">mActiveConnections</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">old</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">old</span><span class="o">.</span><span class="na">binder</span> <span class="o">==</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Huh, already have this one.  Oh well!</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">service</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// A new service is being connected... set it all up.</span>
            <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionInfo</span><span class="o">();</span>
            <span class="n">info</span><span class="o">.</span><span class="na">binder</span> <span class="o">=</span> <span class="n">service</span><span class="o">;</span>
            <span class="n">info</span><span class="o">.</span><span class="na">deathMonitor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DeathMonitor</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">service</span><span class="o">.</span><span class="na">linkToDeath</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">deathMonitor</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                <span class="n">mActiveConnections</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">info</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// This service was dead before we got it...  just</span>
                <span class="c1">// don't do anything with it.</span>
                <span class="n">mActiveConnections</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// The named service is being disconnected... clean up.</span>
            <span class="n">mActiveConnections</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">old</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">old</span><span class="o">.</span><span class="na">binder</span><span class="o">.</span><span class="na">unlinkToDeath</span><span class="o">(</span><span class="n">old</span><span class="o">.</span><span class="na">deathMonitor</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// If there was an old service, it is now disconnected.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">old</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mConnection</span><span class="o">.</span><span class="na">onServiceDisconnected</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// If there is a new service, it is now connected.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">service</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mConnection</span><span class="o">.</span><span class="na">onServiceConnected</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="activitymanagerproxy">ActivityManagerProxy</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/android/app/ActivityManagerNative.java</span>
<span class="c1">//AMP</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">bindService</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span>
        <span class="nc">Intent</span> <span class="n">service</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="nc">IServiceConnection</span> <span class="n">connection</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span>  <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
    <span class="nc">Parcel</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
    <span class="nc">Parcel</span> <span class="n">reply</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="nc">IActivityManager</span><span class="o">.</span><span class="na">descriptor</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeStrongBinder</span><span class="o">(</span><span class="n">caller</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">caller</span><span class="o">.</span><span class="na">asBinder</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeStrongBinder</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="n">service</span><span class="o">.</span><span class="na">writeToParcel</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">resolvedType</span><span class="o">);</span>
    <span class="c1">//将InnerConnection对象传递system_server</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeStrongBinder</span><span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">asBinder</span><span class="o">());</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">flags</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">callingPackage</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
  	<span class="c1">//经过Binder IPC进入system_server进程</span>
    <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="no">BIND_SERVICE_TRANSACTION</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">reply</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">reply</span><span class="o">.</span><span class="na">readException</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
    <span class="n">data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
    <span class="n">reply</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="activitymanagernative">ActivityManagerNative</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre> <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTransact</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="nc">Parcel</span> <span class="n">data</span><span class="o">,</span> <span class="nc">Parcel</span> <span class="n">reply</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nl">BIND_SERVICE_TRANSACTION:</span> <span class="o">{</span>
              <span class="n">data</span><span class="o">.</span><span class="na">enforceInterface</span><span class="o">(</span><span class="nc">IActivityManager</span><span class="o">.</span><span class="na">descriptor</span><span class="o">);</span>
              <span class="nc">IBinder</span> <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">readStrongBinder</span><span class="o">();</span>
              <span class="nc">IApplicationThread</span> <span class="n">app</span> <span class="o">=</span> <span class="nc">ApplicationThreadNative</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
              <span class="nc">IBinder</span> <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">readStrongBinder</span><span class="o">();</span>
              <span class="nc">Intent</span> <span class="n">service</span> <span class="o">=</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">CREATOR</span><span class="o">.</span><span class="na">createFromParcel</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
              <span class="nc">String</span> <span class="n">resolvedType</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">readString</span><span class="o">();</span>
              <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">readStrongBinder</span><span class="o">();</span>
              <span class="kt">int</span> <span class="n">fl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
              <span class="nc">String</span> <span class="n">callingPackage</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">readString</span><span class="o">();</span>
              <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
              <span class="nc">IServiceConnection</span> <span class="n">conn</span> <span class="o">=</span> <span class="nc">IServiceConnection</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
              <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">bindService</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">conn</span><span class="o">,</span> <span class="n">fl</span><span class="o">,</span>
                      <span class="n">callingPackage</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span> <span class="c1">//调用ams的bindService</span>
              <span class="n">reply</span><span class="o">.</span><span class="na">writeNoException</span><span class="o">();</span>
              <span class="n">reply</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
              <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="activitymanagerservice">ActivityManagerService</h2><h3 id="bindservice-2">bindService</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
<span class="kd">final</span> <span class="nc">ActiveServices</span> <span class="n">mServices</span><span class="o">;</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">bindService</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">service</span><span class="o">,</span>
            <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="nc">IServiceConnection</span> <span class="n">connection</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransactionTooLargeException</span> <span class="o">{</span>
    <span class="n">enforceNotIsolatedCaller</span><span class="o">(</span><span class="s">"bindService"</span><span class="o">);</span>

    <span class="c1">// Refuse possible leaked file descriptors</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">service</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">service</span><span class="o">.</span><span class="na">hasFileDescriptors</span><span class="o">()</span> <span class="o">==</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"File descriptors passed in Intent"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">callingPackage</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"callingPackage cannot be null"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mServices</span><span class="o">.</span><span class="na">bindServiceLocked</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span>
                <span class="n">resolvedType</span><span class="o">,</span> <span class="n">connection</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="publishservice">publishService</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">publishService</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Refuse possible leaked file descriptors</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">intent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">intent</span><span class="o">.</span><span class="na">hasFileDescriptors</span><span class="o">()</span> <span class="o">==</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"File descriptors passed in Intent"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">token</span> <span class="k">instanceof</span> <span class="nc">ServiceRecord</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Invalid service token"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//调用publishServiceLocked</span>
        <span class="n">mServices</span><span class="o">.</span><span class="na">publishServiceLocked</span><span class="o">((</span><span class="nc">ServiceRecord</span><span class="o">)</span><span class="n">token</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="activeservices">ActiveServices</h2><h3 id="bindservicelocked">bindServiceLocked</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span>
<span class="kt">int</span> <span class="nf">bindServiceLocked</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">service</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">IServiceConnection</span> <span class="n">connection</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransactionTooLargeException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"bindService: "</span> <span class="o">+</span> <span class="n">service</span>
            <span class="o">+</span> <span class="s">" type="</span> <span class="o">+</span> <span class="n">resolvedType</span> <span class="o">+</span> <span class="s">" conn="</span> <span class="o">+</span> <span class="n">connection</span><span class="o">.</span><span class="na">asBinder</span><span class="o">()</span>
            <span class="o">+</span> <span class="s">" flags=0x"</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">flags</span><span class="o">));</span>
    <span class="kd">final</span> <span class="nc">ProcessRecord</span> <span class="n">callerApp</span> <span class="o">=</span> <span class="n">mAm</span><span class="o">.</span><span class="na">getRecordForAppLocked</span><span class="o">(</span><span class="n">caller</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">callerApp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span>
                <span class="s">"Unable to find app for caller "</span> <span class="o">+</span> <span class="n">caller</span>
                <span class="o">+</span> <span class="s">" (pid="</span> <span class="o">+</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">()</span>
                <span class="o">+</span> <span class="s">") when binding service "</span> <span class="o">+</span> <span class="n">service</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">ActivityRecord</span> <span class="n">activity</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">activity</span> <span class="o">=</span> <span class="nc">ActivityRecord</span><span class="o">.</span><span class="na">isInStackLocked</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Binding with unknown activity: "</span> <span class="o">+</span> <span class="n">token</span><span class="o">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">clientLabel</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="nc">PendingIntent</span> <span class="n">clientIntent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isCallerSystem</span> <span class="o">=</span> <span class="n">callerApp</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">uid</span> <span class="o">==</span> <span class="nc">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isCallerSystem</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Hacky kind of thing -- allow system stuff to tell us</span>
        <span class="c1">// what they are, so we can report this elsewhere for</span>
        <span class="c1">// others to know why certain services are running.</span>
        <span class="n">service</span><span class="o">.</span><span class="na">setDefusable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">clientIntent</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">EXTRA_CLIENT_INTENT</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">clientIntent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">clientLabel</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getIntExtra</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">EXTRA_CLIENT_LABEL</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clientLabel</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// There are no useful extras in the intent, trash them.</span>
                <span class="c1">// System code calling with this stuff just needs to know</span>
                <span class="c1">// this will happen.</span>
                <span class="n">service</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">cloneFilter</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">((</span><span class="n">flags</span><span class="o">&amp;</span><span class="nc">Context</span><span class="o">.</span><span class="na">BIND_TREAT_LIKE_ACTIVITY</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mAm</span><span class="o">.</span><span class="na">enforceCallingPermission</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">MANAGE_ACTIVITY_STACKS</span><span class="o">,</span>
                <span class="s">"BIND_TREAT_LIKE_ACTIVITY"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="nc">Context</span><span class="o">.</span><span class="na">BIND_ALLOW_WHITELIST_MANAGEMENT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isCallerSystem</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span>
                <span class="s">"Non-system caller "</span> <span class="o">+</span> <span class="n">caller</span> <span class="o">+</span> <span class="s">" (pid="</span> <span class="o">+</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">()</span>
                <span class="o">+</span> <span class="s">") set BIND_ALLOW_WHITELIST_MANAGEMENT when binding service "</span> <span class="o">+</span> <span class="n">service</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">callerFg</span> <span class="o">=</span> <span class="n">callerApp</span><span class="o">.</span><span class="na">setSchedGroup</span> <span class="o">!=</span> <span class="nc">ProcessList</span><span class="o">.</span><span class="na">SCHED_GROUP_BACKGROUND</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isBindExternal</span> <span class="o">=</span> <span class="o">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="nc">Context</span><span class="o">.</span><span class="na">BIND_EXTERNAL_SERVICE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">//检索服务</span>
    <span class="nc">ServiceLookupResult</span> <span class="n">res</span> <span class="o">=</span>
        <span class="n">retrieveServiceLocked</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">(),</span>
                <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">(),</span> <span class="n">userId</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">callerFg</span><span class="o">,</span> <span class="n">isBindExternal</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">record</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">ServiceRecord</span> <span class="n">s</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">record</span><span class="o">;</span>

    <span class="kt">boolean</span> <span class="n">permissionsReviewRequired</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="c1">// If permissions need a review before any of the app components can run,</span>
    <span class="c1">// we schedule binding to the service but do not start its process, then</span>
    <span class="c1">// we launch a review activity to which is passed a callback to invoke</span>
    <span class="c1">// when done to start the bound service's process to completing the binding.</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Build</span><span class="o">.</span><span class="na">PERMISSIONS_REVIEW_REQUIRED</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mAm</span><span class="o">.</span><span class="na">getPackageManagerInternalLocked</span><span class="o">().</span><span class="na">isPermissionsReviewRequired</span><span class="o">(</span>
                <span class="n">s</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">userId</span><span class="o">))</span> <span class="o">{</span>

            <span class="n">permissionsReviewRequired</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

            <span class="c1">// Show a permission review UI only for binding from a foreground app</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">callerFg</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"u"</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">userId</span> <span class="o">+</span> <span class="s">" Binding to a service in package"</span>
                        <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">" requires a permissions review"</span><span class="o">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">final</span> <span class="nc">ServiceRecord</span> <span class="n">serviceRecord</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">Intent</span> <span class="n">serviceIntent</span> <span class="o">=</span> <span class="n">service</span><span class="o">;</span>

            <span class="nc">RemoteCallback</span> <span class="n">callback</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RemoteCallback</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nc">RemoteCallback</span><span class="o">.</span><span class="na">OnResultListener</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResult</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">synchronized</span><span class="o">(</span><span class="n">mAm</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kd">final</span> <span class="kt">long</span> <span class="n">identity</span> <span class="o">=</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(!</span><span class="n">mPendingServices</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">serviceRecord</span><span class="o">))</span> <span class="o">{</span>
                                <span class="k">return</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="c1">// If there is still a pending record, then the service</span>
                            <span class="c1">// binding request is still valid, so hook them up. We</span>
                            <span class="c1">// proceed only if the caller cleared the review requirement</span>
                            <span class="c1">// otherwise we unbind because the user didn't approve.</span>
                            <span class="k">if</span> <span class="o">(!</span><span class="n">mAm</span><span class="o">.</span><span class="na">getPackageManagerInternalLocked</span><span class="o">()</span>
                                    <span class="o">.</span><span class="na">isPermissionsReviewRequired</span><span class="o">(</span>
                                            <span class="n">serviceRecord</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span>
                                            <span class="n">serviceRecord</span><span class="o">.</span><span class="na">userId</span><span class="o">))</span> <span class="o">{</span>
                                <span class="k">try</span> <span class="o">{</span> <span class="c1">//拉起目标服务</span>
                                    <span class="n">bringUpServiceLocked</span><span class="o">(</span><span class="n">serviceRecord</span><span class="o">,</span>
                                            <span class="n">serviceIntent</span><span class="o">.</span><span class="na">getFlags</span><span class="o">(),</span>
                                            <span class="n">callerFg</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="cm">/* ignore - local call */</span>
                                <span class="o">}</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="n">unbindServiceLocked</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="nc">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">identity</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">});</span>

            <span class="kd">final</span> <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_REVIEW_PERMISSIONS</span><span class="o">);</span>
            <span class="n">intent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span>
                    <span class="o">|</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</span><span class="o">);</span>
            <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">EXTRA_PACKAGE_NAME</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
            <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">EXTRA_REMOTE_CALLBACK</span><span class="o">,</span> <span class="n">callback</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_PERMISSIONS_REVIEW</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"u"</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">userId</span> <span class="o">+</span> <span class="s">" Launching permission review for package "</span>
                        <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">mAm</span><span class="o">.</span><span class="na">mHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">mAm</span><span class="o">.</span><span class="na">mContext</span><span class="o">.</span><span class="na">startActivityAsUser</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="k">new</span> <span class="nc">UserHandle</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">long</span> <span class="n">origId</span> <span class="o">=</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">unscheduleServiceRestartLocked</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">callerApp</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"BIND SERVICE WHILE RESTART PENDING: "</span>
                    <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">flags</span><span class="o">&amp;</span><span class="nc">Context</span><span class="o">.</span><span class="na">BIND_AUTO_CREATE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">s</span><span class="o">.</span><span class="na">lastActivity</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">s</span><span class="o">.</span><span class="na">hasAutoCreateConnections</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// This is the first binding, let the tracker know.</span>
                <span class="nc">ServiceState</span> <span class="n">stracker</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getTracker</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">stracker</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">stracker</span><span class="o">.</span><span class="na">setBound</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">mAm</span><span class="o">.</span><span class="na">mProcessStats</span><span class="o">.</span><span class="na">getMemFactorLocked</span><span class="o">(),</span>
                            <span class="n">s</span><span class="o">.</span><span class="na">lastActivity</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">mAm</span><span class="o">.</span><span class="na">startAssociationLocked</span><span class="o">(</span><span class="n">callerApp</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">callerApp</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">callerApp</span><span class="o">.</span><span class="na">curProcState</span><span class="o">,</span>
                <span class="n">s</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
        <span class="c1">//获取AppBindRecord</span>
        <span class="nc">AppBindRecord</span> <span class="n">b</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">retrieveAppBindingLocked</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">callerApp</span><span class="o">);</span>
        <span class="nc">ConnectionRecord</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionRecord</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">activity</span><span class="o">,</span>
                <span class="n">connection</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">clientLabel</span><span class="o">,</span> <span class="n">clientIntent</span><span class="o">);</span>

        <span class="nc">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">asBinder</span><span class="o">();</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ConnectionRecord</span><span class="o">&gt;</span> <span class="n">clist</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">connections</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">binder</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">clist</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">clist</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ConnectionRecord</span><span class="o">&gt;();</span>
            <span class="n">s</span><span class="o">.</span><span class="na">connections</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">binder</span><span class="o">,</span> <span class="n">clist</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">clist</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="n">b</span><span class="o">.</span><span class="na">connections</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">connections</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">activity</span><span class="o">.</span><span class="na">connections</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="nc">ConnectionRecord</span><span class="o">&gt;();</span>
            <span class="o">}</span>
            <span class="n">activity</span><span class="o">.</span><span class="na">connections</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">b</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">connections</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">c</span><span class="o">.</span><span class="na">flags</span><span class="o">&amp;</span><span class="nc">Context</span><span class="o">.</span><span class="na">BIND_ABOVE_CLIENT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">b</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">hasAboveClient</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">c</span><span class="o">.</span><span class="na">flags</span><span class="o">&amp;</span><span class="nc">Context</span><span class="o">.</span><span class="na">BIND_ALLOW_WHITELIST_MANAGEMENT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">s</span><span class="o">.</span><span class="na">whitelistManager</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">app</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">updateServiceClientActivitiesLocked</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">app</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="n">mServiceConnections</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">binder</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">clist</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">clist</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ConnectionRecord</span><span class="o">&gt;();</span>
            <span class="n">mServiceConnections</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">binder</span><span class="o">,</span> <span class="n">clist</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">clist</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">flags</span><span class="o">&amp;</span><span class="nc">Context</span><span class="o">.</span><span class="na">BIND_AUTO_CREATE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">s</span><span class="o">.</span><span class="na">lastActivity</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">bringUpServiceLocked</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">service</span><span class="o">.</span><span class="na">getFlags</span><span class="o">(),</span> <span class="n">callerFg</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
                    <span class="n">permissionsReviewRequired</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">app</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">flags</span><span class="o">&amp;</span><span class="nc">Context</span><span class="o">.</span><span class="na">BIND_TREAT_LIKE_ACTIVITY</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">s</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">treatLikeActivity</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">whitelistManager</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">s</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">whitelistManager</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// This could have made the service more important.</span>
            <span class="n">mAm</span><span class="o">.</span><span class="na">updateLruProcessLocked</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">app</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">hasClientActivities</span>
                    <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">treatLikeActivity</span><span class="o">,</span> <span class="n">b</span><span class="o">.</span><span class="na">client</span><span class="o">);</span>
            <span class="n">mAm</span><span class="o">.</span><span class="na">updateOomAdjLocked</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">app</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Bind "</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s">" with "</span> <span class="o">+</span> <span class="n">b</span>
                <span class="o">+</span> <span class="s">": received="</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">received</span>
                <span class="o">+</span> <span class="s">" apps="</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">size</span><span class="o">()</span>
                <span class="o">+</span> <span class="s">" doRebind="</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">doRebind</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">received</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Service is already running, so we can immediately</span>
            <span class="c1">// publish the connection.</span>
            <span class="k">try</span> <span class="o">{</span> <span class="c1">//? binder哪里创建的？？？</span>
                <span class="n">c</span><span class="o">.</span><span class="na">conn</span><span class="o">.</span><span class="na">connected</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">binder</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Failure sending service "</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="na">shortName</span>
                        <span class="o">+</span> <span class="s">" to connection "</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">conn</span><span class="o">.</span><span class="na">asBinder</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">" (in "</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">binding</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">processName</span> <span class="o">+</span> <span class="s">")"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// If this is the first app connected back to this binding,</span>
            <span class="c1">// and the service had previously asked to be told when</span>
            <span class="c1">// rebound, then do so.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">doRebind</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">requestServiceBindingLocked</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">,</span> <span class="n">callerFg</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">requested</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">requestServiceBindingLocked</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">b</span><span class="o">.</span><span class="na">intent</span><span class="o">,</span> <span class="n">callerFg</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">getServiceMap</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">userId</span><span class="o">).</span><span class="na">ensureNotStartingBackground</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>

    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="nc">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">origId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="retrieveservicelocked">retrieveServiceLocked</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">ServiceLookupResult</span> <span class="nf">retrieveServiceLocked</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">service</span><span class="o">,</span>
      <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callingPid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callingUid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span>
      <span class="kt">boolean</span> <span class="n">createIfNeeded</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">callingFromFg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isBindExternal</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">ServiceRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"retrieveServiceLocked: "</span> <span class="o">+</span> <span class="n">service</span>
          <span class="o">+</span> <span class="s">" type="</span> <span class="o">+</span> <span class="n">resolvedType</span> <span class="o">+</span> <span class="s">" callingUid="</span> <span class="o">+</span> <span class="n">callingUid</span><span class="o">);</span>

  <span class="n">userId</span> <span class="o">=</span> <span class="n">mAm</span><span class="o">.</span><span class="na">mUserController</span><span class="o">.</span><span class="na">handleIncomingUser</span><span class="o">(</span><span class="n">callingPid</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
          <span class="nc">ActivityManagerService</span><span class="o">.</span><span class="na">ALLOW_NON_FULL_IN_PROFILE</span><span class="o">,</span> <span class="s">"service"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

  <span class="nc">ServiceMap</span> <span class="n">smap</span> <span class="o">=</span> <span class="n">getServiceMap</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
  <span class="kd">final</span> <span class="nc">ComponentName</span> <span class="n">comp</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getComponent</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">comp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="na">mServicesByName</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">comp</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isBindExternal</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="na">mServicesByIntent</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">serviceInfo</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="nc">ServiceInfo</span><span class="o">.</span><span class="na">FLAG_EXTERNAL_SERVICE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span>
          <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">callingPackage</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">packageName</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// If an external service is running within its own package, other packages</span>
      <span class="c1">// should not bind to that instance.</span>
      <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// TODO: come back and remove this assumption to triage all services</span>
          <span class="nc">ResolveInfo</span> <span class="n">rInfo</span> <span class="o">=</span> <span class="nc">AppGlobals</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">().</span><span class="na">resolveService</span><span class="o">(</span><span class="n">service</span><span class="o">,</span>
                  <span class="n">resolvedType</span><span class="o">,</span> <span class="nc">ActivityManagerService</span><span class="o">.</span><span class="na">STOCK_PM_FLAGS</span>
                          <span class="o">|</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">MATCH_DEBUG_TRIAGED_MISSING</span><span class="o">,</span>
                  <span class="n">userId</span><span class="o">);</span>
          <span class="nc">ServiceInfo</span> <span class="n">sInfo</span> <span class="o">=</span>
              <span class="n">rInfo</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">rInfo</span><span class="o">.</span><span class="na">serviceInfo</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">sInfo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Unable to start service "</span> <span class="o">+</span> <span class="n">service</span> <span class="o">+</span> <span class="s">" U="</span> <span class="o">+</span> <span class="n">userId</span> <span class="o">+</span>
                    <span class="s">": not found"</span><span class="o">);</span>
              <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="nc">ComponentName</span> <span class="n">name</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ComponentName</span><span class="o">(</span>
                  <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">sInfo</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">((</span><span class="n">sInfo</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="nc">ServiceInfo</span><span class="o">.</span><span class="na">FLAG_EXTERNAL_SERVICE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">isBindExternal</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(!</span><span class="n">sInfo</span><span class="o">.</span><span class="na">exported</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span><span class="s">"BIND_EXTERNAL_SERVICE failed, "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span>
                              <span class="s">" is not exported"</span><span class="o">);</span>
                  <span class="o">}</span>
                  <span class="k">if</span> <span class="o">((</span><span class="n">sInfo</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="nc">ServiceInfo</span><span class="o">.</span><span class="na">FLAG_ISOLATED_PROCESS</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span><span class="s">"BIND_EXTERNAL_SERVICE failed, "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span>
                              <span class="s">" is not an isolatedProcess"</span><span class="o">);</span>
                  <span class="o">}</span>
                  <span class="c1">// Run the service under the calling package's application.</span>
                  <span class="nc">ApplicationInfo</span> <span class="n">aInfo</span> <span class="o">=</span> <span class="nc">AppGlobals</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">().</span><span class="na">getApplicationInfo</span><span class="o">(</span>
                          <span class="n">callingPackage</span><span class="o">,</span> <span class="nc">ActivityManagerService</span><span class="o">.</span><span class="na">STOCK_PM_FLAGS</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">aInfo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                      <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span><span class="s">"BIND_EXTERNAL_SERVICE failed, "</span> <span class="o">+</span>
                              <span class="s">"could not resolve client package "</span> <span class="o">+</span> <span class="n">callingPackage</span><span class="o">);</span>
                  <span class="o">}</span>
                  <span class="n">sInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceInfo</span><span class="o">(</span><span class="n">sInfo</span><span class="o">);</span>
                  <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ApplicationInfo</span><span class="o">(</span><span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">);</span>
                  <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span> <span class="o">=</span> <span class="n">aInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">;</span>
                  <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span> <span class="o">=</span> <span class="n">aInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">;</span>
                  <span class="n">name</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ComponentName</span><span class="o">(</span><span class="n">aInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">name</span><span class="o">.</span><span class="na">getClassName</span><span class="o">());</span>
                  <span class="n">service</span><span class="o">.</span><span class="na">setComponent</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span><span class="s">"BIND_EXTERNAL_SERVICE required for "</span> <span class="o">+</span>
                          <span class="n">name</span><span class="o">);</span>
              <span class="o">}</span>
          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isBindExternal</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span><span class="s">"BIND_EXTERNAL_SERVICE failed, "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span>
                      <span class="s">" is not an externalService"</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">userId</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">mAm</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">(</span><span class="n">sInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span>
                      <span class="n">sInfo</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">sInfo</span><span class="o">.</span><span class="na">flags</span><span class="o">)</span>
                      <span class="o">&amp;&amp;</span> <span class="n">mAm</span><span class="o">.</span><span class="na">isValidSingletonCall</span><span class="o">(</span><span class="n">callingUid</span><span class="o">,</span> <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">))</span> <span class="o">{</span>
                  <span class="n">userId</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                  <span class="n">smap</span> <span class="o">=</span> <span class="n">getServiceMap</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="n">sInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceInfo</span><span class="o">(</span><span class="n">sInfo</span><span class="o">);</span>
              <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span> <span class="o">=</span> <span class="n">mAm</span><span class="o">.</span><span class="na">getAppInfoForUser</span><span class="o">(</span><span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="na">mServicesByName</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">createIfNeeded</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span> <span class="n">filter</span>
                      <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">cloneFilter</span><span class="o">());</span>
              <span class="nc">ServiceRestarter</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceRestarter</span><span class="o">();</span>
              <span class="nc">BatteryStatsImpl</span><span class="o">.</span><span class="na">Uid</span><span class="o">.</span><span class="na">Pkg</span><span class="o">.</span><span class="na">Serv</span> <span class="n">ss</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
              <span class="nc">BatteryStatsImpl</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">mAm</span><span class="o">.</span><span class="na">mBatteryStatsService</span><span class="o">.</span><span class="na">getActiveStatistics</span><span class="o">();</span>
              <span class="kd">synchronized</span> <span class="o">(</span><span class="n">stats</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">ss</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="na">getServiceStatsLocked</span><span class="o">(</span>
                          <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">sInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span>
                          <span class="n">sInfo</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceRecord</span><span class="o">(</span><span class="n">mAm</span><span class="o">,</span> <span class="n">ss</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">filter</span><span class="o">,</span> <span class="n">sInfo</span><span class="o">,</span> <span class="n">callingFromFg</span><span class="o">,</span> <span class="n">res</span><span class="o">);</span>
              <span class="n">res</span><span class="o">.</span><span class="na">setService</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
              <span class="n">smap</span><span class="o">.</span><span class="na">mServicesByName</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
              <span class="n">smap</span><span class="o">.</span><span class="na">mServicesByIntent</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">filter</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>

              <span class="c1">// Make sure this component isn't in the pending list.</span>
              <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">mPendingServices</span><span class="o">.</span><span class="na">size</span><span class="o">()-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
                  <span class="nc">ServiceRecord</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">mPendingServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">pr</span><span class="o">.</span><span class="na">serviceInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span> <span class="o">==</span> <span class="n">sInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span>
                          <span class="o">&amp;&amp;</span> <span class="n">pr</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
                      <span class="n">mPendingServices</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// pm is in same process, this will never happen.</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">mAm</span><span class="o">.</span><span class="na">checkComponentPermission</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">permission</span><span class="o">,</span>
              <span class="n">callingPid</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">exported</span><span class="o">)</span>
              <span class="o">!=</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">r</span><span class="o">.</span><span class="na">exported</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Permission Denial: Accessing service "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">name</span>
                      <span class="o">+</span> <span class="s">" from pid="</span> <span class="o">+</span> <span class="n">callingPid</span>
                      <span class="o">+</span> <span class="s">", uid="</span> <span class="o">+</span> <span class="n">callingUid</span>
                      <span class="o">+</span> <span class="s">" that is not exported from uid "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">);</span>
              <span class="k">return</span> <span class="k">new</span> <span class="nf">ServiceLookupResult</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">"not exported from uid "</span>
                      <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Permission Denial: Accessing service "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">name</span>
                  <span class="o">+</span> <span class="s">" from pid="</span> <span class="o">+</span> <span class="n">callingPid</span>
                  <span class="o">+</span> <span class="s">", uid="</span> <span class="o">+</span> <span class="n">callingUid</span>
                  <span class="o">+</span> <span class="s">" requires "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">permission</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nf">ServiceLookupResult</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">permission</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">permission</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">callingPackage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">final</span> <span class="kt">int</span> <span class="n">opCode</span> <span class="o">=</span> <span class="nc">AppOpsManager</span><span class="o">.</span><span class="na">permissionToOpCode</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">permission</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">opCode</span> <span class="o">!=</span> <span class="nc">AppOpsManager</span><span class="o">.</span><span class="na">OP_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">mAm</span><span class="o">.</span><span class="na">mAppOpsService</span><span class="o">.</span><span class="na">noteOperation</span><span class="o">(</span>
                  <span class="n">opCode</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">)</span> <span class="o">!=</span> <span class="nc">AppOpsManager</span><span class="o">.</span><span class="na">MODE_ALLOWED</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Appop Denial: Accessing service "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">name</span>
                      <span class="o">+</span> <span class="s">" from pid="</span> <span class="o">+</span> <span class="n">callingPid</span>
                      <span class="o">+</span> <span class="s">", uid="</span> <span class="o">+</span> <span class="n">callingUid</span>
                      <span class="o">+</span> <span class="s">" requires appop "</span> <span class="o">+</span> <span class="nc">AppOpsManager</span><span class="o">.</span><span class="na">opToName</span><span class="o">(</span><span class="n">opCode</span><span class="o">));</span>
              <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>

      <span class="k">if</span> <span class="o">(!</span><span class="n">mAm</span><span class="o">.</span><span class="na">mIntentFirewall</span><span class="o">.</span><span class="na">checkService</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">callingPid</span><span class="o">,</span>
              <span class="n">resolvedType</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ServiceLookupResult</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="bringupservicelocked">bringUpServiceLocked</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">String</span> <span class="nf">bringUpServiceLocked</span><span class="o">(</span><span class="nc">ServiceRecord</span> <span class="n">r</span><span class="o">,</span> <span class="kt">int</span> <span class="n">intentFlags</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">execInFg</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">whileRestarting</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">permissionsReviewRequired</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">TransactionTooLargeException</span> <span class="o">{</span>
    <span class="c1">//Slog.i(TAG, "Bring up service:");</span>
    <span class="c1">//r.dump("  ");</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sendServiceArgsLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">execInFg</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">whileRestarting</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">restartDelay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// If waiting for a restart, then do nothing.</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Bringing up "</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">);</span>

    <span class="c1">// We are now bringing the service up, so no longer in the</span>
    <span class="c1">// restarting state.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mRestartingServices</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">r</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">r</span><span class="o">.</span><span class="na">resetRestartCounter</span><span class="o">();</span>
        <span class="n">clearRestartingIfNeededLocked</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Make sure this service is no longer considered delayed, we are starting it now.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">delayed</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_DELAYED_STARTS</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"REM FR DELAY LIST (bring up): "</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
        <span class="n">getServiceMap</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">userId</span><span class="o">).</span><span class="na">mDelayedStartList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="n">r</span><span class="o">.</span><span class="na">delayed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Make sure that the user who owns this service is started.  If not,</span>
    <span class="c1">// we don't want to allow it to run.</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">mAm</span><span class="o">.</span><span class="na">mUserController</span><span class="o">.</span><span class="na">hasStartedUserState</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">userId</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Unable to launch app "</span>
                <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">"/"</span>
                <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span> <span class="o">+</span> <span class="s">" for service "</span>
                <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getIntent</span><span class="o">()</span> <span class="o">+</span> <span class="s">": user "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">userId</span> <span class="o">+</span> <span class="s">" is stopped"</span><span class="o">;</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
        <span class="n">bringDownServiceLocked</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Service is now being launched, its package can't be stopped.</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">AppGlobals</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">().</span><span class="na">setPackageStoppedState</span><span class="o">(</span>
                <span class="n">r</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">userId</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Failed trying to unstop package "</span>
                <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isolated</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">serviceInfo</span><span class="o">.</span><span class="na">flags</span><span class="o">&amp;</span><span class="nc">ServiceInfo</span><span class="o">.</span><span class="na">FLAG_ISOLATED_PROCESS</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">String</span> <span class="n">procName</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">;</span>
    <span class="nc">ProcessRecord</span> <span class="n">app</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">isolated</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">mAm</span><span class="o">.</span><span class="na">getProcessRecordLocked</span><span class="o">(</span><span class="n">procName</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_MU</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_MU</span><span class="o">,</span> <span class="s">"bringUpServiceLocked: appInfo.uid="</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span>
                    <span class="o">+</span> <span class="s">" app="</span> <span class="o">+</span> <span class="n">app</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">app</span><span class="o">.</span><span class="na">addPackage</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">versionCode</span><span class="o">,</span> <span class="n">mAm</span><span class="o">.</span><span class="na">mProcessStats</span><span class="o">);</span>
                <span class="n">realStartServiceLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span> <span class="n">execInFg</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TransactionTooLargeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Exception when starting service "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">shortName</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// If a dead object exception was thrown -- fall through to</span>
            <span class="c1">// restart the application.</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// If this service runs in an isolated process, then each time</span>
        <span class="c1">// we call startProcessLocked() we will get a new isolated</span>
        <span class="c1">// process, starting another process if we are currently waiting</span>
        <span class="c1">// for a previous process to come up.  To deal with this, we store</span>
        <span class="c1">// in the service any current isolated process it is running in or</span>
        <span class="c1">// waiting to have come up.</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">isolatedProc</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Not running -- get it started, and enqueue this service record</span>
    <span class="c1">// to be executed when the app comes up.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">app</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">permissionsReviewRequired</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">app</span><span class="o">=</span><span class="n">mAm</span><span class="o">.</span><span class="na">startProcessLocked</span><span class="o">(</span><span class="n">procName</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">intentFlags</span><span class="o">,</span>
                <span class="s">"service"</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">isolated</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Unable to launch app "</span>
                    <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">packageName</span> <span class="o">+</span> <span class="s">"/"</span>
                    <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span> <span class="o">+</span> <span class="s">" for service "</span>
                    <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getIntent</span><span class="o">()</span> <span class="o">+</span> <span class="s">": process is bad"</span><span class="o">;</span>
            <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
            <span class="n">bringDownServiceLocked</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isolated</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">r</span><span class="o">.</span><span class="na">isolatedProc</span> <span class="o">=</span> <span class="n">app</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">mPendingServices</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">r</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">mPendingServices</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">delayedStop</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Oh and hey we've already been asked to stop!</span>
        <span class="n">r</span><span class="o">.</span><span class="na">delayedStop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">startRequested</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_DELAYED_STARTS</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span>
                    <span class="s">"Applying delayed stop (in bring up): "</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
            <span class="n">stopServiceLocked</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="realstartservicelocked">realStartServiceLocked</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">realStartServiceLocked</span><span class="o">(</span><span class="nc">ServiceRecord</span> <span class="n">r</span><span class="o">,</span>
        <span class="nc">ProcessRecord</span> <span class="n">app</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">execInFg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RemoteException</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_MU</span><span class="o">)</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_MU</span><span class="o">,</span> <span class="s">"realStartServiceLocked, ServiceRecord.uid = "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">appInfo</span><span class="o">.</span><span class="na">uid</span>
                <span class="o">+</span> <span class="s">", ProcessRecord.uid = "</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="na">uid</span><span class="o">);</span>
    <span class="n">r</span><span class="o">.</span><span class="na">app</span> <span class="o">=</span> <span class="n">app</span><span class="o">;</span>
    <span class="n">r</span><span class="o">.</span><span class="na">restartTime</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">lastActivity</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>

    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">newService</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">services</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="n">bumpServiceExecutingLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">execInFg</span><span class="o">,</span> <span class="s">"create"</span><span class="o">);</span>
    <span class="n">mAm</span><span class="o">.</span><span class="na">updateLruProcessLocked</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">mAm</span><span class="o">.</span><span class="na">updateOomAdjLocked</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="n">created</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">LOG_SERVICE_START_STOP</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">nameTerm</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">lastPeriod</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">shortName</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="sc">'.'</span><span class="o">);</span>
            <span class="n">nameTerm</span> <span class="o">=</span> <span class="n">lastPeriod</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span><span class="o">.</span><span class="na">shortName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">lastPeriod</span><span class="o">)</span> <span class="o">:</span> <span class="n">r</span><span class="o">.</span><span class="na">shortName</span><span class="o">;</span>
            <span class="nc">EventLogTags</span><span class="o">.</span><span class="na">writeAmCreateService</span><span class="o">(</span>
                    <span class="n">r</span><span class="o">.</span><span class="na">userId</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">r</span><span class="o">),</span> <span class="n">nameTerm</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">stats</span><span class="o">.</span><span class="na">getBatteryStats</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">r</span><span class="o">.</span><span class="na">stats</span><span class="o">.</span><span class="na">startLaunchedLocked</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">mAm</span><span class="o">.</span><span class="na">notifyPackageUse</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">serviceInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span>
                             <span class="nc">PackageManager</span><span class="o">.</span><span class="na">NOTIFY_PACKAGE_USE_SERVICE</span><span class="o">);</span>
        <span class="n">app</span><span class="o">.</span><span class="na">forceProcessStateUpTo</span><span class="o">(</span><span class="nc">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_SERVICE</span><span class="o">);</span>
        <span class="c1">//调用ApplicationThreadProxy的scheduleCreateService</span>
        <span class="n">app</span><span class="o">.</span><span class="na">thread</span><span class="o">.</span><span class="na">scheduleCreateService</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">serviceInfo</span><span class="o">,</span>
                <span class="n">mAm</span><span class="o">.</span><span class="na">compatibilityInfoForPackageLocked</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">serviceInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">),</span>
                <span class="n">app</span><span class="o">.</span><span class="na">repProcState</span><span class="o">);</span>
        <span class="n">r</span><span class="o">.</span><span class="na">postNotification</span><span class="o">();</span>
        <span class="n">created</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">DeadObjectException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Application dead when creating service "</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
        <span class="n">mAm</span><span class="o">.</span><span class="na">appDiedLocked</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">created</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Keep the executeNesting count accurate.</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">inDestroying</span> <span class="o">=</span> <span class="n">mDestroyingServices</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
            <span class="n">serviceDoneExecutingLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">inDestroying</span><span class="o">,</span> <span class="n">inDestroying</span><span class="o">);</span>

            <span class="c1">// Cleanup.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">newService</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">app</span><span class="o">.</span><span class="na">services</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
                <span class="n">r</span><span class="o">.</span><span class="na">app</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// Retry.</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">inDestroying</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">scheduleServiceRestartLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">whitelistManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">app</span><span class="o">.</span><span class="na">whitelistManager</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//</span>
    <span class="n">requestServiceBindingsLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">execInFg</span><span class="o">);</span>

    <span class="n">updateServiceClientActivitiesLocked</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="c1">// If the service is in the started state, and there are no</span>
    <span class="c1">// pending arguments, then fake up one so its onStartCommand() will</span>
    <span class="c1">// be called.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">startRequested</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">callStart</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">pendingStarts</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">r</span><span class="o">.</span><span class="na">pendingStarts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServiceRecord</span><span class="o">.</span><span class="na">StartItem</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">makeNextStartId</span><span class="o">(),</span>
                <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="n">sendServiceArgsLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">execInFg</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">delayed</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_DELAYED_STARTS</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"REM FR DELAY LIST (new proc): "</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
        <span class="n">getServiceMap</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">userId</span><span class="o">).</span><span class="na">mDelayedStartList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="n">r</span><span class="o">.</span><span class="na">delayed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">delayedStop</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Oh and hey we've already been asked to stop!</span>
        <span class="n">r</span><span class="o">.</span><span class="na">delayedStop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">startRequested</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_DELAYED_STARTS</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span>
                    <span class="s">"Applying delayed stop (from start): "</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
            <span class="n">stopServiceLocked</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="requestservicebindingslocked">requestServiceBindingsLocked</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">requestServiceBindingsLocked</span><span class="o">(</span><span class="nc">ServiceRecord</span> <span class="n">r</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">execInFg</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">TransactionTooLargeException</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">size</span><span class="o">()-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
        <span class="nc">IntentBindRecord</span> <span class="n">ibr</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">requestServiceBindingLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">ibr</span><span class="o">,</span> <span class="n">execInFg</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="requestservicebindinglocked">requestServiceBindingLocked</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">requestServiceBindingLocked</span><span class="o">(</span><span class="nc">ServiceRecord</span> <span class="n">r</span><span class="o">,</span> <span class="nc">IntentBindRecord</span> <span class="n">i</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">execInFg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">rebind</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransactionTooLargeException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">app</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// If service is not currently running, can't yet bind.</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">((!</span><span class="n">i</span><span class="o">.</span><span class="na">requested</span> <span class="o">||</span> <span class="n">rebind</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">bumpServiceExecutingLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">execInFg</span><span class="o">,</span> <span class="s">"bind"</span><span class="o">);</span>
            <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">forceProcessStateUpTo</span><span class="o">(</span><span class="nc">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_SERVICE</span><span class="o">);</span>
            <span class="c1">//调用ApplicationThreadProxy的scheduleBindService</span>
            <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span><span class="o">.</span><span class="na">scheduleBindService</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">i</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getIntent</span><span class="o">(),</span> <span class="n">rebind</span><span class="o">,</span>
                    <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">repProcState</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">rebind</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">i</span><span class="o">.</span><span class="na">requested</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">i</span><span class="o">.</span><span class="na">hasBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">i</span><span class="o">.</span><span class="na">doRebind</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TransactionTooLargeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Keep the executeNesting count accurate.</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Crashed while binding "</span> <span class="o">+</span> <span class="n">r</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">inDestroying</span> <span class="o">=</span> <span class="n">mDestroyingServices</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
            <span class="n">serviceDoneExecutingLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">inDestroying</span><span class="o">,</span> <span class="n">inDestroying</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Crashed while binding "</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
            <span class="c1">// Keep the executeNesting count accurate.</span>
            <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">inDestroying</span> <span class="o">=</span> <span class="n">mDestroyingServices</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
            <span class="n">serviceDoneExecutingLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">inDestroying</span><span class="o">,</span> <span class="n">inDestroying</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="publishservicelocked">publishServiceLocked</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">publishServiceLocked</span><span class="o">(</span><span class="nc">ServiceRecord</span> <span class="n">r</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">origId</span> <span class="o">=</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"PUBLISHING "</span> <span class="o">+</span> <span class="n">r</span>
                <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">intent</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">service</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span> <span class="n">filter</span>
                    <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
            <span class="nc">IntentBindRecord</span> <span class="n">b</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">b</span><span class="o">.</span><span class="na">received</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">b</span><span class="o">.</span><span class="na">binder</span> <span class="o">=</span> <span class="n">service</span><span class="o">;</span><span class="c1">//binder赋值</span>
                <span class="n">b</span><span class="o">.</span><span class="na">requested</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="n">b</span><span class="o">.</span><span class="na">received</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">conni</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="na">connections</span><span class="o">.</span><span class="na">size</span><span class="o">()-</span><span class="mi">1</span><span class="o">;</span> <span class="n">conni</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">;</span> <span class="n">conni</span><span class="o">--)</span> <span class="o">{</span>
                    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ConnectionRecord</span><span class="o">&gt;</span> <span class="n">clist</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">connections</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">conni</span><span class="o">);</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">clist</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="nc">ConnectionRecord</span> <span class="n">c</span> <span class="o">=</span> <span class="n">clist</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(!</span><span class="n">filter</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">binding</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">intent</span><span class="o">))</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span>
                                    <span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Not publishing to: "</span> <span class="o">+</span> <span class="n">c</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span>
                                    <span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Bound intent: "</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">binding</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">intent</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span>
                                    <span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Published intent: "</span> <span class="o">+</span> <span class="n">intent</span><span class="o">);</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG_SERVICE</span><span class="o">,</span> <span class="s">"Publishing to: "</span> <span class="o">+</span> <span class="n">c</span><span class="o">);</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">c</span><span class="o">.</span><span class="na">conn</span><span class="o">.</span><span class="na">connected</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Failure sending service "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span>
                                  <span class="s">" to connection "</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">conn</span><span class="o">.</span><span class="na">asBinder</span><span class="o">()</span> <span class="o">+</span>
                                  <span class="s">" (in "</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="na">binding</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">processName</span> <span class="o">+</span> <span class="s">")"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">serviceDoneExecutingLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">mDestroyingServices</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">r</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="nc">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">origId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><h2 id="servicerecord">ServiceRecord</h2><h3 id="retrieveappbindinglocked">retrieveAppBindingLocked</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ServiceRecord.java</span>
<span class="kd">final</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span><span class="o">,</span> <span class="nc">IntentBindRecord</span><span class="o">&gt;</span> <span class="n">bindings</span>
        <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span><span class="o">,</span> <span class="nc">IntentBindRecord</span><span class="o">&gt;();</span>
<span class="kd">public</span> <span class="nc">AppBindRecord</span> <span class="nf">retrieveAppBindingLocked</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span><span class="nc">ProcessRecord</span> <span class="n">app</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
    <span class="nc">IntentBindRecord</span> <span class="n">i</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IntentBindRecord</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span> <span class="c1">//创建IntentBindRecord</span>
        <span class="n">bindings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">filter</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">AppBindRecord</span> <span class="n">a</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AppBindRecord</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">app</span><span class="o">);</span> <span class="c1">//创建</span>
    <span class="n">i</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="processrecord">ProcessRecord</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">ProcessRecord</span> <span class="o">{</span>
  <span class="nc">IApplicationThread</span> <span class="n">thread</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="intentbindrecord">IntentBindRecord</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/services/core/java/com/android/server/am/IntentBindRecord.java</span>
<span class="kd">final</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">ProcessRecord</span><span class="o">,</span> <span class="nc">AppBindRecord</span><span class="o">&gt;</span> <span class="n">apps</span>
            <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayMap</span><span class="o">&lt;</span><span class="nc">ProcessRecord</span><span class="o">,</span> <span class="nc">AppBindRecord</span><span class="o">&gt;();</span>
<span class="nc">IBinder</span> <span class="n">binder</span><span class="o">;</span> 
<span class="nc">IntentBindRecord</span><span class="o">(</span><span class="nc">ServiceRecord</span> <span class="n">_service</span><span class="o">,</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FilterComparison</span> <span class="n">_intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">_service</span><span class="o">;</span>
    <span class="n">intent</span> <span class="o">=</span> <span class="n">_intent</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="iapplicationthread">IApplicationThread</h2><h2 id="applicationthreadproxy">ApplicationThreadProxy</h2><h3 id="schedulecreateservice">scheduleCreateService</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">scheduleCreateService</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nc">ServiceInfo</span> <span class="n">info</span><span class="o">,</span>
            <span class="nc">CompatibilityInfo</span> <span class="n">compatInfo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">processState</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
    <span class="nc">Parcel</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="nc">IApplicationThread</span><span class="o">.</span><span class="na">descriptor</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeStrongBinder</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="n">info</span><span class="o">.</span><span class="na">writeToParcel</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">compatInfo</span><span class="o">.</span><span class="na">writeToParcel</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">processState</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="no">SCHEDULE_CREATE_SERVICE_TRANSACTION</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                <span class="nc">IBinder</span><span class="o">.</span><span class="na">FLAG_ONEWAY</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TransactionTooLargeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"CREATE_SERVICE"</span><span class="o">,</span> <span class="s">"Binder failure starting service; service="</span> <span class="o">+</span> <span class="n">info</span><span class="o">);</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="schedulebindservice">scheduleBindService</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">scheduleBindService</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">rebind</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">processState</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">RemoteException</span> <span class="o">{</span>
    <span class="nc">Parcel</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">Parcel</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInterfaceToken</span><span class="o">(</span><span class="nc">IApplicationThread</span><span class="o">.</span><span class="na">descriptor</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeStrongBinder</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">writeToParcel</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">rebind</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">processState</span><span class="o">);</span>
    <span class="n">mRemote</span><span class="o">.</span><span class="na">transact</span><span class="o">(</span><span class="no">SCHEDULE_BIND_SERVICE_TRANSACTION</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
            <span class="nc">IBinder</span><span class="o">.</span><span class="na">FLAG_ONEWAY</span><span class="o">);</span>
    <span class="n">data</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="applicationthread">ApplicationThread</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">scheduleCreateService</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span>
                <span class="nc">ServiceInfo</span> <span class="n">info</span><span class="o">,</span> <span class="nc">CompatibilityInfo</span> <span class="n">compatInfo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">processState</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">updateProcessState</span><span class="o">(</span><span class="n">processState</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="nc">CreateServiceData</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CreateServiceData</span><span class="o">();</span>
    <span class="n">s</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
    <span class="n">s</span><span class="o">.</span><span class="na">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">;</span>
    <span class="n">s</span><span class="o">.</span><span class="na">compatInfo</span> <span class="o">=</span> <span class="n">compatInfo</span><span class="o">;</span>
    <span class="n">sendMessage</span><span class="o">(</span><span class="no">H</span><span class="o">.</span><span class="na">CREATE_SERVICE</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span> <span class="c1">//最终会调用handleCreateService</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">scheduleBindService</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span>
                <span class="kt">boolean</span> <span class="n">rebind</span><span class="o">,</span> <span class="kt">int</span> <span class="n">processState</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">updateProcessState</span><span class="o">(</span><span class="n">processState</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="nc">BindServiceData</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BindServiceData</span><span class="o">();</span>
    <span class="n">s</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
    <span class="n">s</span><span class="o">.</span><span class="na">intent</span> <span class="o">=</span> <span class="n">intent</span><span class="o">;</span>
    <span class="n">s</span><span class="o">.</span><span class="na">rebind</span> <span class="o">=</span> <span class="n">rebind</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"scheduleBindService token="</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="s">" intent="</span> <span class="o">+</span> <span class="n">intent</span> <span class="o">+</span> <span class="s">" uid="</span>
                <span class="o">+</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">()</span> <span class="o">+</span> <span class="s">" pid="</span> <span class="o">+</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">());</span>
    <span class="n">sendMessage</span><span class="o">(</span><span class="no">H</span><span class="o">.</span><span class="na">BIND_SERVICE</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="activitythread">ActivityThread</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleCreateService</span><span class="o">(</span><span class="nc">CreateServiceData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// If we are getting ready to gc after going to the background, well</span>
    <span class="c1">// we are back active so skip it.</span>
    <span class="n">unscheduleGcIdler</span><span class="o">();</span>

    <span class="nc">LoadedApk</span> <span class="n">packageInfo</span> <span class="o">=</span> <span class="n">getPackageInfoNoCheck</span><span class="o">(</span>
            <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">compatInfo</span><span class="o">);</span>
    <span class="nc">Service</span> <span class="n">service</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">packageInfo</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
        <span class="n">service</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Service</span><span class="o">)</span> <span class="n">cl</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">).</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Unable to instantiate service "</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span>
                <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Creating service "</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>

        <span class="nc">ContextImpl</span> <span class="n">context</span> <span class="o">=</span> <span class="nc">ContextImpl</span><span class="o">.</span><span class="na">createAppContext</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">packageInfo</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setOuterContext</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
        <span class="c1">//创建Application</span>
        <span class="nc">Application</span> <span class="n">app</span> <span class="o">=</span> <span class="n">packageInfo</span><span class="o">.</span><span class="na">makeApplication</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">mInstrumentation</span><span class="o">);</span>
        <span class="n">service</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span>
                <span class="nc">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">());</span>
        <span class="n">service</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span><span class="c1">//调用onCreate方法</span>
        <span class="n">mServices</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">serviceDoneExecuting</span><span class="o">(</span>
                    <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="no">SERVICE_DONE_EXECUTING_ANON</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Unable to create service "</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span>
                <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="handlebindservice">handleBindService</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleBindService</span><span class="o">(</span><span class="nc">BindServiceData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Service</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG_SERVICE</span><span class="o">)</span>
        <span class="nc">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"handleBindService s="</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s">" rebind="</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">rebind</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">setExtrasClassLoader</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
            <span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">prepareToEnterProcess</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">data</span><span class="o">.</span><span class="na">rebind</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">onBind</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">);</span> <span class="c1">//调用Service的onBind方法获取IBinder</span>
                    <span class="c1">//amp 的publishService方法</span>
                    <span class="nc">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">publishService</span><span class="o">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">,</span> <span class="n">binder</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">s</span><span class="o">.</span><span class="na">onRebind</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">);</span> <span class="c1">//调用onRebind</span>
                    <span class="nc">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">serviceDoneExecuting</span><span class="o">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="no">SERVICE_DONE_EXECUTING_ANON</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">ensureJitEnabled</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="n">ex</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                        <span class="s">"Unable to bind to service "</span> <span class="o">+</span> <span class="n">s</span>
                        <span class="o">+</span> <span class="s">" with "</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">intent</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-tag no-text-decoration" >源码分析</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=bindService流程分析 - malinkang&url=https://malinkang.cn/posts/framework-bind-service/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=bindService流程分析 - malinkang&u=https://malinkang.cn/posts/framework-bind-service/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=bindService流程分析 - malinkang&url=https://malinkang.cn/posts/framework-bind-service/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dagger-guide/">Dagger使用指南</a><li><a href="/posts/understanding-the-jvm-runtime-data-areas/">《深入理解JVM》第2章Java内存区域与内存溢出异常</a><li><a href="/posts/understanding-the-jvm-garbage-collection/">《深入理解JVM》第3章垃圾收集器</a><li><a href="/posts/understanding-the-jvm-class-file-structure/">《深入理解JVM》第6章类文件结构</a><li><a href="/posts/understanding-the-jvm-class-loader/">《深入理解JVM》第7章虚拟机类加载机制</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/arouter-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 24, 2020 <i class="unloaded">2020-11-24T19:14:29+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ARouter源码分析</h3><div class="text-muted small"><p> ARouter原理如下 编译期，会扫描@Route注解，将注解里的信息封装成一个RouteMeta对象。并生成一个辅助类ARouter$$Group$$groupName，groupName即分组的名字，这也意味着同一个group只会生成一个辅助类。该类继承自IRouteGroup，有一个loadInto()方法。在运行时，调用loadInto()方法，将@Route中的path作为k...</p></div></div></a></div><div class="card"> <a href="/posts/okhttp-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 26, 2020 <i class="unloaded">2020-11-26T04:01:47+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Okhttp源码分析</h3><div class="text-muted small"><p> Okhttp基本流程分析 基本流程 创建RequestBody 创建Request 创建OkhttpClient 调用newCall创建Call对象 执行异步或同步操作。 创建Socket连接 发送请求并处理返回结果 创建RequestBody RequestBody主要通过writeTo方法将请求内容写入到BufferedSink。RequestBo...</p></div></div></a></div><div class="card"> <a href="/posts/retrofit-source-analysis/"><div class="card-body"> <span class="timeago small" > Jul 26, 2017 <i class="unloaded">2017-07-26T04:07:22+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Retrofit源码分析</h3><div class="text-muted small"><p> Retrofit源码分析 流程分析 Retrofit执行流程可以分为两部分： 创建ServiceMethod。 调用ServiceMethod的invoke()。 下图中，黑线部分是创建ServiceMethod的过程，红线部分是invoke()的调用过程。 ServiceMethod创建过程： 通过动态代理，获取到我们定义的接口里的所有Method，调用S...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/start-activity/" class="btn btn-outline-primary" prompt="Older"><p>startActivity流程分析</p></a> <a href="/posts/what-is-reactive-programming/" class="btn btn-outline-primary" prompt="Newer"><p>什么是响应式编程</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//malinkang-cn.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'bindService流程分析'; this.page.url = 'https://malinkang.cn/posts/framework-bind-service/'; this.page.identifier = '/posts/framework-bind-service/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/malinkang">malinkang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://malinkang.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
