<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="《Java编程思想》第14章类型信息" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="运行时类型信息使得可以在程序运行时发现和使用类型信息。" /><meta property="og:description" content="运行时类型信息使得可以在程序运行时发现和使用类型信息。" /><link rel="canonical" href="https://malinkang.cn/posts/thinking-in-java-type-information/" /><meta property="og:url" content="https://malinkang.cn/posts/thinking-in-java-type-information/" /><meta property="og:site_name" content="malinkang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2013-06-11T21:39:36+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="《Java编程思想》第14章类型信息" /><meta name="twitter:site" content="@malinkang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"运行时类型信息使得可以在程序运行时发现和使用类型信息。","headline":"《Java编程思想》第14章类型信息","dateModified":"2013-06-11T21:39:36+08:00","url":"https://malinkang.cn/posts/thinking-in-java-type-information/","datePublished":"2013-06-11T21:39:36+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://malinkang.cn/posts/thinking-in-java-type-information/"},"@context":"https://schema.org"}</script><title>《Java编程思想》第14章类型信息 | malinkang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="malinkang"><meta name="application-name" content="malinkang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">malinkang</a></div><div class="site-subtitle font-italic">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/malinkang" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/malinkang" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['linkang.ma','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>《Java编程思想》第14章类型信息</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>《Java编程思想》第14章类型信息</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> malinkang </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 11, 2013, 9:39 PM +0800" prep="on" > Jun 11, 2013 <i class="unloaded">2013-06-11T21:39:36+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="9804 words">54 min</span></div></div><div class="post-content"><p>运行时类型信息使得可以在程序运行时发现和使用类型信息。</p><p>它使你从只能在编译期执行面向类型的操作的禁锢中解脱了出来，并且可以使用某些非常强大的程序。对<code class="language-plaintext highlighter-rouge">RTTI</code>的需要，揭示了面向对象设计中许多有趣的问题，同时也提出了如何组织程序的问题。</p><p>Java是如何让我们在运行时识别对象和类的信息的。主要有两种方式：一种是传统的RTTI，它假定我们在编译时已经知道了所有的类型；另一种是“反射”机制，它允许我们在运行时发现和使用类的信息。</p><h2 id="141-为什么需要rtti">14.1 为什么需要RTTI</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Shape</span><span class="o">{</span>
    <span class="kt">void</span> <span class="nf">draw</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">this</span> <span class="o">+</span> <span class="s">".draw()"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">abstract</span> <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Circle</span> <span class="kd">extends</span> <span class="nc">Shape</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"Circle"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Square</span> <span class="kd">extends</span> <span class="nc">Shape</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"Square"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Triangle</span> <span class="kd">extends</span> <span class="nc">Shape</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"Triangle"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Shapes</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Shape</span><span class="o">&gt;</span> <span class="n">shapeList</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
             <span class="k">new</span> <span class="nf">Circle</span><span class="o">(),</span><span class="k">new</span> <span class="nc">Square</span><span class="o">(),</span><span class="k">new</span> <span class="nc">Triangle</span><span class="o">()</span>
        <span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Shape</span> <span class="n">shape</span> <span class="o">:</span> <span class="n">shapeList</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">shape</span><span class="o">.</span><span class="na">draw</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
Circle.draw()
Square.draw()
Triangle.draw()
 */</span>
</pre></table></code></div></div><p>当把<code class="language-plaintext highlighter-rouge">Shape</code>对象放入<code class="language-plaintext highlighter-rouge">List&lt;Shape&gt;</code>的数组时会向上转型。但在向上转型为<code class="language-plaintext highlighter-rouge">Shape</code>的时候也丢失了<code class="language-plaintext highlighter-rouge">Shape</code>对象的具体类型。对于数组而言，它们只是<code class="language-plaintext highlighter-rouge">Shape</code>类的对象。</p><p>当从数组中取出元素时，这种容器实际上它将所有的事物都当作<code class="language-plaintext highlighter-rouge">Object</code>持有会自动将结果转型回<code class="language-plaintext highlighter-rouge">Shape</code>。这是<code class="language-plaintext highlighter-rouge">RTTI</code>最基本的使用形式，因为在<code class="language-plaintext highlighter-rouge">Java</code>中，所有的类型转换都是在运行时进行正确性检查的。这也是<code class="language-plaintext highlighter-rouge">RTTI</code>名字的含义：在运行时，识别一个对象的类型。</p><p>在这个例子中，<code class="language-plaintext highlighter-rouge">RTTI</code>类型转换并不彻底：<code class="language-plaintext highlighter-rouge">Object</code>被转型为<code class="language-plaintext highlighter-rouge">Shape</code>，而不是转型为<code class="language-plaintext highlighter-rouge">Circle</code>、<code class="language-plaintext highlighter-rouge">Square</code>或者<code class="language-plaintext highlighter-rouge">Triangle</code>。这是因为目前我们只知道这个<code class="language-plaintext highlighter-rouge">List&lt;Shape&gt;</code>保存的都是<code class="language-plaintext highlighter-rouge">Shape</code>。在编译时，将由容器和<code class="language-plaintext highlighter-rouge">Java</code>的泛型系统来强制确保这一点；而在运行时，由类型转换操作来确保这一点。</p><p>接下来就是多态机制的事情了，<code class="language-plaintext highlighter-rouge">Shape</code>对象实际执行什么样的代码，是由引用所指向的具体对象<code class="language-plaintext highlighter-rouge">Circle</code>、<code class="language-plaintext highlighter-rouge">Square</code>或者<code class="language-plaintext highlighter-rouge">Triangle</code>而决定的。通常，也正是这样要求的；你希望大部分代码尽可能少地了解对象的具体类型，而是只与对象家族中的一个通用表示打交道（在这个例子中是<code class="language-plaintext highlighter-rouge">Shape</code>)。这样代码更容易写，更容易读，且更便于维护；设计也更容易实现、理解和改变。所以”多态”是面向对象编程的基本目标。</p><h2 id="142-class对象">14.2 Class对象</h2><p>要理解<code class="language-plaintext highlighter-rouge">RTTI</code>在<code class="language-plaintext highlighter-rouge">Java</code>中的工作原理，首先必须知道类型信息在运行时是如何表示的。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/toys/ToyTest.java</span>
<span class="c1">// Testing class Class.</span>
<span class="kn">package</span> <span class="nn">typeinfo.toys</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">interface</span> <span class="nc">HasBatteries</span> <span class="o">{}</span>
<span class="kd">interface</span> <span class="nc">Waterproof</span> <span class="o">{}</span>
<span class="kd">interface</span> <span class="nc">Shoots</span> <span class="o">{}</span>

<span class="kd">class</span> <span class="nc">Toy</span> <span class="o">{</span>
    <span class="c1">// Comment out the following default constructor</span>
    <span class="c1">// to see NoSuchMethodError from (*1*)</span>
    <span class="nc">Toy</span><span class="o">()</span> <span class="o">{}</span>
    <span class="nc">Toy</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">FancyToy</span> <span class="kd">extends</span> <span class="nc">Toy</span>
        <span class="kd">implements</span> <span class="nc">HasBatteries</span><span class="o">,</span> <span class="nc">Waterproof</span><span class="o">,</span> <span class="nc">Shoots</span> <span class="o">{</span>
    <span class="nc">FancyToy</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ToyTest</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">printInfo</span><span class="o">(</span><span class="nc">Class</span> <span class="n">cc</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">print</span><span class="o">(</span><span class="s">"Class name: "</span> <span class="o">+</span> <span class="n">cc</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
                <span class="s">" is interface? ["</span> <span class="o">+</span> <span class="n">cc</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="n">print</span><span class="o">(</span><span class="s">"Simple name: "</span> <span class="o">+</span> <span class="n">cc</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
        <span class="n">print</span><span class="o">(</span><span class="s">"Canonical name : "</span> <span class="o">+</span> <span class="n">cc</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"typeinfo.toys.FancyToy"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">print</span><span class="o">(</span><span class="s">"Can't find FancyToy"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">printInfo</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Class</span> <span class="n">face</span> <span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">())</span>
            <span class="n">printInfo</span><span class="o">(</span><span class="n">face</span><span class="o">);</span>
        <span class="nc">Class</span> <span class="n">up</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
        <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Requires default constructor:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">print</span><span class="o">(</span><span class="s">"Cannot instantiate"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">print</span><span class="o">(</span><span class="s">"Cannot access"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">printInfo</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span><span class="cm">/* Output:
Class name: typeinfo.toys.FancyToy is interface? [false]
Simple name: FancyToy
Canonical name : typeinfo.toys.FancyToy
Class name: typeinfo.toys.HasBatteries is interface? [true]
Simple name: HasBatteries
Canonical name : typeinfo.toys.HasBatteries
Class name: typeinfo.toys.Waterproof is interface? [true]
Simple name: Waterproof
Canonical name : typeinfo.toys.Waterproof
Class name: typeinfo.toys.Shoots is interface? [true]
Simple name: Shoots
Canonical name : typeinfo.toys.Shoots
Class name: typeinfo.toys.Toy is interface? [false]
Simple name: Toy
Canonical name : typeinfo.toys.Toy
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><ul><li>getName()：产生全限定的类名。<li>getSimpleName()：产生不含包名的类名。<li>getCannonicalName()：（Java SE5中引入)产生全限定的类名。<li>isInterface()：Class对象是否表示某个接口。<li>getInterfaces()：Class对象中所包含的接口。<li>getSuperclass()：获取直接基类。<li>newInstance()：</ul><h3 id="1421-类字面常量">14.2.1 类字面常量</h3><p><code class="language-plaintext highlighter-rouge">Java</code>还提供了另一种方法来生成对<code class="language-plaintext highlighter-rouge">Class</code>对象的引用，即使用<code class="language-plaintext highlighter-rouge">类字面常量</code>。对上述程序来说，就像下面这样：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">FancyToy</span><span class="o">.</span><span class="na">class</span>
</pre></table></code></div></div><p>这样做不仅更简单，而且更安全，因为它在编译时就会受到检查。并且它根除了对<code class="language-plaintext highlighter-rouge">forName()</code>方法的调用，所以更高效。</p><p>类字面常量不仅可以应用于普通的类，也可以应用于接口、数组以及基本数据类型。另外，对于基本数据类型包装器类，还有一个标准字段<code class="language-plaintext highlighter-rouge">TYPE</code>。<code class="language-plaintext highlighter-rouge">TYPE</code>字段是一个引用，指向对应的基本数据类型的<code class="language-plaintext highlighter-rouge">Class</code>对象。</p><ul><li>boolean.class 等价于 Boolean.TYPE<li>char.class 等价于 Character.TYPE<li>byte.class 等价于 Byte.TYPE<li>short.class 等价于 Short.TYPE<li>int.class 等价于 Integer.TYPE<li>long.class 等价于 Long.TYPE<li>float.class 等价于 Float.TYPE<li>double.class 等价于 Double.TYPE<li>void.class 等价于 Void.TYPE</ul><p>当使用<code class="language-plaintext highlighter-rouge">.class</code>来创建对<code class="language-plaintext highlighter-rouge">Class</code>对象的引用时，不会自动地初始化该<code class="language-plaintext highlighter-rouge">Class</code>对象。为了使用类而做的准备工作实际包含三个步骤：</p><ol><li><code class="language-plaintext highlighter-rouge">加载</code>，这是由类加载器执行的。该步骤将查找字节码（通常在<code class="language-plaintext highlighter-rouge">classpath</code>指定的路径中查找，但这并非是必需的），并从这些字节码中创建一个<code class="language-plaintext highlighter-rouge">Class</code>对象。<li><code class="language-plaintext highlighter-rouge">链接</code>。在链接阶段将验证类中的字节码，为静态域分配存储空间，并且如果必需的话，将解析这个类创建的对其他类的所有引用。<li><code class="language-plaintext highlighter-rouge">初始化</code>。如果该类具有超类，则对其初始化，执行静态初始化器和静态初始化块。</ol><p>初始化被延迟到了对<strong>静态方法</strong>或者<strong>非常数静态域</strong>进行首次引用时才执行：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/ClassInitialization.java</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">Initable</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">staticFinal</span> <span class="o">=</span> <span class="mi">47</span><span class="o">;</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">staticFinal2</span> <span class="o">=</span>
    <span class="nc">ClassInitialization</span><span class="o">.</span><span class="na">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
  <span class="kd">static</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Initializing Initable"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Initable2</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kt">int</span> <span class="n">staticNonFinal</span> <span class="o">=</span> <span class="mi">147</span><span class="o">;</span>
  <span class="kd">static</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Initializing Initable2"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Initable3</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kt">int</span> <span class="n">staticNonFinal</span> <span class="o">=</span> <span class="mi">74</span><span class="o">;</span>
  <span class="kd">static</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Initializing Initable3"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassInitialization</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">(</span><span class="mi">47</span><span class="o">);</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Class</span> <span class="n">initable</span> <span class="o">=</span> <span class="nc">Initable</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"After creating Initable ref"</span><span class="o">);</span>
    <span class="c1">// Does not trigger initialization:</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Initable</span><span class="o">.</span><span class="na">staticFinal</span><span class="o">);</span>
    <span class="c1">// Does trigger initialization:</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Initable</span><span class="o">.</span><span class="na">staticFinal2</span><span class="o">);</span>
    <span class="c1">// Does trigger initialization:</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Initable2</span><span class="o">.</span><span class="na">staticNonFinal</span><span class="o">);</span>
    <span class="nc">Class</span> <span class="n">initable3</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"Initable3"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"After creating Initable3 ref"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Initable3</span><span class="o">.</span><span class="na">staticNonFinal</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
After creating Initable ref
47
Initializing Initable
258
Initializing Initable2
147
Initializing Initable3
After creating Initable3 ref
74
*/</span><span class="c1">//:~</span>
<span class="n">code</span>
</pre></table></code></div></div><p>从对<code class="language-plaintext highlighter-rouge">initable</code>引用的创建中可以看到，仅使用<code class="language-plaintext highlighter-rouge">.class</code>语法来获得对类的引用不会引发初始化。但是，<code class="language-plaintext highlighter-rouge">Class.forName()</code>立即进行了初始化。</p><p>如果一个<code class="language-plaintext highlighter-rouge">static final</code>值是<code class="language-plaintext highlighter-rouge">编译器常量</code>，就像<code class="language-plaintext highlighter-rouge">Initable.staticFinal</code>那样，那么这个值不需要对<code class="language-plaintext highlighter-rouge">Initable</code>类进行初始化就可以被读取。但是，如果只是将一个域设置为<code class="language-plaintext highlighter-rouge">static</code>和<code class="language-plaintext highlighter-rouge">final</code>的，还不足以确保这种行为，例如，对<code class="language-plaintext highlighter-rouge">Initable。staticFinal2</code>的访问将强制进行类的初始化，因为它不是一个编译器常量。</p><p>如果一个<code class="language-plaintext highlighter-rouge">static</code>域不是<code class="language-plaintext highlighter-rouge">final</code>的，那么在对它访问时，总是要求在它被读取之前，要先进行链接（为这个域分配存储空间）和初始化（初始化该存储空间），就像在对<code class="language-plaintext highlighter-rouge">Initable2.staticNonFinal</code>的访问中所看到的那样。</p><h3 id="1422-泛化的class引用">14.2.2 泛化的Class引用</h3><p><code class="language-plaintext highlighter-rouge">Class</code>引用总是指向某个<code class="language-plaintext highlighter-rouge">Class</code>对象，它可以制造类的实例，并包含可作用域这些实例的所有方法代码。它还包含该类的静态成员，因此，<code class="language-plaintext highlighter-rouge">Class</code>引用表示的就是它所指向的对象的确切类型，而该对象便是<code class="language-plaintext highlighter-rouge">Class</code>类的一个对象。</p><p><code class="language-plaintext highlighter-rouge">Java SE5</code>将它的类型变得更具体了一些，而这时通过允许你对<code class="language-plaintext highlighter-rouge">Class</code>引用所指向的<code class="language-plaintext highlighter-rouge">Class</code>对象的类型进行限定而实现的，这里用到了泛型语法。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/GenericClassReferences.java</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericClassReferences</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Class</span> <span class="n">intClass</span> <span class="o">=</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">genericIntClass</span> <span class="o">=</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="n">genericIntClass</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">;</span> <span class="c1">// Same thing</span>
    <span class="n">intClass</span> <span class="o">=</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="c1">// genericIntClass = double.class; // Illegal</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p>泛型类引用只能赋值为指向其声明的类型，但是普通的类引用可以被重新赋值为指向任何其他的<code class="language-plaintext highlighter-rouge">Class</code>对象。通过使用泛型语法，可以让编译器强制执行额外的类型检查。</p><p>为了在使用泛化的<code class="language-plaintext highlighter-rouge">Class</code>引用时放松限制，我们使用通配符，它是<code class="language-plaintext highlighter-rouge">Java</code>泛型的一部分。通配符就是“?”，表示“任何事物”。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/WildcardClassReferences.java</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WildcardClassReferences</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">intClass</span> <span class="o">=</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="n">intClass</span> <span class="o">=</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p>在<code class="language-plaintext highlighter-rouge">Java SE5</code>中，<code class="language-plaintext highlighter-rouge">Class&lt;?&gt;</code>优于平凡的<code class="language-plaintext highlighter-rouge">Class</code>，即便它们是等价的，并且平凡的<code class="language-plaintext highlighter-rouge">Class</code>如你所见，不会产生编译器警告信息。<code class="language-plaintext highlighter-rouge">Class&lt;?&gt;</code>的好处是它表示你并非是碰巧或者由于疏忽，而使用了一个非具体的类引用，你就是选择了非具体的版本。</p><p>为了创建一个<code class="language-plaintext highlighter-rouge">Class</code>引用，它被限定为某种类型，或该类型的任何子类型，你需要将通配符与<code class="language-plaintext highlighter-rouge">extends</code>关键字相结合，创建一个<code class="language-plaintext highlighter-rouge">范围</code>.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/BoundedClassReferences.java</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BoundedClassReferences</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Number</span><span class="o">&gt;</span> <span class="n">bounded</span> <span class="o">=</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="n">bounded</span> <span class="o">=</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="n">bounded</span> <span class="o">=</span> <span class="nc">Number</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="c1">// Or anything else derived from Number.</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p>下面示例使用了泛型类语法。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/FilledList.java</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">CountedInteger</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">counter</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">counter</span><span class="o">++;</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="nc">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">id</span><span class="o">);</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FilledList</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">FilledList</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span> <span class="o">}</span>    
  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">nElements</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nElements</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
        <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">FilledList</span><span class="o">&lt;</span><span class="nc">CountedInteger</span><span class="o">&gt;</span> <span class="n">fl</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nc">FilledList</span><span class="o">&lt;</span><span class="nc">CountedInteger</span><span class="o">&gt;(</span><span class="nc">CountedInteger</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fl</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">15</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>将泛型语法用于<code class="language-plaintext highlighter-rouge">Class</code>对象时，会发生一件很有趣的事情：<code class="language-plaintext highlighter-rouge">newInstance()</code>将返回该对象的确切类型。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/toys/GenericToyTest.java</span>
<span class="c1">// Testing class Class.</span>
<span class="kn">package</span> <span class="nn">typeinfo.toys</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericToyTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">FancyToy</span><span class="o">&gt;</span> <span class="n">ftClass</span> <span class="o">=</span> <span class="nc">FancyToy</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="c1">// Produces exact type:</span>
    <span class="nc">FancyToy</span> <span class="n">fancyToy</span> <span class="o">=</span> <span class="n">ftClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">FancyToy</span><span class="o">&gt;</span> <span class="n">up</span> <span class="o">=</span> <span class="n">ftClass</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
    <span class="c1">// This won't compile:</span>
    <span class="c1">// Class&lt;Toy&gt; up2 = ftClass.getSuperclass();</span>
    <span class="c1">// Only produces Object:</span>
    <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><h3 id="1423-新的转型语法">14.2.3 新的转型语法</h3><p><code class="language-plaintext highlighter-rouge">Java SE5</code>还添加了用于<code class="language-plaintext highlighter-rouge">Class</code>引用的转型语法，即<code class="language-plaintext highlighter-rouge">cast()</code>方法：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/ClassCasts.java</span>

<span class="kd">class</span> <span class="nc">Building</span> <span class="o">{}</span>
<span class="kd">class</span> <span class="nc">House</span> <span class="kd">extends</span> <span class="nc">Building</span> <span class="o">{}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassCasts</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Building</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">House</span><span class="o">();</span>
    <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">House</span><span class="o">&gt;</span> <span class="n">houseType</span> <span class="o">=</span> <span class="nc">House</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="nc">House</span> <span class="n">h</span> <span class="o">=</span> <span class="n">houseType</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
    <span class="n">h</span> <span class="o">=</span> <span class="o">(</span><span class="nc">House</span><span class="o">)</span><span class="n">b</span><span class="o">;</span> <span class="c1">// ... or just do this.</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Class.asSubclass()</code>允许你将一个类对象转型为更加具体的类型。</p><h2 id="143-类型转换前先做检查">14.3 类型转换前先做检查</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Individual</span> <span class="kd">implements</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="nc">Individual</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">counter</span><span class="o">++;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Individual</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
  <span class="c1">// 'name' is optional:</span>
  <span class="kd">public</span> <span class="nf">Individual</span><span class="o">()</span> <span class="o">{}</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span>
      <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">id</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Individual</span> <span class="o">&amp;&amp;</span>
      <span class="n">id</span> <span class="o">==</span> <span class="o">((</span><span class="nc">Individual</span><span class="o">)</span><span class="n">o</span><span class="o">).</span><span class="na">id</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">17</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
      <span class="n">result</span> <span class="o">=</span> <span class="mi">37</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">37</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">id</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="nc">Individual</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Compare by class name first:</span>
    <span class="nc">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">argFirst</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">firstCompare</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">argFirst</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">firstCompare</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">return</span> <span class="n">firstCompare</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span><span class="o">.</span><span class="na">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">secondCompare</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">secondCompare</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">secondCompare</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">id</span> <span class="o">&lt;</span> <span class="n">id</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pet</span> <span class="kd">extends</span> <span class="nc">Individual</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Pet</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Pet</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//🐱</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cat</span> <span class="kd">extends</span> <span class="nc">Pet</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Cat</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Cat</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//🐶</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dog</span> <span class="kd">extends</span> <span class="nc">Pet</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Dog</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Dog</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//鼠类</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Rodent</span> <span class="kd">extends</span> <span class="nc">Pet</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Rodent</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Rodent</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//马恩岛🐱</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Manx</span> <span class="kd">extends</span> <span class="nc">Cat</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Manx</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Manx</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//埃及🐱</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EgyptianMau</span> <span class="kd">extends</span> <span class="nc">Cat</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">EgyptianMau</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">EgyptianMau</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//威尔士🐱</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cymric</span> <span class="kd">extends</span> <span class="nc">Manx</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Cymric</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Cymric</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//混血🐶</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mutt</span> <span class="kd">extends</span> <span class="nc">Dog</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Mutt</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Mutt</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//哈巴🐶</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pug</span> <span class="kd">extends</span> <span class="nc">Dog</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Pug</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Pug</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//大🐭</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Rat</span> <span class="kd">extends</span> <span class="nc">Rodent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Rat</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Rat</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span> 
<span class="c1">//仓鼠</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hamster</span> <span class="kd">extends</span> <span class="nc">Rodent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Hamster</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Hamster</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//小🐭</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mouse</span> <span class="kd">extends</span> <span class="nc">Rodent</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">Mouse</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Mouse</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>接下来，需要一种方法，通过它可以随机地创建不同类型的宠物，并且为方便起见，还可以创建宠物数组和<code class="language-plaintext highlighter-rouge">List</code>。为了使该工具能够适应多种不同的实现，我们将其定义为抽象类：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/pets/PetCreator.java</span>
<span class="c1">// Creates random sequences of Pets.</span>
<span class="kn">package</span> <span class="nn">typeinfo.pets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PetCreator</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">(</span><span class="mi">47</span><span class="o">);</span>
  <span class="c1">// The List of the different types of Pet to create:</span>
  <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;&gt;</span> <span class="nf">types</span><span class="o">();</span>
  <span class="kd">public</span> <span class="nc">Pet</span> <span class="nf">randomPet</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// Create one random Pet</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">types</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">types</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="nc">Pet</span><span class="o">[]</span> <span class="nf">createArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Pet</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Pet</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
      <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">randomPet</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Pet</span><span class="o">&gt;</span> <span class="nf">arrayList</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Pet</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Pet</span><span class="o">&gt;();</span>
    <span class="nc">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">createArray</span><span class="o">(</span><span class="n">size</span><span class="o">));</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p>使用<code class="language-plaintext highlighter-rouge">forName()</code>的一个具体实现：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForNameCreator</span> <span class="kd">extends</span> <span class="nc">PetCreator</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;&gt;</span> <span class="n">types</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;&gt;();</span>
  <span class="c1">// Types that you want to be randomly created:</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">typeNames</span> <span class="o">=</span> <span class="o">{</span>
    <span class="s">"typeinfo.pets.Mutt"</span><span class="o">,</span>
    <span class="s">"typeinfo.pets.Pug"</span><span class="o">,</span>
    <span class="s">"typeinfo.pets.EgyptianMau"</span><span class="o">,</span>
    <span class="s">"typeinfo.pets.Manx"</span><span class="o">,</span>
    <span class="s">"typeinfo.pets.Cymric"</span><span class="o">,</span>
    <span class="s">"typeinfo.pets.Rat"</span><span class="o">,</span>
    <span class="s">"typeinfo.pets.Mouse"</span><span class="o">,</span>
    <span class="s">"typeinfo.pets.Hamster"</span>
  <span class="o">};</span>    
  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">loader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">for</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">typeNames</span><span class="o">)</span>
        <span class="n">types</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
          <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;)</span><span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">static</span> <span class="o">{</span> <span class="n">loader</span><span class="o">();</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;&gt;</span> <span class="nf">types</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="n">types</span><span class="o">;}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p>使用<code class="language-plaintext highlighter-rouge">instanceof</code>来对<code class="language-plaintext highlighter-rouge">Pet</code>进行计数</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/PetCount.java</span>
<span class="c1">// Using instanceof.</span>
<span class="kn">import</span> <span class="nn">typeinfo.pets.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PetCount</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PetCounter</span> <span class="kd">extends</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">count</span><span class="o">(</span><span class="nc">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//获取数量</span>
      <span class="nc">Integer</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">quantity</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
      <span class="k">else</span>
        <span class="nf">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">quantity</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">countPets</span><span class="o">(</span><span class="nc">PetCreator</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">PetCounter</span> <span class="n">counter</span><span class="o">=</span> <span class="k">new</span> <span class="nc">PetCounter</span><span class="o">();</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">Pet</span> <span class="n">pet</span> <span class="o">:</span> <span class="n">creator</span><span class="o">.</span><span class="na">createArray</span><span class="o">(</span><span class="mi">20</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// List each individual pet:</span>
      <span class="n">printnb</span><span class="o">(</span><span class="n">pet</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Pet</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Pet"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Dog</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Dog"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Mutt</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Mutt"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Pug</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Pug"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Cat</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Cat"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Manx</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"EgyptianMau"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Manx</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Manx"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Manx</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Cymric"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Rodent</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Rodent"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Rat</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Rat"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Mouse</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Mouse"</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">pet</span> <span class="k">instanceof</span> <span class="nc">Hamster</span><span class="o">)</span>
        <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Hamster"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// Show the counts:</span>
    <span class="n">print</span><span class="o">();</span>
    <span class="n">print</span><span class="o">(</span><span class="n">counter</span><span class="o">);</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">countPets</span><span class="o">(</span><span class="k">new</span> <span class="nc">ForNameCreator</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
Rat Manx Cymric Mutt Pug Cymric Pug Manx Cymric Rat EgyptianMau Hamster EgyptianMau Mutt Mutt Cymric Mouse Pug Mouse Cymric
{Pug=3, Cat=9, Hamster=1, Cymric=7, Mouse=2, Mutt=3, Rodent=5, Pet=20, Manx=7, EgyptianMau=7, Dog=6, Rat=2}
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>对<code class="language-plaintext highlighter-rouge">instanceof</code>有比较严格的限制：只可将其与命名类型进行比较，而不能与<code class="language-plaintext highlighter-rouge">Class</code>对象作比较。</p><h3 id="1431-使用类字面常量">14.3.1 使用类字面常量</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LiteralPetCreator</span> <span class="kd">extends</span> <span class="nc">PetCreator</span> <span class="o">{</span>
  <span class="c1">// No try block needed.</span>
  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;&gt;</span> <span class="n">allTypes</span> <span class="o">=</span>
    <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
      <span class="nc">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Dog</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>  <span class="nc">Rodent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
      <span class="nc">Mutt</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Pug</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">EgyptianMau</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Manx</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
      <span class="nc">Cymric</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Rat</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Mouse</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="nc">Hamster</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
  <span class="c1">// Types for random creation:</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;&gt;</span> <span class="n">types</span> <span class="o">=</span>
    <span class="n">allTypes</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">allTypes</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="nc">Mutt</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
      <span class="n">allTypes</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;&gt;</span> <span class="nf">types</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">types</span><span class="o">;</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">types</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
[class typeinfo.pets.Mutt, class typeinfo.pets.Pug, class typeinfo.pets.EgyptianMau, class typeinfo.pets.Manx, class typeinfo.pets.Cymric, class typeinfo.pets.Rat, class typeinfo.pets.Mouse, class typeinfo.pets.Hamster]
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>将<code class="language-plaintext highlighter-rouge">LiteralPetCreator</code>实现作为默认实现。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pets</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">PetCreator</span> <span class="n">creator</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nf">LiteralPetCreator</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Pet</span> <span class="nf">randomPet</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">creator</span><span class="o">.</span><span class="na">randomPet</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Pet</span><span class="o">[]</span> <span class="nf">createArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">creator</span><span class="o">.</span><span class="na">createArray</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Pet</span><span class="o">&gt;</span> <span class="nf">arrayList</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">creator</span><span class="o">.</span><span class="na">arrayList</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p>因为<code class="language-plaintext highlighter-rouge">PetCount.countPets()</code>接受的是一个<code class="language-plaintext highlighter-rouge">PetCreator</code>参数，我们可以很容易地测试<code class="language-plaintext highlighter-rouge">LiteralPetCreator</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/PetCount2.java</span>
<span class="kn">import</span> <span class="nn">typeinfo.pets.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PetCount2</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">PetCount</span><span class="o">.</span><span class="na">countPets</span><span class="o">(</span><span class="nc">Pets</span><span class="o">.</span><span class="na">creator</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* (Execute to see output) */</span><span class="c1">//:~</span>
</pre></table></code></div></div><h3 id="1432-动态的instanceof">14.3.2 动态的instanceof</h3><p><code class="language-plaintext highlighter-rouge">Class.isInstance</code>方法提供了一种动态地测试对象的途径。于是所有那些单调的<code class="language-plaintext highlighter-rouge">instanceof</code>语句都可以从<code class="language-plaintext highlighter-rouge">PetCount</code>中移除。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/PetCount3.java</span>
<span class="c1">// Using isInstance()</span>
<span class="kn">import</span> <span class="nn">typeinfo.pets.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.mindview.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PetCount3</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PetCounter</span>
  <span class="kd">extends</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;,</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
      <span class="c1">//构造函数中put所有的Class</span>
    <span class="kd">public</span> <span class="nf">PetCounter</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="nc">MapData</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nc">LiteralPetCreator</span><span class="o">.</span><span class="na">allTypes</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">count</span><span class="o">(</span><span class="nc">Pet</span> <span class="n">pet</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Class.isInstance() eliminates instanceofs:</span>
      <span class="k">for</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;,</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">pair</span> <span class="o">:</span> <span class="n">entrySet</span><span class="o">())</span>
        <span class="k">if</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">isInstance</span><span class="o">(</span><span class="n">pet</span><span class="o">))</span>
          <span class="n">put</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">pair</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>    
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="s">"{"</span><span class="o">);</span>
      <span class="k">for</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Pet</span><span class="o">&gt;,</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">pair</span>
          <span class="o">:</span> <span class="n">entrySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">());</span>
        <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"="</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">", "</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">result</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">2</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
      <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"}"</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">PetCounter</span> <span class="n">petCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PetCounter</span><span class="o">();</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">Pet</span> <span class="n">pet</span> <span class="o">:</span> <span class="nc">Pets</span><span class="o">.</span><span class="na">createArray</span><span class="o">(</span><span class="mi">20</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">printnb</span><span class="o">(</span><span class="n">pet</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="n">petCount</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">pet</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">print</span><span class="o">();</span>
    <span class="n">print</span><span class="o">(</span><span class="n">petCount</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
Rat Manx Cymric Mutt Pug Cymric Pug Manx Cymric Rat EgyptianMau Hamster EgyptianMau Mutt Mutt Cymric Mouse Pug Mouse Cymric
{Pet=20, Dog=6, Cat=9, Rodent=5, Mutt=3, Pug=3, EgyptianMau=2, Manx=7, Cymric=5, Rat=2, Mouse=2, Hamster=1}
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><h3 id="1433-递归计数">14.3.3 递归计数</h3><p>在<code class="language-plaintext highlighter-rouge">PetCount3.PetCounter</code>中的<code class="language-plaintext highlighter-rouge">Map</code>预加载了所有不同的<code class="language-plaintext highlighter-rouge">Pet</code>类。与预加载映射表不同的是，我们可以使用<code class="language-plaintext highlighter-rouge">Class.isAssignableFrom()</code>，并创建一个不局限于<code class="language-plaintext highlighter-rouge">Pet</code>计数的通用工具。</p><p><code class="language-plaintext highlighter-rouge">isAssignableFrom()</code>方法：</p><blockquote><p>Determines if the class or interface represented by this Class object is either the same as, or is a superclass or superinterface of, the class or interface represented by the specified Class parameter. It returns true if so;otherwise it returns false.If this Class object represents a primitive type,this method returns true if the specified Class parameter is exactly this Class object; otherwise it returns false. 确定此Class对象表示的类或接口是否与指定的Class参数表示的类或接口相同，或者是否为超类或超接口。如果是，则返回true;否则返回false。如果此Class对象表示一个基本类型，如果指定的Class参数恰好是此Class对象则此方法返回true;否则返回false。</p></blockquote><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1">//: net/mindview/util/TypeCounter.java</span>
<span class="c1">// Counts instances of a type family.</span>
<span class="kn">package</span> <span class="nn">net.mindview.util</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TypeCounter</span> <span class="kd">extends</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span><span class="nc">Integer</span><span class="o">&gt;{</span>
  <span class="kd">private</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">baseType</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">TypeCounter</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">baseType</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">baseType</span> <span class="o">=</span> <span class="n">baseType</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">count</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">baseType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">type</span><span class="o">))</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">obj</span> <span class="o">+</span> <span class="s">" incorrect type: "</span>
        <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">", should be type or subtype of "</span>
        <span class="o">+</span> <span class="n">baseType</span><span class="o">);</span>
    <span class="n">countClass</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
  <span class="o">}</span>    
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">countClass</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Integer</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="n">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">quantity</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">quantity</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">superClass</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">superClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
       <span class="n">baseType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">superClass</span><span class="o">))</span>
      <span class="n">countClass</span><span class="o">(</span><span class="n">superClass</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="s">"{"</span><span class="o">);</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">pair</span> <span class="o">:</span> <span class="n">entrySet</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"="</span><span class="o">);</span>
      <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
      <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">", "</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">result</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">2</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
    <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"}"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/PetCount4.java</span>
<span class="kn">import</span> <span class="nn">typeinfo.pets.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.mindview.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PetCount4</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">TypeCounter</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TypeCounter</span><span class="o">(</span><span class="nc">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">Pet</span> <span class="n">pet</span> <span class="o">:</span> <span class="nc">Pets</span><span class="o">.</span><span class="na">createArray</span><span class="o">(</span><span class="mi">20</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">printnb</span><span class="o">(</span><span class="n">pet</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="n">counter</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">pet</span><span class="o">);</span><span class="c1">//遍历计数</span>
    <span class="o">}</span>
    <span class="n">print</span><span class="o">();</span>
    <span class="n">print</span><span class="o">(</span><span class="n">counter</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output: (Sample)
Rat Manx Cymric Mutt Pug Cymric Pug Manx Cymric Rat EgyptianMau Hamster EgyptianMau Mutt Mutt Cymric Mouse Pug Mouse Cymric
{Mouse=2, Dog=6, Manx=7, EgyptianMau=2, Rodent=5, Pug=3, Mutt=3, Cymric=5, Cat=9, Hamster=1, Pet=20, Rat=2}
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><h2 id="144-注册工厂">14.4 注册工厂</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/factory/Factory.java</span>
<span class="kn">package</span> <span class="nn">typeinfo.factory</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Factory</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span> <span class="no">T</span> <span class="nf">create</span><span class="o">();</span> <span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/RegisteredFactories.java</span>
<span class="c1">// Registering Class Factories in the base class.</span>
<span class="kn">import</span> <span class="nn">typeinfo.factory.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">Part</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Factory</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Part</span><span class="o">&gt;&gt;</span> <span class="n">partFactories</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Factory</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Part</span><span class="o">&gt;&gt;();</span>    
  <span class="kd">static</span> <span class="o">{</span>
    <span class="c1">// Collections.addAll() gives an "unchecked generic</span>
    <span class="c1">// array creation ... for varargs parameter" warning.</span>
    <span class="n">partFactories</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">FuelFilter</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
    <span class="n">partFactories</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">AirFilter</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
    <span class="n">partFactories</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">CabinAirFilter</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
    <span class="n">partFactories</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">OilFilter</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
    <span class="n">partFactories</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">FanBelt</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
    <span class="n">partFactories</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">PowerSteeringBelt</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
    <span class="n">partFactories</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">GeneratorBelt</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">(</span><span class="mi">47</span><span class="o">);</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Part</span> <span class="nf">createRandom</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">partFactories</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">partFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="na">create</span><span class="o">();</span> <span class="c1">//随机获取Factory并调用create方法</span>
  <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">class</span> <span class="nc">Filter</span> <span class="kd">extends</span> <span class="nc">Part</span> <span class="o">{}</span>

<span class="kd">class</span> <span class="nc">FuelFilter</span> <span class="kd">extends</span> <span class="nc">Filter</span> <span class="o">{</span>
  <span class="c1">// Create a Class Factory for each specific type:</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span>
  <span class="kd">implements</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">Factory</span><span class="o">&lt;</span><span class="nc">FuelFilter</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">FuelFilter</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">FuelFilter</span><span class="o">();</span> <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">AirFilter</span> <span class="kd">extends</span> <span class="nc">Filter</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span>
  <span class="kd">implements</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">Factory</span><span class="o">&lt;</span><span class="nc">AirFilter</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">AirFilter</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">AirFilter</span><span class="o">();</span> <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">class</span> <span class="nc">CabinAirFilter</span> <span class="kd">extends</span> <span class="nc">Filter</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span>
  <span class="kd">implements</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">Factory</span><span class="o">&lt;</span><span class="nc">CabinAirFilter</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">CabinAirFilter</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">CabinAirFilter</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">OilFilter</span> <span class="kd">extends</span> <span class="nc">Filter</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span>
  <span class="kd">implements</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">Factory</span><span class="o">&lt;</span><span class="nc">OilFilter</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">OilFilter</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">OilFilter</span><span class="o">();</span> <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">class</span> <span class="nc">Belt</span> <span class="kd">extends</span> <span class="nc">Part</span> <span class="o">{}</span>

<span class="kd">class</span> <span class="nc">FanBelt</span> <span class="kd">extends</span> <span class="nc">Belt</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span>
  <span class="kd">implements</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">Factory</span><span class="o">&lt;</span><span class="nc">FanBelt</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">FanBelt</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">FanBelt</span><span class="o">();</span> <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">GeneratorBelt</span> <span class="kd">extends</span> <span class="nc">Belt</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span>
  <span class="kd">implements</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">Factory</span><span class="o">&lt;</span><span class="nc">GeneratorBelt</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">GeneratorBelt</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">GeneratorBelt</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">class</span> <span class="nc">PowerSteeringBelt</span> <span class="kd">extends</span> <span class="nc">Belt</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span>
  <span class="kd">implements</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">Factory</span><span class="o">&lt;</span><span class="nc">PowerSteeringBelt</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">PowerSteeringBelt</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">PowerSteeringBelt</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegisteredFactories</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Part</span><span class="o">.</span><span class="na">createRandom</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
GeneratorBelt
CabinAirFilter
GeneratorBelt
AirFilter
PowerSteeringBelt
CabinAirFilter
FuelFilter
PowerSteeringBelt
PowerSteeringBelt
FuelFilter
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><h2 id="145-instanceof与class的等价性">14.5 instanceof与Class的等价性</h2><p>在查询类型信息时，以<code class="language-plaintext highlighter-rouge">instanceof</code>的形式与直接比较<code class="language-plaintext highlighter-rouge">Class</code>对象有一个很重要的差别。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/FamilyVsExactType.java</span>
<span class="c1">// The difference between instanceof and class</span>
<span class="kn">package</span> <span class="nn">typeinfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">class</span> <span class="nc">Base</span> <span class="o">{}</span>
<span class="kd">class</span> <span class="nc">Derived</span> <span class="kd">extends</span> <span class="nc">Base</span> <span class="o">{}</span>    

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FamilyVsExactType</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(</span><span class="nc">Object</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"Testing x of type "</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"x instanceof Base "</span> <span class="o">+</span> <span class="o">(</span><span class="n">x</span> <span class="k">instanceof</span> <span class="nc">Base</span><span class="o">));</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"x instanceof Derived "</span><span class="o">+</span> <span class="o">(</span><span class="n">x</span> <span class="k">instanceof</span> <span class="nc">Derived</span><span class="o">));</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"Base.isInstance(x) "</span><span class="o">+</span> <span class="nc">Base</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">x</span><span class="o">));</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"Derived.isInstance(x) "</span> <span class="o">+</span>
      <span class="nc">Derived</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">x</span><span class="o">));</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"x.getClass() == Base.class "</span> <span class="o">+</span>
      <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">==</span> <span class="nc">Base</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"x.getClass() == Derived.class "</span> <span class="o">+</span>
      <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">==</span> <span class="nc">Derived</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"x.getClass().equals(Base.class)) "</span><span class="o">+</span>
      <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Base</span><span class="o">.</span><span class="na">class</span><span class="o">)));</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"x.getClass().equals(Derived.class)) "</span> <span class="o">+</span>
      <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Derived</span><span class="o">.</span><span class="na">class</span><span class="o">)));</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">test</span><span class="o">(</span><span class="k">new</span> <span class="nc">Base</span><span class="o">());</span>
    <span class="n">test</span><span class="o">(</span><span class="k">new</span> <span class="nc">Derived</span><span class="o">());</span>
  <span class="o">}</span>    
<span class="o">}</span> <span class="cm">/* Output:
Testing x of type class typeinfo.Base
x instanceof Base true
x instanceof Derived false
Base.isInstance(x) true
Derived.isInstance(x) false
x.getClass() == Base.class true
x.getClass() == Derived.class false
x.getClass().equals(Base.class)) true
x.getClass().equals(Derived.class)) false
Testing x of type class typeinfo.Derived
x instanceof Base true
x instanceof Derived true
Base.isInstance(x) true
Derived.isInstance(x) true
x.getClass() == Base.class false
x.getClass() == Derived.class true
x.getClass().equals(Base.class)) false
x.getClass().equals(Derived.class)) true
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">instanceof</code>和<code class="language-plaintext highlighter-rouge">isInstance()</code>生成的结果完全一样，<code class="language-plaintext highlighter-rouge">equals()</code>和<code class="language-plaintext highlighter-rouge">==</code>也一样。但是这两组测试得出的结论却不相同。<code class="language-plaintext highlighter-rouge">instanceof</code>保持了类型的概念,它指的是“你是这个类吗？，或者你是这个类的派生类吗？”而如果用<code class="language-plaintext highlighter-rouge">==</code>比较实际的<code class="language-plaintext highlighter-rouge">Class</code>对象，就没有考虑继承，它是这个确切的类型，或者不是。</p><h2 id="146-反射运行时的类信息">14.6 反射：运行时的类信息</h2><h3 id="1461-类方法提取器">14.6.1 类方法提取器</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/ShowMethods.java</span>
<span class="c1">// Using reflection to show all the methods of a class,</span>
<span class="c1">// even if the methods are defined in the base class.</span>
<span class="c1">// {Args: ShowMethods}</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShowMethods</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="n">usage</span> <span class="o">=</span>
    <span class="s">"usage:\n"</span> <span class="o">+</span>
    <span class="s">"ShowMethods qualified.class.name\n"</span> <span class="o">+</span>
    <span class="s">"To show all methods in class or:\n"</span> <span class="o">+</span>
    <span class="s">"ShowMethods qualified.class.name word\n"</span> <span class="o">+</span>
    <span class="s">"To search for methods involving 'word'"</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Pattern</span> <span class="n">p</span> <span class="o">=</span> <span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"\\w+\\."</span><span class="o">);</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">print</span><span class="o">(</span><span class="n">usage</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span><span class="c1">//返回Method对象的数组</span>
      <span class="nc">Constructor</span><span class="o">[]</span> <span class="n">ctors</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getConstructors</span><span class="o">();</span><span class="c1">//返回Constructor对象的数组</span>
      <span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span>
          <span class="n">print</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">""</span><span class="o">));</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Constructor</span> <span class="n">ctor</span> <span class="o">:</span> <span class="n">ctors</span><span class="o">)</span>
          <span class="n">print</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">ctor</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">""</span><span class="o">));</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">ctors</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span>
          <span class="k">if</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">indexOf</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">])</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">print</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">""</span><span class="o">));</span>
            <span class="n">lines</span><span class="o">++;</span>
          <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Constructor</span> <span class="n">ctor</span> <span class="o">:</span> <span class="n">ctors</span><span class="o">)</span>
          <span class="k">if</span><span class="o">(</span><span class="n">ctor</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">indexOf</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">])</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">print</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span>
              <span class="n">ctor</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">""</span><span class="o">));</span>
            <span class="n">lines</span><span class="o">++;</span>
          <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">print</span><span class="o">(</span><span class="s">"No such class: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
public static void main(String[])
public native int hashCode()
public final native Class getClass()
public final void wait(long,int) throws InterruptedException
public final void wait() throws InterruptedException
public final native void wait(long) throws InterruptedException
public boolean equals(Object)
public String toString()
public final native void notify()
public final native void notifyAll()
public ShowMethods()
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><h2 id="147-动态代理">14.7 动态代理</h2><p><code class="language-plaintext highlighter-rouge">代理</code>是基本的设计模式之一，它是你为了提供额外的或不同的操作，而插入的用来代替”实际“对象的对象。这些操作通常设计与“实际”对象的通信，因此代理通常充当着中间人的角色。下面是一个用来展示代理结构的简单示例：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">Interface</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">();</span>

    <span class="kt">void</span> <span class="nf">somethingElse</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c1">//实现Interface</span>
<span class="kd">class</span> <span class="nc">RealObject</span> <span class="kd">implements</span> <span class="nc">Interface</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"doSomething"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">somethingElse</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"somethingElse "</span> <span class="o">+</span> <span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">SimpleProxy</span> <span class="kd">implements</span> <span class="nc">Interface</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Interface</span> <span class="n">proxied</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SimpleProxy</span><span class="o">(</span><span class="nc">Interface</span> <span class="n">proxied</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">proxied</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SimpleProxy doSomething"</span><span class="o">);</span>
        <span class="n">proxied</span><span class="o">.</span><span class="na">doSomething</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">somethingElse</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SimpleProxy somethingElse"</span> <span class="o">+</span> <span class="n">arg</span><span class="o">);</span>
        <span class="n">proxied</span><span class="o">.</span><span class="na">somethingElse</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleProxyDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">consumer</span><span class="o">(</span><span class="nc">Interface</span> <span class="n">iface</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">iface</span><span class="o">.</span><span class="na">doSomething</span><span class="o">();</span>
        <span class="n">iface</span><span class="o">.</span><span class="na">somethingElse</span><span class="o">(</span><span class="s">"bonobo"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">consumer</span><span class="o">(</span><span class="k">new</span> <span class="nc">RealObject</span><span class="o">());</span>
        <span class="n">consumer</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleProxy</span><span class="o">(</span><span class="k">new</span> <span class="nc">RealObject</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>在任何时刻，只要你想要将额外的操作从“实际”对象中分离到不同的地方，特别是当你希望能够很容易地做出修改，<strong>从</strong>没有使用额外操作<strong>转为</strong>使用这些操作，或者反过来时，代理就显得很有用。例如，如果你希望跟踪对<code class="language-plaintext highlighter-rouge">RealObject</code>中的方法的调用，或者希望度量这些调用的开销，这些代码肯定是你不希望将其合并到应用中的代码，因此代理使得你可以很容易地添加或者移除它们。（总结：额外的操作与实际的对象分离，可以很容易地添加或者移除这些额外的操作）。</p><p><code class="language-plaintext highlighter-rouge">Java</code>的动态代理比代理的思想更向前迈进了一步，因为它可以动态地创建代理并动态地处理对所代理方法的调用。在动态代理上所做的所有调用都会被重定向到单一的<code class="language-plaintext highlighter-rouge">调用处理器</code>上，它的工作是揭示调用的类型并确定相应的对策。下面是用动态代理重写的<code class="language-plaintext highlighter-rouge">SimpleDynamicProxy</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamicProxyHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Object</span> <span class="n">proxied</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">DynamicProxyHandler</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxied</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">proxied</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"**** proxy: "</span> <span class="o">+</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span>
                <span class="s">", method: "</span> <span class="o">+</span> <span class="n">method</span> <span class="o">+</span> <span class="s">", args: "</span> <span class="o">+</span> <span class="n">args</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">for</span><span class="o">(</span><span class="nc">Object</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  "</span> <span class="o">+</span> <span class="n">arg</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">proxied</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleDynamicProxy</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">consumer</span><span class="o">(</span><span class="nc">Interface</span> <span class="n">iface</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">iface</span><span class="o">.</span><span class="na">doSomething</span><span class="o">();</span>
        <span class="n">iface</span><span class="o">.</span><span class="na">somethingElse</span><span class="o">(</span><span class="s">"bonobo"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RealObject</span> <span class="n">real</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RealObject</span><span class="o">();</span>
        <span class="n">consumer</span><span class="o">(</span><span class="n">real</span><span class="o">);</span>
        <span class="nc">Interface</span> <span class="n">proxy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Interface</span><span class="o">)</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
                <span class="nc">Interface</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nc">Class</span><span class="o">[]{</span><span class="nc">Interface</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="c1">//实现多个接口</span>
                <span class="k">new</span> <span class="nf">DynamicProxyHandler</span><span class="o">(</span><span class="n">real</span><span class="o">)</span>
        <span class="o">);</span>
        <span class="n">consumer</span><span class="o">(</span><span class="n">proxy</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>通过调用静态方法<code class="language-plaintext highlighter-rouge">Proxy.newProxyInstance()</code>可以创建动态代理，这个方法需要得到一个类加载器（你通常可以从已经被加载的对象中获取其类加载器，然后传递给它），一个你希望<strong>该代理实现的接口列表</strong>（不是类或抽象类），以及<code class="language-plaintext highlighter-rouge">InvocationHandler</code>接口的一个实现。动态代理可以将所有调用重定向到调用处理器，因此通常会向调用处理器的构造器传递给一个“实际”对象的引用，从而使得调用处理器在执行其中介任务时，可以将请求转发。</p><p><code class="language-plaintext highlighter-rouge">invoke()</code>方法中传递进来的代理对象，以防你需要区分请求的来源，但是在许多情况下，你并不关心这一点。然后，在<code class="language-plaintext highlighter-rouge">invoke()</code>内部，在代理上调用方法时需要格外当心，因为对接口的调用将被重定向为对代理的调用。</p><p>你可以通过传递某些参数，来过滤某些方法调用：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/SelectingMethods.java</span>
<span class="c1">// Looking for particular methods in a dynamic proxy.</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">class</span> <span class="nc">MethodSelector</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">Object</span> <span class="n">proxied</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">MethodSelector</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxied</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">proxied</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"interesting"</span><span class="o">))</span>
      <span class="n">print</span><span class="o">(</span><span class="s">"Proxy detected the interesting method"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">proxied</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">interface</span> <span class="nc">SomeMethods</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">boring1</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">boring2</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">interesting</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">);</span>
  <span class="kt">void</span> <span class="nf">boring3</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Implementation</span> <span class="kd">implements</span> <span class="nc">SomeMethods</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boring1</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"boring1"</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boring2</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"boring2"</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">interesting</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">print</span><span class="o">(</span><span class="s">"interesting "</span> <span class="o">+</span> <span class="n">arg</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">boring3</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"boring3"</span><span class="o">);</span> <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">class</span> <span class="nc">SelectingMethods</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">SomeMethods</span> <span class="n">proxy</span><span class="o">=</span> <span class="o">(</span><span class="nc">SomeMethods</span><span class="o">)</span><span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
      <span class="nc">SomeMethods</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
      <span class="k">new</span> <span class="nc">Class</span><span class="o">[]{</span> <span class="nc">SomeMethods</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span>
      <span class="k">new</span> <span class="nf">MethodSelector</span><span class="o">(</span><span class="k">new</span> <span class="nc">Implementation</span><span class="o">()));</span>
    <span class="n">proxy</span><span class="o">.</span><span class="na">boring1</span><span class="o">();</span>
    <span class="n">proxy</span><span class="o">.</span><span class="na">boring2</span><span class="o">();</span>
    <span class="n">proxy</span><span class="o">.</span><span class="na">interesting</span><span class="o">(</span><span class="s">"bonobo"</span><span class="o">);</span>
    <span class="n">proxy</span><span class="o">.</span><span class="na">boring3</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
boring1
boring2
Proxy detected the interesting method
interesting bonobo
boring3
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><h2 id="148-空对象">14.8 空对象</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">//: net/mindview/util/Null.java</span>
<span class="kn">package</span> <span class="nn">net.mindview.util</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Null</span> <span class="o">{}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/Person.java</span>
<span class="c1">// A class with a Null Object.</span>
<span class="kn">import</span> <span class="nn">net.mindview.util.*</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">first</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">last</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>
  <span class="c1">// etc.</span>
  <span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="nc">String</span> <span class="n">first</span><span class="o">,</span> <span class="nc">String</span> <span class="n">last</span><span class="o">,</span> <span class="nc">String</span> <span class="n">address</span><span class="o">){</span>
    <span class="k">this</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">last</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"Person: "</span> <span class="o">+</span> <span class="n">first</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">last</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NullPerson</span>
  <span class="kd">extends</span> <span class="nc">Person</span> <span class="kd">implements</span> <span class="nc">Null</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nf">NullPerson</span><span class="o">()</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="s">"None"</span><span class="o">,</span> <span class="s">"None"</span><span class="o">,</span> <span class="s">"None"</span><span class="o">);</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"NullPerson"</span><span class="o">;</span> <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Person</span> <span class="no">NULL</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NullPerson</span><span class="o">();</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/Position.java</span>

<span class="kd">class</span> <span class="nc">Position</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Person</span> <span class="n">person</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Position</span><span class="o">(</span><span class="nc">String</span> <span class="n">jobTitle</span><span class="o">,</span> <span class="nc">Person</span> <span class="n">employee</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">jobTitle</span><span class="o">;</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">employee</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">person</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
      <span class="n">person</span> <span class="o">=</span> <span class="nc">Person</span><span class="o">.</span><span class="na">NULL</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Position</span><span class="o">(</span><span class="nc">String</span> <span class="n">jobTitle</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">jobTitle</span><span class="o">;</span>
    <span class="n">person</span> <span class="o">=</span> <span class="nc">Person</span><span class="o">.</span><span class="na">NULL</span><span class="o">;</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">title</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">newTitle</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">newTitle</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">Person</span> <span class="nf">getPerson</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">person</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPerson</span><span class="o">(</span><span class="nc">Person</span> <span class="n">newPerson</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">newPerson</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">person</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
      <span class="n">person</span> <span class="o">=</span> <span class="nc">Person</span><span class="o">.</span><span class="na">NULL</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"Position: "</span> <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">person</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/Staff.java</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Staff</span> <span class="kd">extends</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Position</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Position</span><span class="o">(</span><span class="n">title</span><span class="o">,</span> <span class="n">person</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">titles</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span> <span class="o">:</span> <span class="n">titles</span><span class="o">)</span>
      <span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Position</span><span class="o">(</span><span class="n">title</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">Staff</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">titles</span><span class="o">)</span> <span class="o">{</span> <span class="n">add</span><span class="o">(</span><span class="n">titles</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">positionAvailable</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">Position</span> <span class="n">position</span> <span class="o">:</span> <span class="k">this</span><span class="o">)</span>
      <span class="k">if</span><span class="o">(</span><span class="n">position</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">title</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">position</span><span class="o">.</span><span class="na">getPerson</span><span class="o">()</span> <span class="o">==</span> <span class="nc">Person</span><span class="o">.</span><span class="na">NULL</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fillPosition</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">Person</span> <span class="n">hire</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">Position</span> <span class="n">position</span> <span class="o">:</span> <span class="k">this</span><span class="o">)</span>
      <span class="k">if</span><span class="o">(</span><span class="n">position</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">title</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">position</span><span class="o">.</span><span class="na">getPerson</span><span class="o">()</span> <span class="o">==</span> <span class="nc">Person</span><span class="o">.</span><span class="na">NULL</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">position</span><span class="o">.</span><span class="na">setPerson</span><span class="o">(</span><span class="n">hire</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
      <span class="s">"Position "</span> <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="s">" not available"</span><span class="o">);</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Staff</span> <span class="n">staff</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Staff</span><span class="o">(</span><span class="s">"President"</span><span class="o">,</span> <span class="s">"CTO"</span><span class="o">,</span>
      <span class="s">"Marketing Manager"</span><span class="o">,</span> <span class="s">"Product Manager"</span><span class="o">,</span>
      <span class="s">"Project Lead"</span><span class="o">,</span> <span class="s">"Software Engineer"</span><span class="o">,</span>
      <span class="s">"Software Engineer"</span><span class="o">,</span> <span class="s">"Software Engineer"</span><span class="o">,</span>
      <span class="s">"Software Engineer"</span><span class="o">,</span> <span class="s">"Test Engineer"</span><span class="o">,</span>
      <span class="s">"Technical Writer"</span><span class="o">);</span>
    <span class="n">staff</span><span class="o">.</span><span class="na">fillPosition</span><span class="o">(</span><span class="s">"President"</span><span class="o">,</span>
      <span class="k">new</span> <span class="nf">Person</span><span class="o">(</span><span class="s">"Me"</span><span class="o">,</span> <span class="s">"Last"</span><span class="o">,</span> <span class="s">"The Top, Lonely At"</span><span class="o">));</span>
    <span class="n">staff</span><span class="o">.</span><span class="na">fillPosition</span><span class="o">(</span><span class="s">"Project Lead"</span><span class="o">,</span>
      <span class="k">new</span> <span class="nf">Person</span><span class="o">(</span><span class="s">"Janet"</span><span class="o">,</span> <span class="s">"Planner"</span><span class="o">,</span> <span class="s">"The Burbs"</span><span class="o">));</span>
    <span class="k">if</span><span class="o">(</span><span class="n">staff</span><span class="o">.</span><span class="na">positionAvailable</span><span class="o">(</span><span class="s">"Software Engineer"</span><span class="o">))</span>
      <span class="n">staff</span><span class="o">.</span><span class="na">fillPosition</span><span class="o">(</span><span class="s">"Software Engineer"</span><span class="o">,</span>
        <span class="k">new</span> <span class="nf">Person</span><span class="o">(</span><span class="s">"Bob"</span><span class="o">,</span> <span class="s">"Coder"</span><span class="o">,</span> <span class="s">"Bright Light City"</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">staff</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:    
[Position: President Person: Me Last The Top, Lonely At, Position: CTO NullPerson, Position: Marketing Manager NullPerson, Position: Product Manager NullPerson, Position: Project Lead Person: Janet Planner The Burbs, Position: Software Engineer Person: Bob Coder Bright Light City, Position: Software Engineer NullPerson, Position: Software Engineer NullPerson, Position: Software Engineer NullPerson, Position: Test Engineer NullPerson, Position: Technical Writer NullPerson]
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/Operation.java</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Operation</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">description</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">command</span><span class="o">();</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/Robot.java</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.mindview.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Robot</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">name</span><span class="o">();</span>
  <span class="nc">String</span> <span class="nf">model</span><span class="o">();</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Operation</span><span class="o">&gt;</span> <span class="nf">operations</span><span class="o">();</span>
  <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(</span><span class="nc">Robot</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span><span class="o">(</span><span class="n">r</span> <span class="k">instanceof</span> <span class="nc">Null</span><span class="o">)</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[Null Robot]"</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Robot name: "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Robot model: "</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">model</span><span class="o">());</span>
      <span class="k">for</span><span class="o">(</span><span class="nc">Operation</span> <span class="n">operation</span> <span class="o">:</span> <span class="n">r</span><span class="o">.</span><span class="na">operations</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">operation</span><span class="o">.</span><span class="na">description</span><span class="o">());</span>
        <span class="n">operation</span><span class="o">.</span><span class="na">command</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p>创建一个扫雪<code class="language-plaintext highlighter-rouge">Robot</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/SnowRemovalRobot.java</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SnowRemovalRobot</span> <span class="kd">implements</span> <span class="nc">Robot</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">SnowRemovalRobot</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span><span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;}</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">name</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">model</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"SnowBot Series 11"</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Operation</span><span class="o">&gt;</span> <span class="nf">operations</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">Operation</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">description</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s">" can shovel snow"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">command</span><span class="o">()</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" shoveling snow"</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">},</span>    
      <span class="k">new</span> <span class="nf">Operation</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">description</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s">" can chip ice"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">command</span><span class="o">()</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" chipping ice"</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">},</span>
      <span class="k">new</span> <span class="nf">Operation</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">description</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s">" can clear the roof"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">command</span><span class="o">()</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" clearing roof"</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Robot</span><span class="o">.</span><span class="na">Test</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="k">new</span> <span class="nc">SnowRemovalRobot</span><span class="o">(</span><span class="s">"Slusher"</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
Robot name: Slusher
Robot model: SnowBot Series 11
Slusher can shovel snow
Slusher shoveling snow
Slusher can chip ice
Slusher chipping ice
Slusher can clear the roof
Slusher clearing roof
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>假设存在许多不同类型的<code class="language-plaintext highlighter-rouge">Robot</code>，我们想对每一种<code class="language-plaintext highlighter-rouge">Robot</code>类型都创建一个空对象，去执行某些特殊操作。在本例中，即提供空对象所代表的<code class="language-plaintext highlighter-rouge">Robot</code>确切类型的信息。这些信息是通过动态代理捕获的：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/NullRobot.java</span>
<span class="c1">// Using a dynamic proxy to create a Null Object.</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.mindview.util.*</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">NullRobotProxyHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">nullName</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Robot</span> <span class="n">proxied</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NRobot</span><span class="o">();</span>
  <span class="nc">NullRobotProxyHandler</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Robot</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">nullName</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" NullRobot"</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">class</span> <span class="nc">NRobot</span> <span class="kd">implements</span> <span class="nc">Null</span><span class="o">,</span> <span class="nc">Robot</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">name</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nullName</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">model</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nullName</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Operation</span><span class="o">&gt;</span> <span class="nf">operations</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span><span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">proxied</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NullRobot</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Robot</span> <span class="nf">newNullRobot</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Robot</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="nc">Robot</span><span class="o">)</span><span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
      <span class="nc">NullRobot</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
      <span class="k">new</span> <span class="nc">Class</span><span class="o">[]{</span> <span class="nc">Null</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Robot</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span> <span class="c1">//</span>
      <span class="k">new</span> <span class="nf">NullRobotProxyHandler</span><span class="o">(</span><span class="n">type</span><span class="o">));</span><span class="c1">//SnowRemovalRobot实现Null接口。</span>
  <span class="o">}</span>    
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Robot</span><span class="o">[]</span> <span class="n">bots</span> <span class="o">=</span> <span class="o">{</span>
      <span class="k">new</span> <span class="nf">SnowRemovalRobot</span><span class="o">(</span><span class="s">"SnowBee"</span><span class="o">),</span>
      <span class="n">newNullRobot</span><span class="o">(</span><span class="nc">SnowRemovalRobot</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">};</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">Robot</span> <span class="n">bot</span> <span class="o">:</span> <span class="n">bots</span><span class="o">)</span>
      <span class="nc">Robot</span><span class="o">.</span><span class="na">Test</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">bot</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
Robot name: SnowBee
Robot model: SnowBot Series 11
SnowBee can shovel snow
SnowBee shoveling snow
SnowBee can chip ice
SnowBee chipping ice
SnowBee can clear the roof
SnowBee clearing roof
[Null Robot]
Robot name: SnowRemovalRobot NullRobot
Robot model: SnowRemovalRobot NullRobot
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>无论何时，如果你需要一个空<code class="language-plaintext highlighter-rouge">Robot</code>对象，只需调用<code class="language-plaintext highlighter-rouge">newNullRobot()</code>，并传递需要代理的<code class="language-plaintext highlighter-rouge">Robot</code>类型。代理会满足<code class="language-plaintext highlighter-rouge">Robot</code>和<code class="language-plaintext highlighter-rouge">Null</code>接口的需求，并提供它所代理的类型的确切名字。</p><h2 id="149-接口与类型信息">14.9 接口与类型信息</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/interfacea/A.java</span>
<span class="kn">package</span> <span class="nn">typeinfo.interfacea</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">A</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">f</span><span class="o">();</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/InterfaceViolation.java</span>
<span class="c1">// Sneaking around an interface.</span>
<span class="kn">import</span> <span class="nn">typeinfo.interfacea.*</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">B</span> <span class="kd">implements</span> <span class="no">A</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">f</span><span class="o">()</span> <span class="o">{}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">g</span><span class="o">()</span> <span class="o">{}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InterfaceViolation</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">A</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="no">B</span><span class="o">();</span>
    <span class="n">a</span><span class="o">.</span><span class="na">f</span><span class="o">();</span>
    <span class="c1">// a.g(); // Compile error</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="k">if</span><span class="o">(</span><span class="n">a</span> <span class="k">instanceof</span> <span class="no">B</span><span class="o">)</span> <span class="o">{</span>
      <span class="no">B</span> <span class="n">b</span> <span class="o">=</span> <span class="o">(</span><span class="no">B</span><span class="o">)</span><span class="n">a</span><span class="o">;</span>
      <span class="n">b</span><span class="o">.</span><span class="na">g</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
B
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>对实现使用包访问权限，这样在包外部的客户端就不能看到它了：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/packageaccess/HiddenC.java</span>
<span class="kn">package</span> <span class="nn">typeinfo.packageaccess</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">typeinfo.interfacea.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">class</span> <span class="nc">C</span> <span class="kd">implements</span> <span class="no">A</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">f</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"public C.f()"</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">g</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"public C.g()"</span><span class="o">);</span> <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">u</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"package C.u()"</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">v</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"protected C.v()"</span><span class="o">);</span> <span class="o">}</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">w</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"private C.w()"</span><span class="o">);</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HiddenC</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="no">A</span> <span class="nf">makeA</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="k">new</span> <span class="no">C</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span> <span class="c1">///:~</span>
</pre></table></code></div></div><p>如果试图将其向下转型为C，则将被禁止，因为在包的外部没有任何C类型可用。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/HiddenImplementation.java</span>
<span class="c1">// Sneaking around package access.</span>
<span class="kn">import</span> <span class="nn">typeinfo.interfacea.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">typeinfo.packageaccess.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HiddenImplementation</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="no">A</span> <span class="n">a</span> <span class="o">=</span> <span class="nc">HiddenC</span><span class="o">.</span><span class="na">makeA</span><span class="o">();</span>
    <span class="n">a</span><span class="o">.</span><span class="na">f</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="c1">// Compile error: cannot find symbol 'C':</span>
    <span class="cm">/* if(a instanceof C) {
      C c = (C)a;
      c.g();
    } */</span>
    <span class="c1">// Oops! Reflection still allows us to call g():</span>
    <span class="n">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"g"</span><span class="o">);</span>
    <span class="c1">// And even methods that are less accessible!</span>
    <span class="n">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"u"</span><span class="o">);</span>
    <span class="n">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"v"</span><span class="o">);</span>
    <span class="n">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"w"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">static</span> <span class="kt">void</span> <span class="nf">callHiddenMethod</span><span class="o">(</span><span class="nc">Object</span> <span class="n">a</span><span class="o">,</span> <span class="nc">String</span> <span class="n">methodName</span><span class="o">)</span><span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Method</span> <span class="n">g</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
    <span class="n">g</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">g</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
public C.f()
typeinfo.packageaccess.C
public C.g()
package C.u()
protected C.v()
private C.w()
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>通过使用反射，仍旧可以到达并调用所有方法，甚至是<code class="language-plaintext highlighter-rouge">private</code>方法！如果知道方法名，可以在其<code class="language-plaintext highlighter-rouge">Method</code>对象上调用<code class="language-plaintext highlighter-rouge">setAccessible(true)</code>，就像在<code class="language-plaintext highlighter-rouge">callHiddenMethod()</code>中看到的那样。</p><p>使用命令行：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">java</span> <span class="o">-</span><span class="kd">private</span> <span class="no">C</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">-private</code>标志表示所有的成员都应该显示，甚至包括私有成员。下面是输出：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">typeinfo</span><span class="o">.</span><span class="na">packageaccess</span><span class="o">.</span><span class="na">C</span> <span class="kd">implements</span> <span class="n">typeinfo</span><span class="o">.</span><span class="na">interfacea</span><span class="o">.</span><span class="na">A</span> <span class="o">{</span>
  <span class="n">typeinfo</span><span class="o">.</span><span class="na">packageaccess</span><span class="o">.</span><span class="na">C</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">f</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">g</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">u</span><span class="o">();</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">v</span><span class="o">();</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">w</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>因此任何人都可以获取你最私有的方法的名字和签名，然后调用它们。</p><p>如果你将接口实现为一个私有内部类，又会怎样呢？</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/InnerImplementation.java</span>
<span class="c1">// Private inner classes can't hide from reflection.</span>
<span class="kn">import</span> <span class="nn">typeinfo.interfacea.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">class</span> <span class="nc">InnerA</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">C</span> <span class="kd">implements</span> <span class="no">A</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">f</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"public C.f()"</span><span class="o">);</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">g</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"public C.g()"</span><span class="o">);</span> <span class="o">}</span>
    <span class="kt">void</span> <span class="nf">u</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"package C.u()"</span><span class="o">);</span> <span class="o">}</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">v</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"protected C.v()"</span><span class="o">);</span> <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">w</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"private C.w()"</span><span class="o">);</span> <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="no">A</span> <span class="nf">makeA</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="k">new</span> <span class="no">C</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InnerImplementation</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="no">A</span> <span class="n">a</span> <span class="o">=</span> <span class="nc">InnerA</span><span class="o">.</span><span class="na">makeA</span><span class="o">();</span>
    <span class="n">a</span><span class="o">.</span><span class="na">f</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="c1">// Reflection still gets into the private class:</span>
    <span class="nc">HiddenImplementation</span><span class="o">.</span><span class="na">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"g"</span><span class="o">);</span>
    <span class="nc">HiddenImplementation</span><span class="o">.</span><span class="na">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"u"</span><span class="o">);</span>
    <span class="nc">HiddenImplementation</span><span class="o">.</span><span class="na">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"v"</span><span class="o">);</span>
    <span class="nc">HiddenImplementation</span><span class="o">.</span><span class="na">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"w"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
public C.f()
InnerA$C
public C.g()
package C.u()
protected C.v()
private C.w()
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>这里对反射仍旧没有隐藏任何东西。那么如果是匿名类呢？</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/AnonymousImplementation.java</span>
<span class="c1">// Anonymous inner classes can't hide from reflection.</span>
<span class="kn">import</span> <span class="nn">typeinfo.interfacea.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">mindview</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Print</span><span class="o">.*;</span>

<span class="kd">class</span> <span class="nc">AnonymousA</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="no">A</span> <span class="nf">makeA</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">A</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">f</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"public C.f()"</span><span class="o">);</span> <span class="o">}</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">g</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"public C.g()"</span><span class="o">);</span> <span class="o">}</span>
      <span class="kt">void</span> <span class="nf">u</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"package C.u()"</span><span class="o">);</span> <span class="o">}</span>
      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">v</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"protected C.v()"</span><span class="o">);</span> <span class="o">}</span>
      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">w</span><span class="o">()</span> <span class="o">{</span> <span class="n">print</span><span class="o">(</span><span class="s">"private C.w()"</span><span class="o">);</span> <span class="o">}</span>
    <span class="o">};</span>
  <span class="o">}</span>
<span class="o">}</span>    

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnonymousImplementation</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="no">A</span> <span class="n">a</span> <span class="o">=</span> <span class="nc">AnonymousA</span><span class="o">.</span><span class="na">makeA</span><span class="o">();</span>
    <span class="n">a</span><span class="o">.</span><span class="na">f</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="c1">// Reflection still gets into the anonymous class:</span>
    <span class="nc">HiddenImplementation</span><span class="o">.</span><span class="na">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"g"</span><span class="o">);</span>
    <span class="nc">HiddenImplementation</span><span class="o">.</span><span class="na">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"u"</span><span class="o">);</span>
    <span class="nc">HiddenImplementation</span><span class="o">.</span><span class="na">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"v"</span><span class="o">);</span>
    <span class="nc">HiddenImplementation</span><span class="o">.</span><span class="na">callHiddenMethod</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="s">"w"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
public C.f()
AnonymousA$1
public C.g()
package C.u()
protected C.v()
private C.w()
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>看起来没有任何方式可以阻止反射到达并调用那些非公共访问权限的方法。对于域来说，的确如此，即便是<code class="language-plaintext highlighter-rouge">private</code>域：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="c1">//: typeinfo/ModifyingPrivateFields.java</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">WithPrivateFinalField</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"I'm totally safe"</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">s2</span> <span class="o">=</span> <span class="s">"Am I safe?"</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"i = "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">s2</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ModifyingPrivateFields</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">WithPrivateFinalField</span> <span class="n">pf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WithPrivateFinalField</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pf</span><span class="o">);</span>
    <span class="nc">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"i"</span><span class="o">);</span>
    <span class="n">f</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"f.getInt(pf): "</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">pf</span><span class="o">));</span>
    <span class="n">f</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">pf</span><span class="o">,</span> <span class="mi">47</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pf</span><span class="o">);</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"s"</span><span class="o">);</span>
    <span class="n">f</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"f.get(pf): "</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">pf</span><span class="o">));</span>
    <span class="n">f</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">pf</span><span class="o">,</span> <span class="s">"No, you're not!"</span><span class="o">);</span> <span class="c1">//修改finally值</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pf</span><span class="o">);</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"s2"</span><span class="o">);</span>
    <span class="n">f</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"f.get(pf): "</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">pf</span><span class="o">));</span>
    <span class="n">f</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">pf</span><span class="o">,</span> <span class="s">"No, you're not!"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pf</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="cm">/* Output:
i = 1, I'm totally safe, Am I safe?
f.getInt(pf): 1
i = 47, I'm totally safe, Am I safe?
f.get(pf): I'm totally safe
i = 47, I'm totally safe, Am I safe?
f.get(pf): Am I safe?
i = 47, I'm totally safe, No, you're not!
*/</span><span class="c1">//:~</span>
</pre></table></code></div></div><p>但是，<code class="language-plaintext highlighter-rouge">final</code>域实际上在遭遇修改时是安全的。运行时系统会在不抛异常的情况下接受任何修改尝试，但是实际上不会发生任何修改。</p><h2 id="参考">参考</h2><ul><li><a href="https://www.zhihu.com/question/19826278">Java 反射到底慢在哪里？</a><li><a href="https://www.iteye.com/blog/rednaxelafx-548536">关于反射调用方法的一个log</a><li><a href="https://juejin.cn/post/6844903965725818887">大家都说 Java 反射效率低，你知道原因在哪里么</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/thinking-in-java/" class="post-tag no-text-decoration" >Thinking in Java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=《Java编程思想》第14章类型信息 - malinkang&url=https://malinkang.cn/posts/thinking-in-java-type-information/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=《Java编程思想》第14章类型信息 - malinkang&u=https://malinkang.cn/posts/thinking-in-java-type-information/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=《Java编程思想》第14章类型信息 - malinkang&url=https://malinkang.cn/posts/thinking-in-java-type-information/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dagger-guide/">Dagger使用指南</a><li><a href="/posts/understanding-the-jvm-runtime-data-areas/">《深入理解JVM》第2章Java内存区域与内存溢出异常</a><li><a href="/posts/understanding-the-jvm-garbage-collection/">《深入理解JVM》第3章垃圾收集器</a><li><a href="/posts/understanding-the-jvm-class-file-structure/">《深入理解JVM》第6章类文件结构</a><li><a href="/posts/understanding-the-jvm-class-loader/">《深入理解JVM》第7章虚拟机类加载机制</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/thinking-in-java-everything-is-an-object/"><div class="card-body"> <span class="timeago small" > Mar 20, 2013 <i class="unloaded">2013-03-20T00:26:34+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>《Java编程思想》第2章一切都是对象</h3><div class="text-muted small"><p> 2.2 必须由你创建所有对象 2.2.1 存储到什么地方 2.2.2 特例：基本类型 在程序设计中经常用到一系列类型，它们需要特殊对待。可以把它们想象成“基本”类型。之所以特殊对待，是因为new将对象存储在“堆”里，故用new创建一个对象，特别是小的、简单的变量，往往不是很有效。因此，对于这些类型，Java采取与C和C++相同的方法。也就是说，不用new来创建变量，而是创建一个并非是引...</p></div></div></a></div><div class="card"> <a href="/posts/thinking-in-java-operators/"><div class="card-body"> <span class="timeago small" > Mar 26, 2013 <i class="unloaded">2013-03-26T21:39:36+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>《Java编程思想》第3章操作符</h3><div class="text-muted small"><p></p></div></div></a></div><div class="card"> <a href="/posts/thinking-in-java-controlling-execution/"><div class="card-body"> <span class="timeago small" > Apr 2, 2013 <i class="unloaded">2013-04-02T21:39:36+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>《Java编程思想》第4章控制流程</h3><div class="text-muted small"><p></p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/thinking-in-java-strings/" class="btn btn-outline-primary" prompt="Older"><p>《Java编程思想》第13章字符串</p></a> <a href="/posts/thinking-in-java-generics/" class="btn btn-outline-primary" prompt="Newer"><p>《Java编程思想》第15章泛型</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//malinkang-cn.disqus.com/embed.js', disqusConfig: function() { this.page.title = '《Java编程思想》第14章类型信息'; this.page.url = 'https://malinkang.cn/posts/thinking-in-java-type-information/'; this.page.identifier = '/posts/thinking-in-java-type-information/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/malinkang">malinkang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://malinkang.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
