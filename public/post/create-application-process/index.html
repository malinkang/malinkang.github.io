<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>创建应用程序进程 - 人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="malinkang" /><meta name="description" content="一个App打开另一个App的Activity或者绑定另外一个App的服务的过程，如果另外一个App的进程不存在，都会先创建另外一个App的进程，再执行后续操作。
应用程序进程创建过程可以分为以下几部分：
 AMS发送启动应用程序进程请求 Zygote接收请求并创建应用程序进程。 ActivityThread初始化 " /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.80.0 with theme even" />


<link rel="canonical" href="https://malinkang.cn/post/create-application-process/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c12ac5d6e912b28ec1fcd71d47773cc8112a03296d4ff03660135b54f0923299.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="创建应用程序进程" />
<meta property="og:description" content="一个App打开另一个App的Activity或者绑定另外一个App的服务的过程，如果另外一个App的进程不存在，都会先创建另外一个App的进程，再执行后续操作。
应用程序进程创建过程可以分为以下几部分：

AMS发送启动应用程序进程请求
Zygote接收请求并创建应用程序进程。
ActivityThread初始化
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://malinkang.cn/post/create-application-process/" />
<meta property="article:published_time" content="2020-02-27T09:55:01+08:00" />
<meta property="article:modified_time" content="2020-02-27T09:55:01+08:00" />
<meta itemprop="name" content="创建应用程序进程">
<meta itemprop="description" content="一个App打开另一个App的Activity或者绑定另外一个App的服务的过程，如果另外一个App的进程不存在，都会先创建另外一个App的进程，再执行后续操作。
应用程序进程创建过程可以分为以下几部分：

AMS发送启动应用程序进程请求
Zygote接收请求并创建应用程序进程。
ActivityThread初始化
">
<meta itemprop="datePublished" content="2020-02-27T09:55:01+08:00" />
<meta itemprop="dateModified" content="2020-02-27T09:55:01+08:00" />
<meta itemprop="wordCount" content="5575">



<meta itemprop="keywords" content="系统源码分析," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="创建应用程序进程"/>
<meta name="twitter:description" content="一个App打开另一个App的Activity或者绑定另外一个App的服务的过程，如果另外一个App的进程不存在，都会先创建另外一个App的进程，再执行后续操作。
应用程序进程创建过程可以分为以下几部分：

AMS发送启动应用程序进程请求
Zygote接收请求并创建应用程序进程。
ActivityThread初始化
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Malinkang&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Malinkang&#39;s Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">创建应用程序进程</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-02-27 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#ams发送启动应用程序进程请求">AMS发送启动应用程序进程请求</a>
      <ul>
        <li><a href="#atmsstartprocessasync">ATMS#startProcessAsync</a></li>
        <li><a href="#pooledlambdaobtainmessage">PooledLambda#obtainMessage</a></li>
        <li><a href="#atmsonactivitymanagerinternaladded">ATMS#onActivityManagerInternalAdded</a></li>
        <li><a href="#localservice">LocalService</a></li>
        <li><a href="#amsstartprocesslocked">AMS#startProcessLocked</a></li>
        <li><a href="#processliststartprocesslocked">ProcessList#startProcessLocked</a></li>
        <li><a href="#processstartprocess">Process#startProcess</a></li>
        <li><a href="#processstart">Process#start</a></li>
        <li><a href="#zygoteprocessstart">ZygoteProcess#start</a></li>
        <li><a href="#zygoteprocessstartviazygote">ZygoteProcess#startViaZygote</a></li>
        <li><a href="#zygoteprocessopenzygotesocketifneeded">ZygoteProcess#openZygoteSocketIfNeeded</a></li>
        <li><a href="#zygoteprocessattemptconnectiontoprimaryzygote">ZygoteProcess#attemptConnectionToPrimaryZygote</a></li>
        <li><a href="#zygotestateconnect">ZygoteState#connect</a></li>
        <li><a href="#zygoteprocesszygotesendargsandgetresult">ZygoteProcess#zygoteSendArgsAndGetResult</a></li>
        <li><a href="#zygotestateattemptzygotesendargsandgetresult">ZygoteState#attemptZygoteSendArgsAndGetResult</a></li>
      </ul>
    </li>
    <li><a href="#zygote接收请求并创建应用程序进程">Zygote接收请求并创建应用程序进程</a>
      <ul>
        <li><a href="#zygoteserverrunselectloop">ZygoteServer#runSelectloop</a></li>
        <li><a href="#zygoteconnectionprocesscommand">ZygoteConnection#processCommand</a></li>
        <li><a href="#zygoteconnectionhandlechildproc">ZygoteConnection#handleChildProc</a></li>
        <li><a href="#zygoteinitzygoteinit">ZygoteInit#zygoteInit</a></li>
        <li><a href="#zygoteinitchildzygote">ZygoteInit#childZygote</a></li>
        <li><a href="#runtimeinitapplicationinit">RuntimeInit#applicationInit</a></li>
        <li><a href="#runtimeinitfindstaticmain">RuntimeInit#findStaticMain</a></li>
        <li><a href="#methodandargscaller">MethodAndArgsCaller</a></li>
      </ul>
    </li>
    <li><a href="#activitythread初始化">ActivityThread初始化</a>
      <ul>
        <li><a href="#atmain">AT#main</a></li>
        <li><a href="#atattach">AT#attach</a></li>
        <li><a href="#amsattachapplication">AMS#attachApplication</a></li>
        <li><a href="#amsattachapplicationlocked">AMS#attachApplicationLocked</a></li>
        <li><a href="#atmsattachapplication">ATMS#attachApplication</a></li>
        <li><a href="#rwcattachapplication">RWC#attachApplication</a></li>
        <li><a href="#rwcstartactivityforattachedapplicationifneeded">RWC#startActivityForAttachedApplicationIfNeeded</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>一个App打开另一个App的Activity或者绑定另外一个App的服务的过程，如果另外一个App的进程不存在，都会先创建另外一个App的进程，再执行后续操作。</p>
<p>应用程序进程创建过程可以分为以下几部分：</p>
<ol>
<li>AMS发送启动应用程序进程请求</li>
<li>Zygote接收请求并创建应用程序进程。</li>
<li>ActivityThread初始化</li>
</ol>
<h2 id="ams发送启动应用程序进程请求">AMS发送启动应用程序进程请求</h2>
<p>这里先给出AMS发送启动应用程序进程请求过程的时序图，然后对每一个步骤进行详细分析，如图所示。</p>
<p><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/android/AMS%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B.png" alt=""></p>
<h3 id="atmsstartprocessasync">ATMS#startProcessAsync</h3>
<p>在<code>Activity</code>的启动过程中，会调用<code>ATMS</code>的<code>startProcessAsync</code>方法来创建新的进程。<code>startProcessAsync</code>会调用<code>PooledLambda</code>的<code>obtainMessage</code>方法获得一个<code>Message</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">startProcessAsync</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">activity</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">knownToBeDead</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isTop</span><span class="o">,</span>
        <span class="n">String</span> <span class="n">hostingType</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">isTagEnabled</span><span class="o">(</span><span class="n">TRACE_TAG_WINDOW_MANAGER</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_WINDOW_MANAGER</span><span class="o">,</span> <span class="s">&#34;dispatchingStartProcess:&#34;</span>
                    <span class="o">+</span> <span class="n">activity</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// Post message to start process to avoid possible deadlock of calling into AMS with the
</span><span class="c1"></span>        <span class="c1">// ATMS lock held.
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">Message</span> <span class="n">m</span> <span class="o">=</span> <span class="n">PooledLambda</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">ActivityManagerInternal</span><span class="o">::</span><span class="n">startProcess</span><span class="o">,</span>
                <span class="n">mAmInternal</span><span class="o">,</span> <span class="n">activity</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">activity</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="n">knownToBeDead</span><span class="o">,</span>
                <span class="n">isTop</span><span class="o">,</span> <span class="n">hostingType</span><span class="o">,</span> <span class="n">activity</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getComponent</span><span class="o">());</span>
        <span class="n">mH</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_WINDOW_MANAGER</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="pooledlambdaobtainmessage">PooledLambda#obtainMessage</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/com/android/internal/util/function/pooled/PooledLambda.java
</span><span class="c1"></span><span class="kd">static</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="n">B</span><span class="o">,</span> <span class="n">C</span><span class="o">&gt;</span> <span class="n">Message</span> <span class="nf">obtainMessage</span><span class="o">(</span>
        <span class="n">TriConsumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">A</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="n">B</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="n">C</span><span class="o">&gt;</span> <span class="n">function</span><span class="o">,</span>
        <span class="n">A</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">B</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">C</span> <span class="n">arg3</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Message</span><span class="o">.</span><span class="na">sPoolSync</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PooledRunnable</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">(</span><span class="n">PooledLambdaImpl</span><span class="o">.</span><span class="na">sMessageCallbacksPool</span><span class="o">,</span>
                <span class="n">function</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">ReturnType</span><span class="o">.</span><span class="na">VOID</span><span class="o">,</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">arg3</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">().</span><span class="na">setCallback</span><span class="o">(</span><span class="n">callback</span><span class="o">.</span><span class="na">recycleOnUse</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/com/android/internal/util/function/pooled/PooledLambdaImpl.java
</span><span class="c1"></span><span class="kd">static</span> <span class="o">&lt;</span><span class="n">E</span> <span class="kd">extends</span> <span class="n">PooledLambda</span><span class="o">&gt;</span> <span class="n">E</span> <span class="nf">acquire</span><span class="o">(</span><span class="n">Pool</span> <span class="n">pool</span><span class="o">,</span> <span class="n">Object</span> <span class="n">func</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">fNumArgs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">numPlaceholders</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fReturnType</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a</span><span class="o">,</span> <span class="n">Object</span> <span class="n">b</span><span class="o">,</span> <span class="n">Object</span> <span class="n">c</span><span class="o">,</span>
        <span class="n">Object</span> <span class="n">d</span><span class="o">,</span> <span class="n">Object</span> <span class="n">e</span><span class="o">,</span> <span class="n">Object</span> <span class="n">f</span><span class="o">,</span> <span class="n">Object</span> <span class="n">g</span><span class="o">,</span> <span class="n">Object</span> <span class="n">h</span><span class="o">,</span> <span class="n">Object</span> <span class="n">i</span><span class="o">,</span> <span class="n">Object</span> <span class="n">j</span><span class="o">,</span> <span class="n">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">PooledLambdaImpl</span> <span class="n">r</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">(</span><span class="n">pool</span><span class="o">);</span><span class="c1">//获取PooledLambdaImpl
</span><span class="c1"></span>    <span class="c1">//...
</span><span class="c1"></span>    <span class="k">return</span> <span class="o">(</span><span class="n">E</span><span class="o">)</span> <span class="n">r</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>PooledLambdaImpl</code>继承自<code>OmniFunction</code>,<code>OmniFunction</code>实现了<code>Runnuable</code>接口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/com/android/internal/util/function/pooled/OmniFunction.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/com/android/internal/util/function/pooled/PooledLambdaImpl.java
</span><span class="c1"></span><span class="nd">@Override</span>
<span class="n">R</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">a1</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a2</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a3</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a4</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a5</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a6</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a7</span><span class="o">,</span>
        <span class="n">Object</span> <span class="n">a8</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a9</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a10</span><span class="o">,</span> <span class="n">Object</span> <span class="n">a11</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//...
</span><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">doInvoke</span><span class="o">();</span> <span class="c1">//调用doInvoke
</span><span class="c1"></span>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isRecycleOnUse</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">doRecycle</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">isRecycled</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">argsSize</span> <span class="o">=</span> <span class="n">ArrayUtils</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">mArgs</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argsSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">popArg</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">R</span> <span class="nf">doInvoke</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">funcType</span> <span class="o">=</span> <span class="n">getFlags</span><span class="o">(</span><span class="n">MASK_FUNC_TYPE</span><span class="o">);</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">argCount</span> <span class="o">=</span> <span class="n">LambdaType</span><span class="o">.</span><span class="na">decodeArgCount</span><span class="o">(</span><span class="n">funcType</span><span class="o">);</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">returnType</span> <span class="o">=</span> <span class="n">LambdaType</span><span class="o">.</span><span class="na">decodeReturnType</span><span class="o">(</span><span class="n">funcType</span><span class="o">);</span>

    <span class="k">switch</span> <span class="o">(</span><span class="n">argCount</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//根据参数个数
</span><span class="c1"></span>        <span class="c1">//...
</span><span class="c1"></span>        <span class="k">case</span> <span class="n">3</span><span class="o">:</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">returnType</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="n">LambdaType</span><span class="o">.</span><span class="na">ReturnType</span><span class="o">.</span><span class="na">VOID</span><span class="o">:</span> <span class="o">{</span>
                    <span class="o">((</span><span class="n">TriConsumer</span><span class="o">)</span> <span class="n">mFunc</span><span class="o">).</span><span class="na">accept</span><span class="o">(</span><span class="n">popArg</span><span class="o">(</span><span class="n">0</span><span class="o">),</span> <span class="n">popArg</span><span class="o">(</span><span class="n">1</span><span class="o">),</span> <span class="n">popArg</span><span class="o">(</span><span class="n">2</span><span class="o">));</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">case</span> <span class="n">LambdaType</span><span class="o">.</span><span class="na">ReturnType</span><span class="o">.</span><span class="na">BOOLEAN</span><span class="o">:</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="o">(</span><span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="o">((</span><span class="n">TriPredicate</span><span class="o">)</span> <span class="n">mFunc</span><span class="o">).</span><span class="na">test</span><span class="o">(</span>
                            <span class="n">popArg</span><span class="o">(</span><span class="n">0</span><span class="o">),</span> <span class="n">popArg</span><span class="o">(</span><span class="n">1</span><span class="o">),</span> <span class="n">popArg</span><span class="o">(</span><span class="n">2</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">case</span> <span class="n">LambdaType</span><span class="o">.</span><span class="na">ReturnType</span><span class="o">.</span><span class="na">OBJECT</span><span class="o">:</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="o">(</span><span class="n">R</span><span class="o">)</span> <span class="o">((</span><span class="n">TriFunction</span><span class="o">)</span> <span class="n">mFunc</span><span class="o">).</span><span class="na">apply</span><span class="o">(</span><span class="n">popArg</span><span class="o">(</span><span class="n">0</span><span class="o">),</span> <span class="n">popArg</span><span class="o">(</span><span class="n">1</span><span class="o">),</span> <span class="n">popArg</span><span class="o">(</span><span class="n">2</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">break</span><span class="o">;</span>
       <span class="c1">//...
</span><span class="c1"></span>    <span class="o">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Unknown function type: &#34;</span> <span class="o">+</span> <span class="n">LambdaType</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">funcType</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最终<code>startProcessAsync</code>方法会调用<code>mAmInternal</code>的<code>startProcess</code>。<code>mAmInternal</code>是<code>ActivityManagerInternal</code>类，在<code>onActivityManagerInternalAdded</code>方法中调用<code>LocalServices</code>的<code>getService</code>获取该对象。</p>
<h3 id="atmsonactivitymanagerinternaladded">ATMS#onActivityManagerInternalAdded</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">ActivityManagerInternal</span> <span class="n">mAmInternal</span><span class="o">;</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityManagerInternalAdded</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mGlobalLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mAmInternal</span> <span class="o">=</span> <span class="n">LocalServices</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">ActivityManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">mUgmInternal</span> <span class="o">=</span> <span class="n">LocalServices</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">UriGrantsManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在<code>AMS</code>的构造函数中创建<code>LocalService</code>，并在start方法中注册到<code>LocalServices</code>中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
</span><span class="c1"></span><span class="kd">public</span> <span class="nf">ActivityManagerService</span><span class="o">(</span><span class="n">Context</span> <span class="n">systemContext</span><span class="o">,</span> <span class="n">ActivityTaskManagerService</span> <span class="n">atm</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//LocalService是
</span><span class="c1"></span>  <span class="n">mInternal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalService</span><span class="o">();</span><span class="c1">//创建LocalService 
</span><span class="c1"></span>  <span class="n">mAtmInternal</span> <span class="o">=</span> <span class="n">LocalServices</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">ActivityTaskManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
</span><span class="c1"></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//...
</span><span class="c1"></span>    <span class="c1">//添加ActivityManagerInternal
</span><span class="c1"></span>    <span class="n">LocalServices</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">ActivityManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">mInternal</span><span class="o">);</span>
    <span class="c1">//...
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="localservice">LocalService</h3>
<p><code>LocalService</code>是<code>ActivityManagerService</code>的内部类，是<code>ActivityManagerInternal</code>的子类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">startProcess</span><span class="o">(</span><span class="n">String</span> <span class="n">processName</span><span class="o">,</span> <span class="n">ApplicationInfo</span> <span class="n">info</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">knownToBeDead</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">isTop</span><span class="o">,</span> <span class="n">String</span> <span class="n">hostingType</span><span class="o">,</span> <span class="n">ComponentName</span> <span class="n">hostingName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">isTagEnabled</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">&#34;startProcess:&#34;</span>
                    <span class="o">+</span> <span class="n">processName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// If the process is known as top app, set a hint so when the process is
</span><span class="c1"></span>            <span class="c1">// started, the top priority can be applied immediately to avoid cpu being
</span><span class="c1"></span>            <span class="c1">// preempted by other processes before attaching the process of top app.
</span><span class="c1"></span>            <span class="c1">//调用startProcessLocked
</span><span class="c1"></span>            <span class="n">startProcessLocked</span><span class="o">(</span><span class="n">processName</span><span class="o">,</span> <span class="n">info</span><span class="o">,</span> <span class="n">knownToBeDead</span><span class="o">,</span> <span class="n">0</span> <span class="cm">/* intentFlags */</span><span class="o">,</span>
                    <span class="k">new</span> <span class="n">HostingRecord</span><span class="o">(</span><span class="n">hostingType</span><span class="o">,</span> <span class="n">hostingName</span><span class="o">,</span> <span class="n">isTop</span><span class="o">),</span>
                    <span class="n">ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE</span><span class="o">,</span> <span class="kc">false</span> <span class="cm">/* allowWhileBooting */</span><span class="o">,</span>
                    <span class="kc">false</span> <span class="cm">/* isolated */</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/* keepIfLarge */</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="amsstartprocesslocked">AMS#startProcessLocked</h3>
<p>最终会调用<code>AMS</code>的<code>startProcessLocked</code>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
</span><span class="c1">//在构造函数中调用Injector的getProcessList方法中创建ProcessList
</span><span class="c1"></span><span class="kd">final</span> <span class="n">ProcessList</span> <span class="n">mProcessList</span><span class="o">;</span> 
<span class="kd">final</span> <span class="n">ProcessRecord</span> <span class="nf">startProcessLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">processName</span><span class="o">,</span>
      <span class="n">ApplicationInfo</span> <span class="n">info</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">knownToBeDead</span><span class="o">,</span> <span class="kt">int</span> <span class="n">intentFlags</span><span class="o">,</span>
      <span class="n">HostingRecord</span> <span class="n">hostingRecord</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowWhileBooting</span><span class="o">,</span>
      <span class="kt">boolean</span> <span class="n">isolated</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">keepIfLarge</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">mProcessList</span><span class="o">.</span><span class="na">startProcessLocked</span><span class="o">(</span><span class="n">processName</span><span class="o">,</span> <span class="n">info</span><span class="o">,</span> <span class="n">knownToBeDead</span><span class="o">,</span> <span class="n">intentFlags</span><span class="o">,</span>
          <span class="n">hostingRecord</span><span class="o">,</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="n">allowWhileBooting</span><span class="o">,</span> <span class="n">isolated</span><span class="o">,</span> <span class="n">0</span> <span class="cm">/* isolatedUid */</span><span class="o">,</span>
          <span class="n">keepIfLarge</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/* ABI override */</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/* entryPoint */</span><span class="o">,</span>
          <span class="kc">null</span> <span class="cm">/* entryPointArgs */</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/* crashHandler */</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>AMS</code>的<code>startProcessLocked</code>方法会调用<code>ProcessList</code>的<code>startProcessLocked</code>方法。</p>
<h3 id="processliststartprocesslocked">ProcessList#startProcessLocked</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ProcessList.java
</span><span class="c1"></span><span class="kt">boolean</span> <span class="nf">startProcessLocked</span><span class="o">(</span><span class="n">ProcessRecord</span> <span class="n">app</span><span class="o">,</span> <span class="n">HostingRecord</span> <span class="n">hostingRecord</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">disableHiddenApiChecks</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">disableTestApiChecks</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">mountExtStorageFull</span><span class="o">,</span> <span class="n">String</span> <span class="n">abiOverride</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//...
</span><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">uid</span><span class="o">);</span><span class="c1">//
</span><span class="c1"></span>            <span class="n">AppGlobals</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">().</span><span class="na">checkPackageStartable</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowAsRuntimeException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//获取要创建的应用程序进程的用户ID
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="na">uid</span><span class="o">;</span><span class="c1">//①
</span><span class="c1"></span>        <span class="c1">//
</span><span class="c1"></span>        <span class="c1">// Start the process.  It will either succeed and return a result containing
</span><span class="c1"></span>        <span class="c1">// the PID of the new process, or else throw a RuntimeException.
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">String</span> <span class="n">entryPoint</span> <span class="o">=</span> <span class="s">&#34;android.app.ActivityThread&#34;</span><span class="o">;</span><span class="c1">//应用线程类名
</span><span class="c1"></span>
        <span class="k">return</span> <span class="n">startProcessLocked</span><span class="o">(</span><span class="n">hostingRecord</span><span class="o">,</span> <span class="n">entryPoint</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span>
                <span class="n">runtimeFlags</span><span class="o">,</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">requiredAbi</span><span class="o">,</span>
                <span class="n">instructionSet</span><span class="o">,</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="n">startTime</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="c1">//...
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ProcessList.java
</span><span class="c1"></span><span class="kt">boolean</span> <span class="nf">startProcessLocked</span><span class="o">(</span><span class="n">HostingRecord</span> <span class="n">hostingRecord</span><span class="o">,</span> <span class="n">String</span> <span class="n">entryPoint</span><span class="o">,</span> <span class="n">ProcessRecord</span> <span class="n">app</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
      <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">String</span> <span class="n">requiredAbi</span><span class="o">,</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">String</span> <span class="n">invokeWith</span><span class="o">,</span>
      <span class="kt">long</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">app</span><span class="o">.</span><span class="na">pendingStart</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="n">app</span><span class="o">.</span><span class="na">killedByAm</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="n">app</span><span class="o">.</span><span class="na">removed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="n">app</span><span class="o">.</span><span class="na">killed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
 <span class="c1">//...
</span><span class="c1"></span>
  <span class="k">if</span> <span class="o">(</span><span class="n">mService</span><span class="o">.</span><span class="na">mConstants</span><span class="o">.</span><span class="na">FLAG_PROCESS_START_ASYNC</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_PROCESSES</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG_PROCESSES</span><span class="o">,</span>
              <span class="s">&#34;Posting procStart msg for &#34;</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="na">toShortString</span><span class="o">());</span>
      <span class="n">mService</span><span class="o">.</span><span class="na">mProcStartHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">handleProcessStart</span><span class="o">(</span>
              <span class="n">app</span><span class="o">,</span> <span class="n">entryPoint</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span>
              <span class="n">requiredAbi</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="n">startSeq</span><span class="o">));</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
      <span class="c1">//调用startProcess方法
</span><span class="c1"></span>          <span class="kd">final</span> <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="n">startResult</span> <span class="o">=</span> <span class="n">startProcess</span><span class="o">(</span><span class="n">hostingRecord</span><span class="o">,</span>
                  <span class="n">entryPoint</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span>
                  <span class="n">uid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span>
                  <span class="n">requiredAbi</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="n">startTime</span><span class="o">);</span>
          <span class="n">handleProcessStartedLocked</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">startResult</span><span class="o">.</span><span class="na">pid</span><span class="o">,</span> <span class="n">startResult</span><span class="o">.</span><span class="na">usingWrapper</span><span class="o">,</span>
                  <span class="n">startSeq</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                  <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
          <span class="n">app</span><span class="o">.</span><span class="na">pendingStart</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
          <span class="n">mService</span><span class="o">.</span><span class="na">forceStopPackageLocked</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">UserHandle</span><span class="o">.</span><span class="na">getAppId</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">uid</span><span class="o">),</span>
                  <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">userId</span><span class="o">,</span> <span class="s">&#34;start failure&#34;</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="na">pid</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="processstartprocess">Process#startProcess</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ProcessList.java
</span><span class="c1"></span><span class="kd">private</span> <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="nf">startProcess</span><span class="o">(</span><span class="n">HostingRecord</span> <span class="n">hostingRecord</span><span class="o">,</span> <span class="n">String</span> <span class="n">entryPoint</span><span class="o">,</span>
      <span class="n">ProcessRecord</span> <span class="n">app</span><span class="o">,</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">String</span> <span class="n">requiredAbi</span><span class="o">,</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">,</span>
      <span class="n">String</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">//...
</span><span class="c1"></span>      <span class="kd">final</span> <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="n">startResult</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">hostingRecord</span><span class="o">.</span><span class="na">usesWebviewZygote</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">//...
</span><span class="c1"></span>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">//调用Process启动进程
</span><span class="c1"></span>          <span class="n">startResult</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">entryPoint</span><span class="o">,</span>
                  <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span>
                  <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">requiredAbi</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span>
                  <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">dataDir</span><span class="o">,</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span>
                  <span class="n">isTopApp</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">mDisabledCompatChanges</span><span class="o">,</span> <span class="n">pkgDataInfoMap</span><span class="o">,</span>
                  <span class="n">whitelistedAppDataInfoMap</span><span class="o">,</span> <span class="n">bindMountAppsData</span><span class="o">,</span> <span class="n">bindMountAppStorageDirs</span><span class="o">,</span>
                  <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="n">PROC_START_SEQ_IDENT</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="na">startSeq</span><span class="o">});</span>
      <span class="o">}</span>
      <span class="n">checkSlow</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="s">&#34;startProcess: returned from zygote!&#34;</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">startResult</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="processstart">Process#start</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/android/os/Process.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ZygoteProcess</span> <span class="n">ZYGOTE_PROCESS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZygoteProcess</span><span class="o">();</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">ProcessStartResult</span> <span class="nf">start</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">processClass</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span>
                                       <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span>
                                       <span class="kt">int</span> <span class="n">runtimeFlags</span><span class="o">,</span>
                                       <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
                                       <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span>
                                       <span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">abi</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">appDataDir</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">invokeWith</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">,</span>
                                       <span class="kt">int</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span>
                                       <span class="kt">boolean</span> <span class="n">isTopApp</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">disabledCompatChanges</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span>
                                               <span class="n">pkgDataInfoMap</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span>
                                               <span class="n">whitelistedDataInfoMap</span><span class="o">,</span>
                                       <span class="kt">boolean</span> <span class="n">bindMountAppsData</span><span class="o">,</span>
                                       <span class="kt">boolean</span> <span class="n">bindMountAppStorageDirs</span><span class="o">,</span>
                                       <span class="nd">@Nullable</span> <span class="n">String</span><span class="o">[]</span> <span class="n">zygoteArgs</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">ZYGOTE_PROCESS</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">processClass</span><span class="o">,</span> <span class="n">niceName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span>
                <span class="n">runtimeFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span>
                <span class="n">abi</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">appDataDir</span><span class="o">,</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span>
                <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="n">isTopApp</span><span class="o">,</span> <span class="n">disabledCompatChanges</span><span class="o">,</span>
                <span class="n">pkgDataInfoMap</span><span class="o">,</span> <span class="n">whitelistedDataInfoMap</span><span class="o">,</span> <span class="n">bindMountAppsData</span><span class="o">,</span>
                <span class="n">bindMountAppStorageDirs</span><span class="o">,</span> <span class="n">zygoteArgs</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteprocessstart">ZygoteProcess#start</h3>
<p>在<code>Process</code>的<code>start</code>方法中只调用了<code>ZygoteProcess</code>的start方法，其中ZygoteProcess类用于保持与Zygote进程的通信状态。该start方法如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/android/os/ZygoteProcess.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">final</span> <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="nf">start</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">processClass</span><span class="o">,</span>
                                              <span class="kd">final</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span>
                                              <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span>
                                              <span class="kt">int</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
                                              <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span>
                                              <span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">abi</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">appDataDir</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">invokeWith</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">,</span>
                                              <span class="kt">int</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span>
                                              <span class="kt">boolean</span> <span class="n">isTopApp</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">disabledCompatChanges</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span>
                                                      <span class="n">pkgDataInfoMap</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span>
                                                      <span class="n">whitelistedDataInfoMap</span><span class="o">,</span>
                                              <span class="kt">boolean</span> <span class="n">bindMountAppsData</span><span class="o">,</span>
                                              <span class="kt">boolean</span> <span class="n">bindMountAppStorageDirs</span><span class="o">,</span>
                                              <span class="nd">@Nullable</span> <span class="n">String</span><span class="o">[]</span> <span class="n">zygoteArgs</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// TODO (chriswailes): Is there a better place to check this value?
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">fetchUsapPoolEnabledPropWithMinInterval</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">informZygotesOfUsapPoolStatus</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">startViaZygote</span><span class="o">(</span><span class="n">processClass</span><span class="o">,</span> <span class="n">niceName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span>
                <span class="n">runtimeFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span>
                <span class="n">abi</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">appDataDir</span><span class="o">,</span> <span class="n">invokeWith</span><span class="o">,</span> <span class="cm">/*startChildZygote=*/</span> <span class="kc">false</span><span class="o">,</span>
                <span class="n">packageName</span><span class="o">,</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="n">isTopApp</span><span class="o">,</span> <span class="n">disabledCompatChanges</span><span class="o">,</span>
                <span class="n">pkgDataInfoMap</span><span class="o">,</span> <span class="n">whitelistedDataInfoMap</span><span class="o">,</span> <span class="n">bindMountAppsData</span><span class="o">,</span>
                <span class="n">bindMountAppStorageDirs</span><span class="o">,</span> <span class="n">zygoteArgs</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ZygoteStartFailedEx</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span>
                <span class="s">&#34;Starting VM process through Zygote failed&#34;</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                <span class="s">&#34;Starting VM process through Zygote failed&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteprocessstartviazygote">ZygoteProcess#startViaZygote</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="nf">startViaZygote</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">processClass</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span>
                                                  <span class="kd">final</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span>
                                                  <span class="kt">int</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
                                                  <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span>
                                                  <span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">abi</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">instructionSet</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">appDataDir</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">invokeWith</span><span class="o">,</span>
                                                  <span class="kt">boolean</span> <span class="n">startChildZygote</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">,</span>
                                                  <span class="kt">int</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span>
                                                  <span class="kt">boolean</span> <span class="n">isTopApp</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">disabledCompatChanges</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span>
                                                          <span class="n">pkgDataInfoMap</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span>
                                                          <span class="n">whitelistedDataInfoMap</span><span class="o">,</span>
                                                  <span class="kt">boolean</span> <span class="n">bindMountAppsData</span><span class="o">,</span>
                                                  <span class="kt">boolean</span> <span class="n">bindMountAppStorageDirs</span><span class="o">,</span>
                                                  <span class="nd">@Nullable</span> <span class="n">String</span><span class="o">[]</span> <span class="n">extraArgs</span><span class="o">)</span>
                                                  <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
    <span class="c1">//创建字符串列表argsForZygote，并将应用进程的启动参数保存在argsForZygote中
</span><span class="c1"></span>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">argsForZygote</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// --runtime-args, --setuid=, --setgid=,
</span><span class="c1"></span>    <span class="c1">// and --setgroups= must go first
</span><span class="c1"></span>    <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;--runtime-args&#34;</span><span class="o">);</span>
    <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;--setuid=&#34;</span> <span class="o">+</span> <span class="n">uid</span><span class="o">);</span>
    <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;--setgid=&#34;</span> <span class="o">+</span> <span class="n">gid</span><span class="o">);</span>
    <span class="n">argsForZygote</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;--runtime-flags=&#34;</span> <span class="o">+</span> <span class="n">runtimeFlags</span><span class="o">);</span>
    <span class="c1">//...
</span><span class="c1"></span>    <span class="kd">synchronized</span><span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// The USAP pool can not be used if the application will not use the systems graphics
</span><span class="c1"></span>        <span class="c1">// driver.  If that driver is requested use the Zygote application start path.
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">zygoteSendArgsAndGetResult</span><span class="o">(</span><span class="n">openZygoteSocketIfNeeded</span><span class="o">(</span><span class="n">abi</span><span class="o">),</span>
                                          <span class="n">zygotePolicyFlags</span><span class="o">,</span>
                                          <span class="n">argsForZygote</span><span class="o">);</span><span class="c1">//启动参数
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteprocessopenzygotesocketifneeded">ZygoteProcess#openZygoteSocketIfNeeded</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">ZygoteState</span> <span class="nf">openZygoteSocketIfNeeded</span><span class="o">(</span><span class="n">String</span> <span class="n">abi</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">attemptConnectionToPrimaryZygote</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">primaryZygoteState</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">abi</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">primaryZygoteState</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mZygoteSecondarySocketAddress</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// The primary zygote didn&#39;t match. Try the secondary.
</span><span class="c1"></span>            <span class="n">attemptConnectionToSecondaryZygote</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">secondaryZygoteState</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">abi</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">secondaryZygoteState</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">ZygoteStartFailedEx</span><span class="o">(</span><span class="s">&#34;Error connecting to zygote&#34;</span><span class="o">,</span> <span class="n">ioe</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="n">ZygoteStartFailedEx</span><span class="o">(</span><span class="s">&#34;Unsupported zygote ABI: &#34;</span> <span class="o">+</span> <span class="n">abi</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteprocessattemptconnectiontoprimaryzygote">ZygoteProcess#attemptConnectionToPrimaryZygote</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">attemptConnectionToPrimaryZygote</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">primaryZygoteState</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">primaryZygoteState</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">primaryZygoteState</span> <span class="o">=</span>
                <span class="n">ZygoteState</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">mZygoteSocketAddress</span><span class="o">,</span> <span class="n">mUsapPoolSocketAddress</span><span class="o">);</span>

        <span class="n">maybeSetApiDenylistExemptions</span><span class="o">(</span><span class="n">primaryZygoteState</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">maybeSetHiddenApiAccessLogSampleRate</span><span class="o">(</span><span class="n">primaryZygoteState</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygotestateconnect">ZygoteState#connect</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="n">ZygoteState</span> <span class="nf">connect</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">LocalSocketAddress</span> <span class="n">zygoteSocketAddress</span><span class="o">,</span>
        <span class="nd">@Nullable</span> <span class="n">LocalSocketAddress</span> <span class="n">usapSocketAddress</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">DataInputStream</span> <span class="n">zygoteInputStream</span><span class="o">;</span>
    <span class="n">BufferedWriter</span> <span class="n">zygoteOutputWriter</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">LocalSocket</span> <span class="n">zygoteSessionSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalSocket</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">zygoteSocketAddress</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;zygoteSocketAddress can&#39;t be null&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">zygoteSessionSocket</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">zygoteSocketAddress</span><span class="o">);</span>
        <span class="n">zygoteInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">zygoteSessionSocket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
        <span class="n">zygoteOutputWriter</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span>
                        <span class="k">new</span> <span class="n">OutputStreamWriter</span><span class="o">(</span><span class="n">zygoteSessionSocket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()),</span>
                        <span class="n">Zygote</span><span class="o">.</span><span class="na">SOCKET_BUFFER_SIZE</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">zygoteSessionSocket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>

        <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">ZygoteState</span><span class="o">(</span><span class="n">zygoteSocketAddress</span><span class="o">,</span> <span class="n">usapSocketAddress</span><span class="o">,</span>
                           <span class="n">zygoteSessionSocket</span><span class="o">,</span> <span class="n">zygoteInputStream</span><span class="o">,</span> <span class="n">zygoteOutputWriter</span><span class="o">,</span>
                           <span class="n">getAbiList</span><span class="o">(</span><span class="n">zygoteOutputWriter</span><span class="o">,</span> <span class="n">zygoteInputStream</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteprocesszygotesendargsandgetresult">ZygoteProcess#zygoteSendArgsAndGetResult</h3>
<p><code>zygoteSendArgsAndGetResult</code>方法的主要作用就是将传入的应用进程的启动参数argsForZygote写入<code>ZygoteState</code>中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="nf">zygoteSendArgsAndGetResult</span><span class="o">(</span>
        <span class="n">ZygoteState</span> <span class="n">zygoteState</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zygotePolicyFlags</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
   <span class="c1">//...
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">msgStr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">&#34;\n&#34;</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="o">;</span>
   <span class="c1">//...
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">attemptZygoteSendArgsAndGetResult</span><span class="o">(</span><span class="n">zygoteState</span><span class="o">,</span> <span class="n">msgStr</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygotestateattemptzygotesendargsandgetresult">ZygoteState#attemptZygoteSendArgsAndGetResult</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="nf">attemptZygoteSendArgsAndGetResult</span><span class="o">(</span>
        <span class="n">ZygoteState</span> <span class="n">zygoteState</span><span class="o">,</span> <span class="n">String</span> <span class="n">msgStr</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">BufferedWriter</span> <span class="n">zygoteWriter</span> <span class="o">=</span> <span class="n">zygoteState</span><span class="o">.</span><span class="na">mZygoteOutputWriter</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">DataInputStream</span> <span class="n">zygoteInputStream</span> <span class="o">=</span> <span class="n">zygoteState</span><span class="o">.</span><span class="na">mZygoteInputStream</span><span class="o">;</span>
        <span class="c1">//写入数据
</span><span class="c1"></span>        <span class="n">zygoteWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msgStr</span><span class="o">);</span>
        <span class="n">zygoteWriter</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="c1">//创建ProcessStartResult
</span><span class="c1"></span>        <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span><span class="o">();</span>
        <span class="c1">//读取数据
</span><span class="c1"></span>        <span class="n">result</span><span class="o">.</span><span class="na">pid</span> <span class="o">=</span> <span class="n">zygoteInputStream</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span> 
        <span class="n">result</span><span class="o">.</span><span class="na">usingWrapper</span> <span class="o">=</span> <span class="n">zygoteInputStream</span><span class="o">.</span><span class="na">readBoolean</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">pid</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ZygoteStartFailedEx</span><span class="o">(</span><span class="s">&#34;fork() failed&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">zygoteState</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&#34;IO Exception while communicating with Zygote - &#34;</span>
                <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">ZygoteStartFailedEx</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="zygote接收请求并创建应用程序进程">Zygote接收请求并创建应用程序进程</h2>
<p>启动<code>Zygote</code>进程，会注册<code>Socket</code>，并调用<code>ZygoteServer</code>的<code>runSelectloop</code>进入无限循环。</p>
<h3 id="zygoteserverrunselectloop">ZygoteServer#runSelectloop</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteServer.java
</span><span class="c1"></span><span class="n">Runnable</span> <span class="nf">runSelectLoop</span><span class="o">(</span><span class="n">String</span> <span class="n">abiList</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">FileDescriptor</span><span class="o">&gt;</span> <span class="n">socketFDs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
  <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ZygoteConnection</span><span class="o">&gt;</span> <span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

  <span class="n">socketFDs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mZygoteSocket</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">());</span>
  <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

  <span class="n">mUsapPoolRefillTriggerTimestamp</span> <span class="o">=</span> <span class="n">INVALID_TIMESTAMP</span><span class="o">;</span>

  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//...
</span><span class="c1"></span>
      <span class="k">if</span> <span class="o">(</span><span class="n">pollReturnValue</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// The poll returned zero results either when the timeout value has been exceeded
</span><span class="c1"></span>          <span class="c1">// or when a non-blocking poll is issued and no FDs are ready.  In either case it
</span><span class="c1"></span>          <span class="c1">// is time to refill the pool.  This will result in a duplicate assignment when
</span><span class="c1"></span>          <span class="c1">// the non-blocking poll returns zero results, but it avoids an additional
</span><span class="c1"></span>          <span class="c1">// conditional in the else branch.
</span><span class="c1"></span>          <span class="n">mUsapPoolRefillTriggerTimestamp</span> <span class="o">=</span> <span class="n">INVALID_TIMESTAMP</span><span class="o">;</span>
          <span class="n">mUsapPoolRefillAction</span> <span class="o">=</span> <span class="n">UsapPoolRefillAction</span><span class="o">.</span><span class="na">DELAYED</span><span class="o">;</span>

      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kt">boolean</span> <span class="n">usapPoolFDRead</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

          <span class="k">while</span> <span class="o">(--</span><span class="n">pollIndex</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">((</span><span class="n">pollFDs</span><span class="o">[</span><span class="n">pollIndex</span><span class="o">].</span><span class="na">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">continue</span><span class="o">;</span>
              <span class="o">}</span>

              <span class="k">if</span> <span class="o">(</span><span class="n">pollIndex</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// Zygote server socket
</span><span class="c1"></span>                  <span class="c1">//创建ZygoteConnection
</span><span class="c1"></span>                  <span class="n">ZygoteConnection</span> <span class="n">newPeer</span> <span class="o">=</span> <span class="n">acceptCommandPeer</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
                  <span class="c1">//添加到集合中
</span><span class="c1"></span>                  <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">);</span>
                  <span class="n">socketFDs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">());</span>
              <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pollIndex</span> <span class="o">&lt;</span> <span class="n">usapPoolEventFDIndex</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// Session socket accepted from the Zygote server socket
</span><span class="c1"></span>
                  <span class="k">try</span> <span class="o">{</span>
                      <span class="n">ZygoteConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">peers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">pollIndex</span><span class="o">);</span>
                      <span class="kt">boolean</span> <span class="n">multipleForksOK</span> <span class="o">=</span> <span class="o">!</span><span class="n">isUsapPoolEnabled</span><span class="o">()</span>
                              <span class="o">&amp;&amp;</span> <span class="n">ZygoteHooks</span><span class="o">.</span><span class="na">indefiniteThreadSuspensionOK</span><span class="o">();</span>
                      <span class="c1">//调用ZygoteConnection的processCommand方法
</span><span class="c1"></span>                      <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">command</span> <span class="o">=</span>
                              <span class="n">connection</span><span class="o">.</span><span class="na">processCommand</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">multipleForksOK</span><span class="o">);</span>
                      <span class="c1">//...
</span><span class="c1"></span>                  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                      <span class="c1">//...
</span><span class="c1"></span>                  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                      <span class="c1">//...
</span><span class="c1"></span>                  <span class="o">}</span>

              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="c1">//。。。
</span><span class="c1"></span>              <span class="o">}</span>
          <span class="o">}</span>
          <span class="c1">//...
</span><span class="c1"></span>      <span class="o">}</span>
      <span class="c1">//...
</span><span class="c1"></span>  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteconnectionprocesscommand">ZygoteConnection#processCommand</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Runnable</span> <span class="nf">processCommand</span><span class="o">(</span><span class="n">ZygoteServer</span> <span class="n">zygoteServer</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">multipleOK</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ZygoteArguments</span> <span class="n">parsedArgs</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">(</span><span class="n">ZygoteCommandBuffer</span> <span class="n">argBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZygoteCommandBuffer</span><span class="o">(</span><span class="n">mSocket</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//获取参数
</span><span class="c1"></span>                <span class="n">parsedArgs</span> <span class="o">=</span> <span class="n">ZygoteArguments</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">argBuffer</span><span class="o">);</span>
                <span class="c1">// Keep argBuffer around, since we need it to fork.
</span><span class="c1"></span>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;IOException on command socket&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInvokeWith</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mStartChildZygote</span>
                    <span class="o">||</span> <span class="o">!</span><span class="n">multipleOK</span> <span class="o">||</span> <span class="n">peer</span><span class="o">.</span><span class="na">getUid</span><span class="o">()</span> <span class="o">!=</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Continue using old code for now. TODO: Handle these cases in the other path.
</span><span class="c1"></span>                <span class="c1">//创建进程
</span><span class="c1"></span>                <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mGid</span><span class="o">,</span>
                        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mGids</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRuntimeFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span>
                        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mMountExternal</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mSeInfo</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span><span class="o">,</span>
                        <span class="n">fdsToClose</span><span class="o">,</span> <span class="n">fdsToIgnore</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mStartChildZygote</span><span class="o">,</span>
                        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInstructionSet</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mAppDataDir</span><span class="o">,</span>
                        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mIsTopApp</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPkgDataInfoList</span><span class="o">,</span>
                        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mWhitelistedDataInfoList</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mBindMountAppDataDirs</span><span class="o">,</span>
                        <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mBindMountAppStorageDirs</span><span class="o">);</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// in child
</span><span class="c1"></span>                        <span class="n">zygoteServer</span><span class="o">.</span><span class="na">setForkChild</span><span class="o">();</span>

                        <span class="n">zygoteServer</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>
                        <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
                        <span class="n">serverPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

                        <span class="k">return</span> <span class="n">handleChildProc</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">childPipeFd</span><span class="o">,</span>
                                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mStartChildZygote</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="c1">// In the parent. A pid &lt; 0 indicates a failure and will be handled in
</span><span class="c1"></span>                        <span class="c1">// handleParentProc.
</span><span class="c1"></span>                        <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
                        <span class="n">childPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">handleParentProc</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">serverPipeFd</span><span class="o">);</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
                    <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="c1">//...
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//...
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteconnectionhandlechildproc">ZygoteConnection#handleChildProc</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Runnable</span> <span class="nf">handleChildProc</span><span class="o">(</span><span class="n">ZygoteArguments</span> <span class="n">parsedArgs</span><span class="o">,</span>
        <span class="n">FileDescriptor</span> <span class="n">pipeFd</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isZygote</span><span class="o">)</span> <span class="o">{</span>
    <span class="cm">/*
</span><span class="cm">     * By the time we get here, the native code has closed the two actual Zygote
</span><span class="cm">     * socket connections, and substituted /dev/null in their place.  The LocalSocket
</span><span class="cm">     * objects still need to be closed properly.
</span><span class="cm">     */</span>

    <span class="n">closeSocket</span><span class="o">();</span>

    <span class="n">Zygote</span><span class="o">.</span><span class="na">setAppProcessName</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">TAG</span><span class="o">);</span>

    <span class="c1">// End of the postFork event.
</span><span class="c1"></span>    <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInvokeWith</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">WrapperInit</span><span class="o">.</span><span class="na">execApplication</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInvokeWith</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">,</span>
                <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getCurrentInstructionSet</span><span class="o">(),</span>
                <span class="n">pipeFd</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span><span class="o">);</span>

        <span class="c1">// Should not get here.
</span><span class="c1"></span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;WrapperInit.execApplication unexpectedly returned&#34;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isZygote</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">,</span>
                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mDisabledCompatChanges</span><span class="o">,</span>
                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/* classLoader */</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">childZygoteInit</span><span class="o">(</span>
                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span>  <span class="cm">/* classLoader */</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteinitzygoteinit">ZygoteInit#zygoteInit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">zygoteInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">disabledCompatChanges</span><span class="o">,</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">RuntimeInit</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">RuntimeInit</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span> <span class="s">&#34;RuntimeInit: Starting application from zygote&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">&#34;ZygoteInit&#34;</span><span class="o">);</span>
    <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">redirectLogStreams</span><span class="o">();</span>

    <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">commonInit</span><span class="o">();</span>
    <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">nativeZygoteInit</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">applicationInit</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">disabledCompatChanges</span><span class="o">,</span> <span class="n">argv</span><span class="o">,</span>
            <span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="zygoteinitchildzygote">ZygoteInit#childZygote</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">childZygoteInit</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">Arguments</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">findStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="cm">/* classLoader= */</span><span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="runtimeinitapplicationinit">RuntimeInit#applicationInit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/com/android/internal/os/RuntimeInit.java
</span><span class="c1"></span><span class="kd">protected</span> <span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">disabledCompatChanges</span><span class="o">,</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// If the application calls System.exit(), terminate the process
</span><span class="c1"></span>    <span class="c1">// immediately without running any shutdown hooks.  It is not possible to
</span><span class="c1"></span>    <span class="c1">// shutdown an Android application gracefully.  Among other things, the
</span><span class="c1"></span>    <span class="c1">// Android runtime shutdown hooks close the Binder driver, which can cause
</span><span class="c1"></span>    <span class="c1">// leftover running threads to crash before the process actually exits.
</span><span class="c1"></span>    <span class="n">nativeSetExitWithoutCleanup</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

    <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetSdkVersion</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">);</span>
    <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setDisabledCompatChanges</span><span class="o">(</span><span class="n">disabledCompatChanges</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">Arguments</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>

    <span class="c1">// The end of of the RuntimeInit event (see #zygoteInit).
</span><span class="c1"></span>    <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>

    <span class="c1">// Remaining arguments are passed to the start class&#39;s static main
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">findStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="runtimeinitfindstaticmain">RuntimeInit#findStaticMain</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/core/java/com/android/internal/os/RuntimeInit.java
</span><span class="c1"></span><span class="kd">protected</span> <span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">findStaticMain</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span>
        <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                <span class="s">&#34;Missing class when invoking static main &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span>
                <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">Method</span> <span class="n">m</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//反射获取main方法
</span><span class="c1"></span>        <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;main&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                <span class="s">&#34;Missing static main on &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SecurityException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                <span class="s">&#34;Problem getting static main on &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(!</span> <span class="o">(</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">isPublic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">)))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                <span class="s">&#34;Main method is not public and static on &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/*
</span><span class="cm">     * This throw gets caught in ZygoteInit.main(), which responds
</span><span class="cm">     * by invoking the exception&#39;s run() method. This arrangement
</span><span class="cm">     * clears up all the stack frames that were required in setting
</span><span class="cm">     * up the process.
</span><span class="cm">     */</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="methodandargscaller">MethodAndArgsCaller</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodAndArgsCaller</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
    <span class="cm">/** method to call */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Method</span> <span class="n">mMethod</span><span class="o">;</span>

    <span class="cm">/** argument array */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">mArgs</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MethodAndArgsCaller</span><span class="o">(</span><span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
        <span class="n">mArgs</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          	<span class="c1">//执行方法
</span><span class="c1"></span>            <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">mArgs</span> <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">RuntimeException</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="o">(</span><span class="n">RuntimeException</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">Error</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="o">(</span><span class="n">Error</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="activitythread初始化">ActivityThread初始化</h2>
<h3 id="atmain">AT#main</h3>
<p><code>Zygote</code>进程创建<code>ActivityThread</code>之后会执行它的<code>main</code>方法。<code>ActivityThread</code>的<code>main</code>方法会创建<code>ActivityThread</code>，并调用<code>attach</code>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  
    <span class="c1">//创建主线程 looper
</span><span class="c1"></span>    <span class="n">Looper</span><span class="o">.</span><span class="na">prepareMainLooper</span><span class="o">();</span>
		<span class="c1">//创建ActivityThread
</span><span class="c1"></span>    <span class="n">ActivityThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityThread</span><span class="o">();</span>
    <span class="n">thread</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">startSeq</span><span class="o">);</span><span class="c1">//调用attach
</span><span class="c1"></span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sMainThreadHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sMainThreadHandler</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">().</span><span class="na">setMessageLogging</span><span class="o">(</span><span class="k">new</span>
                <span class="n">LogPrinter</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">,</span> <span class="s">&#34;ActivityThread&#34;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// End of event ActivityThreadMain.
</span><span class="c1"></span>    <span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>

    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Main thread loop unexpectedly exited&#34;</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="atattach">AT#attach</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">attach</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">system</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startSeq</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sCurrentActivityThread</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="n">mSystemThread</span> <span class="o">=</span> <span class="n">system</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">system</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">android</span><span class="o">.</span><span class="na">ddm</span><span class="o">.</span><span class="na">DdmHandleAppName</span><span class="o">.</span><span class="na">setAppName</span><span class="o">(</span><span class="s">&#34;&lt;pre-initialized&gt;&#34;</span><span class="o">,</span>
                                                <span class="n">UserHandle</span><span class="o">.</span><span class="na">myUserId</span><span class="o">());</span>
        <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">setApplicationObject</span><span class="o">(</span><span class="n">mAppThread</span><span class="o">.</span><span class="na">asBinder</span><span class="o">());</span>
        <span class="c1">//获取ams
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">IActivityManager</span> <span class="n">mgr</span> <span class="o">=</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">getService</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//调用ams的attachApplication方法
</span><span class="c1"></span>            <span class="n">mgr</span><span class="o">.</span><span class="na">attachApplication</span><span class="o">(</span><span class="n">mAppThread</span><span class="o">,</span> <span class="n">startSeq</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//...
</span><span class="c1"></span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
       <span class="c1">//...
</span><span class="c1"></span>    <span class="o">}</span>
    <span class="c1">//...
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="amsattachapplication">AMS#attachApplication</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">attachApplication</span><span class="o">(</span><span class="n">IApplicationThread</span> <span class="n">thread</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startSeq</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">thread</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span><span class="s">&#34;Invalid application interface&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">callingPid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">callingUid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">origId</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
        <span class="n">attachApplicationLocked</span><span class="o">(</span><span class="n">thread</span><span class="o">,</span> <span class="n">callingPid</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">startSeq</span><span class="o">);</span>
        <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">origId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="amsattachapplicationlocked">AMS#attachApplicationLocked</h3>
<p><code>attachApplicationLocked</code>会调用<code>mAtmInternal</code>的<code>attachApplication</code>方法。<code>mAtmInternal</code>是<code>ActivityTaskManagerInternal</code>类型，它的子类是<code>ATMS</code>的内部类<code>LocalService</code>。在<code>ATMS</code>创建并添加到<code>LocalServices</code>中，并在<code>AMS</code>中获取。<code>LocalService</code>的<code>attachApplication</code>方法最终会调用<code>ATMS</code>的<code>attachApplication</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">&#34;this&#34;</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">attachApplicationLocked</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">IApplicationThread</span> <span class="n">thread</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">pid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callingUid</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startSeq</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// See if the top visible activity is waiting to run in this process...
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">normalMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span> <span class="c1">//调用mAtmInternal的方法。
</span><span class="c1"></span>            <span class="n">didSomething</span> <span class="o">=</span> <span class="n">mAtmInternal</span><span class="o">.</span><span class="na">attachApplication</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">getWindowProcessController</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Exception thrown launching activities in &#34;</span> <span class="o">+</span> <span class="n">app</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="n">badApp</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="atmsattachapplication">ATMS#attachApplication</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">attachApplication</span><span class="o">(</span><span class="n">WindowProcessController</span> <span class="n">wpc</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mGlobalLockWithoutBoost</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">isTagEnabled</span><span class="o">(</span><span class="n">TRACE_TAG_WINDOW_MANAGER</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">TRACE_TAG_WINDOW_MANAGER</span><span class="o">,</span> <span class="s">&#34;attachApplication:&#34;</span> <span class="o">+</span> <span class="n">wpc</span><span class="o">.</span><span class="na">mName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">mRootWindowContainer</span><span class="o">.</span><span class="na">attachApplication</span><span class="o">(</span><span class="n">wpc</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">TRACE_TAG_WINDOW_MANAGER</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="rwcattachapplication">RWC#attachApplication</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java
</span><span class="c1"></span><span class="kt">boolean</span> <span class="nf">attachApplication</span><span class="o">(</span><span class="n">WindowProcessController</span> <span class="n">app</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">didSomething</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">displayNdx</span> <span class="o">=</span> <span class="n">getChildCount</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">displayNdx</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="o">--</span><span class="n">displayNdx</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mTmpRemoteException</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">mTmpBoolean</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// Set to true if an activity was started.
</span><span class="c1"></span>
        <span class="kd">final</span> <span class="n">DisplayContent</span> <span class="n">display</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">displayNdx</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">areaNdx</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="na">getTaskDisplayAreaCount</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">areaNdx</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="o">--</span><span class="n">areaNdx</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">TaskDisplayArea</span> <span class="n">taskDisplayArea</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="na">getTaskDisplayAreaAt</span><span class="o">(</span><span class="n">areaNdx</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">taskNdx</span> <span class="o">=</span> <span class="n">taskDisplayArea</span><span class="o">.</span><span class="na">getStackCount</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">taskNdx</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">;</span> <span class="o">--</span><span class="n">taskNdx</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">ActivityStack</span> <span class="n">rootTask</span> <span class="o">=</span> <span class="n">taskDisplayArea</span><span class="o">.</span><span class="na">getStackAt</span><span class="o">(</span><span class="n">taskNdx</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">rootTask</span><span class="o">.</span><span class="na">getVisibility</span><span class="o">(</span><span class="kc">null</span> <span class="cm">/*starting*/</span><span class="o">)</span> <span class="o">==</span> <span class="n">STACK_VISIBILITY_INVISIBLE</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                 <span class="c1">//调用startActivityForAttachedApplicationIfNeeded方法
</span><span class="c1"></span>                <span class="kd">final</span> <span class="n">PooledFunction</span> <span class="n">c</span> <span class="o">=</span> <span class="n">PooledLambda</span><span class="o">.</span><span class="na">obtainFunction</span><span class="o">(</span>
                        <span class="n">RootWindowContainer</span><span class="o">::</span><span class="n">startActivityForAttachedApplicationIfNeeded</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span>
                        <span class="n">PooledLambda</span><span class="o">.</span><span class="na">__</span><span class="o">(</span><span class="n">ActivityRecord</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">app</span><span class="o">,</span>
                        <span class="n">rootTask</span><span class="o">.</span><span class="na">topRunningActivity</span><span class="o">());</span>
                <span class="n">rootTask</span><span class="o">.</span><span class="na">forAllActivities</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
                <span class="n">c</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mTmpRemoteException</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="n">mTmpRemoteException</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">didSomething</span> <span class="o">|=</span> <span class="n">mTmpBoolean</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">didSomething</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ensureActivitiesVisible</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="kc">false</span> <span class="cm">/* preserve_windows */</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">didSomething</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="rwcstartactivityforattachedapplicationifneeded">RWC#startActivityForAttachedApplicationIfNeeded</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">startActivityForAttachedApplicationIfNeeded</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">r</span><span class="o">,</span>
        <span class="n">WindowProcessController</span> <span class="n">app</span><span class="o">,</span> <span class="n">ActivityRecord</span> <span class="n">top</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">finishing</span> <span class="o">||</span> <span class="o">!</span><span class="n">r</span><span class="o">.</span><span class="na">okToShowLocked</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">r</span><span class="o">.</span><span class="na">visibleIgnoringKeyguard</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="na">app</span> <span class="o">!=</span> <span class="kc">null</span>
            <span class="o">||</span> <span class="n">app</span><span class="o">.</span><span class="na">mUid</span> <span class="o">!=</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span> <span class="o">||</span> <span class="o">!</span><span class="n">app</span><span class="o">.</span><span class="na">mName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span> <span class="c1">//调用realStartActivityLocked
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">realStartActivityLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span>
                <span class="n">top</span> <span class="o">==</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">isFocusable</span><span class="o">()</span> <span class="cm">/*andResume*/</span><span class="o">,</span> <span class="kc">true</span> <span class="cm">/*checkConfig*/</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">mTmpBoolean</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Exception in new application when starting activity &#34;</span>
                <span class="o">+</span> <span class="n">top</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getComponent</span><span class="o">().</span><span class="na">flattenToShortString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="n">mTmpRemoteException</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://calmcenter.club/2020/android-framework-activity.html">Android 11 Activity 启动分析</a></li>
</ul>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">系统源码分析</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/start-activity/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">startActivity流程分析</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/windowmanagerservice/">
            <span class="next-text nav-default">WindowManagerService分析</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://twitter.com/malinkang" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/malinkang" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/malinkang" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://malinkang.cn/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">malinkang</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>








</body>
</html>
