<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="【译】避免Android中内存泄漏的9种方法" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="原文，本文介绍了，引发内存泄露的常见情况，并给出了对应的修复方法。" /><meta property="og:description" content="原文，本文介绍了，引发内存泄露的常见情况，并给出了对应的修复方法。" /><link rel="canonical" href="https://malinkang.cn/posts/9-ways-to-avoid-memory-leaks-in-android/" /><meta property="og:url" content="https://malinkang.cn/posts/9-ways-to-avoid-memory-leaks-in-android/" /><meta property="og:site_name" content="malinkang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-06-10T14:33:57+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="【译】避免Android中内存泄漏的9种方法" /><meta name="twitter:site" content="@malinkang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"原文，本文介绍了，引发内存泄露的常见情况，并给出了对应的修复方法。","headline":"【译】避免Android中内存泄漏的9种方法","dateModified":"2019-06-10T14:33:57+08:00","url":"https://malinkang.cn/posts/9-ways-to-avoid-memory-leaks-in-android/","datePublished":"2019-06-10T14:33:57+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://malinkang.cn/posts/9-ways-to-avoid-memory-leaks-in-android/"},"@context":"https://schema.org"}</script><title>【译】避免Android中内存泄漏的9种方法 | malinkang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="malinkang"><meta name="application-name" content="malinkang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">malinkang</a></div><div class="site-subtitle font-italic">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/malinkang" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/malinkang" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['linkang.ma','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>【译】避免Android中内存泄漏的9种方法</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>【译】避免Android中内存泄漏的9种方法</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> malinkang </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 10, 2019, 2:33 PM +0800" prep="on" > Jun 10, 2019 <i class="unloaded">2019-06-10T14:33:57+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5236 words">29 min</span></div></div><div class="post-content"><p><a href="https://android.jlelse.eu/9-ways-to-avoid-memory-leaks-in-android-b6d81648e35e">原文</a>，本文介绍了，引发内存泄露的常见情况，并给出了对应的修复方法。</p><blockquote><p>I have been an android developer for quite some time now. And I <strong>realised（意识到）</strong> that most of that time, I tend to spend on adding new features to an app or working on visually enhancements of the app, rather than focusing on the core issues like performance and quality.</p></blockquote><p>我做安卓开发者已经有一段时间了。我意识到，大部分的时间，我倾向于花在为应用添加新功能，或者在应用的视觉增强上，而不是关注性能和质量等核心问题。</p><blockquote><p>This was me a while back when I would be asked to optimise or refactor code</p></blockquote><p>这是我前段时间被要求优化或重构代码时的情景</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/9-ways-to-avoid-memory-leaks-in-android-1.gif" alt="" /></p><blockquote><p>But these things have a way of catching up to you and I spent a long time wishing I had not ignored the important stuff. So in this article, I thought I would focus on one of the most important optimisation techniques in android: Memory leaks.</p></blockquote><p>但是这些东西有办法让你追上，我花了很长时间希望自己没有忽略重要的东西。所以在这篇文章中，我想我会关注<code class="language-plaintext highlighter-rouge">android</code>中最重要的优化技术之一：内存泄漏。</p><blockquote><p>There are a lot of articles on memory leaks and how to fix them. But when I was learning myself, I found that none of them were in one place and it was hard to keep track of it all. So I thought I would collectively post an article on it so that it might help people in the future.</p></blockquote><p>关于内存泄漏以及如何解决内存泄漏的文章很多。但是我自己在学习的时候，发现这些文章都不在一个地方，很难全部记录下来。所以我想，我就集体发一篇文章，这样可能会对以后的人有所帮助。</p><blockquote><p>So let’s begin.</p></blockquote><p>那么我们开始吧。</p><h2 id="什么是内存泄露-what-are-memory-leaks">什么是内存泄露？ （What are memory leaks?）</h2><blockquote><p>A memory leak happens when memory is allocated but never freed. This means the garbage collector is not able to take out the trash once we are done with the takeout. Initially, this might not be a problem. But imagine if you don’t take the trash out for 2 weeks! The house starts to smell right?</p></blockquote><p>当内存被分配但从未被释放时，就会发生内存泄漏。这意味着一旦我们吃完了外卖，垃圾回收器就无法回收垃圾。最初，这可能不是一个问题。但试想一下，如果你2个星期都不倒垃圾的话! 家里就开始有味道了吧?</p><blockquote><p>Similarly, as the user keeps on using our app, the memory also keeps on increasing and if the memory leaks are not plugged, then the unused memory cannot be freed up by the Garbage Collection. So the memory of our app will constantly increase until no more memory can be allocated to our app, leading to OutOfMemoryError which ultimately crashes the app.</p></blockquote><p>同样，随着用户不断的使用我们的app，内存也会不断的增加，如果不堵住内存泄漏的地方，那么未使用的内存就无法被垃圾回收释放出来。所以我们的应用的内存会不断的增加，直到不能再给我们的应用分配更多的内存，导致<code class="language-plaintext highlighter-rouge">OutOfMemoryError</code>，最终导致应用崩溃。</p><h2 id="那么如何检查我的应用是否泄露so-how-do-i-check-if-my-app-is-leaking">那么，如何检查我的应用是否泄露？(So how do I check if my app is leaking?)</h2><blockquote><p>I am sure everyone on the planet is aware of it but just in case, there is an awesome library called LeakyCanary that is great for finding out the leaks in our app along with the stack trace.</p></blockquote><p>我相信地球上的每个人都知道它，但为了以防万一，有一个很棒的库叫<a href="https://github.com/square/leakcanary">LeakyCanary</a>，它可以很好地找出我们应用程序中的泄漏以及堆栈跟踪。</p><h2 id="那么导致内存泄露的常见错误有哪些呢so-what-are-some-of-the-common-mistakes-that-lead-to-memory-leaks">那么，导致内存泄露的常见错误有哪些呢？(So what are some of the common mistakes that lead to memory leaks?)</h2><h3 id="1广播接受者broadcast-receivers">1.广播接受者（Broadcast Receivers:）</h3><blockquote><p>Consider this scenario - you need to register a local broadcast receiver in your activity. If you don’t unregister the broadcast receiver, then it still holds a reference to the activity, even if you close the activity.</p></blockquote><p>考虑这种情况–你需要在你的活动中注册一个本地广播接收器。如果你不取消注册广播接收器，那么即使你关闭了<code class="language-plaintext highlighter-rouge">activity</code>，它仍然持有对<code class="language-plaintext highlighter-rouge">activity</code>的引用。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BroadcastReceiverLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">BroadcastReceiver</span> <span class="n">broadcastReceiver</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerBroadCastReceiver</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">broadcastReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BroadcastReceiver</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//your receiver code goes here!</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">registerReceiver</span><span class="o">(</span><span class="n">broadcastReceiver</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IntentFilter</span><span class="o">(</span><span class="s">"SmsMessage.intent.MAIN"</span><span class="o">));</span>
    <span class="o">}</span>
    
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
        <span class="n">registerBroadCastReceiver</span><span class="o">();</span>
    <span class="o">}</span>    


    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onStop</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onStop</span><span class="o">();</span>

        <span class="cm">/*
         * Uncomment this line in order to avoid memory leak.
         * You need to unregister the broadcast receiver since the broadcast receiver keeps a reference of the activity.
         * Now when its time for your Activity to die, the Android framework will call onDestroy() on it
         * but the garbage collector will not be able to remove the instance from memory because the broadcastReceiver
         * is still holding a strong reference to it.
         * */</span>

        <span class="k">if</span><span class="o">(</span><span class="n">broadcastReceiver</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">unregisterReceiver</span><span class="o">(</span><span class="n">broadcastReceiver</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>How to solve this? Always remember to call unregister receiver in onStop() of the activity.</p></blockquote><p>如何解决这个问题？一定要记得在活动的<code class="language-plaintext highlighter-rouge">onStop()</code>中调用<code class="language-plaintext highlighter-rouge">unregisterReceiver</code>。</p><blockquote><p>Note: As Artem Demyanov pointed out, if the broadcast Receiver is registered in onCreate(), then when the app goes into the background and resumed again, the receiver will not be registered again. So it is always good to register the broadcastReceiver in onStart() or onResume() of the activity and unregister in onStop().</p></blockquote><p>注意：正如Artem Demyanov所指出的，如果广播接收器是在<code class="language-plaintext highlighter-rouge">onCreate()</code>中注册的，那么当应用程序进入后台并再次恢复时，接收器将不会被再次注册。所以最好在<code class="language-plaintext highlighter-rouge">activity</code>的<code class="language-plaintext highlighter-rouge">onStart()</code>或<code class="language-plaintext highlighter-rouge">onResume()</code>中注册广播接收器，并在<code class="language-plaintext highlighter-rouge">onStop()</code>中取消注册。</p><h3 id="2静态activity或者静态view引用2-static-activity-or-view-reference">2.静态Activity或者静态View引用（2. Static Activity or View Reference:）</h3><blockquote><p>Consider the below example — You are declaring a TextView as static (for whatever reason). If you reference an activity or view directly or indirectly from a static reference, the activity would not be garbage collected after it is destroyed.</p></blockquote><p>考虑下面的例子–你正在将一个<code class="language-plaintext highlighter-rouge">TextView</code>声明为静态（无论出于什么原因）。如果你直接或间接地从静态引用中引用一个<code class="language-plaintext highlighter-rouge">activity</code>或<code class="language-plaintext highlighter-rouge">view</code>，该<code class="language-plaintext highlighter-rouge">activity</code>在被销毁后不会被垃圾回收。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StaticReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="cm">/*  
     * This is a bad idea! 
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">TextView</span> <span class="n">textView</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Activity</span> <span class="n">activity</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>
        
        
        <span class="n">textView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">activity_text</span><span class="o">);</span>
        <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Bad Idea!"</span><span class="o">);</span>
           
        <span class="n">activity</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>How to solve this? Always remember to NEVER use static variables for views or activities or contexts.</p></blockquote><p>如何解决这个问题？永远记住，千万不要使用<code class="language-plaintext highlighter-rouge">view</code>或<code class="language-plaintext highlighter-rouge">activity</code>或<code class="language-plaintext highlighter-rouge">context</code>静态变量。</p><h3 id="3单例类引用3-singleton-class-reference">3.单例类引用（3. Singleton Class Reference:）</h3><blockquote><p>Consider the below example — you have defined a Singleton class as displayed below and you need to pass the context in order to fetch some files from the local storage.</p></blockquote><p>考虑下面的例子–你已经定义了一个<code class="language-plaintext highlighter-rouge">Singleton</code>类，如下图所示，你需要传递上下文，以便从本地存储中获取一些文件。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonLeakExampleActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">SingletonSampleClass</span> <span class="n">singletonSampleClass</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        
    <span class="cm">/* 
     * Option 1: Do not pass activity context to the Singleton class. Instead pass application Context
     */</span>      
        <span class="n">singletonSampleClass</span> <span class="o">=</span> <span class="nc">SingletonSampleClass</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
  
    
   <span class="nd">@Override</span>
   <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>

    <span class="cm">/* 
     * Option 2: Unregister the singleton class here i.e. if you pass activity context to the Singleton class, 
     * then ensure that when the activity is destroyed, the context in the singleton class is set to null.
     */</span>
     <span class="n">singletonSampleClass</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">SingletonSampleClass.java</code></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonSampleClass</span> <span class="o">{</span>
  
    <span class="kd">private</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">SingletonSampleClass</span> <span class="n">instance</span><span class="o">;</span>
  
    <span class="kd">private</span> <span class="nf">SingletonSampleClass</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kd">static</span> <span class="nc">SingletonSampleClass</span> <span class="nf">getInstance</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SingletonSampleClass</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">if</span><span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">context</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> 
       <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>How to solve this? Option 1: Instead of passing activity context i.e. this to the singleton class, you can pass applicationContext(). Option 2: If you really have to use activity context, then when the activity is destroyed, ensure that the context you passed to the singleton class is set to null.</p></blockquote><p>如何解决这个问题？</p><p>选项一：</p><p>如何解决这个问题？</p><ul><li>方案1：可以不传递活动上下文即这个给单子类，而是传递<code class="language-plaintext highlighter-rouge">applicationContext()</code>。<li>方案2：如果你真的要使用<code class="language-plaintext highlighter-rouge">activity</code>上下文，那么当<code class="language-plaintext highlighter-rouge">activity</code>被销毁时，确保你传递给单例类的上下文被设置为<code class="language-plaintext highlighter-rouge">null</code>。</ul><h3 id="4内部类引用4-inner-class-reference">4.内部类引用（4. Inner Class Reference:）</h3><blockquote><p>Consider the below example — you have defined a inner class called LeakyClass.java as displayed below and you need to pass the activity in order to redirect to a new activity.</p></blockquote><p>考虑下面的例子–你定义了一个名为<code class="language-plaintext highlighter-rouge">LeakyClass.java</code>的内部类，如下所示，你需要传递<code class="language-plaintext highlighter-rouge">activity</code>来跳转到一个新的<code class="language-plaintext highlighter-rouge">activity</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InnerClassReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

  <span class="cm">/* 
   * Mistake Number 1: 
   * Never create a static variable of an inner class
   * Fix I:
   * private LeakyClass leakyClass;
   */</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">LeakyClass</span> <span class="n">leakyClass</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>
        
        <span class="k">new</span> <span class="nf">LeakyClass</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">redirectToSecondScreen</span><span class="o">();</span>

        <span class="cm">/*
         * Inner class is defined here
         * */</span>
         <span class="n">leakyClass</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LeakyClass</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
         <span class="n">leakyClass</span><span class="o">.</span><span class="na">redirectToSecondScreen</span><span class="o">();</span>
    <span class="o">}</span>
    
  <span class="cm">/* 
   * Mistake Number 2: 
   * 1. Never create a inner variable of an inner class
   * 2. Never pass an instance of the activity to the inner class
   */</span>       
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">LeakyClass</span> <span class="o">{</span>
        
        <span class="kd">private</span> <span class="nc">Activity</span> <span class="n">activity</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">LeakyClass</span><span class="o">(</span><span class="nc">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">activity</span> <span class="o">=</span> <span class="n">activity</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">redirectToSecondScreen</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">activity</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="nc">SecondActivity</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>How to solve this? Option 1: As mentioned before never create a static variable of an inner class. Option 2: The class should be set to static. Instances of anonymous classes do not hold an implicit reference to their outer class when they are “static”. Option 3: Use a weakReference of any view/activity. Garbage collector can collect an object if only weak references are pointing towards it.</p></blockquote><p>如何解决这个问题？</p><ul><li>方案1：如前所述，千万不要创建一个内类的静态变量。<li>方案2：应该将类设置为静态。匿名类的实例在 “静态 “时不会对其外类持有隐式引用。<li>选项3：使用任何视图/活动的弱引用。如果只有弱引用指向一个对象，垃圾收集器可以收集这个对象。</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InnerClassReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

  <span class="cm">/* 
   * Mistake Number 1: 
   * Never create a static variable of an inner class
   * Fix I:
   */</span>
  <span class="kd">private</span> <span class="nc">LeakyClass</span> <span class="n">leakyClass</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>
        
        <span class="k">new</span> <span class="nf">LeakyClass</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">redirectToSecondScreen</span><span class="o">();</span>

        <span class="cm">/*
         * Inner class is defined here
         * */</span>
         <span class="n">leakyClass</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LeakyClass</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
         <span class="n">leakyClass</span><span class="o">.</span><span class="na">redirectToSecondScreen</span><span class="o">();</span>
    <span class="o">}</span>
  
  
    <span class="cm">/*  
     * How to fix the above class:
     * Fix memory leaks:
     * Option 1: The class should be set to static
     * Explanation: Instances of anonymous classes do not hold an implicit reference to their outer class 
     * when they are "static".
     *
     * Option 2: Use a weakReference of the textview or any view/activity for that matter
     * Explanation: Weak References: Garbage collector can collect an object if only weak references 
     * are pointing towards it.
     * */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LeakyClass</span> <span class="o">{</span>
        
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Activity</span><span class="o">&gt;</span> <span class="n">messageViewReference</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">LeakyClass</span><span class="o">(</span><span class="nc">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">activity</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="n">activity</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">redirectToSecondScreen</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Activity</span> <span class="n">activity</span> <span class="o">=</span> <span class="n">messageViewReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">activity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">activity</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="nc">SecondActivity</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>  
<span class="o">}</span>
</pre></table></code></div></div><h3 id="5匿名内部类引用5-anonymous-class-reference">5.匿名内部类引用（5. Anonymous Class Reference:）</h3><blockquote><p>This follows the same theory as above. Sample implementation for fixing memory leak is given below:</p></blockquote><p>这与上面的理论相同。下面给出了修复内存泄漏的实现示例。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnonymousClassReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">TextView</span> <span class="n">textView</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>


        <span class="n">textView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">activity_text</span><span class="o">);</span>
        <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">text_inner_class_1</span><span class="o">));</span>
        <span class="n">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">activity_dialog_btn</span><span class="o">).</span><span class="na">setVisibility</span><span class="o">(</span><span class="nc">View</span><span class="o">.</span><span class="na">INVISIBLE</span><span class="o">);</span>

        <span class="cm">/*
         * Runnable class is defined here
         * */</span>
         <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">LeakyRunnable</span><span class="o">(</span><span class="n">textView</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>



    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LeakyRunnable</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">TextView</span><span class="o">&gt;</span> <span class="n">messageViewReference</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nf">LeakyRunnable</span><span class="o">(</span><span class="nc">TextView</span> <span class="n">textView</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">messageViewReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="n">textView</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="n">messageViewReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">textView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Runnable class has completed its work"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="6asynctask引用6-asynctask-reference">6.AsyncTask引用（6. AsyncTask Reference:）</h3><blockquote><p>Consider the following example — You are using an asyncTask to get a string value which is used to update the textView in OnPostExecute().</p></blockquote><p>考虑下面的例子–你正在使用<code class="language-plaintext highlighter-rouge">AsyncTask</code>来获取一个字符串值，这个字符串值在<code class="language-plaintext highlighter-rouge">OnPostExecute()</code>中用来更新<code class="language-plaintext highlighter-rouge">textView</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsyncTaskReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">TextView</span> <span class="n">textView</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">BackgroundTask</span> <span class="n">backgroundTask</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>

        <span class="cm">/*
         * Executing AsyncTask here!
         * */</span>
        <span class="n">backgroundTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BackgroundTask</span><span class="o">(</span><span class="n">textView</span><span class="o">);</span>
        <span class="n">backgroundTask</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/*
     * Couple of things we should NEVER do here:
     * Mistake number 1. NEVER reference a class inside the activity. If we definitely need to, we should set the class as static as static inner classes don’t hold
     *    any implicit reference to its parent activity class
     * Mistake number 2. We should always cancel the asyncTask when activity is destroyed. This is because the asyncTask will still be executing even if the activity
     *    is destroyed.
     * Mistake number 3. Never use a direct reference of a view from acitivty inside an asynctask.
     * */</span>
 <span class="kd">private</span> <span class="kd">class</span> <span class="nc">BackgroundTask</span> <span class="kd">extends</span> <span class="nc">AsyncTask</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>    
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="nc">Void</span><span class="o">...</span> <span class="n">voids</span><span class="o">)</span> <span class="o">{</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="s">"The task is completed!"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>How to solve this? Option 1: We should always cancel the asyncTask when activity is destroyed. This is because the asyncTask will still be executing even if the activity is destroyed. Option 2: NEVER reference a class inside the activity. If we definitely need to, we should set the class as static as static inner classes don’t hold any implicit reference to its parent activity class. Option 3: Use a weakReference of the textview.</p></blockquote><p>如何解决这个问题？</p><ul><li>方案1：当activity被销毁时，我们应该总是取消asyncTask。因为即使activity被销毁，asyncTask仍然会执行。<li>方案2：永远不要在activity内部引用类。如果我们一定要这样做，我们应该把类设置为静态的，因为静态的内部类不会对它的父<code class="language-plaintext highlighter-rouge">activity</code>类持有任何隐式引用。<li>方案3：使用textview的弱引用。</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsyncTaskReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">TextView</span> <span class="n">textView</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">BackgroundTask</span> <span class="n">backgroundTask</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>

        <span class="cm">/*
         * Executing AsyncTask here!
         * */</span>
        <span class="n">backgroundTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BackgroundTask</span><span class="o">(</span><span class="n">textView</span><span class="o">);</span>
        <span class="n">backgroundTask</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="cm">/*
     * Fix number 1
     * */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BackgroundTask</span> <span class="kd">extends</span> <span class="nc">AsyncTask</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">TextView</span><span class="o">&gt;</span> <span class="n">messageViewReference</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nf">BackgroundTask</span><span class="o">(</span><span class="nc">TextView</span> <span class="n">textView</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">messageViewReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="n">textView</span><span class="o">);</span>
        <span class="o">}</span>


        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="nc">Void</span><span class="o">...</span> <span class="n">voids</span><span class="o">)</span> <span class="o">{</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="s">"The task is completed!"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
          <span class="cm">/*
           * Fix number 3
           * */</span>          
            <span class="nc">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="n">messageViewReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">textView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>

        <span class="cm">/*
         * Fix number 2
         * */</span>
        <span class="k">if</span><span class="o">(</span><span class="n">backgroundTask</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">backgroundTask</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="7handler引用7-handler-reference">7.Handler引用（7. Handler Reference:）</h3><blockquote><p>Consider the following example — You are using a Handler to redirect to a new screen after 5 seconds.</p></blockquote><p>考虑以下例子–你正在使用一个处理程序在5秒后跳转到一个新的界面。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HandlersReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">TextView</span> <span class="n">textView</span><span class="o">;</span>

    <span class="cm">/*
     * Mistake Number 1
     * */</span>
     <span class="kd">private</span> <span class="nc">Handler</span> <span class="n">leakyHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Handler</span><span class="o">();</span>


    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>

        <span class="cm">/*
         * Mistake Number 2
         * */</span>
        <span class="n">leakyHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">text_handler_1</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="mi">5000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>How to solve this? Option 1: NEVER reference a class inside the activity. If we definitely need to, we should set the class as static. This is because when a Handler is instantiated on the main thread, it is associated with the Looper’s message queue. Messages posted to the message queue will hold a reference to the Handler so that the framework can call Handler#handleMessage(Message) when the Looper eventually processes the message. Option 2: Use a weakReference of the Activity.</p></blockquote><p>如何解决这个问题？</p><ul><li>方案一：永远不要在活动里面引用类。如果一定要引用，我们应该将类设置为静态。这是因为当在主线程上实例化一个Handler时，它会与Looper的消息队列相关联。发布到消息队列中的消息将持有对Handler的引用，这样当Looper最终处理消息时，框架可以调用Handler#handleMessage(Message)。<li>方案2：使用Activity的弱引用。</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HandlersReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">TextView</span> <span class="n">textView</span><span class="o">;</span>

    <span class="cm">/*
     * Fix number I
     * */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">LeakyHandler</span> <span class="n">leakyHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LeakyHandler</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>

        <span class="n">leakyHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">leakyRunnable</span><span class="o">,</span> <span class="mi">5000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/*
     * Fix number II - define as static
     * */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LeakyHandler</span> <span class="kd">extends</span> <span class="nc">Handler</span> <span class="o">{</span>
      
    <span class="cm">/*
     * Fix number III - Use WeakReferences
     * */</span>      
        <span class="kd">private</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">HandlersReferenceLeakActivity</span><span class="o">&gt;</span> <span class="n">weakReference</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">LeakyHandler</span><span class="o">(</span><span class="nc">HandlersReferenceLeakActivity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">weakReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="n">activity</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">HandlersReferenceLeakActivity</span> <span class="n">activity</span> <span class="o">=</span> <span class="n">weakReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">activity</span><span class="o">.</span><span class="na">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">text_handler_2</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Runnable</span> <span class="n">leakyRunnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="8线程引用8-threads-reference">8.线程引用（8. Threads Reference:）</h3><blockquote><p>We can repeat this same mistake again with both the Thread and TimerTask classes.</p></blockquote><p>我们可以在Thread和TimerTask两个类中再次重复这个错误。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="cm">/*  
     * Mistake Number 1: Do not use static variables
     * */</span>    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">LeakyThread</span> <span class="n">thread</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>

        <span class="n">createThread</span><span class="o">();</span>
        <span class="n">redirectToNewScreen</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createThread</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LeakyThread</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">redirectToNewScreen</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">SecondActivity</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>


    <span class="cm">/*
     * Mistake Number 2: Non-static anonymous classes hold an 
     * implicit reference to their enclosing class.
     * */</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">LeakyThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>How to solve this? Option 1: Non-static anonymous classes hold an implicit reference to their enclosing class. Option 2: Close thread in activity onDestroy() to avoid thread leak.</p></blockquote><p>如何解决这个问题？</p><ul><li>方案1：非静态匿名类对其包围类持有一个隐式引用。<li>方案2：在onDestroy()活动中关闭线程，避免线程泄漏。</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="cm">/*
     * FIX I: make variable non static
     * */</span>
    <span class="kd">private</span> <span class="nc">LeakyThread</span> <span class="n">leakyThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LeakyThread</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>

        <span class="n">createThread</span><span class="o">();</span>
        <span class="n">redirectToNewScreen</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createThread</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">leakyThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">redirectToNewScreen</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">startActivity</span><span class="o">(</span><span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">SecondActivity</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
        <span class="c1">// FIX II: kill the thread</span>
        <span class="n">leakyThread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="cm">/*
     * Fix III: Make thread static
     * */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LeakyThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="9timetask引用9-timertask-reference">9.TimeTask引用（9. TimerTask Reference:）</h2><blockquote><p>The same principle is as Threads can be followed for TimerTask as well. Sample implementation for fixing memory leak is given below:</p></blockquote><p>TimerTask也可以遵循与Threads相同的原理。下面给出了修复内存泄漏的实现示例。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimerTaskReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">Activity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">CountDownTimer</span> <span class="n">countDownTimer</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>

        <span class="n">startTimer</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/*  
     * Mistake 1: Cancel Timer is never called 
     * even though activity might be completed
     * */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancelTimer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">countDownTimer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">countDownTimer</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
    <span class="o">}</span>

    
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">startTimer</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">countDownTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownTimer</span><span class="o">(</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onTick</span><span class="o">(</span><span class="kt">long</span> <span class="n">millisUntilFinished</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">secondsRemaining</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">millisUntilFinished</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">);</span>
                <span class="c1">//update UI</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFinish</span><span class="o">()</span> <span class="o">{</span>
                <span class="c1">//handle onFinish</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">countDownTimer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>How to solve this? Option 1: Cancel timer in activity onDestroy() to avoid memory leak.</p></blockquote><p>如何解决这个问题？ 方案1：在<code class="language-plaintext highlighter-rouge">activity</code>的<code class="language-plaintext highlighter-rouge">onDestroy()</code>中取消定时器，避免内存泄漏。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimerTaskReferenceLeakActivity</span> <span class="kd">extends</span> <span class="nc">Activity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">CountDownTimer</span> <span class="n">countDownTimer</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_first</span><span class="o">);</span>

        <span class="n">startTimer</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancelTimer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">countDownTimer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">countDownTimer</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">startTimer</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">countDownTimer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownTimer</span><span class="o">(</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onTick</span><span class="o">(</span><span class="kt">long</span> <span class="n">millisUntilFinished</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">secondsRemaining</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">millisUntilFinished</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">);</span>
                <span class="c1">//update UI</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFinish</span><span class="o">()</span> <span class="o">{</span>
                <span class="c1">//handle onFinish</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">countDownTimer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
  
  
    <span class="cm">/*
     * Fix 1: Cancel Timer when 
     * activity might be completed
     * */</span>  
   <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
        <span class="n">cancelTimer</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p>So basically to summarise:</p><ol><li>Use applicationContext() instead of activity context when possible. If you really have to use activity context, then when the activity is destroyed, ensure that the context you passed to the class is set to null.<li>Never use static variables to declare views or activity context.<li>Never reference a class inside the activity. If we need to, we should declare it as static, whether it is a thread or a handler or a timer or an asyncTask.<li>Always make sure to unregister broadcastReceivers or timers inside the activity. Cancel any asyncTasks or Threads inside onDestroy().<li>Always use a weakReference of the activity or view when needed.</ol></blockquote><p>所以基本上要总结一下。</p><ol><li>尽可能使用applicationContext()来代替活动上下文。如果你真的要使用活动上下文，那么当活动被销毁时，确保你传递给类的上下文被设置为null。<li>千万不要使用静态变量来声明view或activity上下文。<li>千万不要在活动内部引用类。如果需要，我们应该将其声明为静态，不管它是线程还是处理程序，还是定时器或asyncTask。<li>一定要确保在activity里面取消注册broadcastReceivers或定时器。在onDestroy()里面取消任何asyncTask或Threads。<li>在需要的时候，一定要使用活动或视图的弱引用。</ol><blockquote><p>And that’s it folks! Thanks for reading! I hope you enjoyed this article and found it useful, if so please hit the Clap button. Let me know your thoughts in the comments section. Happy coding!</p></blockquote><p>就这样了，朋友们! 谢谢大家的阅读! 我希望你喜欢这篇文章，并发现它是有用的，如果是这样，请点击拍手按钮。在评论区告诉我你的想法。 祝你编码愉快。</p><h2 id="更多资料">更多资料</h2><ul><li><a href="https://www.youtube.com/watch?v=BkbHeFHn8JY">DO NOT LEAK VIEWS (Android Performance Patterns Season 3 ep6)</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >Android</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=【译】避免Android中内存泄漏的9种方法 - malinkang&url=https://malinkang.cn/posts/9-ways-to-avoid-memory-leaks-in-android/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=【译】避免Android中内存泄漏的9种方法 - malinkang&u=https://malinkang.cn/posts/9-ways-to-avoid-memory-leaks-in-android/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=【译】避免Android中内存泄漏的9种方法 - malinkang&url=https://malinkang.cn/posts/9-ways-to-avoid-memory-leaks-in-android/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dagger-guide/">Dagger使用指南</a><li><a href="/posts/understanding-the-jvm-runtime-data-areas/">《深入理解JVM》第2章Java内存区域与内存溢出异常</a><li><a href="/posts/understanding-the-jvm-garbage-collection/">《深入理解JVM》第3章垃圾收集器</a><li><a href="/posts/understanding-the-jvm-class-file-structure/">《深入理解JVM》第6章类文件结构</a><li><a href="/posts/understanding-the-jvm-class-loader/">《深入理解JVM》第7章虚拟机类加载机制</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/runtime-permissions/"><div class="card-body"> <span class="timeago small" > Dec 25, 2018 <i class="unloaded">2018-12-25T04:25:35+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android运行时权限</h3><div class="text-muted small"><p> 权限的作用是保护 Android 用户的隐私。Android 应用必须请求权限才能访问敏感的用户数据（例如联系人和短信）以及某些系统功能（例如相机和互联网）。系统可能会自动授予权限，也可能会提示用户批准请求，具体取决于访问的功能。 Android 安全架构的设计主旨是：在默认情况下，任何应用都没有权限执行会对其他应用、操作系统或用户带来不利影响的任何操作。这包括读取或写入用户的私有数据（例...</p></div></div></a></div><div class="card"> <a href="/posts/android-crash-performance/"><div class="card-body"> <span class="timeago small" > Mar 5, 2019 <i class="unloaded">2019-03-05T10:08:28+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android崩溃优化</h3><div class="text-muted small"><p> Android的两种崩溃 Android崩溃分为Java崩溃和Native崩溃。Java崩溃就是在Java代码中，出现了未捕获异常，导致程序异常退出。Native崩溃一般都是因为在Native代码中访问非法地址，也可能是地址对齐出现的问题，或者发生了程序主动abort，这些都会产生相应的signal信号，导致程序异常退出。 1.Native崩溃的捕获流程 2.Native崩溃捕获的...</p></div></div></a></div><div class="card"> <a href="/posts/android-memory-performance/"><div class="card-body"> <span class="timeago small" > Mar 5, 2019 <i class="unloaded">2019-03-05T15:10:02+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android优化之内存优化</h3><div class="text-muted small"><p> 目录 使用内存效率更高的代码结构 谨慎使用服务 使用经过优化的数据容器 谨慎对待代码抽象 针对序列化数据使用精简版-protobuf 避免内存抖动 移除会占用大量内存的资源和库 缩减总体 apk大小 使用-...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/android-handler/" class="btn btn-outline-primary" prompt="Older"><p>Handler的使用和原理分析</p></a> <a href="/posts/android-activity-launch-process/" class="btn btn-outline-primary" prompt="Newer"><p>Activity的启动流程</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//malinkang-cn.disqus.com/embed.js', disqusConfig: function() { this.page.title = '【译】避免Android中内存泄漏的9种方法'; this.page.url = 'https://malinkang.cn/posts/9-ways-to-avoid-memory-leaks-in-android/'; this.page.identifier = '/posts/9-ways-to-avoid-memory-leaks-in-android/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/malinkang">malinkang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://malinkang.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
