<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Zygote进程启动流程" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="在Android系统中，应用程序进程以及运行系统的关键服务的SystemServer进程都是由Zygote进程来创建的，我们也将它称为孵化器。它通过fork（复制进程）的形式来创建应用程序进程和SystemServer进程。" /><meta property="og:description" content="在Android系统中，应用程序进程以及运行系统的关键服务的SystemServer进程都是由Zygote进程来创建的，我们也将它称为孵化器。它通过fork（复制进程）的形式来创建应用程序进程和SystemServer进程。" /><link rel="canonical" href="https://malinkang.cn/posts/framework-zygote/" /><meta property="og:url" content="https://malinkang.cn/posts/framework-zygote/" /><meta property="og:site_name" content="malinkang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-01-11T23:01:48+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Zygote进程启动流程" /><meta name="twitter:site" content="@malinkang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"在Android系统中，应用程序进程以及运行系统的关键服务的SystemServer进程都是由Zygote进程来创建的，我们也将它称为孵化器。它通过fork（复制进程）的形式来创建应用程序进程和SystemServer进程。","headline":"Zygote进程启动流程","dateModified":"2020-01-11T23:01:48+08:00","url":"https://malinkang.cn/posts/framework-zygote/","datePublished":"2020-01-11T23:01:48+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://malinkang.cn/posts/framework-zygote/"},"@context":"https://schema.org"}</script><title>Zygote进程启动流程 | malinkang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="malinkang"><meta name="application-name" content="malinkang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">malinkang</a></div><div class="site-subtitle font-italic">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/malinkang" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/malinkang" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['linkang.ma','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Zygote进程启动流程</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Zygote进程启动流程</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> malinkang </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jan 11, 2020, 11:01 PM +0800" prep="on" > Jan 11, 2020 <i class="unloaded">2020-01-11T23:01:48+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4619 words">25 min</span></div></div><div class="post-content"><p>在Android系统中，应用程序进程以及运行系统的关键服务的<code class="language-plaintext highlighter-rouge">SystemServer</code>进程都是由<code class="language-plaintext highlighter-rouge">Zygote</code>进程来创建的，我们也将它称为孵化器。它通过<code class="language-plaintext highlighter-rouge">fork</code>（复制进程）的形式来创建应用程序进程和<code class="language-plaintext highlighter-rouge">SystemServer</code>进程。</p><p>Zygote进程是在init进程启动时创建的，起初Zygote进程的名称并不是叫“zygote”，而是叫“app_process”，这个名称是在Android.mk中定义的，Zygote进程启动后，Linux系统下的pctrl系统会调用app_process，将其名称换成了“zygote”。</p><h2 id="zygote启动脚本分析">Zygote启动脚本分析</h2><p>在<code class="language-plaintext highlighter-rouge">init.rc</code>文件中采用了<code class="language-plaintext highlighter-rouge">import</code>引入<code class="language-plaintext highlighter-rouge">Zygote</code>启动脚本。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">//system/core/rootdir/init.rc</span>
<span class="kn">import</span> <span class="err">/</span><span class="nn">init.</span><span class="err">$</span><span class="o">{</span><span class="n">ro</span><span class="o">.</span><span class="na">hardware</span><span class="o">}.</span><span class="na">rc</span>
<span class="kn">import</span> <span class="err">/</span><span class="nn">init.usb.configfs.rc</span>
<span class="kn">import</span> <span class="err">/</span><span class="nn">init.</span><span class="err">$</span><span class="o">{</span><span class="n">ro</span><span class="o">.</span><span class="na">zygote</span><span class="o">}.</span><span class="na">rc</span><span class="c1">//导入zygote.rc</span>
</pre></table></code></div></div><p>可以看出<code class="language-plaintext highlighter-rouge">init.rc</code>不会直接引入一个固定的文件，而是根据属性ro.zygote的内容来引入不同的文件。</p><p>从<code class="language-plaintext highlighter-rouge">Android 5.0</code>开始，Android开始支持64位程序，Zygote也就有了32位和64位的区别，所以在这里用<code class="language-plaintext highlighter-rouge">ro.zygote</code>属性来控制使用不同的<code class="language-plaintext highlighter-rouge">Zygote</code>启动脚本，从而也就启动了不同版本的<code class="language-plaintext highlighter-rouge">Zygote</code>进程，<code class="language-plaintext highlighter-rouge">ro.zygote</code>属性的取值有以下4种：</p><ul><li>init.zygote32.rc<li>init.zygote32_64.rc<li>init.zygote64.rc<li>init.zygote64_32.rc</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">//system/core/rootdir/init.zygote64.rc</span>
<span class="c1">//启动zygote service 路径/system/bin/app_process64</span>
<span class="n">service</span> <span class="n">zygote</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">app_process64</span> <span class="o">-</span><span class="nc">Xzygote</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span> <span class="o">--</span><span class="n">zygote</span> <span class="o">--</span><span class="n">start</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">server</span>
    <span class="kd">class</span> <span class="nc">main</span>
    <span class="n">socket</span> <span class="n">zygote</span> <span class="n">stream</span> <span class="mi">660</span> <span class="n">root</span> <span class="n">system</span>
    <span class="n">onrestart</span> <span class="n">write</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">android_power</span><span class="o">/</span><span class="n">request_state</span> <span class="n">wake</span>
    <span class="n">onrestart</span> <span class="n">write</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">power</span><span class="o">/</span><span class="n">state</span> <span class="n">on</span>
    <span class="n">onrestart</span> <span class="n">restart</span> <span class="n">audioserver</span>
    <span class="n">onrestart</span> <span class="n">restart</span> <span class="n">cameraserver</span>
    <span class="n">onrestart</span> <span class="n">restart</span> <span class="n">media</span>
    <span class="n">onrestart</span> <span class="n">restart</span> <span class="n">netd</span>
    <span class="n">writepid</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">cpuset</span><span class="o">/</span><span class="n">foreground</span><span class="o">/</span><span class="n">tasks</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/cmds/app_process/Android.mk</span>
<span class="n">include</span> <span class="err">$</span><span class="o">(</span><span class="no">CLEAR_VARS</span><span class="o">)</span>

<span class="nl">LOCAL_SRC_FILES:</span><span class="o">=</span> <span class="err">\</span>
    <span class="n">app_main</span><span class="o">.</span><span class="na">cpp</span>

<span class="no">LOCAL_SHARED_LIBRARIES</span> <span class="o">:=</span> <span class="err">\</span>
    <span class="n">libcutils</span> <span class="err">\</span>
    <span class="n">libutils</span> <span class="err">\</span>
    <span class="n">liblog</span> <span class="err">\</span>
    <span class="n">libbinder</span> <span class="err">\</span>
    <span class="n">libandroid_runtime</span> <span class="err">\</span>
    <span class="err">$</span><span class="o">(</span><span class="n">app_process_common_shared_libs</span><span class="o">)</span> <span class="err">\</span>

<span class="no">LOCAL_WHOLE_STATIC_LIBRARIES</span> <span class="o">:=</span> <span class="n">libsigchain</span>

<span class="no">LOCAL_LDFLAGS</span> <span class="o">:=</span> <span class="o">-</span><span class="n">ldl</span> <span class="o">-</span><span class="nc">Wl</span><span class="o">,--</span><span class="n">version</span><span class="o">-</span><span class="n">script</span><span class="o">,</span><span class="n">art</span><span class="o">/</span><span class="n">sigchainlib</span><span class="o">/</span><span class="n">version</span><span class="o">-</span><span class="n">script</span><span class="o">.</span><span class="na">txt</span> <span class="o">-</span><span class="nc">Wl</span><span class="o">,--</span><span class="n">export</span><span class="o">-</span><span class="n">dynamic</span>
<span class="no">LOCAL_CPPFLAGS</span> <span class="o">:=</span> <span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c</span><span class="o">++</span><span class="mi">11</span>

<span class="no">LOCAL_MODULE</span> <span class="o">:=</span> <span class="n">app_process__asan</span>
<span class="no">LOCAL_MULTILIB</span> <span class="o">:=</span> <span class="n">both</span> <span class="c1">//编译32位和64位</span>
<span class="no">LOCAL_MODULE_STEM_32</span> <span class="o">:=</span> <span class="n">app_process32</span> <span class="c1">//32位</span>
<span class="no">LOCAL_MODULE_STEM_64</span> <span class="o">:=</span> <span class="n">app_process64</span><span class="c1">//64位</span>
</pre></table></code></div></div><h2 id="app_main">app_main</h2><h3 id="main">main</h3><p><code class="language-plaintext highlighter-rouge">app_main.cpp</code>的<code class="language-plaintext highlighter-rouge">main</code>方法会接收传进的来参数，并根据传进来的参数调用<code class="language-plaintext highlighter-rouge">AndroidRuntime</code>的<code class="language-plaintext highlighter-rouge">start</code>方法。</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/cmds/app_process/app_main.cpp</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="c1">//...</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--zygote"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
            <span class="n">zygote</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">//传进来的参数--zygote 将布尔值zygote设置为true</span>
            <span class="n">niceName</span> <span class="o">=</span> <span class="n">ZYGOTE_NICE_NAME</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--start-system-server"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">startSystemServer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">//启动SystemServer进程</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--application"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">application</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--nice-name="</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">niceName</span><span class="p">.</span><span class="n">setTo</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">className</span><span class="p">.</span><span class="n">setTo</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="o">--</span><span class="n">i</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
        <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String8</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">className</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
       <span class="c1">//...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//...</span>
        <span class="c1">//start-system-server写入参数中</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">startSystemServer</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">String8</span><span class="p">(</span><span class="s">"start-system-server"</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="c1">//...</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">niceName</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//线程名字不是空 设置线程名字</span>
        <span class="n">runtime</span><span class="p">.</span><span class="n">setArgv0</span><span class="p">(</span><span class="n">niceName</span><span class="p">.</span><span class="n">string</span><span class="p">());</span>
        <span class="n">set_process_name</span><span class="p">(</span><span class="n">niceName</span><span class="p">.</span><span class="n">string</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zygote</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//调用AppRuntime的start方法启动ZygoteInit</span>
        <span class="n">runtime</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">"com.android.internal.os.ZygoteInit"</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">zygote</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">className</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">runtime</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">"com.android.internal.os.RuntimeInit"</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">zygote</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error: no class name or --zygote supplied.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">app_usage</span><span class="p">();</span>
        <span class="n">LOG_ALWAYS_FATAL</span><span class="p">(</span><span class="s">"app_process: no class name or --zygote supplied."</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="androidruntime">AndroidRuntime</h2><h3 id="start">start</h3><p><code class="language-plaintext highlighter-rouge">AndroidRuntime</code>的<code class="language-plaintext highlighter-rouge">start</code>方法负责启动虚拟机，并根据传进来的类名，获取到对应的类，并执行该类的<code class="language-plaintext highlighter-rouge">main</code>方法。在<code class="language-plaintext highlighter-rouge">app_main.cpp</code>的<code class="language-plaintext highlighter-rouge">main</code>方法中，我们传进来的是<code class="language-plaintext highlighter-rouge">ZygoteInit</code>类， 所以执行的就是<code class="language-plaintext highlighter-rouge">ZygoteInit</code>的<code class="language-plaintext highlighter-rouge">main</code>方法。</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/jni/AndroidRuntime.cpp</span>
<span class="kt">void</span> <span class="n">AndroidRuntime</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">className</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String8</span><span class="o">&gt;&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">zygote</span><span class="p">)</span>
<span class="p">{</span>   <span class="c1">//...</span>
    <span class="n">JniInvocation</span> <span class="n">jni_invocation</span><span class="p">;</span>
    <span class="n">jni_invocation</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">;</span>
    <span class="c1">//启动虚拟机</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">startVm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mJavaVM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">,</span> <span class="n">zygote</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">onVmCreated</span><span class="p">(</span><span class="n">env</span><span class="p">);</span> <span class="c1">//启动虚拟机后的回调</span>
    <span class="c1">//...</span>

    <span class="c1">//将className中的. 替换为/</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">slashClassName</span> <span class="o">=</span> <span class="n">toSlashClassName</span><span class="p">(</span><span class="n">className</span><span class="p">);</span>
    <span class="c1">//寻找类</span>
    <span class="n">jclass</span> <span class="n">startClass</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">slashClassName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">startClass</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"JavaVM unable to locate class '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">slashClassName</span><span class="p">);</span>
        <span class="cm">/* keep going */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//获取main方法</span>
        <span class="n">jmethodID</span> <span class="n">startMeth</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">(</span><span class="n">startClass</span><span class="p">,</span> <span class="s">"main"</span><span class="p">,</span>
            <span class="s">"([Ljava/lang/String;)V"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">startMeth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ALOGE</span><span class="p">(</span><span class="s">"JavaVM unable to find main() in '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">className</span><span class="p">);</span>
            <span class="cm">/* keep going */</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//调用main方法</span>
            <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">startClass</span><span class="p">,</span> <span class="n">startMeth</span><span class="p">,</span> <span class="n">strArray</span><span class="p">);</span>

<span class="c">#if 0
            if (env-&gt;ExceptionCheck())
                threadExitUncaughtException(env);
#endif
</span>        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="zygoteinit">ZygoteInit</h2><h3 id="main-1">main</h3><p>在<code class="language-plaintext highlighter-rouge">ZygoteInit</code>的<code class="language-plaintext highlighter-rouge">main</code>方法中，主要做了四件事情：</p><ul><li>注册一个Socket<li>预加载各种资源<li>启动SystemServer<li>进入循环，等待AMS请求创建新的进程</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
    <span class="c1">//...</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//...</span>
        <span class="c1">//注册一个Socket </span>
        <span class="n">registerZygoteSocket</span><span class="o">(</span><span class="n">socketName</span><span class="o">);</span> 
        <span class="c1">//...</span>
        <span class="c1">//预加载各种资源</span>
        <span class="n">preload</span><span class="o">();</span> 
        <span class="c1">//...</span>
        <span class="c1">//启动SystemServer</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">startSystemServer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">startSystemServer</span><span class="o">(</span><span class="n">abiList</span><span class="o">,</span> <span class="n">socketName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Accepting command socket connections"</span><span class="o">);</span>
        <span class="c1">//死循环</span>
        <span class="n">runSelectLoop</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span> 
        <span class="n">closeServerSocket</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">MethodAndArgsCaller</span> <span class="n">caller</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">caller</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Zygote died with exception"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="n">closeServerSocket</span><span class="o">();</span>
        <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span> 
</pre></table></code></div></div><h3 id="registerzygotesocket">registerZygoteSocket</h3><p><code class="language-plaintext highlighter-rouge">registerZygoteSocket</code>方法主要负责注册一个<code class="language-plaintext highlighter-rouge">Socket</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerZygoteSocket</span><span class="o">(</span><span class="nc">String</span> <span class="n">socketName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sServerSocket</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">fileDesc</span><span class="o">;</span>
        <span class="c1">//拼接socket名字</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">fullSocketName</span> <span class="o">=</span> <span class="no">ANDROID_SOCKET_PREFIX</span> <span class="o">+</span> <span class="n">socketName</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="n">fullSocketName</span><span class="o">);</span>
            <span class="n">fileDesc</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">fullSocketName</span> <span class="o">+</span> <span class="s">" unset or invalid"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileDescriptor</span><span class="o">();</span>
            <span class="n">fd</span><span class="o">.</span><span class="na">setInt</span><span class="err">$</span><span class="o">(</span><span class="n">fileDesc</span><span class="o">);</span>
             <span class="c1">//创建Socket</span>
            <span class="n">sServerSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LocalServerSocket</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                    <span class="s">"Error binding to local socket '"</span> <span class="o">+</span> <span class="n">fileDesc</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="startsystemserver">startSystemServer</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">startSystemServer</span><span class="o">(</span><span class="nc">String</span> <span class="n">abiList</span><span class="o">,</span> <span class="nc">String</span> <span class="n">socketName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">MethodAndArgsCaller</span><span class="o">,</span> <span class="nc">RuntimeException</span> <span class="o">{</span>

    <span class="c1">//创建数组，保存启动SystemServer的启动参数</span>
    <span class="cm">/* Hardcoded command line to start the system server */</span>
    <span class="nc">String</span> <span class="n">args</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
        <span class="s">"--setuid=1000"</span><span class="o">,</span>
        <span class="s">"--setgid=1000"</span><span class="o">,</span>
        <span class="s">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010"</span><span class="o">,</span>
        <span class="s">"--capabilities="</span> <span class="o">+</span> <span class="n">capabilities</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">capabilities</span><span class="o">,</span>
        <span class="s">"--nice-name=system_server"</span><span class="o">,</span>
        <span class="s">"--runtime-args"</span><span class="o">,</span>
        <span class="s">"com.android.server.SystemServer"</span><span class="o">,</span>
    <span class="o">};</span>
    <span class="nc">ZygoteConnection</span><span class="o">.</span><span class="na">Arguments</span> <span class="n">parsedArgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kt">int</span> <span class="n">pid</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">parsedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZygoteConnection</span><span class="o">.</span><span class="na">Arguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="nc">ZygoteConnection</span><span class="o">.</span><span class="na">applyDebuggerSystemProperty</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
        <span class="nc">ZygoteConnection</span><span class="o">.</span><span class="na">applyInvokeWithSystemProperty</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>

        <span class="cm">/* Request to fork the system server process */</span>
      <span class="c1">//fork一个新进程</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">forkSystemServer</span><span class="o">(</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span>
                <span class="kc">null</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">permittedCapabilities</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">effectiveCapabilities</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/* For child process */</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasSecondZygote</span><span class="o">(</span><span class="n">abiList</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">waitForSecondaryZygote</span><span class="o">(</span><span class="n">socketName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//处理SystemServer</span>
        <span class="n">handleSystemServerProcess</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="runselectloop">runSelectLoop</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runSelectLoop</span><span class="o">(</span><span class="nc">String</span> <span class="n">abiList</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MethodAndArgsCaller</span> <span class="o">{</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">FileDescriptor</span><span class="o">&gt;</span> <span class="n">fds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">FileDescriptor</span><span class="o">&gt;();</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ZygoteConnection</span><span class="o">&gt;</span> <span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ZygoteConnection</span><span class="o">&gt;();</span>

    <span class="n">fds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sServerSocket</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">());</span>
    <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="c1">//无限循环等待AMS的请求</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">StructPollfd</span><span class="o">[]</span> <span class="n">pollFds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StructPollfd</span><span class="o">[</span><span class="n">fds</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pollFds</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StructPollfd</span><span class="o">();</span>
            <span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">fd</span> <span class="o">=</span> <span class="n">fds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">events</span> <span class="o">=</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="no">POLLIN</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Os</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">pollFds</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ErrnoException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"poll failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pollFds</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">--</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">pollFds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">revents</span> <span class="o">&amp;</span> <span class="no">POLLIN</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> 
                <span class="c1">//有新的连接请求</span>
                <span class="nc">ZygoteConnection</span> <span class="n">newPeer</span> <span class="o">=</span> <span class="n">acceptCommandPeer</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
                <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">);</span>
                <span class="n">fds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">newPeer</span><span class="o">.</span><span class="na">getFileDesciptor</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">//已建立的连接中有客户端发过来的数据需要处理</span>
                <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="n">peers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">runOnce</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">peers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="n">fds</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="acceptcommandpeer">acceptCommandPeer</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="nc">ZygoteConnection</span> <span class="nf">acceptCommandPeer</span><span class="o">(</span><span class="nc">String</span> <span class="n">abiList</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ZygoteConnection</span><span class="o">(</span><span class="n">sServerSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">(),</span> <span class="n">abiList</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
              <span class="s">"IOException during accept()"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="zygoteconnection">ZygoteConnection</h2><h3 id="构造函数">构造函数</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span>
<span class="nc">ZygoteConnection</span><span class="o">(</span><span class="nc">LocalSocket</span> <span class="n">socket</span><span class="o">,</span> <span class="nc">String</span> <span class="n">abiList</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="n">mSocket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">abiList</span> <span class="o">=</span> <span class="n">abiList</span><span class="o">;</span>

      <span class="n">mSocketOutStream</span>
              <span class="o">=</span> <span class="k">new</span> <span class="nc">DataOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>

      <span class="n">mSocketReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span>
              <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()),</span> <span class="mi">256</span><span class="o">);</span>

      <span class="n">mSocket</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="no">CONNECTION_TIMEOUT_MILLIS</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="n">peer</span> <span class="o">=</span> <span class="n">mSocket</span><span class="o">.</span><span class="na">getPeerCredentials</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Cannot read peer credentials"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
          <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="runonce">runOnce</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span>
<span class="kt">boolean</span> <span class="nf">runOnce</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
    <span class="c1">//...</span>
    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="nc">FileDescriptor</span> <span class="n">childPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">FileDescriptor</span> <span class="n">serverPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">parsedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Arguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">abiListQuery</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">handleAbiListQuery</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">permittedCapabilities</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">effectiveCapabilities</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ZygoteSecurityException</span><span class="o">(</span><span class="s">"Client may not specify capabilities: "</span> <span class="o">+</span>
                    <span class="s">"permitted=0x"</span> <span class="o">+</span> <span class="nc">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">permittedCapabilities</span><span class="o">)</span> <span class="o">+</span>
                    <span class="s">", effective=0x"</span> <span class="o">+</span> <span class="nc">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">effectiveCapabilities</span><span class="o">));</span>
        <span class="o">}</span> 
        <span class="c1">//...</span>
        <span class="kt">int</span> <span class="o">[]</span> <span class="n">fdsToClose</span> <span class="o">=</span> <span class="o">{</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">};</span>

        <span class="nc">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">mSocket</span><span class="o">.</span><span class="na">getFileDescriptor</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fdsToClose</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="na">getInt</span><span class="err">$</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">getServerSocketFileDescriptor</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fdsToClose</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="na">getInt</span><span class="err">$</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">//创建应用程序进程 返回pid</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mountExternal</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">seInfo</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">instructionSet</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">appDataDir</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ErrnoException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logAndPrintError</span><span class="o">(</span><span class="n">newStderr</span><span class="o">,</span> <span class="s">"Exception creating pipe"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logAndPrintError</span><span class="o">(</span><span class="n">newStderr</span><span class="o">,</span> <span class="s">"Invalid zygote arguments"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ZygoteSecurityException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logAndPrintError</span><span class="o">(</span><span class="n">newStderr</span><span class="o">,</span>
                <span class="s">"Zygote security policy prevents request: "</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// in child</span>
            <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
            <span class="n">serverPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
           <span class="c1">//②</span>
            <span class="n">handleChildProc</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">childPipeFd</span><span class="o">,</span> <span class="n">newStderr</span><span class="o">);</span>

            <span class="c1">// should never get here, the child is expected to either</span>
            <span class="c1">// throw ZygoteInit.MethodAndArgsCaller or exec().</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// in parent...pid of &lt; 0 means failure</span>
            <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
            <span class="n">childPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">return</span> <span class="nf">handleParentProc</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">serverPipeFd</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
        <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">zygote</code>需要为每个新启动的应用程序声称该自己独立的进程。不过runOnce并没有直接使用fork来完成这一工作，而是调用了<code class="language-plaintext highlighter-rouge">forkAndSpecialize</code>。另外，新创建的进程中一定需要运行工应用程序本身的代码，这一部分工作是在<code class="language-plaintext highlighter-rouge">handleChildProc</code>中展开的。</p><p>执行完上述的任务后，父进程还需要做一些清尾工作才算“大功告成”。包括：将子进程加入进程组；正确关闭文件；调用方返回结果值等。</p><h3 id="readargumentlist">readArgumentList</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">readArgumentList</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="cm">/**
     * See android.os.Process.zygoteSendArgsAndGetPid()
     * Presently the wire format to the zygote process is:
     * a) a count of arguments (argc, in essence)
     * b) a number of newline-separated argument strings equal to count
     *
     * After the zygote process reads these it will write the pid of
     * the child or -1 on failure.
     */</span>

    <span class="kt">int</span> <span class="n">argc</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mSocketReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// EOF reached.</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">argc</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NumberFormatException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"invalid Zygote wire format: non-int at argc"</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"invalid wire format"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// See bug 1092107: large argc can be used for a DOS attack</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="no">MAX_ZYGOTE_ARGC</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"max arg count exceeded"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">String</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">argc</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">mSocketReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// We got an unexpected EOF.</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"truncated request"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="zygote">Zygote</h2><h3 id="forkandspecialize">forkAndSpecialize</h3><p>forkAndSpecialize的处理分为3个阶段，即preFork、nativeForkAndSpecialize以及postForkCommon。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkAndSpecialize</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
          <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="nc">String</span> <span class="n">seInfo</span><span class="o">,</span> <span class="nc">String</span> <span class="n">niceName</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">fdsToClose</span><span class="o">,</span>
          <span class="nc">String</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="nc">String</span> <span class="n">appDataDir</span><span class="o">)</span> <span class="o">{</span>
    <span class="no">VM_HOOKS</span><span class="o">.</span><span class="na">preFork</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkAndSpecialize</span><span class="o">(</span>
              <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">niceName</span><span class="o">,</span> <span class="n">fdsToClose</span><span class="o">,</span>
              <span class="n">instructionSet</span><span class="o">,</span> <span class="n">appDataDir</span><span class="o">);</span>
    <span class="c1">// Enable tracing as soon as possible for the child process.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Trace</span><span class="o">.</span><span class="na">setTracingEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="c1">// Note that this event ends at the end of handleChildProc,</span>
        <span class="nc">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="nc">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">"PostFork"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="no">VM_HOOKS</span><span class="o">.</span><span class="na">postForkCommon</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
<span class="o">}</span>

</pre></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">//art/runtime/native/dalvik_system_ZygoteHooks.cc</span>
<span class="k">static</span> <span class="n">jlong</span> <span class="nf">ZygoteHooks_nativePreFork</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Runtime</span><span class="o">*</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">Current</span><span class="p">();</span>
  <span class="n">CHECK</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">IsZygote</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="s">"runtime instance not started with -Xzygote"</span><span class="p">;</span>

  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">PreZygoteFork</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Trace</span><span class="o">::</span><span class="n">GetMethodTracingMode</span><span class="p">()</span> <span class="o">!=</span> <span class="n">TracingMode</span><span class="o">::</span><span class="n">kTracingInactive</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Tracing active, pause it.</span>
    <span class="n">Trace</span><span class="o">::</span><span class="n">Pause</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Grab thread before fork potentially makes Thread::pthread_key_self_ unusable.</span>
  <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ThreadForEnv</span><span class="p">(</span><span class="n">env</span><span class="p">));</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</span>
<span class="k">static</span> <span class="n">jint</span> <span class="nf">com_android_internal_os_Zygote_nativeForkAndSpecialize</span><span class="p">(</span>
        <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">jint</span> <span class="n">uid</span><span class="p">,</span> <span class="n">jint</span> <span class="n">gid</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">gids</span><span class="p">,</span>
        <span class="n">jint</span> <span class="n">debug_flags</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">rlimits</span><span class="p">,</span>
        <span class="n">jint</span> <span class="n">mount_external</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">se_info</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">se_name</span><span class="p">,</span>
        <span class="n">jintArray</span> <span class="n">fdsToClose</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">instructionSet</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">appDataDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">jlong</span> <span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Grant CAP_WAKE_ALARM to the Bluetooth process.</span>
    <span class="c1">// Additionally, allow bluetooth to open packet sockets so it can start the DHCP client.</span>
    <span class="c1">// TODO: consider making such functionality an RPC to netd.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">multiuser_get_app_id</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">AID_BLUETOOTH</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">capabilities</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="n">CAP_WAKE_ALARM</span><span class="p">);</span>
      <span class="n">capabilities</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="n">CAP_NET_RAW</span><span class="p">);</span>
      <span class="n">capabilities</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="n">CAP_NET_BIND_SERVICE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Grant CAP_BLOCK_SUSPEND to processes that belong to GID "wakelock"</span>
    <span class="kt">bool</span> <span class="n">gid_wakelock_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gid</span> <span class="o">==</span> <span class="n">AID_WAKELOCK</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">gid_wakelock_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gids</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">jsize</span> <span class="n">gids_num</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">gids</span><span class="p">);</span>
      <span class="n">ScopedIntArrayRO</span> <span class="n">ar</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">gids</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Bad gids array"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gids_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">AID_WAKELOCK</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">gid_wakelock_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gid_wakelock_found</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">capabilities</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="n">CAP_BLOCK_SUSPEND</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ForkAndSpecializeCommon</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gids</span><span class="p">,</span> <span class="n">debug_flags</span><span class="p">,</span>
            <span class="n">rlimits</span><span class="p">,</span> <span class="n">capabilities</span><span class="p">,</span> <span class="n">capabilities</span><span class="p">,</span> <span class="n">mount_external</span><span class="p">,</span> <span class="n">se_info</span><span class="p">,</span>
            <span class="n">se_name</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">fdsToClose</span><span class="p">,</span> <span class="n">instructionSet</span><span class="p">,</span> <span class="n">appDataDir</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</span>
<span class="c1">// Utility routine to fork zygote and specialize the child process.</span>
<span class="k">static</span> <span class="n">pid_t</span> <span class="nf">ForkAndSpecializeCommon</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">javaGids</span><span class="p">,</span>
                                     <span class="n">jint</span> <span class="n">debug_flags</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">javaRlimits</span><span class="p">,</span>
                                     <span class="n">jlong</span> <span class="n">permittedCapabilities</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">effectiveCapabilities</span><span class="p">,</span>
                                     <span class="n">jint</span> <span class="n">mount_external</span><span class="p">,</span>
                                     <span class="n">jstring</span> <span class="n">java_se_info</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">java_se_name</span><span class="p">,</span>
                                     <span class="kt">bool</span> <span class="n">is_system_server</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">fdsToClose</span><span class="p">,</span>
                                     <span class="n">jstring</span> <span class="n">instructionSet</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">dataDir</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">SetSigChldHandler</span><span class="p">();</span>

<span class="cp">#ifdef ENABLE_SCHED_BOOST
</span>  <span class="n">SetForkLoad</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="cp">#endif
</span>
  <span class="n">sigset_t</span> <span class="n">sigchld</span><span class="p">;</span>
  <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sigchld</span><span class="p">);</span>
  <span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sigchld</span><span class="p">,</span> <span class="n">SIGCHLD</span><span class="p">);</span>

  <span class="c1">// Temporarily block SIGCHLD during forks. The SIGCHLD handler might</span>
  <span class="c1">// log, which would result in the logging FDs we close being reopened.</span>
  <span class="c1">// This would cause failures because the FDs are not whitelisted.</span>
  <span class="c1">//</span>
  <span class="c1">// Note that the zygote process is single threaded at this point.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigchld</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ALOGE</span><span class="p">(</span><span class="s">"sigprocmask(SIG_SETMASK, { SIGCHLD }) failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
    <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Call to sigprocmask(SIG_BLOCK, { SIGCHLD }) failed."</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Close any logging related FDs before we start evaluating the list of</span>
  <span class="c1">// file descriptors.</span>
  <span class="n">__android_log_close</span><span class="p">();</span>

  <span class="c1">// If this is the first fork for this zygote, create the open FD table.</span>
  <span class="c1">// If it isn't, we just need to check whether the list of open files has</span>
  <span class="c1">// changed (and it shouldn't in the normal case).</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gOpenFdTable</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gOpenFdTable</span> <span class="o">=</span> <span class="n">FileDescriptorTable</span><span class="o">::</span><span class="n">Create</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gOpenFdTable</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Unable to construct file descriptor table."</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gOpenFdTable</span><span class="o">-&gt;</span><span class="n">Restat</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Unable to restat file descriptor table."</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span><span class="c1">//孵化出一个新进程</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The child process.</span>
    <span class="n">gMallocLeakZygoteChild</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">// Clean up any descriptors which must be closed immediately</span>
    <span class="n">DetachDescriptors</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">fdsToClose</span><span class="p">);</span>

    <span class="c1">// Re-open all remaining open file descriptors so that they aren't shared</span>
    <span class="c1">// with the zygote across a fork.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gOpenFdTable</span><span class="o">-&gt;</span><span class="n">ReopenOrDetach</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Unable to reopen whitelisted descriptors."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_UNBLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigchld</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ALOGE</span><span class="p">(</span><span class="s">"sigprocmask(SIG_SETMASK, { SIGCHLD }) failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
      <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Call to sigprocmask(SIG_UNBLOCK, { SIGCHLD }) failed."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Keep capabilities across UID change, unless we're staying root.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">EnableKeepCapabilities</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">DropCapabilitiesBoundingSet</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>

    <span class="kt">bool</span> <span class="n">use_native_bridge</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_system_server</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">instructionSet</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="o">&amp;&amp;</span> <span class="n">android</span><span class="o">::</span><span class="n">NativeBridgeAvailable</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">use_native_bridge</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ScopedUtfChars</span> <span class="n">isa_string</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">instructionSet</span><span class="p">);</span>
      <span class="n">use_native_bridge</span> <span class="o">=</span> <span class="n">android</span><span class="o">::</span><span class="n">NeedsNativeBridge</span><span class="p">(</span><span class="n">isa_string</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">use_native_bridge</span> <span class="o">&amp;&amp;</span> <span class="n">dataDir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// dataDir should never be null if we need to use a native bridge.</span>
      <span class="c1">// In general, dataDir will never be null for normal applications. It can only happen in</span>
      <span class="c1">// special cases (for isolated processes which are not associated with any app). These are</span>
      <span class="c1">// launched by the framework and should not be emulated anyway.</span>
      <span class="n">use_native_bridge</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">ALOGW</span><span class="p">(</span><span class="s">"Native bridge will not be used because dataDir == NULL."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MountEmulatedStorage</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">mount_external</span><span class="p">,</span> <span class="n">use_native_bridge</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">ALOGW</span><span class="p">(</span><span class="s">"Failed to mount emulated storage: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ENOTCONN</span> <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">EROFS</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// When device is actively encrypting, we get ENOTCONN here</span>
        <span class="c1">// since FUSE was mounted before the framework restarted.</span>
        <span class="c1">// When encrypted device is booting, we get EROFS since</span>
        <span class="c1">// FUSE hasn't been created yet by init.</span>
        <span class="c1">// In either case, continue without external storage.</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Cannot continue without emulated storage"</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_system_server</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">createProcessGroup</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ALOGW</span><span class="p">(</span><span class="s">"createProcessGroup failed, kernel missing CONFIG_CGROUP_CPUACCT?"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">ALOGE</span><span class="p">(</span><span class="s">"createProcessGroup(%d, %d) failed: %s"</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">rc</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">SetGids</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">javaGids</span><span class="p">);</span>

    <span class="n">SetRLimits</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">javaRlimits</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">use_native_bridge</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ScopedUtfChars</span> <span class="n">isa_string</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">instructionSet</span><span class="p">);</span>
      <span class="n">ScopedUtfChars</span> <span class="n">data_dir</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">dataDir</span><span class="p">);</span>
      <span class="n">android</span><span class="o">::</span><span class="n">PreInitializeNativeBridge</span><span class="p">(</span><span class="n">data_dir</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">isa_string</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ALOGE</span><span class="p">(</span><span class="s">"setresgid(%d) failed: %s"</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
      <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"setresgid failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">setresuid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ALOGE</span><span class="p">(</span><span class="s">"setresuid(%d) failed: %s"</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
      <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"setresuid failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">NeedsNoRandomizeWorkaround</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// Work around ARM kernel ASLR lossage (http://b/5817320).</span>
        <span class="kt">int</span> <span class="n">old_personality</span> <span class="o">=</span> <span class="n">personality</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">new_personality</span> <span class="o">=</span> <span class="n">personality</span><span class="p">(</span><span class="n">old_personality</span> <span class="o">|</span> <span class="n">ADDR_NO_RANDOMIZE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">new_personality</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ALOGW</span><span class="p">(</span><span class="s">"personality(%d) failed: %s"</span><span class="p">,</span> <span class="n">new_personality</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">SetCapabilities</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">permittedCapabilities</span><span class="p">,</span> <span class="n">effectiveCapabilities</span><span class="p">);</span>

    <span class="n">SetSchedulerPolicy</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">se_info_c_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ScopedUtfChars</span><span class="o">*</span> <span class="n">se_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">java_se_info</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">se_info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScopedUtfChars</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">java_se_info</span><span class="p">);</span>
        <span class="n">se_info_c_str</span> <span class="o">=</span> <span class="n">se_info</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">se_info_c_str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"se_info_c_str == NULL"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">se_name_c_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ScopedUtfChars</span><span class="o">*</span> <span class="n">se_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">java_se_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">se_name</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScopedUtfChars</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">java_se_name</span><span class="p">);</span>
        <span class="n">se_name_c_str</span> <span class="o">=</span> <span class="n">se_name</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">se_name_c_str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"se_name_c_str == NULL"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">selinux_android_setcontext</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">is_system_server</span><span class="p">,</span> <span class="n">se_info_c_str</span><span class="p">,</span> <span class="n">se_name_c_str</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ALOGE</span><span class="p">(</span><span class="s">"selinux_android_setcontext(%d, %d, </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">, </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">) failed"</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span>
            <span class="n">is_system_server</span><span class="p">,</span> <span class="n">se_info_c_str</span><span class="p">,</span> <span class="n">se_name_c_str</span><span class="p">);</span>
      <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"selinux_android_setcontext failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Make it easier to debug audit logs by setting the main thread's name to the</span>
    <span class="c1">// nice name rather than "app_process".</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">se_info_c_str</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">is_system_server</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">se_name_c_str</span> <span class="o">=</span> <span class="s">"system_server"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">se_info_c_str</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">SetThreadName</span><span class="p">(</span><span class="n">se_name_c_str</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">delete</span> <span class="n">se_info</span><span class="p">;</span>
    <span class="k">delete</span> <span class="n">se_name</span><span class="p">;</span>

    <span class="n">UnsetSigChldHandler</span><span class="p">();</span>

    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">gZygoteClass</span><span class="p">,</span> <span class="n">gCallPostForkChildHooks</span><span class="p">,</span> <span class="n">debug_flags</span><span class="p">,</span>
                              <span class="n">is_system_server</span><span class="p">,</span> <span class="n">instructionSet</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Error calling post fork hooks."</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// the parent process</span>

<span class="cp">#ifdef ENABLE_SCHED_BOOST
</span>    <span class="c1">// unset scheduler knob</span>
    <span class="n">SetForkLoad</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="cp">#endif
</span>
    <span class="c1">// We blocked SIGCHLD prior to a fork, we unblock it here.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_UNBLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigchld</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ALOGE</span><span class="p">(</span><span class="s">"sigprocmask(SIG_SETMASK, { SIGCHLD }) failed: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
      <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">"Call to sigprocmask(SIG_UNBLOCK, { SIGCHLD }) failed."</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleChildProc</span><span class="o">(</span><span class="nc">Arguments</span> <span class="n">parsedArgs</span><span class="o">,</span>
        <span class="nc">FileDescriptor</span><span class="o">[]</span> <span class="n">descriptors</span><span class="o">,</span> <span class="nc">FileDescriptor</span> <span class="n">pipeFd</span><span class="o">,</span> <span class="nc">PrintStream</span> <span class="n">newStderr</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
    <span class="cm">/**
     * By the time we get here, the native code has closed the two actual Zygote
     * socket connections, and substituted /dev/null in their place.  The LocalSocket
     * objects still need to be closed properly.
     */</span>

    <span class="n">closeSocket</span><span class="o">();</span>
    <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">descriptors</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Os</span><span class="o">.</span><span class="na">dup2</span><span class="o">(</span><span class="n">descriptors</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="no">STDIN_FILENO</span><span class="o">);</span>
            <span class="nc">Os</span><span class="o">.</span><span class="na">dup2</span><span class="o">(</span><span class="n">descriptors</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="no">STDOUT_FILENO</span><span class="o">);</span>
            <span class="nc">Os</span><span class="o">.</span><span class="na">dup2</span><span class="o">(</span><span class="n">descriptors</span><span class="o">[</span><span class="mi">2</span><span class="o">],</span> <span class="no">STDERR_FILENO</span><span class="o">);</span>

            <span class="k">for</span> <span class="o">(</span><span class="nc">FileDescriptor</span> <span class="nl">fd:</span> <span class="n">descriptors</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">newStderr</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ErrnoException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Error reopening stdio"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//子进程别名不为null</span>
        <span class="nc">Process</span><span class="o">.</span><span class="na">setArgV0</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// End of the postFork event.</span>
    <span class="nc">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="nc">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">invokeWith</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">WrapperInit</span><span class="o">.</span><span class="na">execApplication</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">invokeWith</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span>
                <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getCurrentInstructionSet</span><span class="o">(),</span>
                <span class="n">pipeFd</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">,</span> <span class="kc">null</span> <span class="cm">/* classLoader */</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handleSystemServerProcess</span><span class="o">(</span>
            <span class="nc">ZygoteConnection</span><span class="o">.</span><span class="na">Arguments</span> <span class="n">parsedArgs</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>

    <span class="n">closeServerSocket</span><span class="o">();</span>

    <span class="c1">// set umask to 0077 so new files and directories will default to owner-only permissions.</span>
    <span class="nc">Os</span><span class="o">.</span><span class="na">umask</span><span class="o">(</span><span class="no">S_IRWXG</span> <span class="o">|</span> <span class="no">S_IRWXO</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Process</span><span class="o">.</span><span class="na">setArgV0</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="nc">String</span> <span class="n">systemServerClasspath</span> <span class="o">=</span> <span class="nc">Os</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">"SYSTEMSERVERCLASSPATH"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">systemServerClasspath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">performSystemServerDexOpt</span><span class="o">(</span><span class="n">systemServerClasspath</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">invokeWith</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">;</span>
        <span class="c1">// If we have a non-null system server class path, we'll have to duplicate the</span>
        <span class="c1">// existing arguments and append the classpath to it. ART will handle the classpath</span>
        <span class="c1">// correctly when we exec a new process.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">systemServerClasspath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">amendedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">2</span><span class="o">];</span>
            <span class="n">amendedArgs</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s">"-cp"</span><span class="o">;</span>
            <span class="n">amendedArgs</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">systemServerClasspath</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">amendedArgs</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">WrapperInit</span><span class="o">.</span><span class="na">execApplication</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">invokeWith</span><span class="o">,</span>
                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span>
                <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getCurrentInstructionSet</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">systemServerClasspath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="n">createSystemServerClassLoader</span><span class="o">(</span><span class="n">systemServerClasspath</span><span class="o">,</span>
                                               <span class="n">parsedArgs</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">);</span>

            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/*
         * Pass the remaining arguments to SystemServer.
         */</span>
        <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">,</span> <span class="n">cl</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/* should never reach here */</span>
<span class="o">}</span>

</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">//frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">zygoteInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"RuntimeInit: Starting application from zygote"</span><span class="o">);</span>

    <span class="nc">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="nc">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">"RuntimeInit"</span><span class="o">);</span>
    <span class="n">redirectLogStreams</span><span class="o">();</span>

    <span class="n">commonInit</span><span class="o">();</span>
    <span class="n">nativeZygoteInit</span><span class="o">();</span>
    <span class="n">applicationInit</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">argv</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span><span class="c1">//调用SystemServer的main方法</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
        <span class="c1">// If the application calls System.exit(), terminate the process</span>
        <span class="c1">// immediately without running any shutdown hooks.  It is not possible to</span>
        <span class="c1">// shutdown an Android application gracefully.  Among other things, the</span>
        <span class="c1">// Android runtime shutdown hooks close the Binder driver, which can cause</span>
        <span class="c1">// leftover running threads to crash before the process actually exits.</span>
        <span class="n">nativeSetExitWithoutCleanup</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="c1">// We want to be fairly aggressive about heap utilization, to avoid</span>
        <span class="c1">// holding on to a lot of memory that isn't needed.</span>
        <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetHeapUtilization</span><span class="o">(</span><span class="mf">0.75f</span><span class="o">);</span>
        <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetSdkVersion</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">);</span>

        <span class="kd">final</span> <span class="nc">Arguments</span> <span class="n">args</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="c1">// let the process exit</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// The end of of the RuntimeInit event (see #zygoteInit).</span>
        <span class="nc">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="nc">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>

        <span class="c1">// Remaining arguments are passed to the start class's static main</span>
        <span class="n">invokeStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeStaticMain</span><span class="o">(</span><span class="nc">String</span> <span class="n">className</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Missing class when invoking static main "</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span>
                <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">Method</span> <span class="n">m</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"main"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Missing static main on "</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SecurityException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Problem getting static main on "</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(!</span> <span class="o">(</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="nc">Modifier</span><span class="o">.</span><span class="na">isPublic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">)))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Main method is not public and static on "</span> <span class="o">+</span> <span class="n">className</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/*
     * This throw gets caught in ZygoteInit.main(), which responds
     * by invoking the exception's run() method. This arrangement
     * clears up all the stack frames that were required in setting
     * up the process.
     */</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-tag no-text-decoration" >源码分析</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Zygote进程启动流程 - malinkang&url=https://malinkang.cn/posts/framework-zygote/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Zygote进程启动流程 - malinkang&u=https://malinkang.cn/posts/framework-zygote/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Zygote进程启动流程 - malinkang&url=https://malinkang.cn/posts/framework-zygote/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dagger-guide/">Dagger使用指南</a><li><a href="/posts/understanding-the-jvm-runtime-data-areas/">《深入理解JVM》第2章Java内存区域与内存溢出异常</a><li><a href="/posts/understanding-the-jvm-garbage-collection/">《深入理解JVM》第3章垃圾收集器</a><li><a href="/posts/understanding-the-jvm-class-file-structure/">《深入理解JVM》第6章类文件结构</a><li><a href="/posts/understanding-the-jvm-class-loader/">《深入理解JVM》第7章虚拟机类加载机制</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/arouter-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 24, 2020 <i class="unloaded">2020-11-24T19:14:29+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ARouter源码分析</h3><div class="text-muted small"><p> ARouter原理如下 编译期，会扫描@Route注解，将注解里的信息封装成一个RouteMeta对象。并生成一个辅助类ARouter$$Group$$groupName，groupName即分组的名字，这也意味着同一个group只会生成一个辅助类。该类继承自IRouteGroup，有一个loadInto()方法。在运行时，调用loadInto()方法，将@Route中的path作为k...</p></div></div></a></div><div class="card"> <a href="/posts/okhttp-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 26, 2020 <i class="unloaded">2020-11-26T04:01:47+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Okhttp源码分析</h3><div class="text-muted small"><p> Okhttp基本流程分析 基本流程 创建RequestBody 创建Request 创建OkhttpClient 调用newCall创建Call对象 执行异步或同步操作。 创建Socket连接 发送请求并处理返回结果 创建RequestBody RequestBody主要通过writeTo方法将请求内容写入到BufferedSink。RequestBo...</p></div></div></a></div><div class="card"> <a href="/posts/retrofit-source-analysis/"><div class="card-body"> <span class="timeago small" > Jul 26, 2017 <i class="unloaded">2017-07-26T04:07:22+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Retrofit源码分析</h3><div class="text-muted small"><p> Retrofit源码分析 流程分析 Retrofit执行流程可以分为两部分： 创建ServiceMethod。 调用ServiceMethod的invoke()。 下图中，黑线部分是创建ServiceMethod的过程，红线部分是invoke()的调用过程。 ServiceMethod创建过程： 通过动态代理，获取到我们定义的接口里的所有Method，调用S...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Epoxy-Models/" class="btn btn-outline-primary" prompt="Older"><p>Epoxy Models</p></a> <a href="/posts/framework-systemserver/" class="btn btn-outline-primary" prompt="Newer"><p>SystemServer启动流程</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//malinkang-cn.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Zygote进程启动流程'; this.page.url = 'https://malinkang.cn/posts/framework-zygote/'; this.page.identifier = '/posts/framework-zygote/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/malinkang">malinkang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://malinkang.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
