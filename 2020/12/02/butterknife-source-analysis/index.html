<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ButterKnife源码分析 | 马林康的博客</title><meta name="keywords" content="Android"><meta name="author" content="马林康"><meta name="copyright" content="马林康"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="本文分析的源码为8.4.0。 项目结构 butterknife包含ButterKnife核心的Api，如ButterKnife。butterknife-annotations包含了所有定义的注解。butterknife-compiler包含了生成模板代码的代码。这里我们重点研究ButterKnife是如何生成模板代码以及在我们的类中是如何调用的。 核心类ViewBinding是一个接口，有两个直接">
<meta property="og:type" content="article">
<meta property="og:title" content="ButterKnife源码分析">
<meta property="og:url" content="https://malinkang.cn/2020/12/02/butterknife-source-analysis/index.html">
<meta property="og:site_name" content="马林康的博客">
<meta property="og:description" content="本文分析的源码为8.4.0。 项目结构 butterknife包含ButterKnife核心的Api，如ButterKnife。butterknife-annotations包含了所有定义的注解。butterknife-compiler包含了生成模板代码的代码。这里我们重点研究ButterKnife是如何生成模板代码以及在我们的类中是如何调用的。 核心类ViewBinding是一个接口，有两个直接">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/疯狂动物城.JPG">
<meta property="article:published_time" content="2020-12-02T08:37:06.000Z">
<meta property="article:modified_time" content="2020-12-02T08:40:07.624Z">
<meta property="article:author" content="马林康">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/疯狂动物城.JPG"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://malinkang.cn/2020/12/02/butterknife-source-analysis/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-02 16:40:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 笔记</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener" href="https://leetcode.malinkang.cn/"><i class="fa-fw fas fa-link"></i><span> LeetCode解题</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/疯狂动物城.JPG)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">马林康的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 笔记</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener" href="https://leetcode.malinkang.cn/"><i class="fa-fw fas fa-link"></i><span> LeetCode解题</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ButterKnife源码分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-02T08:37:06.000Z" title="发表于 2020-12-02 16:37:06">2020-12-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-12-02T08:40:07.624Z" title="更新于 2020-12-02 16:40:07">2020-12-02</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本文分析的源码为<code>8.4.0</code>。</p>
<h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><p><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/butterknife-1.png" alt="butterknife-1"></p>
<p><code>butterknife</code>包含ButterKnife核心的Api，如ButterKnife。<code>butterknife-annotations</code>包含了所有定义的注解。<code>butterknife-compiler</code>包含了生成模板代码的代码。这里我们重点研究ButterKnife是如何生成模板代码以及在我们的类中是如何调用的。</p>
<h4 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a>核心类</h4><p><code>ViewBinding</code>是一个接口，有两个直接的子类<code>FieldViewBinding</code>和<code>MethodViewBinding</code>。</p>
<p><code>FieldViewBinding</code>封装了使用<code>@BindView</code>注解的Field的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String name;<span class="comment">//字段名</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeName type;<span class="comment">//类型</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> required;<span class="comment">//是否必须</span></span><br></pre></td></tr></table></figure>

<p><code>MethodViewBinding</code>封装了使用<code>@OnClick</code>等注解注解的方法的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String name;<span class="comment">//方法名</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Parameter&gt; parameters;<span class="comment">//方法参数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> required;<span class="comment">//是否必须</span></span><br></pre></td></tr></table></figure>



<p>注解@ListenerClass代表一个监听器的类，作用在如@OnClick等事件监听的注解上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RUNTIME)</span> <span class="meta">@Target(ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListenerClass &#123;</span><br><span class="line">  <span class="function">String <span class="title">targetType</span><span class="params">()</span></span>;<span class="comment">//目标类型</span></span><br><span class="line">  <span class="comment">/** Name of the setter method on the &#123;<span class="doctag">@linkplain</span> #targetType() target type&#125; for the listener. */</span></span><br><span class="line">  <span class="function">String <span class="title">setter</span><span class="params">()</span></span>;<span class="comment">//将该类设置给目标类型的方法</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Name of the method on the &#123;<span class="doctag">@linkplain</span> #targetType() target type&#125; to remove the listener. If</span></span><br><span class="line"><span class="comment">   * empty &#123;<span class="doctag">@link</span> #setter()&#125; will be used by default.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">String <span class="title">remover</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">  <span class="comment">/** Fully-qualified class name of the listener type. */</span></span><br><span class="line">  <span class="function">String <span class="title">type</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Enum which declares the listener callback methods. Mutually exclusive to &#123;<span class="doctag">@link</span> #method()&#125;. */</span></span><br><span class="line">  Class&lt;? extends Enum&lt;?&gt;&gt; callbacks() <span class="keyword">default</span> NONE.class;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Method data for single-method listener callbacks. Mutually exclusive with &#123;<span class="doctag">@link</span> #callbacks()&#125;</span></span><br><span class="line"><span class="comment">   * and an error to specify more than one value.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ListenerMethod[] method() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Default value for &#123;<span class="doctag">@link</span> #callbacks()&#125;. */</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">NONE</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@ListenerMethod注解代表一个监听类的方法，因为类里面可能有多个方法，所以是一个数组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RUNTIME)</span> <span class="meta">@Target(FIELD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListenerMethod &#123;</span><br><span class="line">  <span class="comment">/** Name of the listener method for which this annotation applies. */</span></span><br><span class="line">  <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** List of method parameters. If the type is not a primitive it must be fully-qualified. */</span></span><br><span class="line">  String[] parameters() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Primitive or fully-qualified return type of the listener method. May also be &#123;<span class="doctag">@code</span> void&#125;. */</span></span><br><span class="line">  <span class="function">String <span class="title">returnType</span><span class="params">()</span> <span class="keyword">default</span> &quot;<span class="keyword">void</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** If &#123;<span class="doctag">@link</span> #returnType()&#125; is not &#123;<span class="doctag">@code</span> void&#125; this value is returned when no binding exists. */</span></span><br><span class="line">  <span class="function">String <span class="title">defaultReturn</span><span class="params">()</span> <span class="keyword">default</span> &quot;<span class="keyword">null</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@OnClick</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(METHOD)</span></span><br><span class="line"><span class="meta">@Retention(CLASS)</span></span><br><span class="line"><span class="meta">@ListenerClass(</span></span><br><span class="line"><span class="meta">    targetType = &quot;android.view.View&quot;,</span></span><br><span class="line"><span class="meta">    setter = &quot;setOnClickListener&quot;,</span></span><br><span class="line"><span class="meta">    type = &quot;butterknife.internal.DebouncingOnClickListener&quot;,</span></span><br><span class="line"><span class="meta">    method = @ListenerMethod(</span></span><br><span class="line"><span class="meta">        name = &quot;doClick&quot;,</span></span><br><span class="line"><span class="meta">        parameters = &quot;android.view.View&quot;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnClick &#123;</span><br><span class="line">  <span class="comment">/** View IDs to which the method will be bound. */</span></span><br><span class="line">  <span class="meta">@IdRes</span> <span class="keyword">int</span>[] value() <span class="keyword">default</span> &#123; View.NO_ID &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ViewBindings</code>封装了一个View的所有<code>ViewBinding</code>。例如在SimpleActivity中有如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindView(R.id.hello)</span> Button hello;<span class="comment">//对应封装成一个FieldViewBinding</span></span><br><span class="line"><span class="meta">@OnClick(R.id.hello)</span> <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;Hello, views!&quot;</span>, LENGTH_SHORT).show();</span><br><span class="line">    ButterKnife.apply(headerViews, ALPHA_FADE);<span class="comment">//对应封装成一个MethodViewBinding</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@OnLongClick(R.id.hello)</span> <span class="function"><span class="keyword">boolean</span> <span class="title">sayGetOffMe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;Let go of me!&quot;</span>, LENGTH_SHORT).show();<span class="comment">//对应封装成一个MethodViewBinding</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>R.id.hello</code>这个view对应的ViewBindings包含一个FieldViewBinding和两个MethodViewBinding。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewBindings</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Id id; <span class="comment">//View对应的id</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ListenerClass, Map&lt;ListenerMethod, Set&lt;MethodViewBinding&gt;&gt;&gt; methodBindings =</span><br><span class="line">      <span class="keyword">new</span> LinkedHashMap&lt;&gt;();<span class="comment">//Map用于存储多个MethodViewBinding</span></span><br><span class="line">  <span class="keyword">private</span> FieldViewBinding fieldBinding;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用 Map&lt;ListenerMethod, Set<MethodViewBinding>来存储MethodViewBinding。因为同一个ListenerMethod可能对应多个MethodViewBinding。比如下面代码就是一个ListenerMethod就对应了两个MethodViewBinding。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClick(&#123;R.id.hello&#125;)</span><span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;Hello, views!&quot;</span>, LENGTH_SHORT).show();</span><br><span class="line">  ButterKnife.apply(headerViews, ALPHA_FADE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@OnClick(&#123;R.id.hello&#125;)</span><span class="function"><span class="keyword">void</span> <span class="title">sayHello2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;Hello, views!&quot;</span>, LENGTH_SHORT).show();</span><br><span class="line">  ButterKnife.apply(headerViews, ALPHA_FADE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BindingSet</code>可以看做是一个类里面所有所有Binding信息。同时还负责生成代码的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BindingSet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeName targetTypeName;<span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassName bindingClassName;<span class="comment">//生成辅助类的类名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isFinal;<span class="comment">//是否是final类型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ViewBindings&gt; viewBindings;<span class="comment">//用于存储ViewBinding</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;FieldCollectionViewBinding&gt; collectionBindings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ResourceBinding&gt; resourceBindings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BindingSet parentBinding;<span class="comment">//父parentBinding</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ResourceBinding是一个接口，有两个实现类FieldResourceBinding和FieldDrawableBinding。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//例如  @BindColor(android.R.color.black) @ColorInt int blackColor;</span></span><br><span class="line"><span class="comment">//将会生成代码    target.blackColor = ContextCompat.getColor(context, android.R.color.black);</span></span><br><span class="line"><span class="comment">//ResourceMethod方法指的是生成代码的对象</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldResourceBinding</span> <span class="keyword">implements</span> <span class="title">ResourceBinding</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> </span>&#123;</span><br><span class="line">        BITMAP(<span class="keyword">new</span> ResourceMethod(BindingSet.BITMAP_FACTORY, <span class="string">&quot;decodeResource&quot;</span>, <span class="keyword">true</span>, <span class="number">1</span>)),</span><br><span class="line">        BOOL(<span class="string">&quot;getBoolean&quot;</span>),</span><br><span class="line">        COLOR(<span class="keyword">new</span> ResourceMethod(BindingSet.CONTEXT_COMPAT, <span class="string">&quot;getColor&quot;</span>, <span class="keyword">false</span>, <span class="number">1</span>),</span><br><span class="line">                <span class="keyword">new</span> ResourceMethod(<span class="keyword">null</span>, <span class="string">&quot;getColor&quot;</span>, <span class="keyword">false</span>, <span class="number">23</span>)),</span><br><span class="line">        COLOR_STATE_LIST(<span class="keyword">new</span> ResourceMethod(BindingSet.CONTEXT_COMPAT, <span class="string">&quot;getColorStateList&quot;</span>, <span class="keyword">false</span>, <span class="number">1</span>),</span><br><span class="line">                <span class="keyword">new</span> ResourceMethod(<span class="keyword">null</span>, <span class="string">&quot;getColorStateList&quot;</span>, <span class="keyword">false</span>, <span class="number">23</span>)),</span><br><span class="line">        DIMEN_AS_INT(<span class="string">&quot;getDimensionPixelSize&quot;</span>),</span><br><span class="line">        DIMEN_AS_FLOAT(<span class="string">&quot;getDimension&quot;</span>),</span><br><span class="line">        FLOAT(<span class="keyword">new</span> ResourceMethod(BindingSet.UTILS, <span class="string">&quot;getFloat&quot;</span>, <span class="keyword">false</span>, <span class="number">1</span>)),</span><br><span class="line">        INT(<span class="string">&quot;getInteger&quot;</span>),</span><br><span class="line">        INT_ARRAY(<span class="string">&quot;getIntArray&quot;</span>),</span><br><span class="line">        STRING(<span class="string">&quot;getString&quot;</span>),</span><br><span class="line">        STRING_ARRAY(<span class="string">&quot;getStringArray&quot;</span>),</span><br><span class="line">        TEXT_ARRAY(<span class="string">&quot;getTextArray&quot;</span>),</span><br><span class="line">        TYPED_ARRAY(<span class="string">&quot;obtainTypedArray&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ResourceMethod&gt; methods;</span><br><span class="line"></span><br><span class="line">        Type(ResourceMethod... methods) &#123;</span><br><span class="line">            List&lt;ResourceMethod&gt; methodList = <span class="keyword">new</span> ArrayList&lt;&gt;(methods.length);</span><br><span class="line">            Collections.addAll(methodList, methods);</span><br><span class="line">            Collections.sort(methodList);</span><br><span class="line">            Collections.reverse(methodList);</span><br><span class="line">            <span class="keyword">this</span>.methods = unmodifiableList(methodList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Type(String methodName) &#123;</span><br><span class="line">            methods = singletonList(<span class="keyword">new</span> ResourceMethod(<span class="keyword">null</span>, methodName, <span class="keyword">true</span>, <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">ResourceMethod <span class="title">methodForSdk</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (ResourceMethod method : methods) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.sdk &lt;= sdk) &#123;</span><br><span class="line">                    <span class="keyword">return</span> method;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//资源方法</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceMethod</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">ResourceMethod</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ClassName typeName;<span class="comment">//类名 </span></span><br><span class="line">        <span class="keyword">final</span> String name;<span class="comment">//方法名</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> requiresResources;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sdk;<span class="comment">//sdk版本号 因为sdk版本号不一样，调用的方法可能不一样。</span></span><br><span class="line"></span><br><span class="line">        ResourceMethod(ClassName typeName, String name, <span class="keyword">boolean</span> requiresResources, <span class="keyword">int</span> sdk) &#123;</span><br><span class="line">            <span class="keyword">this</span>.typeName = typeName;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">this</span>.requiresResources = requiresResources;</span><br><span class="line">            <span class="keyword">this</span>.sdk = sdk;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(ResourceMethod other)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(sdk, other.sdk);<span class="comment">//按照sdk排序</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造函数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Id id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Type type;</span><br><span class="line"></span><br><span class="line">    FieldResourceBinding(Id id, String name, Type type) &#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Id <span class="title">id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">requiresResources</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type.methodForSdk(sdk).requiresResources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CodeBlock <span class="title">render</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">        ResourceMethod method = type.methodForSdk(sdk);</span><br><span class="line">        <span class="keyword">if</span> (method.typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.requiresResources) &#123;</span><br><span class="line">                <span class="keyword">return</span> CodeBlock.of(<span class="string">&quot;target.$L = res.$L($L)&quot;</span>, name, method.name, id.code);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> CodeBlock.of(<span class="string">&quot;target.$L = context.$L($L)&quot;</span>, name, method.name, id.code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (method.requiresResources) &#123;</span><br><span class="line">            <span class="keyword">return</span> CodeBlock.of(<span class="string">&quot;target.$L = $T.$L(res, $L)&quot;</span>, name, method.typeName, method.name,</span><br><span class="line">                    id.code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CodeBlock.of(<span class="string">&quot;target.$L = $T.$L(context, $L)&quot;</span>, name, method.typeName, method.name,</span><br><span class="line">                id.code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="解析注解"><a href="#解析注解" class="headerlink" title="解析注解"></a>解析注解</h4><p>知道各个类的作用之后，下一步工作就是了解如何解析这些标注了注解的字段和方法的信息，并封装成类。<br>ButterKnife解析这些信息的类为<code>ButterKnifeProcessor</code>，解析的工作由<code>findAndParseTargets</code>方法完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;   <span class="comment">//使用Map存储BindingSet.Builder避免同一个类重复创建BindingSet.Builder</span></span><br><span class="line">    Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();<span class="comment">//</span></span><br><span class="line">    Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();<span class="comment">//</span></span><br><span class="line">    scanForRClasses(env);</span><br><span class="line">    <span class="comment">// Process each @BindArray element.</span></span><br><span class="line">    <span class="comment">//获取注解@BindArray的Element</span></span><br><span class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindArray.class)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        parseResourceArray(element, builderMap, erasedTargetNames);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logParsingError(element, BindArray.class, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>findAndParseTargets</code>获取不同注解对应的Element，然后调用对应的parse方法来解析。</p>
<h5 id="解析-BindView"><a href="#解析-BindView" class="headerlink" title="解析@BindView"></a>解析@BindView</h5><p><code>parseBindView</code>解析<code>@BindView</code>注解的Element。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap,</span></span></span><br><span class="line"><span class="function"><span class="params">  Set&lt;TypeElement&gt; erasedTargetNames)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//验证注解是否使用正确</span></span><br><span class="line">    <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(BindView.class, <span class="string">&quot;fields&quot;</span>, element)</span><br><span class="line">        || isBindingInWrongPackage(BindView.class, element);</span><br><span class="line"></span><br><span class="line">    TypeMirror elementType = element.asType();</span><br><span class="line">    TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line">    <span class="comment">//例如当@BindView T view; 这时候就是一个TypeKind.TYPEVAR类型</span></span><br><span class="line">    <span class="keyword">if</span> (elementType.getKind() == TypeKind.TYPEVAR) &#123;<span class="comment">//泛型类型</span></span><br><span class="line">      TypeVariable typeVariable = (TypeVariable) elementType;</span><br><span class="line">      elementType = typeVariable.getUpperBound();<span class="comment">//获取上边界</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isSubtypeOfType(elementType, VIEW_TYPE) &amp;&amp; !isInterface(elementType)) &#123;<span class="comment">//判断field的类型</span></span><br><span class="line">      <span class="keyword">if</span> (elementType.getKind() == TypeKind.ERROR) &#123;</span><br><span class="line">        note(element, <span class="string">&quot;@%s field with unresolved type (%s) &quot;</span></span><br><span class="line">                + <span class="string">&quot;must elsewhere be generated as a View or interface. (%s.%s)&quot;</span>,</span><br><span class="line">            BindView.class.getSimpleName(), elementType, enclosingElement.getQualifiedName(),</span><br><span class="line">            element.getSimpleName());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        error(element, <span class="string">&quot;@%s fields must extend from View or be an interface. (%s.%s)&quot;</span>,</span><br><span class="line">            BindView.class.getSimpleName(), enclosingElement.getQualifiedName(),</span><br><span class="line">            element.getSimpleName());</span><br><span class="line">        hasError = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> id = element.getAnnotation(BindView.class).value();<span class="comment">//获取id</span></span><br><span class="line">    BindingSet.Builder builder = builderMap.get(enclosingElement);<span class="comment">//创建  BindingSet.Builder</span></span><br><span class="line">    <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">      ViewBindings viewBindings = builder.getViewBinding(getId(id));</span><br><span class="line">      <span class="comment">//当FieldBinding已经存在说明已经绑定过了。重复绑定将抛异常</span></span><br><span class="line">      <span class="keyword">if</span> (viewBindings != <span class="keyword">null</span> &amp;&amp; viewBindings.getFieldBinding() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        FieldViewBinding existingBinding = viewBindings.getFieldBinding();</span><br><span class="line"></span><br><span class="line">        error(element, <span class="string">&quot;Attempt to use @%s for an already bound ID %d on &#x27;%s&#x27;. (%s.%s)&quot;</span>,</span><br><span class="line">            BindView.class.getSimpleName(), id, existingBinding.getName(),</span><br><span class="line">            enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</span><br><span class="line">    &#125;</span><br><span class="line">    String name = element.getSimpleName().toString();<span class="comment">//获取FieldName</span></span><br><span class="line">    TypeName type = TypeName.get(elementType);<span class="comment">//获取Field的Type</span></span><br><span class="line">    <span class="keyword">boolean</span> required = isFieldRequired(element);<span class="comment">//是否必须</span></span><br><span class="line">    builder.addField(getId(id), <span class="keyword">new</span> FieldViewBinding(name, type, required));</span><br><span class="line">    <span class="comment">// Add the type-erased version to the valid binding targets set.</span></span><br><span class="line">    erasedTargetNames.add(enclosingElement);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>isInaccessibleViaGeneratedCode</code>方法用于通过修饰符来判断字段是否能够被生成的代码访问。由于ButterKnife的原理是通过辅助类来完成findViewById的操作，所以必须引用原来的的字段，因此不能设置为private</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target.title = Utils.findRequiredViewAsType(source, R.id.title, <span class="string">&quot;field &#x27;title&#x27;&quot;</span>, TextView.class);</span><br></pre></td></tr></table></figure>
<p>isInaccessibleViaGeneratedCode方法的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInaccessibleViaGeneratedCode</span><span class="params">(Class&lt;? extends Annotation&gt; annotationClass,</span></span></span><br><span class="line"><span class="function"><span class="params">  String targetThing, Element element)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> hasError = <span class="keyword">false</span>;</span><br><span class="line">    TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line">    <span class="comment">// Verify method modifiers.</span></span><br><span class="line">    Set&lt;Modifier&gt; modifiers = element.getModifiers();</span><br><span class="line">    <span class="keyword">if</span> (modifiers.contains(PRIVATE) || modifiers.contains(STATIC)) &#123;</span><br><span class="line">      error(element, <span class="string">&quot;@%s %s must not be private or static. (%s.%s)&quot;</span>,</span><br><span class="line">          annotationClass.getSimpleName(), targetThing, enclosingElement.getQualifiedName(),</span><br><span class="line">          element.getSimpleName());</span><br><span class="line">      hasError = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Verify containing type.</span></span><br><span class="line">    <span class="keyword">if</span> (enclosingElement.getKind() != CLASS) &#123;</span><br><span class="line">      error(enclosingElement, <span class="string">&quot;@%s %s may only be contained in classes. (%s.%s)&quot;</span>,</span><br><span class="line">          annotationClass.getSimpleName(), targetThing, enclosingElement.getQualifiedName(),</span><br><span class="line">          element.getSimpleName());</span><br><span class="line">      hasError = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Verify containing class visibility is not private.</span></span><br><span class="line">    <span class="keyword">if</span> (enclosingElement.getModifiers().contains(PRIVATE)) &#123;</span><br><span class="line">      error(enclosingElement, <span class="string">&quot;@%s %s may not be contained in private classes. (%s.%s)&quot;</span>,</span><br><span class="line">          annotationClass.getSimpleName(), targetThing, enclosingElement.getQualifiedName(),</span><br><span class="line">          element.getSimpleName());</span><br><span class="line">      hasError = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasError;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="解析方法注解"><a href="#解析方法注解" class="headerlink" title="解析方法注解"></a>解析方法注解</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) &#123;</span><br><span class="line">  findAndParseListener(env, listener, builderMap, erasedTargetNames);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findAndParseListener</span><span class="params">(RoundEnvironment env,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;? extends Annotation&gt; annotationClass,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, Set&lt;TypeElement&gt; erasedTargetNames)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(annotationClass)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      parseListenerAnnotation(annotationClass, element, builderMap, erasedTargetNames);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      StringWriter stackTrace = <span class="keyword">new</span> StringWriter();</span><br><span class="line">      e.printStackTrace(<span class="keyword">new</span> PrintWriter(stackTrace));</span><br><span class="line"></span><br><span class="line">      error(element, <span class="string">&quot;Unable to generate view binder for @%s.\n\n%s&quot;</span>,</span><br><span class="line">          annotationClass.getSimpleName(), stackTrace.toString());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseListenerAnnotation</span><span class="params">(Class&lt;? extends Annotation&gt; annotationClass, Element element,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, Set&lt;TypeElement&gt; erasedTargetNames)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">// This should be guarded by the annotation&#x27;s @Target but it&#x27;s worth a check for safe casting.</span></span><br><span class="line">  <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> ExecutableElement) || element.getKind() != METHOD) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">        String.format(<span class="string">&quot;@%s annotation must be on a method.&quot;</span>, annotationClass.getSimpleName()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ExecutableElement executableElement = (ExecutableElement) element;</span><br><span class="line">  TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line">  <span class="comment">// Assemble information on the method.</span></span><br><span class="line">  Annotation annotation = element.getAnnotation(annotationClass);</span><br><span class="line">  Method annotationValue = annotationClass.getDeclaredMethod(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (annotationValue.getReturnType() != <span class="keyword">int</span>[].class) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">        String.format(<span class="string">&quot;@%s annotation value() type not int[].&quot;</span>, annotationClass));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span>[] ids = (<span class="keyword">int</span>[]) annotationValue.invoke(annotation);<span class="comment">//通过反射获取值</span></span><br><span class="line">  String name = executableElement.getSimpleName().toString();<span class="comment">//方法名</span></span><br><span class="line">  <span class="keyword">boolean</span> required = isListenerRequired(executableElement);</span><br><span class="line">  <span class="comment">// Verify that the method and its containing class are accessible via generated code.</span></span><br><span class="line">  <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(annotationClass, <span class="string">&quot;methods&quot;</span>, element);</span><br><span class="line">  hasError |= isBindingInWrongPackage(annotationClass, element);</span><br><span class="line">  <span class="comment">//发现重复的id</span></span><br><span class="line">  Integer duplicateId = findDuplicate(ids);</span><br><span class="line">  <span class="keyword">if</span> (duplicateId != <span class="keyword">null</span>) &#123;</span><br><span class="line">    error(element, <span class="string">&quot;@%s annotation for method contains duplicate ID %d. (%s.%s)&quot;</span>,</span><br><span class="line">        annotationClass.getSimpleName(), duplicateId, enclosingElement.getQualifiedName(),</span><br><span class="line">        element.getSimpleName());</span><br><span class="line">    hasError = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ListenerClass listener = annotationClass.getAnnotation(ListenerClass.class);</span><br><span class="line">  <span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">        String.format(<span class="string">&quot;No @%s defined on @%s.&quot;</span>, ListenerClass.class.getSimpleName(),</span><br><span class="line">            annotationClass.getSimpleName()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> id : ids) &#123;</span><br><span class="line">    <span class="keyword">if</span> (id == NO_ID.value) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ids.length == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!required) &#123;</span><br><span class="line">          error(element, <span class="string">&quot;ID-free binding must not be annotated with @Optional. (%s.%s)&quot;</span>,</span><br><span class="line">              enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">          hasError = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        error(element, <span class="string">&quot;@%s annotation contains invalid ID %d. (%s.%s)&quot;</span>,</span><br><span class="line">            annotationClass.getSimpleName(), id, enclosingElement.getQualifiedName(),</span><br><span class="line">            element.getSimpleName());</span><br><span class="line">        hasError = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ListenerMethod method;</span><br><span class="line">  ListenerMethod[] methods = listener.method();</span><br><span class="line">  <span class="keyword">if</span> (methods.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">&quot;Multiple listener methods specified on @%s.&quot;</span>,</span><br><span class="line">        annotationClass.getSimpleName()));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methods.length == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (listener.callbacks() != ListenerClass.NONE.class) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">          String.format(<span class="string">&quot;Both method() and callback() defined on @%s.&quot;</span>,</span><br><span class="line">              annotationClass.getSimpleName()));</span><br><span class="line">    &#125;</span><br><span class="line">    method = methods[<span class="number">0</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Method annotationCallback = annotationClass.getDeclaredMethod(<span class="string">&quot;callback&quot;</span>);</span><br><span class="line">    Enum&lt;?&gt; callback = (Enum&lt;?&gt;) annotationCallback.invoke(annotation);</span><br><span class="line">    Field callbackField = callback.getDeclaringClass().getField(callback.name());</span><br><span class="line">    method = callbackField.getAnnotation(ListenerMethod.class);</span><br><span class="line">    <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">          String.format(<span class="string">&quot;No @%s defined on @%s&#x27;s %s.%s.&quot;</span>, ListenerMethod.class.getSimpleName(),</span><br><span class="line">              annotationClass.getSimpleName(), callback.getDeclaringClass().getSimpleName(),</span><br><span class="line">              callback.name()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Verify that the method has equal to or less than the number of parameters as the listener.</span></span><br><span class="line">  List&lt;? extends VariableElement&gt; methodParameters = executableElement.getParameters();</span><br><span class="line">  <span class="keyword">if</span> (methodParameters.size() &gt; method.parameters().length) &#123;</span><br><span class="line">    error(element, <span class="string">&quot;@%s methods can have at most %s parameter(s). (%s.%s)&quot;</span>,</span><br><span class="line">        annotationClass.getSimpleName(), method.parameters().length,</span><br><span class="line">        enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">    hasError = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Verify method return type matches the listener.</span></span><br><span class="line">  TypeMirror returnType = executableElement.getReturnType();</span><br><span class="line">  <span class="keyword">if</span> (returnType <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">    TypeVariable typeVariable = (TypeVariable) returnType;</span><br><span class="line">    returnType = typeVariable.getUpperBound();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!returnType.toString().equals(method.returnType())) &#123;</span><br><span class="line">    error(element, <span class="string">&quot;@%s methods must have a &#x27;%s&#x27; return type. (%s.%s)&quot;</span>,</span><br><span class="line">        annotationClass.getSimpleName(), method.returnType(),</span><br><span class="line">        enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">    hasError = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Parameter[] parameters = Parameter.NONE;</span><br><span class="line">  <span class="keyword">if</span> (!methodParameters.isEmpty()) &#123;</span><br><span class="line">    parameters = <span class="keyword">new</span> Parameter[methodParameters.size()];</span><br><span class="line">    BitSet methodParameterUsed = <span class="keyword">new</span> BitSet(methodParameters.size());</span><br><span class="line">    String[] parameterTypes = method.parameters();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodParameters.size(); i++) &#123;</span><br><span class="line">      VariableElement methodParameter = methodParameters.get(i);</span><br><span class="line">      TypeMirror methodParameterType = methodParameter.asType();</span><br><span class="line">      <span class="keyword">if</span> (methodParameterType <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">        TypeVariable typeVariable = (TypeVariable) methodParameterType;</span><br><span class="line">        methodParameterType = typeVariable.getUpperBound();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; parameterTypes.length; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (methodParameterUsed.get(j)) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isSubtypeOfType(methodParameterType, parameterTypes[j])</span><br><span class="line">            || isInterface(methodParameterType)) &#123;</span><br><span class="line">          parameters[i] = <span class="keyword">new</span> Parameter(j, TypeName.get(methodParameterType));</span><br><span class="line">          methodParameterUsed.set(j);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (parameters[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        builder.append(<span class="string">&quot;Unable to match @&quot;</span>)</span><br><span class="line">            .append(annotationClass.getSimpleName())</span><br><span class="line">            .append(<span class="string">&quot; method arguments. (&quot;</span>)</span><br><span class="line">            .append(enclosingElement.getQualifiedName())</span><br><span class="line">            .append(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">            .append(element.getSimpleName())</span><br><span class="line">            .append(<span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; parameters.length; j++) &#123;</span><br><span class="line">          Parameter parameter = parameters[j];</span><br><span class="line">          builder.append(<span class="string">&quot;\n\n  Parameter #&quot;</span>)</span><br><span class="line">              .append(j + <span class="number">1</span>)</span><br><span class="line">              .append(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">              .append(methodParameters.get(j).asType().toString())</span><br><span class="line">              .append(<span class="string">&quot;\n    &quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (parameter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            builder.append(<span class="string">&quot;did not match any listener parameters&quot;</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder.append(<span class="string">&quot;matched listener parameter #&quot;</span>)</span><br><span class="line">                .append(parameter.getListenerPosition() + <span class="number">1</span>)</span><br><span class="line">                .append(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">                .append(parameter.getType());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        builder.append(<span class="string">&quot;\n\nMethods may have up to &quot;</span>)</span><br><span class="line">            .append(method.parameters().length)</span><br><span class="line">            .append(<span class="string">&quot; parameter(s):\n&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String parameterType : method.parameters()) &#123;</span><br><span class="line">          builder.append(<span class="string">&quot;\n  &quot;</span>).append(parameterType);</span><br><span class="line">        &#125;</span><br><span class="line">        builder.append(</span><br><span class="line">            <span class="string">&quot;\n\nThese may be listed in any order but will be searched for from top to bottom.&quot;</span>);</span><br><span class="line">        error(executableElement, builder.toString());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  MethodViewBinding binding = <span class="keyword">new</span> MethodViewBinding(name, Arrays.asList(parameters), required);</span><br><span class="line">  BindingSet.Builder builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> id : ids) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!builder.addMethod(getId(id), listener, method, binding)) &#123;</span><br><span class="line">      error(element, <span class="string">&quot;Multiple listener methods with return value specified for ID %d. (%s.%s)&quot;</span>,</span><br><span class="line">          id, enclosingElement.getQualifiedName(), element.getSimpleName());</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Add the type-erased version to the valid binding targets set.</span></span><br><span class="line">  erasedTargetNames.add(enclosingElement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="解析资源绑定"><a href="#解析资源绑定" class="headerlink" title="解析资源绑定"></a>解析资源绑定</h5><p>解析资源的代码基本都差不多。这里只给出parseResourceString的源码和注释。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseResourceString</span><span class="params">(Element element,</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, Set&lt;TypeElement&gt; erasedTargetNames)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> hasError = <span class="keyword">false</span>;</span><br><span class="line">  TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Verify that the target type is String.</span></span><br><span class="line">  <span class="keyword">if</span> (!STRING_TYPE.equals(element.asType().toString())) &#123;</span><br><span class="line">    error(element, <span class="string">&quot;@%s field type must be &#x27;String&#x27;. (%s.%s)&quot;</span>,</span><br><span class="line">        BindString.class.getSimpleName(), enclosingElement.getQualifiedName(),</span><br><span class="line">        element.getSimpleName());</span><br><span class="line">    hasError = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Verify common generated code restrictions.</span></span><br><span class="line">  hasError |= isInaccessibleViaGeneratedCode(BindString.class, <span class="string">&quot;fields&quot;</span>, element);</span><br><span class="line">  hasError |= isBindingInWrongPackage(BindString.class, element);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasError) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Assemble information on the field.</span></span><br><span class="line">  String name = element.getSimpleName().toString();</span><br><span class="line">  <span class="keyword">int</span> id = element.getAnnotation(BindString.class).value();</span><br><span class="line"></span><br><span class="line">  BindingSet.Builder builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</span><br><span class="line">  builder.addResource(</span><br><span class="line">      <span class="keyword">new</span> FieldResourceBinding(getId(id), name, FieldResourceBinding.Type.STRING));</span><br><span class="line"></span><br><span class="line">  erasedTargetNames.add(enclosingElement);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="设置parentBinding"><a href="#设置parentBinding" class="headerlink" title="设置parentBinding"></a>设置parentBinding</h5><p>在findAndParseTargets最后几行代码的作用是为解析出来的BindingSet.Builder设置parentBinding</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries =</span><br><span class="line">       <span class="keyword">new</span> ArrayDeque&lt;&gt;(builderMap.entrySet());</span><br><span class="line">   Map&lt;TypeElement, BindingSet&gt; bindingMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">   <span class="keyword">while</span> (!entries.isEmpty()) &#123;</span><br><span class="line">     Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.removeFirst();</span><br><span class="line">     TypeElement type = entry.getKey();</span><br><span class="line">     BindingSet.Builder builder = entry.getValue();</span><br><span class="line">     TypeElement parentType = findParentType(type, erasedTargetNames);</span><br><span class="line">     <span class="keyword">if</span> (parentType == <span class="keyword">null</span>) &#123;<span class="comment">//没有parentBinding，不是某各类的子类</span></span><br><span class="line">       bindingMap.put(type, builder.build());</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       BindingSet parentBinding = bindingMap.get(parentType);</span><br><span class="line">       <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">         builder.setParent(parentBinding);</span><br><span class="line">         bindingMap.put(type, builder.build());</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// Has a superclass binding but we haven&#x27;t built it yet. Re-enqueue for later.</span></span><br><span class="line">         entries.addLast(entry);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成代码"><a href="#生成代码" class="headerlink" title="生成代码"></a>生成代码</h4><p>生成代码主要由BindingSet的brewJava方法完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JavaFile <span class="title">brewJava</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> JavaFile.builder(bindingClassName.packageName(), createType(sdk))</span><br><span class="line">             .addFileComment(<span class="string">&quot;Generated code from Butter Knife. Do not modify!&quot;</span>)<span class="comment">//添加注释</span></span><br><span class="line">             .build();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> TypeSpec <span class="title">createType</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">        TypeSpec.Builder result = TypeSpec.classBuilder(bindingClassName.simpleName())<span class="comment">//类名</span></span><br><span class="line">                .addModifiers(PUBLIC);<span class="comment">//修饰符</span></span><br><span class="line">        <span class="keyword">if</span> (isFinal) &#123;</span><br><span class="line">            result.addModifiers(FINAL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.superclass(parentBinding.bindingClassName);<span class="comment">//添加父类</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.addSuperinterface(UNBINDER);<span class="comment">//添加接口UnBinder</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasTargetField()) &#123;</span><br><span class="line">            result.addField(targetTypeName, <span class="string">&quot;target&quot;</span>, PRIVATE);<span class="comment">//添加字段target</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (!constructorNeedsView()) &#123;</span><br><span class="line">            <span class="comment">// Add a delegating constructor with a target type + view signature for reflective use.</span></span><br><span class="line">            result.addMethod(createBindingViewDelegateConstructor(targetTypeName));</span><br><span class="line">        &#125;</span><br><span class="line">        result.addMethod(createBindingConstructor(targetTypeName, sdk));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasViewBindings() || parentBinding == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result.addMethod(createBindingUnbindMethod(result, targetTypeName));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result.build();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>createBindingConstructor创建构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingConstructor</span><span class="params">(TypeName targetType, <span class="keyword">int</span> sdk)</span> </span>&#123;</span><br><span class="line">    MethodSpec.Builder constructor = MethodSpec.constructorBuilder()</span><br><span class="line">            .addAnnotation(UI_THREAD)<span class="comment">//添加注解</span></span><br><span class="line">            .addModifiers(PUBLIC);<span class="comment">//添加修饰符</span></span><br><span class="line">    <span class="keyword">if</span> (hasMethodBindings()) &#123;<span class="comment">//如果没有MethodBinding就不用声明成final类型</span></span><br><span class="line">        constructor.addParameter(targetType, <span class="string">&quot;target&quot;</span>, FINAL);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        constructor.addParameter(targetType, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (constructorNeedsView()) &#123;<span class="comment">//当构造函数需要View</span></span><br><span class="line">        constructor.addParameter(VIEW, <span class="string">&quot;source&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        constructor.addParameter(CONTEXT, <span class="string">&quot;context&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasUnqualifiedResourceBindings()) &#123;<span class="comment">//添加SuppressWarnings注解</span></span><br><span class="line">        <span class="comment">// Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</span></span><br><span class="line">        constructor.addAnnotation(AnnotationSpec.builder(SuppressWarnings.class)</span><br><span class="line">                .addMember(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;$S&quot;</span>, <span class="string">&quot;ResourceType&quot;</span>)</span><br><span class="line">                .build());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;<span class="comment">//添加父类构造方法的调用</span></span><br><span class="line">        <span class="keyword">if</span> (parentBinding.constructorNeedsView()) &#123;</span><br><span class="line">            constructor.addStatement(<span class="string">&quot;super(target, source)&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constructorNeedsView()) &#123;</span><br><span class="line">            constructor.addStatement(<span class="string">&quot;super(target, source.getContext())&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            constructor.addStatement(<span class="string">&quot;super(target, context)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        constructor.addCode(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hasTargetField()) &#123;<span class="comment">//</span></span><br><span class="line">        constructor.addStatement(<span class="string">&quot;this.target = target&quot;</span>);</span><br><span class="line">        constructor.addCode(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasViewBindings()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasViewLocal()) &#123;</span><br><span class="line">            <span class="comment">// Local variable in which all views will be temporarily stored.</span></span><br><span class="line">            constructor.addStatement(<span class="string">&quot;$T view&quot;</span>, VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (ViewBindings bindings : viewBindings) &#123;</span><br><span class="line">            addViewBindings(constructor, bindings);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (FieldCollectionViewBinding binding : collectionBindings) &#123;</span><br><span class="line">            constructor.addStatement(<span class="string">&quot;$L&quot;</span>, binding.render());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</span><br><span class="line">            constructor.addCode(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (constructorNeedsView()) &#123;</span><br><span class="line">            constructor.addStatement(<span class="string">&quot;$T context = source.getContext()&quot;</span>, CONTEXT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasResourceBindingsNeedingResource(sdk)) &#123;</span><br><span class="line">            constructor.addStatement(<span class="string">&quot;$T res = context.getResources()&quot;</span>, RESOURCES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (ResourceBinding binding : resourceBindings) &#123;</span><br><span class="line">            constructor.addStatement(<span class="string">&quot;$L&quot;</span>, binding.render(sdk));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> constructor.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>addViewBindings用于添加ViewBindings对象所对应的表达式。当只有FieldViewBinding时直接生成代码 <code>target.title = Utils.findRequiredViewAsType(source, R.id.title, &quot;field &#39;title&#39;&quot;, TextView.class);</code>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addViewBindings</span><span class="params">(MethodSpec.Builder result, ViewBindings bindings)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bindings.isSingleFieldBinding()) &#123;<span class="comment">//如果只有FieldBinding</span></span><br><span class="line">        <span class="comment">// Optimize the common case where there&#x27;s a single binding directly to a field.</span></span><br><span class="line">        FieldViewBinding fieldBinding = bindings.getFieldBinding();</span><br><span class="line">        CodeBlock.Builder builder = CodeBlock.builder()</span><br><span class="line">                .add(<span class="string">&quot;target.$L = &quot;</span>, fieldBinding.getName());</span><br><span class="line">    <span class="comment">//当type是View类型不需要强制转换</span></span><br><span class="line">        <span class="keyword">boolean</span> requiresCast = requiresCast(fieldBinding.getType());</span><br><span class="line">        <span class="keyword">if</span> (!requiresCast &amp;&amp; !fieldBinding.isRequired()) &#123;</span><br><span class="line">            builder.add(<span class="string">&quot;source.findViewById($L)&quot;</span>, bindings.getId().code);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder.add(<span class="string">&quot;$T.find&quot;</span>, UTILS);<span class="comment">//Utils.findRequiredViewAsType(source,12345,</span></span><br><span class="line">            builder.add(fieldBinding.isRequired() ? <span class="string">&quot;RequiredView&quot;</span> : <span class="string">&quot;OptionalView&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (requiresCast) &#123;</span><br><span class="line">                builder.add(<span class="string">&quot;AsType&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            builder.add(<span class="string">&quot;(source, $L&quot;</span>, bindings.getId().code);</span><br><span class="line">            <span class="keyword">if</span> (fieldBinding.isRequired() || requiresCast) &#123;</span><br><span class="line">                builder.add(<span class="string">&quot;, $S&quot;</span>, asHumanDescription(singletonList(fieldBinding)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (requiresCast) &#123;</span><br><span class="line">                builder.add(<span class="string">&quot;, $T.class&quot;</span>, fieldBinding.getRawType());</span><br><span class="line">            &#125;</span><br><span class="line">            builder.add(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        result.addStatement(<span class="string">&quot;$L&quot;</span>, builder.build());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//如同时存在FieldViewBinding和MethodViewBinding</span></span><br><span class="line">  <span class="comment">//先生成    view = Utils.findRequiredView(source, R.id.hello, &quot;field &#x27;hello&#x27;, method &#x27;sayHello&#x27;, method &#x27;sayHello2&#x27;, and method &#x27;sayGetOffMe&#x27;&quot;);</span></span><br><span class="line"><span class="comment">//调用addFieldBindings方法生成    target.hello = Utils.castView(view, R.id.hello, &quot;field &#x27;hello&#x27;&quot;, Button.class);</span></span><br><span class="line"></span><br><span class="line">    List&lt;ViewBinding&gt; requiredViewBindings = bindings.getRequiredBindings();</span><br><span class="line">    <span class="keyword">if</span> (requiredViewBindings.isEmpty()) &#123;</span><br><span class="line">        result.addStatement(<span class="string">&quot;view = source.findViewById($L)&quot;</span>, bindings.getId().code);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!bindings.isBoundToRoot()) &#123;</span><br><span class="line">        result.addStatement(<span class="string">&quot;view = $T.findRequiredView(source, $L, $S)&quot;</span>, UTILS,</span><br><span class="line">                bindings.getId().code, asHumanDescription(requiredViewBindings));</span><br><span class="line">    &#125;</span><br><span class="line">    addFieldBindings(result, bindings);</span><br><span class="line">    addMethodBindings(result, bindings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFieldBindings</span><span class="params">(MethodSpec.Builder result, ViewBindings bindings)</span> </span>&#123;</span><br><span class="line">    FieldViewBinding fieldBinding = bindings.getFieldBinding();</span><br><span class="line">    <span class="keyword">if</span> (fieldBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (requiresCast(fieldBinding.getType())) &#123;</span><br><span class="line">            result.addStatement(<span class="string">&quot;target.$L = $T.castView(view, $L, $S, $T.class)&quot;</span>,</span><br><span class="line">                    fieldBinding.getName(), UTILS, bindings.getId().code,</span><br><span class="line">                    asHumanDescription(singletonList(fieldBinding)), fieldBinding.getRawType());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.addStatement(<span class="string">&quot;target.$L = view&quot;</span>, fieldBinding.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addMethodBindings</span><span class="params">(MethodSpec.Builder result, ViewBindings bindings)</span> </span>&#123;</span><br><span class="line">    Map&lt;ListenerClass, Map&lt;ListenerMethod, Set&lt;MethodViewBinding&gt;&gt;&gt; classMethodBindings =</span><br><span class="line">            bindings.getMethodBindings();</span><br><span class="line">    <span class="keyword">if</span> (classMethodBindings.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We only need to emit the null check if there are zero required bindings.</span></span><br><span class="line">    <span class="keyword">boolean</span> needsNullChecked = bindings.getRequiredBindings().isEmpty();</span><br><span class="line">    <span class="keyword">if</span> (needsNullChecked) &#123;</span><br><span class="line">        result.beginControlFlow(<span class="string">&quot;if (view != null)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the view reference to the binding.</span></span><br><span class="line">    String fieldName = <span class="string">&quot;viewSource&quot;</span>;</span><br><span class="line">    String bindName = <span class="string">&quot;source&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!bindings.isBoundToRoot()) &#123;</span><br><span class="line">        fieldName = <span class="string">&quot;view&quot;</span> + bindings.getId().value;</span><br><span class="line">        bindName = <span class="string">&quot;view&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    result.addStatement(<span class="string">&quot;$L = $N&quot;</span>, fieldName, bindName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;ListenerClass, Map&lt;ListenerMethod, Set&lt;MethodViewBinding&gt;&gt;&gt; e</span><br><span class="line">            : classMethodBindings.entrySet()) &#123;</span><br><span class="line">        ListenerClass listener = e.getKey();</span><br><span class="line">        Map&lt;ListenerMethod, Set&lt;MethodViewBinding&gt;&gt; methodBindings = e.getValue();</span><br><span class="line"></span><br><span class="line">        TypeSpec.Builder callback = TypeSpec.anonymousClassBuilder(<span class="string">&quot;&quot;</span>)</span><br><span class="line">                .superclass(ClassName.bestGuess(listener.type()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ListenerMethod method : getListenerMethods(listener)) &#123;</span><br><span class="line">            MethodSpec.Builder callbackMethod = MethodSpec.methodBuilder(method.name())</span><br><span class="line">                    .addAnnotation(Override.class)</span><br><span class="line">                    .addModifiers(PUBLIC)</span><br><span class="line">                    .returns(bestGuess(method.returnType()));</span><br><span class="line">            String[] parameterTypes = method.parameters();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = parameterTypes.length; i &lt; count; i++) &#123;</span><br><span class="line">                callbackMethod.addParameter(bestGuess(parameterTypes[i]), <span class="string">&quot;p&quot;</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> hasReturnType = !<span class="string">&quot;void&quot;</span>.equals(method.returnType());</span><br><span class="line">            CodeBlock.Builder builder = CodeBlock.builder();</span><br><span class="line">            <span class="keyword">if</span> (hasReturnType) &#123;</span><br><span class="line">                builder.add(<span class="string">&quot;return &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (methodBindings.containsKey(method)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (MethodViewBinding binding : methodBindings.get(method)) &#123;</span><br><span class="line">                    builder.add(<span class="string">&quot;target.$L(&quot;</span>, binding.getName());</span><br><span class="line">                    List&lt;Parameter&gt; parameters = binding.getParameters();</span><br><span class="line">                    String[] listenerParameters = method.parameters();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = parameters.size(); i &lt; count; i++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            builder.add(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        Parameter parameter = parameters.get(i);</span><br><span class="line">                        <span class="keyword">int</span> listenerPosition = parameter.getListenerPosition();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (parameter.requiresCast(listenerParameters[listenerPosition])) &#123;</span><br><span class="line">                            builder.add(<span class="string">&quot;$T.&lt;$T&gt;castParam(p$L, $S, $L, $S, $L)&quot;</span>, UTILS, parameter.getType(),</span><br><span class="line">                                    listenerPosition, method.name(), listenerPosition, binding.getName(), i);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            builder.add(<span class="string">&quot;p$L&quot;</span>, listenerPosition);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    builder.add(<span class="string">&quot;);\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasReturnType) &#123;</span><br><span class="line">                builder.add(<span class="string">&quot;$L;\n&quot;</span>, method.defaultReturn());</span><br><span class="line">            &#125;</span><br><span class="line">            callbackMethod.addCode(builder.build());</span><br><span class="line">            callback.addMethod(callbackMethod.build());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> requiresRemoval = listener.remover().length() != <span class="number">0</span>;</span><br><span class="line">        String listenerField = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (requiresRemoval) &#123;</span><br><span class="line">            TypeName listenerClassName = bestGuess(listener.type());</span><br><span class="line">            listenerField = fieldName + ((ClassName) listenerClassName).simpleName();</span><br><span class="line">            result.addStatement(<span class="string">&quot;$L = $L&quot;</span>, listenerField, callback.build());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!VIEW_TYPE.equals(listener.targetType())) &#123;</span><br><span class="line">            result.addStatement(<span class="string">&quot;(($T) $N).$L($L)&quot;</span>, bestGuess(listener.targetType()), bindName,</span><br><span class="line">                    listener.setter(), requiresRemoval ? listenerField : callback.build());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.addStatement(<span class="string">&quot;$N.$L($L)&quot;</span>, bindName, listener.setter(),</span><br><span class="line">                    requiresRemoval ? listenerField : callback.build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needsNullChecked) &#123;</span><br><span class="line">        result.endControlFlow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用辅助方法"><a href="#调用辅助方法" class="headerlink" title="调用辅助方法"></a>调用辅助方法</h4><p>我们在类中通过调用ButterKnife的bind方法来调用辅助类的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(<span class="meta">@NonNull</span> Object target, <span class="meta">@NonNull</span> View source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createBinding(target, source);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unbinder <span class="title">createBinding</span><span class="params">(<span class="meta">@NonNull</span> Object target, <span class="meta">@NonNull</span> View source)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; targetClass = target.getClass();</span><br><span class="line">    <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;Looking up binding for &quot;</span> + targetClass.getName());</span><br><span class="line">    Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);</span><br><span class="line">    <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> Unbinder.EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> constructor.newInstance(target, source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to invoke &quot;</span> + constructor, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to invoke &quot;</span> + constructor, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">      Throwable cause = e.getCause();</span><br><span class="line">      <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to create binding instance.&quot;</span>, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="meta">@Nullable</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</span><br><span class="line">    Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);</span><br><span class="line">    <span class="keyword">if</span> (bindingCtor != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;HIT: Cached in binding map.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> bindingCtor;</span><br><span class="line">    &#125;</span><br><span class="line">    String clsName = cls.getName();</span><br><span class="line">    <span class="keyword">if</span> (clsName.startsWith(<span class="string">&quot;android.&quot;</span>) || clsName.startsWith(<span class="string">&quot;java.&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;MISS: Reached framework class. Abandoning search.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Class&lt;?&gt; bindingClass = Class.forName(clsName + <span class="string">&quot;_ViewBinding&quot;</span>);</span><br><span class="line">      <span class="comment">//noinspection unchecked</span></span><br><span class="line">      bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View.class);</span><br><span class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;HIT: Loaded binding class and constructor.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;Not found. Trying superclass &quot;</span> + cls.getSuperclass().getName());</span><br><span class="line">      bindingCtor = findBindingConstructorForClass(cls.getSuperclass());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to find binding constructor for &quot;</span> + clsName, e);</span><br><span class="line">    &#125;</span><br><span class="line">    BINDINGS.put(cls, bindingCtor);</span><br><span class="line">    <span class="keyword">return</span> bindingCtor;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">马林康</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://malinkang.cn/2020/12/02/butterknife-source-analysis/">https://malinkang.cn/2020/12/02/butterknife-source-analysis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://malinkang.cn" target="_blank">马林康的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a></div><div class="post_share"><div class="social-share" data-image="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/疯狂动物城.JPG" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/07/workmanager-source-analysis/"><img class="prev-cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/指环王.JPG" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">WorkManager源码分析</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/27/rxjava-source-analysis/"><img class="next-cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/罗马假日.JPG" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">RxJava源码分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/11/24/arouter-source-analysis/" title="ARouter源码分析"><img class="cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/泰坦尼克号.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-24</div><div class="title">ARouter源码分析</div></div></a></div><div><a href="/2020/11/25/glide-source-analysis/" title="Glide源码分析"><img class="cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/权利的游戏.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-25</div><div class="title">Glide源码分析</div></div></a></div><div><a href="/2020/11/25/leakcanary-source-analysis/" title="Leakcanary源码分析"><img class="cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/千与千寻.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-25</div><div class="title">Leakcanary源码分析</div></div></a></div><div><a href="/2020/11/25/okio-source-analysis/" title="Okio源码分析"><img class="cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/后翼弃兵.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-25</div><div class="title">Okio源码分析</div></div></a></div><div><a href="/2020/11/25/okhttp-source-analysis/" title="Okhttp源码分析"><img class="cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/千与千寻2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-25</div><div class="title">Okhttp源码分析</div></div></a></div><div><a href="/2017/07/25/retrofit-source-analysis/" title="Retrofit源码分析"><img class="cover" src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/飞屋环游记.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-07-25</div><div class="title">Retrofit源码分析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">马林康</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">50</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/malinkang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://twitter.com/maliinkang" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="https://weibo.com/maliinkang" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="https://instagram.com/maliinkang" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%B1%BB"><span class="toc-number">2.</span> <span class="toc-text">核心类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">解析注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-BindView"><span class="toc-number">3.1.</span> <span class="toc-text">解析@BindView</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.2.</span> <span class="toc-text">解析方法注解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E8%B5%84%E6%BA%90%E7%BB%91%E5%AE%9A"><span class="toc-number">3.3.</span> <span class="toc-text">解析资源绑定</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEparentBinding"><span class="toc-number">3.4.</span> <span class="toc-text">设置parentBinding</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">生成代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E8%BE%85%E5%8A%A9%E6%96%B9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">调用辅助方法</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/14/bound-services/" title="绑定服务"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="绑定服务"/></a><div class="content"><a class="title" href="/2020/12/14/bound-services/" title="绑定服务">绑定服务</a><time datetime="2020-12-14T11:18:41.000Z" title="发表于 2020-12-14 19:18:41">2020-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/07/workmanager-source-analysis/" title="WorkManager源码分析"><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/指环王.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WorkManager源码分析"/></a><div class="content"><a class="title" href="/2020/12/07/workmanager-source-analysis/" title="WorkManager源码分析">WorkManager源码分析</a><time datetime="2020-12-07T12:40:56.000Z" title="发表于 2020-12-07 20:40:56">2020-12-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/02/butterknife-source-analysis/" title="ButterKnife源码分析"><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/疯狂动物城.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ButterKnife源码分析"/></a><div class="content"><a class="title" href="/2020/12/02/butterknife-source-analysis/" title="ButterKnife源码分析">ButterKnife源码分析</a><time datetime="2020-12-02T08:37:06.000Z" title="发表于 2020-12-02 16:37:06">2020-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/27/rxjava-source-analysis/" title="RxJava源码分析"><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/罗马假日.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RxJava源码分析"/></a><div class="content"><a class="title" href="/2020/11/27/rxjava-source-analysis/" title="RxJava源码分析">RxJava源码分析</a><time datetime="2020-11-27T15:47:34.000Z" title="发表于 2020-11-27 23:47:34">2020-11-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/25/leakcanary-source-analysis/" title="Leakcanary源码分析"><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/cover/千与千寻.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Leakcanary源码分析"/></a><div class="content"><a class="title" href="/2020/11/25/leakcanary-source-analysis/" title="Leakcanary源码分析">Leakcanary源码分析</a><time datetime="2020-11-25T12:10:28.000Z" title="发表于 2020-11-25 20:10:28">2020-11-25</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2014 - 2021 By 马林康</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://malinkang.cn/2020/12/02/butterknife-source-analysis/'
    this.page.identifier = '2020/12/02/butterknife-source-analysis/'
    this.page.title = 'ButterKnife源码分析'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://malinkang.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>