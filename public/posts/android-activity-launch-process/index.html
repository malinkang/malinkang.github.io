<!DOCTYPE html>
<html><head>
<title>Activity的启动流程</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="stylesheet" href="https://malinkang.cn/scss/journal.min.56b67b8b01d7cd1015ed14414fd2fc33ebfb2e8413dcbc47c5cd734544c92cd7.css" integrity="sha256-VrZ7iwHXzRAV7RRBT9L8M&#43;v7LoQT3LxHxc1zRUTJLNc=" media="screen">



<link rel="stylesheet" href="https://malinkang.cn/scss/dark-mode.min.5a2bbd1758c83affd639a91fbfd5cc681b1a5574df99442825c444dd40504b13.css" integrity="sha256-Wiu9F1jIOv/WOakfv9XMaBsaVXTfmUQoJcRE3UBQSxM=" media="screen">


<script src="https://malinkang.cn//js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>

<script src="https://malinkang.cn//js/table.js"></script>




<script src="https://malinkang.cn//js/toc.js"></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: 'd84786eae9edb9e6521b',
  clientSecret: 'a30a17b679a15e85b8f257eec4231d5b286e1b58',
  repo: 'malinkang.github.io',
  owner: 'malinkang',
  admin: ['malinkang'],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>






</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://malinkang.cn/">
    
        <div class="nav-title">
            Malinkang‘s Blog
        </div>
        
        <div class="nav-subtitle">
            人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://android.malinkang.cn">
                Android笔记
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://kotlin.malinkang.cn">
                Kotlin笔记
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	This is a customized copyright.
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac1%e9%98%b6%e6%ae%b5launcher%e9%80%9a%e7%9f%a5ams" v-on:click="closeDrawer" id="第1阶段launcher通知ams-nav">
										 第1阶段：Launcher通知AMS
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac2%e9%98%b6%e6%ae%b5ams%e5%a4%84%e7%90%86launcher%e4%bc%a0%e8%bf%87%e6%9d%a5%e7%9a%84%e4%bf%a1%e6%81%af" v-on:click="closeDrawer" id="第2阶段ams处理launcher传过来的信息-nav">
										 第2阶段：AMS处理Launcher传过来的信息
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac3%e9%98%b6%e6%ae%b5launcher%e5%8e%bb%e4%bc%91%e7%9c%a0%e7%84%b6%e5%90%8e%e9%80%9a%e7%9f%a5ams%e6%88%91%e7%9c%9f%e7%9a%84%e5%b7%b2%e7%bb%8f%e7%9d%a1%e4%ba%86" v-on:click="closeDrawer" id="第3阶段launcher去休眠然后通知ams我真的已经睡了-nav">
										 第3阶段：Launcher去休眠，然后通知AMS:“我真的已经睡了”
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac4%e9%98%b6%e6%ae%b5ams%e5%90%af%e5%8a%a8%e6%96%b0%e7%9a%84%e8%bf%9b%e7%a8%8b" v-on:click="closeDrawer" id="第4阶段ams启动新的进程-nav">
										 第4阶段：AMS启动新的进程
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac5%e9%98%b6%e6%ae%b5%e6%96%b0%e7%9a%84%e8%bf%9b%e7%a8%8b%e5%90%af%e5%8a%a8%e4%bb%a5activitythread%e7%9a%84main%e5%87%bd%e6%95%b0%e4%bd%9c%e4%b8%ba%e5%85%a5%e5%8f%a3" v-on:click="closeDrawer" id="第5阶段新的进程启动以activitythread的main函数作为入口-nav">
										 第5阶段：新的进程启动，以ActivityThread的main函数作为入口
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac6%e9%98%b6%e6%ae%b5ams%e5%91%8a%e8%af%89%e6%96%b0app%e5%90%af%e5%8a%a8%e5%93%aa%e4%b8%aaactivity" v-on:click="closeDrawer" id="第6阶段ams告诉新app启动哪个activity-nav">
										 第6阶段：AMS告诉新App启动哪个Activity
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac7%e9%98%b6%e6%ae%b5%e5%90%af%e5%8a%a8%e9%a6%96%e9%a1%b5activity" v-on:click="closeDrawer" id="第7阶段启动首页activity-nav">
										 第7阶段：启动首页Activity
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%8f%82%e8%80%83" v-on:click="closeDrawer" id="参考-nav">
										 参考
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://android.malinkang.cn">
                    Android笔记
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://kotlin.malinkang.cn">
                    Kotlin笔记
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac1%e9%98%b6%e6%ae%b5launcher%e9%80%9a%e7%9f%a5ams" v-on:click="closeDrawer" id="第1阶段launcher通知ams-nav">
										 第1阶段：Launcher通知AMS
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac2%e9%98%b6%e6%ae%b5ams%e5%a4%84%e7%90%86launcher%e4%bc%a0%e8%bf%87%e6%9d%a5%e7%9a%84%e4%bf%a1%e6%81%af" v-on:click="closeDrawer" id="第2阶段ams处理launcher传过来的信息-nav">
										 第2阶段：AMS处理Launcher传过来的信息
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac3%e9%98%b6%e6%ae%b5launcher%e5%8e%bb%e4%bc%91%e7%9c%a0%e7%84%b6%e5%90%8e%e9%80%9a%e7%9f%a5ams%e6%88%91%e7%9c%9f%e7%9a%84%e5%b7%b2%e7%bb%8f%e7%9d%a1%e4%ba%86" v-on:click="closeDrawer" id="第3阶段launcher去休眠然后通知ams我真的已经睡了-nav">
										 第3阶段：Launcher去休眠，然后通知AMS:“我真的已经睡了”
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac4%e9%98%b6%e6%ae%b5ams%e5%90%af%e5%8a%a8%e6%96%b0%e7%9a%84%e8%bf%9b%e7%a8%8b" v-on:click="closeDrawer" id="第4阶段ams启动新的进程-nav">
										 第4阶段：AMS启动新的进程
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac5%e9%98%b6%e6%ae%b5%e6%96%b0%e7%9a%84%e8%bf%9b%e7%a8%8b%e5%90%af%e5%8a%a8%e4%bb%a5activitythread%e7%9a%84main%e5%87%bd%e6%95%b0%e4%bd%9c%e4%b8%ba%e5%85%a5%e5%8f%a3" v-on:click="closeDrawer" id="第5阶段新的进程启动以activitythread的main函数作为入口-nav">
										 第5阶段：新的进程启动，以ActivityThread的main函数作为入口
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac6%e9%98%b6%e6%ae%b5ams%e5%91%8a%e8%af%89%e6%96%b0app%e5%90%af%e5%8a%a8%e5%93%aa%e4%b8%aaactivity" v-on:click="closeDrawer" id="第6阶段ams告诉新app启动哪个activity-nav">
										 第6阶段：AMS告诉新App启动哪个Activity
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%ac%ac7%e9%98%b6%e6%ae%b5%e5%90%af%e5%8a%a8%e9%a6%96%e9%a1%b5activity" v-on:click="closeDrawer" id="第7阶段启动首页activity-nav">
										 第7阶段：启动首页Activity
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%8f%82%e8%80%83" v-on:click="closeDrawer" id="参考-nav">
										 参考
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://malinkang.cn/">
            Malinkang‘s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://malinkang.cn/">
        <div class="single-column-header-title">Malinkang‘s Blog</div>
        
        <div class="single-column-header-subtitle">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    Activity的启动流程
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2019-09-24 15:53
                        </time>
                        

                        

                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    <p>App启动的整体流程分为以下7个阶段。</p>
<ol>
<li><code>Launcher</code>通知AMS，要启动<code>App</code>，而且指定要启动<code>App</code>的哪个页面（也就是首页）。</li>
<li><code>AMS</code>通知Launcher, “好了我知道了，没你什么事了”。同时，把要启动的首页记下来。</li>
<li>Launcher当前页面进入Paused状态，然后通知AMS, “我睡了，你可以去找App了”。</li>
<li>AMS检查App是否已经启动了。是，则唤起App即可。否，就要启动一个新的进程。AMS在新进程中创建一个ActivityThread对象，启动其中的main函数。</li>
<li>App启动后，通知AMS, “我启动好了”。</li>
<li>AMS翻出之前在2中存的值，告诉App，启动哪个页面。</li>
<li>App启动首页，创建Context并与首页Activity关联。然后调用首页<code>Activity</code>的onCreate函数。</li>
</ol>
<p>至此启动流程完成，可分成两部分：第1～3阶段，Launcher和AMS相互通信；第4～7阶段，App和AMS相互通信。</p>
<p><a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/marshmallow-release/services/core/java/com/android/server/am/ActivityManagerService.java">ActivityManagerService</a></p>
<h2 id="第1阶段launcher通知ams">第1阶段：Launcher通知AMS</h2>
<p>点击图标会调用<a href="http://androidxref.com/6.0.0_r1/xref/packages/apps/Launcher3/src/com/android/launcher3/Launcher.java">Launcher</a> 的<code>startAppShortcutOrInfoActivity</code>方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Thunk</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startAppShortcutOrInfoActivity</span><span style="color:#f92672">(</span>View v<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object tag <span style="color:#f92672">=</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">getTag</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">final</span> ShortcutInfo shortcut<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">final</span> Intent intent<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tag <span style="color:#66d9ef">instanceof</span> ShortcutInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        shortcut <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ShortcutInfo<span style="color:#f92672">)</span> tag<span style="color:#f92672">;</span>
        intent <span style="color:#f92672">=</span> shortcut<span style="color:#f92672">.</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> pos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[</span>2<span style="color:#f92672">];</span>
        v<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocationOnScreen</span><span style="color:#f92672">(</span>pos<span style="color:#f92672">);</span>
        intent<span style="color:#f92672">.</span><span style="color:#a6e22e">setSourceBounds</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Rect<span style="color:#f92672">(</span>pos<span style="color:#f92672">[</span>0<span style="color:#f92672">],</span> pos<span style="color:#f92672">[</span>1<span style="color:#f92672">],</span>
                pos<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">getWidth</span><span style="color:#f92672">(),</span> pos<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeight</span><span style="color:#f92672">()));</span>

    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tag <span style="color:#66d9ef">instanceof</span> AppInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        shortcut <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        intent <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>AppInfo<span style="color:#f92672">)</span> tag<span style="color:#f92672">).</span><span style="color:#a6e22e">intent</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Input must be a Shortcut or AppInfo&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">boolean</span> success <span style="color:#f92672">=</span> startActivitySafely<span style="color:#f92672">(</span>v<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> tag<span style="color:#f92672">);</span>
    mStats<span style="color:#f92672">.</span><span style="color:#a6e22e">recordLaunch</span><span style="color:#f92672">(</span>v<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> shortcut<span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>success <span style="color:#f92672">&amp;&amp;</span> v <span style="color:#66d9ef">instanceof</span> BubbleTextView<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        mWaitingForResume <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>BubbleTextView<span style="color:#f92672">)</span> v<span style="color:#f92672">;</span>
        mWaitingForResume<span style="color:#f92672">.</span><span style="color:#a6e22e">setStayPressed</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Thunk</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">startActivitySafely</span><span style="color:#f92672">(</span>View v<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span> Object tag<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">boolean</span> success <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mIsSafeModeEnabled <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>Utilities<span style="color:#f92672">.</span><span style="color:#a6e22e">isSystemApp</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> intent<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">makeText</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> R<span style="color:#f92672">.</span><span style="color:#a6e22e">string</span><span style="color:#f92672">.</span><span style="color:#a6e22e">safemode_shortcut_error</span><span style="color:#f92672">,</span> Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">LENGTH_SHORT</span><span style="color:#f92672">).</span><span style="color:#a6e22e">show</span><span style="color:#f92672">();</span>
       <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
   <span style="color:#f92672">}</span>
   <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
       success <span style="color:#f92672">=</span> startActivity<span style="color:#f92672">(</span>v<span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> tag<span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ActivityNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
       Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">makeText</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> R<span style="color:#f92672">.</span><span style="color:#a6e22e">string</span><span style="color:#f92672">.</span><span style="color:#a6e22e">activity_not_found</span><span style="color:#f92672">,</span> Toast<span style="color:#f92672">.</span><span style="color:#a6e22e">LENGTH_SHORT</span><span style="color:#f92672">).</span><span style="color:#a6e22e">show</span><span style="color:#f92672">();</span>
        Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Unable to launch. tag=&#34;</span> <span style="color:#f92672">+</span> tag <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; intent=&#34;</span> <span style="color:#f92672">+</span> intent<span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> success<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><a href="http://androidxref.com/6.0.0_r1/xref/frameworks/base/core/java/android/app/Activity.java">Activity</a>的<code>startActivityForResult</code>方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startActivityForResult</span><span style="color:#f92672">(</span>Intent intent<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> Bundle options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mParent <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">//mMainThread是一个ActivityThread对象
</span><span style="color:#75715e"></span>      <span style="color:#75715e">//通过ActivityThread对象的getApplicationThread方法获取一个Binder对象
</span><span style="color:#75715e"></span>      <span style="color:#75715e">//这个对象的类型是ApplicationThread代表了Launcher所在的线程
</span><span style="color:#75715e"></span>      <span style="color:#75715e">//mToken也是一个Binder对象，代表Launcher这个Activity也通过Instrumentation传给AMS
</span><span style="color:#75715e"></span>     
        Instrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">ActivityResult</span> ar <span style="color:#f92672">=</span>
            mInstrumentation<span style="color:#f92672">.</span><span style="color:#a6e22e">execStartActivity</span><span style="color:#f92672">(</span>
                <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> mMainThread<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationThread</span><span style="color:#f92672">(),</span> mToken<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span>
                intent<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ar <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            mMainThread<span style="color:#f92672">.</span><span style="color:#a6e22e">sendActivityResult</span><span style="color:#f92672">(</span>
                mToken<span style="color:#f92672">,</span> mEmbeddedID<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> ar<span style="color:#f92672">.</span><span style="color:#a6e22e">getResultCode</span><span style="color:#f92672">(),</span>
                ar<span style="color:#f92672">.</span><span style="color:#a6e22e">getResultData</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestCode <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// If this start is requesting a result, we can avoid making
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the activity visible until the result is received.  Setting
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the
</span><span style="color:#75715e"></span>           <span style="color:#75715e">// activity hidden during this time, to avoid flickering.
</span><span style="color:#75715e"></span>           <span style="color:#75715e">// This can only be done when a result is requested because
</span><span style="color:#75715e"></span>           <span style="color:#75715e">// that guarantees we will get information back when the
</span><span style="color:#75715e"></span>           <span style="color:#75715e">// activity is finished, no matter what happens to it.
</span><span style="color:#75715e"></span>           mStartedActivity <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
       <span style="color:#f92672">}</span>

       cancelInputsAndStartExitTransition<span style="color:#f92672">(</span>options<span style="color:#f92672">);</span>
       <span style="color:#75715e">// TODO Consider clearing/flushing other event sources and events for child windows.
</span><span style="color:#75715e"></span>   <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
       <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>options <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
           mParent<span style="color:#f92672">.</span><span style="color:#a6e22e">startActivityFromChild</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
       <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
           <span style="color:#75715e">// Note we want to go through this method for compatibility with
</span><span style="color:#75715e"></span>           <span style="color:#75715e">// existing applications that may have overridden it.
</span><span style="color:#75715e"></span>           mParent<span style="color:#f92672">.</span><span style="color:#a6e22e">startActivityFromChild</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> intent<span style="color:#f92672">,</span> requestCode<span style="color:#f92672">);</span>
       <span style="color:#f92672">}</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

</code></pre></div><p>Instrumentation类的<a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/marshmallow-release/core/java/android/app/Instrumentation.java#1481">execStartActivity</a>方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> ActivityResult <span style="color:#a6e22e">execStartActivity</span><span style="color:#f92672">(</span>
         Context who<span style="color:#f92672">,</span> IBinder contextThread<span style="color:#f92672">,</span> IBinder token<span style="color:#f92672">,</span> Activity target<span style="color:#f92672">,</span>
         Intent intent<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span> Bundle options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
     IApplicationThread whoThread <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>IApplicationThread<span style="color:#f92672">)</span> contextThread<span style="color:#f92672">;</span>
     Uri referrer <span style="color:#f92672">=</span> target <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">onProvideReferrer</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
     <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>referrer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         intent<span style="color:#f92672">.</span><span style="color:#a6e22e">putExtra</span><span style="color:#f92672">(</span>Intent<span style="color:#f92672">.</span><span style="color:#a6e22e">EXTRA_REFERRER</span><span style="color:#f92672">,</span> referrer<span style="color:#f92672">);</span>
     <span style="color:#f92672">}</span>
     <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mActivityMonitors <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mSync<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
             <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> N <span style="color:#f92672">=</span> mActivityMonitors<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
             <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span>N<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
         
                 <span style="color:#66d9ef">final</span> ActivityMonitor am <span style="color:#f92672">=</span> mActivityMonitors<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
                 <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>am<span style="color:#f92672">.</span><span style="color:#a6e22e">match</span><span style="color:#f92672">(</span>who<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> intent<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                     am<span style="color:#f92672">.</span><span style="color:#a6e22e">mHits</span><span style="color:#f92672">++;</span>
                     <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>am<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlocking</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                         <span style="color:#66d9ef">return</span> requestCode <span style="color:#f92672">&gt;=</span> 0 <span style="color:#f92672">?</span> am<span style="color:#f92672">.</span><span style="color:#a6e22e">getResult</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                     <span style="color:#f92672">}</span>
                     <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                 <span style="color:#f92672">}</span>
             <span style="color:#f92672">}</span>
         <span style="color:#f92672">}</span>
     <span style="color:#f92672">}</span>
     <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
         intent<span style="color:#f92672">.</span><span style="color:#a6e22e">migrateExtraStreamToClipData</span><span style="color:#f92672">();</span>
         intent<span style="color:#f92672">.</span><span style="color:#a6e22e">prepareToLeaveProcess</span><span style="color:#f92672">();</span>
             <span style="color:#75715e">//借助Instrumentation把数据传递给ActivityManagerNative
</span><span style="color:#75715e"></span>         <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> ActivityManagerNative<span style="color:#f92672">.</span><span style="color:#a6e22e">getDefault</span><span style="color:#f92672">()</span>
             <span style="color:#f92672">.</span><span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span>whoThread<span style="color:#f92672">,</span> who<span style="color:#f92672">.</span><span style="color:#a6e22e">getBasePackageName</span><span style="color:#f92672">(),</span> intent<span style="color:#f92672">,</span>
                     intent<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveTypeIfNeeded</span><span style="color:#f92672">(</span>who<span style="color:#f92672">.</span><span style="color:#a6e22e">getContentResolver</span><span style="color:#f92672">()),</span>
                     token<span style="color:#f92672">,</span> target <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">mEmbeddedID</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span>
                     requestCode<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
         checkStartActivityResult<span style="color:#f92672">(</span>result<span style="color:#f92672">,</span> intent<span style="color:#f92672">);</span>
     <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
         <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failure from system&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
     <span style="color:#f92672">}</span>
     <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>ServiceManager</code>是一个容器类。<code>AMN</code>通过<code>getDefault</code>方法，从<code>ServiceManager</code>中取得一个名为<code>activity</code>的对象，然后把它包装成一个<code>ActivityManagerProxy</code>（AMP）对象。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Singleton<span style="color:#f92672">&lt;</span>IActivityManager<span style="color:#f92672">&gt;</span> gDefault <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Singleton<span style="color:#f92672">&lt;</span>IActivityManager<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">protected</span> IActivityManager <span style="color:#a6e22e">create</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      IBinder b <span style="color:#f92672">=</span> ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;activity&#34;</span><span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ActivityManager&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;default service binder = &#34;</span> <span style="color:#f92672">+</span> b<span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
      IActivityManager am <span style="color:#f92672">=</span> asInterface<span style="color:#f92672">(</span>b<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          Log<span style="color:#f92672">.</span><span style="color:#a6e22e">v</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ActivityManager&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;default service = &#34;</span> <span style="color:#f92672">+</span> am<span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">return</span> am<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">};</span>
<span style="color:#75715e">//AMN的getDefault
</span><span style="color:#75715e"></span>
</code></pre></div><p><code>AMN</code>的<code>getDefault</code>方法返回类型为<code>IActivityManager</code>，而不是<code>AMP </code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">public</span> IActivityManager <span style="color:#a6e22e">getDefault</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> gDefault<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="第2阶段ams处理launcher传过来的信息">第2阶段：AMS处理Launcher传过来的信息</h2>
<p><code>ActivityManagerProxy </code>的<code>startActivity</code>方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">startActivity</span><span style="color:#f92672">(</span>IApplicationThread caller<span style="color:#f92672">,</span> String callingPackage<span style="color:#f92672">,</span> Intent intent<span style="color:#f92672">,</span>
        String resolvedType<span style="color:#f92672">,</span> IBinder resultTo<span style="color:#f92672">,</span> String resultWho<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> requestCode<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">int</span> startFlags<span style="color:#f92672">,</span> ProfilerInfo profilerInfo<span style="color:#f92672">,</span> Bundle options<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RemoteException <span style="color:#f92672">{</span>
   Parcel data <span style="color:#f92672">=</span> Parcel<span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
   Parcel reply <span style="color:#f92672">=</span> Parcel<span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInterfaceToken</span><span style="color:#f92672">(</span>IActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">descriptor</span><span style="color:#f92672">);</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeStrongBinder</span><span style="color:#f92672">(</span>caller <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> caller<span style="color:#f92672">.</span><span style="color:#a6e22e">asBinder</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeString</span><span style="color:#f92672">(</span>callingPackage<span style="color:#f92672">);</span>
   intent<span style="color:#f92672">.</span><span style="color:#a6e22e">writeToParcel</span><span style="color:#f92672">(</span>data<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeString</span><span style="color:#f92672">(</span>resolvedType<span style="color:#f92672">);</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeStrongBinder</span><span style="color:#f92672">(</span>resultTo<span style="color:#f92672">);</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeString</span><span style="color:#f92672">(</span>resultWho<span style="color:#f92672">);</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>requestCode<span style="color:#f92672">);</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>startFlags<span style="color:#f92672">);</span>
   <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>profilerInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
       data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
       profilerInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">writeToParcel</span><span style="color:#f92672">(</span>data<span style="color:#f92672">,</span> Parcelable<span style="color:#f92672">.</span><span style="color:#a6e22e">PARCELABLE_WRITE_RETURN_VALUE</span><span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
       data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
   <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>options <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
       data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
       options<span style="color:#f92672">.</span><span style="color:#a6e22e">writeToParcel</span><span style="color:#f92672">(</span>data<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
       data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
   <span style="color:#f92672">}</span>
   mRemote<span style="color:#f92672">.</span><span style="color:#a6e22e">transact</span><span style="color:#f92672">(</span>START_ACTIVITY_TRANSACTION<span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> reply<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
   reply<span style="color:#f92672">.</span><span style="color:#a6e22e">readException</span><span style="color:#f92672">();</span>
   <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> reply<span style="color:#f92672">.</span><span style="color:#a6e22e">readInt</span><span style="color:#f92672">();</span>
   reply<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
   data<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
   <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>那么当<code>AMS</code>想给Launcher发消息，又该怎么办呢？前面不是把<code>Launcher</code>以及它所在的进程给传过来了吗？它在AMS这边保存为一个ActivityRecord对象，这个对象里面有一个<code>ApplicationThreadProxy</code>，顾名思义，这就是一个<code>Binder</code>代理对象。它的<code>Binder</code>真身，也就是<code>ApplicationThread</code>。</p>
<p><code>AMS</code>通过<code>ApplicationThreadProxy</code>发送消息，而<code>App</code>端则通过<code>ApplicationThread</code>来接收这个消息。</p>
<p><code>ApplicationThread</code>接收到来自AMS的消息后，调用ActivityThread的sendMessage方法，向Launcher的主线程消息队列发送一个PAUSE_ACTIVITY消息。</p>
<h2 id="第3阶段launcher去休眠然后通知ams我真的已经睡了">第3阶段：Launcher去休眠，然后通知AMS:“我真的已经睡了”</h2>
<p><a href="http://androidxref.com/6.0.0_r1/xref/frameworks/base/core/java/android/app/ActivityThread.java">ActivityThread</a>中的<code>H</code>的类</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">H</span> <span style="color:#66d9ef">extends</span> Handler <span style="color:#f92672">{</span>
   <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//处理AMS发送的消息
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleMessage</span><span style="color:#f92672">(</span>Message msg<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">what</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">case</span> PAUSE_ACTIVITY<span style="color:#f92672">:</span>
                <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>                handlePauseActivity<span style="color:#f92672">((</span>IBinder<span style="color:#f92672">)</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">obj</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg1</span> <span style="color:#f92672">&amp;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">,</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg2</span><span style="color:#f92672">,</span>
                        <span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">arg1</span> <span style="color:#f92672">&amp;</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">);</span>
                maybeSnapshot<span style="color:#f92672">();</span>
                <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p><code>ActivityThread</code>的<code>handlePauseActivity</code>方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handlePauseActivity</span><span style="color:#f92672">(</span>IBinder token<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> finished<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">boolean</span> userLeaving<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> configChanges<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> dontReport<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ActivityClientRecord r <span style="color:#f92672">=</span> mActivities<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//Slog.v(TAG, &#34;userLeaving=&#34; + userLeaving + &#34; handling pause of &#34; + r);
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>userLeaving<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            performUserLeavingActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        r<span style="color:#f92672">.</span><span style="color:#a6e22e">activity</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mConfigChangeFlags</span> <span style="color:#f92672">|=</span> configChanges<span style="color:#f92672">;</span>
        performPauseActivity<span style="color:#f92672">(</span>token<span style="color:#f92672">,</span> finished<span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">isPreHoneycomb</span><span style="color:#f92672">());</span>

        <span style="color:#75715e">// Make sure any pending writes are now committed.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">.</span><span style="color:#a6e22e">isPreHoneycomb</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            QueuedWork<span style="color:#f92672">.</span><span style="color:#a6e22e">waitToFinish</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// Tell the activity manager we have paused.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>dontReport<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                ActivityManagerNative<span style="color:#f92672">.</span><span style="color:#a6e22e">getDefault</span><span style="color:#f92672">().</span><span style="color:#a6e22e">activityPaused</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        mSomeActivitiesChanged <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>ActivityThread</code>里面有一个<code>mActivities</code>集合，保存当前App也就是Launcher中所有打开的Activity，把它找出来，让它休眠。</p>
<p>通过AMP通知AMS, “我真的休眠了。”
你可能会找不到H和APT这两个类文件，那是因为它们都是ActivityThread的内嵌类。</p>
<h2 id="第4阶段ams启动新的进程">第4阶段：AMS启动新的进程</h2>
<p>AMS接下来要启动App的首页，因为App不在后台进程中，所以要启动一个新的进程。这里调用的是<a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/marshmallow-release/services/core/java/com/android/server/am/ActivityManagerService.java#3320">Process.start</a>方法，并且指定了ActivityThread的main函数为入口函数。代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Start the process.  It will either succeed and return a result containing
</span><span style="color:#75715e">// the PID of the new process, or else throw a RuntimeException.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">boolean</span> isActivityProcess <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>entryPoint <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>entryPoint <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> entryPoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;android.app.ActivityThread&#34;</span><span style="color:#f92672">;</span>
Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Start proc: &#34;</span> <span style="color:#f92672">+</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">);</span>
checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: asking zygote to start proc&#34;</span><span style="color:#f92672">);</span>
Process<span style="color:#f92672">.</span><span style="color:#a6e22e">ProcessStartResult</span> startResult <span style="color:#f92672">=</span> Process<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>entryPoint<span style="color:#f92672">,</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">processName</span><span style="color:#f92672">,</span> uid<span style="color:#f92672">,</span> uid<span style="color:#f92672">,</span> gids<span style="color:#f92672">,</span> debugFlags<span style="color:#f92672">,</span> mountExternal<span style="color:#f92672">,</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">targetSdkVersion</span><span style="color:#f92672">,</span> app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">seinfo</span><span style="color:#f92672">,</span> requiredAbi<span style="color:#f92672">,</span> instructionSet<span style="color:#f92672">,</span>
        app<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">.</span><span style="color:#a6e22e">dataDir</span><span style="color:#f92672">,</span> entryPointArgs<span style="color:#f92672">);</span>
checkTime<span style="color:#f92672">(</span>startTime<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;startProcess: returned from zygote!&#34;</span><span style="color:#f92672">);</span>
Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>
</code></pre></div><h2 id="第5阶段新的进程启动以activitythread的main函数作为入口">第5阶段：新的进程启动，以ActivityThread的main函数作为入口</h2>
<p>在启动新进程的时候，为这个进程创建ActivityThread对象，这就是我们耳熟能详的主线程（UI线程）。
创建好UI线程后，立刻进入ActivityThread的main函数，接下来要做两件具有重大意义的事情：</p>
<ol>
<li>创建一个主线程Looper，也就是MainLooper。注意，MainLooper就是在这里创建的。</li>
<li>创建Application。注意，Application是在这里生成的。</li>
</ol>
<p>主线程在收到BIND_APPLICATION消息后，根据传递过来的ApplicationInfo创建一个对应的LoadedApk对象（标志当前APK信息），然后创建ContextImpl对象（标志当前进程的环境），紧接着通过反射创建目标Application，并调用其attach方法，将ContextImpl对象设置为目标Application的上下文环境，最后调用Application的onCreate函数，做一些初始工作。
App开发人员对Application非常熟悉，因为我们可以在其中写代码，进行一些全局的控制，所以我们通常认为Application是掌控全局的，其实Application的地位在App中并没有那么重要，它就是一个Context上下文，仅此而已。
App中的灵魂是ActivityThread，也就是主线程，只是这个类对于App开发人员是访问不到的，但使用反射是可以修改这个类的一些行为的。
创建新App的最后就是告诉AMS“我启动好了”，同时把自己的ActivityThread对象发送给AMS。从此以后，AMS的电话簿中就多了这个新的App的登记信息，AMS以后就通过这个ActivityThread对象，向这个App发送消息。</p>
<h2 id="第6阶段ams告诉新app启动哪个activity">第6阶段：AMS告诉新App启动哪个Activity</h2>
<p>AMS把传入的ActivityThread对象转为一个ApplicationThread对象，用于以后和这个App跨进程通信。还记得APT和ATP的关系吗？参见图2-7。
在第1阶段，Launcher通知AMS，要启动斗鱼App的哪个Activity。在第2阶段，这个信息被AMS存下来。在第6阶段，AMS从过去的记录中翻出来要启动哪个Activity，然后通过ATP告诉App。</p>
<h2 id="第7阶段启动首页activity">第7阶段：启动首页Activity</h2>
<p>在Binder的另一端，App通过APT接收到AMS的消息，仍然在H的handleMessage方法的switch语句中处理，只不过，这次消息的类型是LAUNCH_ACTIVITY：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">case</span> LAUNCH_ACTIVITY<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
    Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceBegin</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;activityStart&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">final</span> ActivityClientRecord r <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ActivityClientRecord<span style="color:#f92672">)</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">obj</span><span style="color:#f92672">;</span>
    r<span style="color:#f92672">.</span><span style="color:#a6e22e">packageInfo</span> <span style="color:#f92672">=</span> getPackageInfoNoCheck<span style="color:#f92672">(</span>
            r<span style="color:#f92672">.</span><span style="color:#a6e22e">activityInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">applicationInfo</span><span style="color:#f92672">,</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">compatInfo</span><span style="color:#f92672">);</span>
    handleLaunchActivity<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ACTIVITY_MANAGER</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span> <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</code></pre></div><p>ActivityClientRecord是什么？这是AMS传递过来的要启动的Activity。
我们仔细看那个getPackageInfoNoCheck方法，这个方法会提取apk中的所有资源，然后设置r的packageInfo属性。这个属性的类型很有名，叫做LoadedApk。注意，这个地方也是插件化技术渗入的一个点。
在H的这个分支中，又反过来回调ActivityThread的handleLaunchActivity方法。</p>
<p>重新看一下这个过程，每次都是APT执行ActivityThread的sendMessage方法，在这个方法中，把消息拼装一下，然后扔给H的swicth语句去分析，来决定要执行ActivityThread的那个方法。每次都是这样，习惯就好了。
handleLaunchActivity方法都做哪些事呢？</p>
<ol>
<li>通过Instrumentation的newActivity方法，创建要启动的Activity实例。</li>
<li>为这个Activity创建一个上下文Context对象，并与Activity进行关联。</li>
<li>通过Instrumentation的callActivityOnCreate方法，执行Activity的onCreate方法，从而启动Activity。看到这里是不是很熟悉很亲切？</li>
</ol>
<p>至此，App启动完毕。这个流程经过了很多次握手，App和ASM频繁地向对方发送消息，而发送消息的机制，是建立在Binder的基础之上的。</p>
<h2 id="参考">参考</h2>
                    
                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2019-09-24</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://malinkang.cn/posts/dex-file-format/">
                    Next<br>Dex文件格式分析
                </a>
                
                
                
                <a class="older-posts" href="https://malinkang.cn/posts/dagger-users-guide/">
                    Previous<br>Dagger Users Guide
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>





            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	This is a customized copyright.
	</div>
    	</div>
    <script src="https://malinkang.cn//js/journal.js"></script>
    </body>
</html>
