<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Recyclerview源码分析一" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="RecyclerView是我们开发中最常用的控件，RecyclerView是如何工作的，如何处理缓存的有助于解决一些使用RecyclerView的bug和优化RecyclerView。" /><meta property="og:description" content="RecyclerView是我们开发中最常用的控件，RecyclerView是如何工作的，如何处理缓存的有助于解决一些使用RecyclerView的bug和优化RecyclerView。" /><link rel="canonical" href="https://malinkang.cn/posts/recyclerview-analysis-1/" /><meta property="og:url" content="https://malinkang.cn/posts/recyclerview-analysis-1/" /><meta property="og:site_name" content="malinkang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-02T16:39:09+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Recyclerview源码分析一" /><meta name="twitter:site" content="@malinkang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"RecyclerView是我们开发中最常用的控件，RecyclerView是如何工作的，如何处理缓存的有助于解决一些使用RecyclerView的bug和优化RecyclerView。","headline":"Recyclerview源码分析一","dateModified":"2020-09-02T16:39:09+08:00","url":"https://malinkang.cn/posts/recyclerview-analysis-1/","datePublished":"2020-09-02T16:39:09+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://malinkang.cn/posts/recyclerview-analysis-1/"},"@context":"https://schema.org"}</script><title>Recyclerview源码分析一 | malinkang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="malinkang"><meta name="application-name" content="malinkang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">malinkang</a></div><div class="site-subtitle font-italic">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/malinkang" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/malinkang" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['linkang.ma','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Recyclerview源码分析一</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Recyclerview源码分析一</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> malinkang </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Sep 2, 2020, 4:39 PM +0800" prep="on" > Sep 2, 2020 <i class="unloaded">2020-09-02T16:39:09+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2090 words">11 min</span></div></div><div class="post-content"><p><code class="language-plaintext highlighter-rouge">RecyclerView</code>是我们开发中最常用的控件，<code class="language-plaintext highlighter-rouge">RecyclerView</code>是如何工作的，如何处理缓存的有助于解决一些使用<code class="language-plaintext highlighter-rouge">RecyclerView</code>的bug和优化<code class="language-plaintext highlighter-rouge">RecyclerView</code>。</p><h2 id="准备源码">准备源码</h2><p>分析源码之前我们需要先准备一份源码。</p><ol><li><p>按照<a href="https://android.googlesource.com/platform/frameworks/support/">官方文档</a>下载一份<code class="language-plaintext highlighter-rouge">support</code>源码</p><li><p>用AndroidStudio打开源码</p></ol><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>#进入support目录
cd androidx-master-dev/frameworks/support
./studiow
</pre></table></code></div></div><ol><li><p>我们可以在源码中添加一些日志</p><li><p>打包</p></ol><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">./</span><span class="n">gradlew</span> <span class="n">createArchive</span>
</pre></table></code></div></div><ol><li>创建一个工程，在项目的<code class="language-plaintext highlighter-rouge">build.gradle</code>文件的 “repositories”属性的顶部加上以下内容。这样项目中依赖的<code class="language-plaintext highlighter-rouge">RecyclerView</code>就是你添加了日志的<code class="language-plaintext highlighter-rouge">RecyclerView</code>。</ol><div class="language-groovy highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s1">'/Volumes/android/androidx-master-dev/out/androidx/build/support_repo/'</span> <span class="o">}</span>
</pre></table></code></div></div><h2 id="recyclerview">RecyclerView</h2><p><code class="language-plaintext highlighter-rouge">RecyclerView</code>内部定义了如下几个内部类。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/recyclerview-1.png" alt="" /></p><p>我们接下来将逐个分析每个内部类的主要功能，和一些常用的方法。后面再把各个部分串起来看他们是如何工作的。</p><h2 id="adapter">Adapter</h2><p><code class="language-plaintext highlighter-rouge">Adapter</code>是一个典型的适配器模式。负责将数据转换成<code class="language-plaintext highlighter-rouge">ItemView</code>，然后添加到<code class="language-plaintext highlighter-rouge">RecyclerView</code>。</p><p>常用方法</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="no">VH</span> <span class="nf">onCreateViewHolder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewGroup</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewType</span><span class="o">);</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">onBindViewHolder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="no">VH</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">);</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getItemViewType</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="o">*</span> <span class="nd">@see</span> <span class="err">#</span><span class="n">notifyItemChanged</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span>
<span class="o">*</span> <span class="nd">@see</span> <span class="err">#</span><span class="n">notifyItemInserted</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span>
<span class="o">*</span> <span class="nd">@see</span> <span class="err">#</span><span class="n">notifyItemRemoved</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span>
<span class="o">*</span> <span class="nd">@see</span> <span class="err">#</span><span class="n">notifyItemRangeChanged</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span> <span class="kt">int</span><span class="o">)</span>
<span class="o">*</span> <span class="nd">@see</span> <span class="err">#</span><span class="n">notifyItemRangeInserted</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span> <span class="kt">int</span><span class="o">)</span>
<span class="o">*</span> <span class="nd">@see</span> <span class="err">#</span><span class="n">notifyItemRangeRemoved</span><span class="o">(</span><span class="kt">int</span><span class="o">,</span> <span class="kt">int</span><span class="o">)</span>
<span class="o">*/</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">notifyDataSetChanged</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">mObservable</span><span class="o">.</span><span class="na">notifyChanged</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="viewholder">ViewHolder</h2><p>在使用<code class="language-plaintext highlighter-rouge">ListView</code>的时候我们都使用过<code class="language-plaintext highlighter-rouge">ViewHolder</code>.<code class="language-plaintext highlighter-rouge">ViewHolder</code>主要是为了防止多次<code class="language-plaintext highlighter-rouge">findViewById</code>.</p><h2 id="layoutmanager">LayoutManager</h2><blockquote><p>A LayoutManager is responsible for measuring and positioning item views within a RecyclerView as well as determining the policy for when to recycle item views that are no longer visible to the user. By changing the LayoutManager a RecyclerView can be used to implement a standard vertically scrolling list,a uniform grid, staggered grids, horizontally scrolling collections and more. Several stock layout managers are provided for general use.</p></blockquote><p><code class="language-plaintext highlighter-rouge">LayoutManager</code>负责测量和定位RecyclerView中的项目视图，以及决定何时回收用户不再可见的项目视图。通过改变<code class="language-plaintext highlighter-rouge">LayoutManager</code>，一个<code class="language-plaintext highlighter-rouge">RecyclerView</code>可以被用来实现一个标准的垂直滚动列表，一个统一的网格，交错的网格，水平滚动的集合等等。系统提供了几种常用的布局管理器。</p><h2 id="itemdecoration">ItemDecoration</h2><p><code class="language-plaintext highlighter-rouge">ItemDecoration</code>顾名思义就是用来对Item进行装饰的。我们最常用的就是为每个Item添加分割线。</p><h2 id="itemanimator">ItemAnimator</h2><p><code class="language-plaintext highlighter-rouge">ItemAnimator</code>定义了当适配器发生变化时的动画。我们可以调用RecyclerView的setItemAnimator方法设置<code class="language-plaintext highlighter-rouge">ItemAnimator</code>.系统为我们默认设置了一个<code class="language-plaintext highlighter-rouge">DefaultItemAnimator</code>。</p><h2 id="recycler">Recycler</h2><p><code class="language-plaintext highlighter-rouge">Recycler</code>的官方解释如下：</p><blockquote><p>A Recycler is responsible for managing scrapped or detached item views for reuse.</p></blockquote><p><code class="language-plaintext highlighter-rouge">Recycler</code>负责管理废弃或拆分的<code class="language-plaintext highlighter-rouge">item views</code>，以便再利用。</p><blockquote><p>A “scrapped” view is a view that is still attached to its parent RecyclerView but that has been marked for removal or reuse.</p></blockquote><p>一个 ”废弃“的<code class="language-plaintext highlighter-rouge">view</code>是一个仍然附着在它的父<code class="language-plaintext highlighter-rouge">RecyclerView</code>上的<code class="language-plaintext highlighter-rouge">view</code>，但它已经被标记为移除或重用。</p><blockquote><p>Typical use of a Recycler by a LayoutManager will be to obtain views for an adapter’s data set representing the data at a given position or item ID. If the view to be reused is considered “dirty” the adapter will be asked to rebind it. If not, the view can be quickly reused by the LayoutManager with no further work. Clean views that have not may be repositioned by a LayoutManager without remeasurement.</p></blockquote><p><code class="language-plaintext highlighter-rouge">LayoutManager</code>对<code class="language-plaintext highlighter-rouge">Recycler</code>的典型使用是为适配器的数据集获取给定位置或<code class="language-plaintext highlighter-rouge">item ID</code>的数据的视图。如果要重用的视图被认为是 “脏的”，适配器将被要求重新绑定它。如果不是，该视图可以被<code class="language-plaintext highlighter-rouge">LayoutManager</code>快速重用，而无需进一步的工作。没有的干净视图可以由<code class="language-plaintext highlighter-rouge">LayoutManager</code>重新定位，而无需重新测量。</p><p>简单来说<code class="language-plaintext highlighter-rouge">Recycler</code>用来缓存和从缓存中获取<code class="language-plaintext highlighter-rouge">ViewHoder</code>的。<code class="language-plaintext highlighter-rouge">Recycler</code>中定义了如下几个<code class="language-plaintext highlighter-rouge">list</code>来存放缓存：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre> <span class="c1">//存放废弃的view</span>
 <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">mAttachedScrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
 <span class="c1">//存放改变的废弃的view</span>
 <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">mChangedScrap</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="c1">//缓存view</span>
 <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">mCachedViews</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;();</span>
 <span class="c1">//最多缓存个数</span>
 <span class="kt">int</span> <span class="n">mViewCacheMax</span> <span class="o">=</span> <span class="no">DEFAULT_CACHE_SIZE</span><span class="o">;</span>
 <span class="c1">//默认缓存为2</span>
 <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_CACHE_SIZE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
 <span class="c1">//更新缓存大小</span>
<span class="kt">void</span> <span class="nf">updateViewCacheSize</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">extraCache</span> <span class="o">=</span> <span class="n">mLayout</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mLayout</span><span class="o">.</span><span class="na">mPrefetchMaxCountObserved</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">mViewCacheMax</span> <span class="o">=</span> <span class="n">mRequestedCacheMax</span> <span class="o">+</span> <span class="n">extraCache</span><span class="o">;</span>

    <span class="c1">// first, try the views that can be recycled</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">mCachedViews</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
            <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mCachedViews</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">mViewCacheMax</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
        <span class="n">recycleCachedViewAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>查找这几个list的<code class="language-plaintext highlighter-rouge">add</code>和<code class="language-plaintext highlighter-rouge">remove</code>以及<code class="language-plaintext highlighter-rouge">clear</code>方法调用。</p><p><code class="language-plaintext highlighter-rouge">mCachedViews</code>的<code class="language-plaintext highlighter-rouge">add</code>、<code class="language-plaintext highlighter-rouge">remove</code>以及<code class="language-plaintext highlighter-rouge">clear</code>方法调用。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre><td class="rouge-code"><pre><span class="c1">//从mCachedViews中移除</span>
<span class="kt">void</span> <span class="nf">recycleCachedViewAt</span><span class="o">(</span><span class="kt">int</span> <span class="n">cachedViewIndex</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ViewHolder</span> <span class="n">viewHolder</span> <span class="o">=</span> <span class="n">mCachedViews</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cachedViewIndex</span><span class="o">);</span>
    <span class="c1">//从mCachedViews中移除添加到RecycledViewPool</span>
    <span class="n">addViewHolderToRecycledViewPool</span><span class="o">(</span><span class="n">viewHolder</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">mCachedViews</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">cachedViewIndex</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//添加到RecycledViewPool</span>
<span class="kt">void</span> <span class="nf">addViewHolderToRecycledViewPool</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">dispatchRecycled</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">clearNestedRecyclerViewIfNotNested</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="nc">View</span> <span class="n">itemView</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">itemView</span><span class="o">;</span>
    <span class="c1">//</span>
    <span class="n">holder</span><span class="o">.</span><span class="na">mBindingAdapter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">holder</span><span class="o">.</span><span class="na">mOwnerRecyclerView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">//调用RecycledViewPool的putRecycledView方法</span>
    <span class="n">getRecycledViewPool</span><span class="o">().</span><span class="na">putRecycledView</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//添加到mCachedViews中</span>
<span class="kt">void</span> <span class="nf">recycleViewHolderInternal</span><span class="o">(</span><span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">forceRecycle</span> <span class="o">||</span> <span class="n">holder</span><span class="o">.</span><span class="na">isRecyclable</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">//存入到mCachedViews中</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">mViewCacheMax</span> <span class="o">&gt;</span> <span class="mi">0</span>
              <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">holder</span><span class="o">.</span><span class="na">hasAnyOfTheFlags</span><span class="o">(</span><span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_INVALID</span>
              <span class="o">|</span> <span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_REMOVED</span>
              <span class="o">|</span> <span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_UPDATE</span>
              <span class="o">|</span> <span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_ADAPTER_POSITION_UNKNOWN</span><span class="o">))</span> <span class="o">{</span>
          <span class="c1">// Retire oldest cached view</span>
          <span class="kt">int</span> <span class="n">cachedViewSize</span> <span class="o">=</span> <span class="n">mCachedViews</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
          <span class="c1">//当mCachedViews size超过最大缓存数时移除第一个</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">cachedViewSize</span> <span class="o">&gt;=</span> <span class="n">mViewCacheMax</span> <span class="o">&amp;&amp;</span> <span class="n">cachedViewSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">recycleCachedViewAt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
              <span class="n">cachedViewSize</span><span class="o">--;</span>
          <span class="o">}</span>

          <span class="kt">int</span> <span class="n">targetCacheIndex</span> <span class="o">=</span> <span class="n">cachedViewSize</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="no">ALLOW_THREAD_GAP_WORK</span>
                  <span class="o">&amp;&amp;</span> <span class="n">cachedViewSize</span> <span class="o">&gt;</span> <span class="mi">0</span>
                  <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mPrefetchRegistry</span><span class="o">.</span><span class="na">lastPrefetchIncludedPosition</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">mPosition</span><span class="o">))</span> <span class="o">{</span>
              <span class="c1">// when adding the view, skip past most recently prefetched views</span>
              <span class="kt">int</span> <span class="n">cacheIndex</span> <span class="o">=</span> <span class="n">cachedViewSize</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
              <span class="k">while</span> <span class="o">(</span><span class="n">cacheIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                  <span class="kt">int</span> <span class="n">cachedPos</span> <span class="o">=</span> <span class="n">mCachedViews</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cacheIndex</span><span class="o">).</span><span class="na">mPosition</span><span class="o">;</span>
                  <span class="k">if</span> <span class="o">(!</span><span class="n">mPrefetchRegistry</span><span class="o">.</span><span class="na">lastPrefetchIncludedPosition</span><span class="o">(</span><span class="n">cachedPos</span><span class="o">))</span> <span class="o">{</span>
                      <span class="k">break</span><span class="o">;</span>
                  <span class="o">}</span>
                  <span class="n">cacheIndex</span><span class="o">--;</span>
              <span class="o">}</span>
              <span class="n">targetCacheIndex</span> <span class="o">=</span> <span class="n">cacheIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">mCachedViews</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">targetCacheIndex</span><span class="o">,</span> <span class="n">holder</span><span class="o">);</span>
          <span class="n">cached</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">//不满足条件的时候存入RecyclerViewPool</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">cached</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">addViewHolderToRecycledViewPool</span><span class="o">(</span><span class="n">holder</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
          <span class="n">recycled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// NOTE: A view can fail to be recycled when it is scrolled off while an animation</span>
      <span class="c1">// runs. In this case, the item is eventually recycled by</span>
      <span class="c1">// ItemAnimatorRestoreListener#onAnimationFinished.</span>

      <span class="c1">// TODO: consider cancelling an animation when an item is removed scrollBy,</span>
      <span class="c1">// to return it to the pool faster</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//</span>
<span class="kt">void</span> <span class="nf">recycleAndClearCachedViews</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mCachedViews</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
        <span class="n">recycleCachedViewAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">mCachedViews</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="c1">//...</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">mAttachedScrap</code>和<code class="language-plaintext highlighter-rouge">mChangedScrap</code>的<code class="language-plaintext highlighter-rouge">add</code>、<code class="language-plaintext highlighter-rouge">remove</code>以及<code class="language-plaintext highlighter-rouge">clear</code>方法调用。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="cm">/**
  * Mark an attached view as scrap.
  *
  * &lt;p&gt;"Scrap" views are still attached to their parent RecyclerView but are eligible
  * for rebinding and reuse. Requests for a view for a given position may return a
  * reused or rebound scrap view instance.&lt;/p&gt;
  *
  * @param view View to scrap
  */</span>
<span class="kt">void</span> <span class="nf">scrapView</span><span class="o">(</span><span class="nc">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ViewHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="n">getChildViewHolderInt</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">hasAnyOfTheFlags</span><span class="o">(</span><span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_REMOVED</span> <span class="o">|</span> <span class="nc">ViewHolder</span><span class="o">.</span><span class="na">FLAG_INVALID</span><span class="o">)</span>
            <span class="o">||</span> <span class="o">!</span><span class="n">holder</span><span class="o">.</span><span class="na">isUpdated</span><span class="o">()</span> <span class="o">||</span> <span class="n">canReuseUpdatedViewHolder</span><span class="o">(</span><span class="n">holder</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">isInvalid</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">holder</span><span class="o">.</span><span class="na">isRemoved</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mAdapter</span><span class="o">.</span><span class="na">hasStableIds</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Called scrap view with an invalid view."</span>
                    <span class="o">+</span> <span class="s">" Invalid views cannot be reused from scrap, they should rebound from"</span>
                    <span class="o">+</span> <span class="s">" recycler pool."</span> <span class="o">+</span> <span class="n">exceptionLabel</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">setScrapContainer</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">//添加到mAttachedScrap集合中</span>
        <span class="n">mAttachedScrap</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mChangedScrap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mChangedScrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;();</span>
        <span class="o">}</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">setScrapContainer</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">mChangedScrap</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kt">void</span> <span class="nf">clearScrap</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mAttachedScrap</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mChangedScrap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mChangedScrap</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/**
  * Remove a previously scrapped view from the pool of eligible scrap.
  *
  * &lt;p&gt;This view will no longer be eligible for reuse until re-scrapped or
  * until it is explicitly removed and recycled.&lt;/p&gt;
  */</span>
<span class="kt">void</span> <span class="nf">unscrapView</span><span class="o">(</span><span class="nc">ViewHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">mInChangeScrap</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mChangedScrap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mAttachedScrap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">holder</span><span class="o">.</span><span class="na">mScrapContainer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">holder</span><span class="o">.</span><span class="na">mInChangeScrap</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">holder</span><span class="o">.</span><span class="na">clearReturnedFromScrapFlag</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="recycledviewpool">RecycledViewPool</h2><blockquote><p>RecycledViewPool lets you share Views between multiple RecyclerViews.</p></blockquote><p><code class="language-plaintext highlighter-rouge">RecycledViewPool</code>允许多个<code class="language-plaintext highlighter-rouge">RecyclerView</code>共享<code class="language-plaintext highlighter-rouge">View</code>.</p><blockquote><p>If you want to recycle views across RecyclerViews, create an instance of RecycledViewPool and use RecyclerView#setRecycledViewPool(RecycledViewPool).</p></blockquote><p>如果你想在不同的RecyclerViews中循环使用视图。创建一个<code class="language-plaintext highlighter-rouge">RecycledViewPool</code>的实例并传递给<code class="language-plaintext highlighter-rouge">RecyclerView#setRecycledViewPool(RecycledViewPool)</code>。</p><blockquote><p>RecyclerView automatically creates a pool for itself if you don’t provide one.</p></blockquote><p>如果你不提供一个<code class="language-plaintext highlighter-rouge">RecycledViewPool</code>，<code class="language-plaintext highlighter-rouge">RecyclerView</code>会自动为自己创建一个。</p><p>默认<code class="language-plaintext highlighter-rouge">RecycledViewPool</code>在<code class="language-plaintext highlighter-rouge">Recycler</code>的<code class="language-plaintext highlighter-rouge">getRecycledViewPool</code>方法中创建。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nc">RecycledViewPool</span> <span class="nf">getRecycledViewPool</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">mRecyclerPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">mRecyclerPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RecycledViewPool</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">mRecyclerPool</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c1">//缓存池</span>
<span class="nc">SparseArray</span><span class="o">&lt;</span><span class="nc">ScrapData</span><span class="o">&gt;</span> <span class="n">mScrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SparseArray</span><span class="o">&lt;&gt;();</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">ScrapData</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">mScrapHeap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="kt">int</span> <span class="n">mMaxScrap</span> <span class="o">=</span> <span class="no">DEFAULT_MAX_SCRAP</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">mCreateRunningAverageNs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">mBindRunningAverageNs</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//存入缓存</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">putRecycledView</span><span class="o">(</span><span class="nc">ViewHolder</span> <span class="n">scrap</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">viewType</span> <span class="o">=</span> <span class="n">scrap</span><span class="o">.</span><span class="na">getItemViewType</span><span class="o">();</span>
    <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">scrapHeap</span> <span class="o">=</span> <span class="n">getScrapDataForType</span><span class="o">(</span><span class="n">viewType</span><span class="o">).</span><span class="na">mScrapHeap</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mScrap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">viewType</span><span class="o">).</span><span class="na">mMaxScrap</span> <span class="o">&lt;=</span> <span class="n">scrapHeap</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="no">DEBUG</span> <span class="o">&amp;&amp;</span> <span class="n">scrapHeap</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">scrap</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"this scrap item already exists"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">scrap</span><span class="o">.</span><span class="na">resetInternal</span><span class="o">();</span>
    <span class="n">scrapHeap</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">scrap</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//从缓存中获取ViewHolder</span>
<span class="cm">/**
  * Acquire a ViewHolder of the specified type from the pool, or {@code null} if none are
  * present.
  *
  * @param viewType ViewHolder type.
  * @return ViewHolder of the specified type acquired from the pool, or {@code null} if none
  * are present.
  */</span>
<span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="nc">ViewHolder</span> <span class="nf">getRecycledView</span><span class="o">(</span><span class="kt">int</span> <span class="n">viewType</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ScrapData</span> <span class="n">scrapData</span> <span class="o">=</span> <span class="n">mScrap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">viewType</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">scrapData</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">scrapData</span><span class="o">.</span><span class="na">mScrapHeap</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ViewHolder</span><span class="o">&gt;</span> <span class="n">scrapHeap</span> <span class="o">=</span> <span class="n">scrapData</span><span class="o">.</span><span class="na">mScrapHeap</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">scrapHeap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">scrapHeap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">isAttachedToTransitionOverlay</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">scrapHeap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >Android</a> <a href="/tags/recyclerview/" class="post-tag no-text-decoration" >RecyclerView</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Recyclerview源码分析一 - malinkang&url=https://malinkang.cn/posts/recyclerview-analysis-1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Recyclerview源码分析一 - malinkang&u=https://malinkang.cn/posts/recyclerview-analysis-1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Recyclerview源码分析一 - malinkang&url=https://malinkang.cn/posts/recyclerview-analysis-1/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dagger-guide/">Dagger使用指南</a><li><a href="/posts/understanding-the-jvm-runtime-data-areas/">《深入理解JVM》第2章Java内存区域与内存溢出异常</a><li><a href="/posts/understanding-the-jvm-garbage-collection/">《深入理解JVM》第3章垃圾收集器</a><li><a href="/posts/understanding-the-jvm-class-file-structure/">《深入理解JVM》第6章类文件结构</a><li><a href="/posts/understanding-the-jvm-class-loader/">《深入理解JVM》第7章虚拟机类加载机制</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/recyclerview-analysis-2/"><div class="card-body"> <span class="timeago small" > Sep 3, 2020 <i class="unloaded">2020-09-03T16:39:09+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Recyclerview源码分析二</h3><div class="text-muted small"><p> 在上一篇文章中，我们主要分析了RecyclerView中的几个重要的内部类。今天我们就把它们串起来，看它们分别是如何工作的。 RecyclerView继承自ViewGroup。所以肯定是通过addView的方式来将所有的item添加进来的。所以在分析过程中，我先找到addView的调用位置，然后一步步倒推，看view是如何获取的。 首先，在创建ChildHelper时传入的Callb...</p></div></div></a></div><div class="card"> <a href="/posts/recyclerview-analysis-3/"><div class="card-body"> <span class="timeago small" > Sep 4, 2020 <i class="unloaded">2020-09-04T16:39:09+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Recyclerview源码分析三</h3><div class="text-muted small"><p> 上一篇分析RecyclerView整体流程的时候提到，RecyclerView缓存机制比较复杂，所以这一篇单独分析一下RecyclerView的缓存机制。 Recycler中的缓存 Recycler中定义了三个list来缓存ViewHolder，那这几个缓存有什么区别呢。 我们先来看mAttachedScrap和mChangedScrap。Recycler的scrapView中调用mA...</p></div></div></a></div><div class="card"> <a href="/posts/runtime-permissions/"><div class="card-body"> <span class="timeago small" > Dec 25, 2018 <i class="unloaded">2018-12-25T04:25:35+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android运行时权限</h3><div class="text-muted small"><p> 权限的作用是保护 Android 用户的隐私。Android 应用必须请求权限才能访问敏感的用户数据（例如联系人和短信）以及某些系统功能（例如相机和互联网）。系统可能会自动授予权限，也可能会提示用户批准请求，具体取决于访问的功能。 Android 安全架构的设计主旨是：在默认情况下，任何应用都没有权限执行会对其他应用、操作系统或用户带来不利影响的任何操作。这包括读取或写入用户的私有数据（例...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/what-is-reactive-programming/" class="btn btn-outline-primary" prompt="Older"><p>什么是响应式编程</p></a> <a href="/posts/recyclerview-analysis-2/" class="btn btn-outline-primary" prompt="Newer"><p>Recyclerview源码分析二</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//malinkang-cn.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Recyclerview源码分析一'; this.page.url = 'https://malinkang.cn/posts/recyclerview-analysis-1/'; this.page.identifier = '/posts/recyclerview-analysis-1/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/malinkang">malinkang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://malinkang.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
