<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="ButterKnife源码分析" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="本文分析的源码为8.4.0。" /><meta property="og:description" content="本文分析的源码为8.4.0。" /><link rel="canonical" href="https://malinkang.cn/posts/butterknife-source-analysis/" /><meta property="og:url" content="https://malinkang.cn/posts/butterknife-source-analysis/" /><meta property="og:site_name" content="malinkang" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-03T00:37:06+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="ButterKnife源码分析" /><meta name="twitter:site" content="@malinkang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"本文分析的源码为8.4.0。","headline":"ButterKnife源码分析","dateModified":"2020-12-03T00:37:06+08:00","url":"https://malinkang.cn/posts/butterknife-source-analysis/","datePublished":"2020-12-03T00:37:06+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://malinkang.cn/posts/butterknife-source-analysis/"},"@context":"https://schema.org"}</script><title>ButterKnife源码分析 | malinkang</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="malinkang"><meta name="application-name" content="malinkang"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/images/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">malinkang</a></div><div class="site-subtitle font-italic">人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/malinkang" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/malinkang" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['linkang.ma','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>ButterKnife源码分析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>ButterKnife源码分析</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> malinkang </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Dec 3, 2020, 12:37 AM +0800" prep="on" > Dec 3, 2020 <i class="unloaded">2020-12-03T00:37:06+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4824 words">26 min</span></div></div><div class="post-content"><p>本文分析的源码为<code class="language-plaintext highlighter-rouge">8.4.0</code>。</p><h4 id="项目结构">项目结构</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/butterknife-1.png" alt="butterknife-1" /></p><p><code class="language-plaintext highlighter-rouge">butterknife</code>包含ButterKnife核心的Api，如ButterKnife。<code class="language-plaintext highlighter-rouge">butterknife-annotations</code>包含了所有定义的注解。<code class="language-plaintext highlighter-rouge">butterknife-compiler</code>包含了生成模板代码的代码。这里我们重点研究ButterKnife是如何生成模板代码以及在我们的类中是如何调用的。</p><h4 id="核心类">核心类</h4><p><code class="language-plaintext highlighter-rouge">ViewBinding</code>是一个接口，有两个直接的子类<code class="language-plaintext highlighter-rouge">FieldViewBinding</code>和<code class="language-plaintext highlighter-rouge">MethodViewBinding</code>。</p><p><code class="language-plaintext highlighter-rouge">FieldViewBinding</code>封装了使用<code class="language-plaintext highlighter-rouge">@BindView</code>注解的Field的信息。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span><span class="c1">//字段名</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">TypeName</span> <span class="n">type</span><span class="o">;</span><span class="c1">//类型</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">required</span><span class="o">;</span><span class="c1">//是否必须</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">MethodViewBinding</code>封装了使用<code class="language-plaintext highlighter-rouge">@OnClick</code>等注解注解的方法的信息。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span><span class="c1">//方法名</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Parameter</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="o">;</span><span class="c1">//方法参数</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">required</span><span class="o">;</span><span class="c1">//是否必须</span>
</pre></table></code></div></div><p>注解@ListenerClass代表一个监听器的类，作用在如@OnClick等事件监听的注解上。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="nd">@Retention</span><span class="o">(</span><span class="no">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="no">ANNOTATION_TYPE</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">ListenerClass</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">targetType</span><span class="o">();</span><span class="c1">//目标类型</span>
  <span class="cm">/** Name of the setter method on the {@linkplain #targetType() target type} for the listener. */</span>
  <span class="nc">String</span> <span class="nf">setter</span><span class="o">();</span><span class="c1">//将该类设置给目标类型的方法</span>
  <span class="cm">/**
   * Name of the method on the {@linkplain #targetType() target type} to remove the listener. If
   * empty {@link #setter()} will be used by default.
   */</span>
  <span class="nc">String</span> <span class="nf">remover</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
  <span class="cm">/** Fully-qualified class name of the listener type. */</span>
  <span class="nc">String</span> <span class="nf">type</span><span class="o">();</span>

  <span class="cm">/** Enum which declares the listener callback methods. Mutually exclusive to {@link #method()}. */</span>
  <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Enum</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">callbacks</span><span class="o">()</span> <span class="k">default</span> <span class="no">NONE</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>

  <span class="cm">/**
   * Method data for single-method listener callbacks. Mutually exclusive with {@link #callbacks()}
   * and an error to specify more than one value.
   */</span>
  <span class="nc">ListenerMethod</span><span class="o">[]</span> <span class="nf">method</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>

  <span class="cm">/** Default value for {@link #callbacks()}. */</span>
  <span class="kd">enum</span> <span class="no">NONE</span> <span class="o">{</span> <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>@ListenerMethod注解代表一个监听类的方法，因为类里面可能有多个方法，所以是一个数组。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nd">@Retention</span><span class="o">(</span><span class="no">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="no">FIELD</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">ListenerMethod</span> <span class="o">{</span>
  <span class="cm">/** Name of the listener method for which this annotation applies. */</span>
  <span class="nc">String</span> <span class="nf">name</span><span class="o">();</span>

  <span class="cm">/** List of method parameters. If the type is not a primitive it must be fully-qualified. */</span>
  <span class="nc">String</span><span class="o">[]</span> <span class="nf">parameters</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>

  <span class="cm">/** Primitive or fully-qualified return type of the listener method. May also be {@code void}. */</span>
  <span class="nc">String</span> <span class="nf">returnType</span><span class="o">()</span> <span class="k">default</span> <span class="s">"void"</span><span class="o">;</span>

  <span class="cm">/** If {@link #returnType()} is not {@code void} this value is returned when no binding exists. */</span>
  <span class="nc">String</span> <span class="nf">defaultReturn</span><span class="o">()</span> <span class="k">default</span> <span class="s">"null"</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>@OnClick</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Target</span><span class="o">(</span><span class="no">METHOD</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="no">CLASS</span><span class="o">)</span>
<span class="nd">@ListenerClass</span><span class="o">(</span>
    <span class="n">targetType</span> <span class="o">=</span> <span class="s">"android.view.View"</span><span class="o">,</span>
    <span class="n">setter</span> <span class="o">=</span> <span class="s">"setOnClickListener"</span><span class="o">,</span>
    <span class="n">type</span> <span class="o">=</span> <span class="s">"butterknife.internal.DebouncingOnClickListener"</span><span class="o">,</span>
    <span class="n">method</span> <span class="o">=</span> <span class="nd">@ListenerMethod</span><span class="o">(</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">"doClick"</span><span class="o">,</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="s">"android.view.View"</span>
    <span class="o">)</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">OnClick</span> <span class="o">{</span>
  <span class="cm">/** View IDs to which the method will be bound. */</span>
  <span class="nd">@IdRes</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="nc">View</span><span class="o">.</span><span class="na">NO_ID</span> <span class="o">};</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ViewBindings</code>封装了一个View的所有<code class="language-plaintext highlighter-rouge">ViewBinding</code>。例如在SimpleActivity中有如下代码</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">@BindView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">hello</span><span class="o">)</span> <span class="nc">Button</span> <span class="n">hello</span><span class="o">;</span><span class="c1">//对应封装成一个FieldViewBinding</span>
<span class="nd">@OnClick</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">hello</span><span class="o">)</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"Hello, views!"</span><span class="o">,</span> <span class="no">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="nc">ButterKnife</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">headerViews</span><span class="o">,</span> <span class="no">ALPHA_FADE</span><span class="o">);</span><span class="c1">//对应封装成一个MethodViewBinding</span>
<span class="o">}</span>
<span class="nd">@OnLongClick</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">hello</span><span class="o">)</span> <span class="kt">boolean</span> <span class="nf">sayGetOffMe</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"Let go of me!"</span><span class="o">,</span> <span class="no">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span><span class="c1">//对应封装成一个MethodViewBinding</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>这里<code class="language-plaintext highlighter-rouge">R.id.hello</code>这个view对应的ViewBindings包含一个FieldViewBinding和两个MethodViewBinding。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">ViewBindings</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Id</span> <span class="n">id</span><span class="o">;</span> <span class="c1">//View对应的id</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerClass</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerMethod</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodViewBinding</span><span class="o">&gt;&gt;&gt;</span> <span class="n">methodBindings</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span><span class="c1">//Map用于存储多个MethodViewBinding</span>
  <span class="kd">private</span> <span class="nc">FieldViewBinding</span> <span class="n">fieldBinding</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><p>这里使用 Map&lt;ListenerMethod, Set<MethodViewBinding>来存储MethodViewBinding。因为同一个ListenerMethod可能对应多个MethodViewBinding。比如下面代码就是一个ListenerMethod就对应了两个MethodViewBinding。</MethodViewBinding></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>  <span class="nd">@OnClick</span><span class="o">({</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">hello</span><span class="o">})</span><span class="kt">void</span> <span class="nf">sayHello</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"Hello, views!"</span><span class="o">,</span> <span class="no">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="nc">ButterKnife</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">headerViews</span><span class="o">,</span> <span class="no">ALPHA_FADE</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@OnClick</span><span class="o">({</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">hello</span><span class="o">})</span><span class="kt">void</span> <span class="nf">sayHello2</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"Hello, views!"</span><span class="o">,</span> <span class="no">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="nc">ButterKnife</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">headerViews</span><span class="o">,</span> <span class="no">ALPHA_FADE</span><span class="o">);</span>
  <span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">BindingSet</code>可以看做是一个类里面所有所有Binding信息。同时还负责生成代码的逻辑。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">BindingSet</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TypeName</span> <span class="n">targetTypeName</span><span class="o">;</span><span class="c1">//</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ClassName</span> <span class="n">bindingClassName</span><span class="o">;</span><span class="c1">//生成辅助类的类名</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isFinal</span><span class="o">;</span><span class="c1">//是否是final类型</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ViewBindings</span><span class="o">&gt;</span> <span class="n">viewBindings</span><span class="o">;</span><span class="c1">//用于存储ViewBinding</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FieldCollectionViewBinding</span><span class="o">&gt;</span> <span class="n">collectionBindings</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ResourceBinding</span><span class="o">&gt;</span> <span class="n">resourceBindings</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BindingSet</span> <span class="n">parentBinding</span><span class="o">;</span><span class="c1">//父parentBinding</span>
<span class="o">}</span>
</pre></table></code></div></div><p>ResourceBinding是一个接口，有两个实现类FieldResourceBinding和FieldDrawableBinding。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre><td class="rouge-code"><pre><span class="c1">//例如  @BindColor(android.R.color.black) @ColorInt int blackColor;</span>
<span class="c1">//将会生成代码    target.blackColor = ContextCompat.getColor(context, android.R.color.black);</span>
<span class="c1">//ResourceMethod方法指的是生成代码的对象</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">FieldResourceBinding</span> <span class="kd">implements</span> <span class="nc">ResourceBinding</span> <span class="o">{</span>
    <span class="kd">enum</span> <span class="nc">Type</span> <span class="o">{</span>
        <span class="no">BITMAP</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResourceMethod</span><span class="o">(</span><span class="nc">BindingSet</span><span class="o">.</span><span class="na">BITMAP_FACTORY</span><span class="o">,</span> <span class="s">"decodeResource"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">1</span><span class="o">)),</span>
        <span class="no">BOOL</span><span class="o">(</span><span class="s">"getBoolean"</span><span class="o">),</span>
        <span class="no">COLOR</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResourceMethod</span><span class="o">(</span><span class="nc">BindingSet</span><span class="o">.</span><span class="na">CONTEXT_COMPAT</span><span class="o">,</span> <span class="s">"getColor"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">1</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">ResourceMethod</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">"getColor"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">23</span><span class="o">)),</span>
        <span class="no">COLOR_STATE_LIST</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResourceMethod</span><span class="o">(</span><span class="nc">BindingSet</span><span class="o">.</span><span class="na">CONTEXT_COMPAT</span><span class="o">,</span> <span class="s">"getColorStateList"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">1</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">ResourceMethod</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">"getColorStateList"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">23</span><span class="o">)),</span>
        <span class="no">DIMEN_AS_INT</span><span class="o">(</span><span class="s">"getDimensionPixelSize"</span><span class="o">),</span>
        <span class="no">DIMEN_AS_FLOAT</span><span class="o">(</span><span class="s">"getDimension"</span><span class="o">),</span>
        <span class="no">FLOAT</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResourceMethod</span><span class="o">(</span><span class="nc">BindingSet</span><span class="o">.</span><span class="na">UTILS</span><span class="o">,</span> <span class="s">"getFloat"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">1</span><span class="o">)),</span>
        <span class="no">INT</span><span class="o">(</span><span class="s">"getInteger"</span><span class="o">),</span>
        <span class="no">INT_ARRAY</span><span class="o">(</span><span class="s">"getIntArray"</span><span class="o">),</span>
        <span class="no">STRING</span><span class="o">(</span><span class="s">"getString"</span><span class="o">),</span>
        <span class="no">STRING_ARRAY</span><span class="o">(</span><span class="s">"getStringArray"</span><span class="o">),</span>
        <span class="no">TEXT_ARRAY</span><span class="o">(</span><span class="s">"getTextArray"</span><span class="o">),</span>
        <span class="no">TYPED_ARRAY</span><span class="o">(</span><span class="s">"obtainTypedArray"</span><span class="o">);</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ResourceMethod</span><span class="o">&gt;</span> <span class="n">methods</span><span class="o">;</span>

        <span class="nc">Type</span><span class="o">(</span><span class="nc">ResourceMethod</span><span class="o">...</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ResourceMethod</span><span class="o">&gt;</span> <span class="n">methodList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">methods</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="nc">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">methodList</span><span class="o">,</span> <span class="n">methods</span><span class="o">);</span>
            <span class="nc">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">methodList</span><span class="o">);</span>
            <span class="nc">Collections</span><span class="o">.</span><span class="na">reverse</span><span class="o">(</span><span class="n">methodList</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">methods</span> <span class="o">=</span> <span class="n">unmodifiableList</span><span class="o">(</span><span class="n">methodList</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Type</span><span class="o">(</span><span class="nc">String</span> <span class="n">methodName</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="n">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResourceMethod</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">methodName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="nc">ResourceMethod</span> <span class="nf">methodForSdk</span><span class="o">(</span><span class="kt">int</span> <span class="n">sdk</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">ResourceMethod</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">sdk</span> <span class="o">&lt;=</span> <span class="n">sdk</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">method</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">AssertionError</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//资源方法</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ResourceMethod</span> <span class="kd">implements</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="nc">ResourceMethod</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ClassName</span> <span class="n">typeName</span><span class="o">;</span><span class="c1">//类名 </span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span><span class="c1">//方法名</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">requiresResources</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">sdk</span><span class="o">;</span><span class="c1">//sdk版本号 因为sdk版本号不一样，调用的方法可能不一样。</span>

        <span class="nc">ResourceMethod</span><span class="o">(</span><span class="nc">ClassName</span> <span class="n">typeName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">requiresResources</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sdk</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">typeName</span> <span class="o">=</span> <span class="n">typeName</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">requiresResources</span> <span class="o">=</span> <span class="n">requiresResources</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">sdk</span> <span class="o">=</span> <span class="n">sdk</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="nc">ResourceMethod</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">sdk</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">sdk</span><span class="o">);</span><span class="c1">//按照sdk排序</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//构造函数</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Id</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">;</span>

    <span class="nc">FieldResourceBinding</span><span class="o">(</span><span class="nc">Id</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Id</span> <span class="nf">id</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">requiresResources</span><span class="o">(</span><span class="kt">int</span> <span class="n">sdk</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">methodForSdk</span><span class="o">(</span><span class="n">sdk</span><span class="o">).</span><span class="na">requiresResources</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">CodeBlock</span> <span class="nf">render</span><span class="o">(</span><span class="kt">int</span> <span class="n">sdk</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ResourceMethod</span> <span class="n">method</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">methodForSdk</span><span class="o">(</span><span class="n">sdk</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">typeName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">requiresResources</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"target.$L = res.$L($L)"</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">id</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"target.$L = context.$L($L)"</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">id</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">requiresResources</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"target.$L = $T.$L(res, $L)"</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">typeName</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
                    <span class="n">id</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"target.$L = $T.$L(context, $L)"</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">typeName</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
                <span class="n">id</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="解析注解">解析注解</h4><p>知道各个类的作用之后，下一步工作就是了解如何解析这些标注了注解的字段和方法的信息，并封装成类。 ButterKnife解析这些信息的类为<code class="language-plaintext highlighter-rouge">ButterKnifeProcessor</code>，解析的工作由<code class="language-plaintext highlighter-rouge">findAndParseTargets</code>方法完成。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="nf">findAndParseTargets</span><span class="o">(</span><span class="nc">RoundEnvironment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">//使用Map存储BindingSet.Builder避免同一个类重复创建BindingSet.Builder</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span><span class="c1">//</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span><span class="c1">//</span>
    <span class="n">scanForRClasses</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
    <span class="c1">// Process each @BindArray element.</span>
    <span class="c1">//获取注解@BindArray的Element</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Element</span> <span class="n">element</span> <span class="o">:</span> <span class="n">env</span><span class="o">.</span><span class="na">getElementsAnnotatedWith</span><span class="o">(</span><span class="nc">BindArray</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="nc">SuperficialValidation</span><span class="o">.</span><span class="na">validateElement</span><span class="o">(</span><span class="n">element</span><span class="o">))</span> <span class="k">continue</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">parseResourceArray</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">builderMap</span><span class="o">,</span> <span class="n">erasedTargetNames</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logParsingError</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="nc">BindArray</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">findAndParseTargets</code>获取不同注解对应的Element，然后调用对应的parse方法来解析。</p><h5 id="解析bindview">解析@BindView</h5><p><code class="language-plaintext highlighter-rouge">parseBindView</code>解析<code class="language-plaintext highlighter-rouge">@BindView</code>注解的Element。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseBindView</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span><span class="o">,</span>
  <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//验证注解是否使用正确</span>
    <span class="kt">boolean</span> <span class="n">hasError</span> <span class="o">=</span> <span class="n">isInaccessibleViaGeneratedCode</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"fields"</span><span class="o">,</span> <span class="n">element</span><span class="o">)</span>
        <span class="o">||</span> <span class="n">isBindingInWrongPackage</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>

    <span class="nc">TypeMirror</span> <span class="n">elementType</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">asType</span><span class="o">();</span>
    <span class="nc">TypeElement</span> <span class="n">enclosingElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeElement</span><span class="o">)</span> <span class="n">element</span><span class="o">.</span><span class="na">getEnclosingElement</span><span class="o">();</span>
    <span class="c1">//例如当@BindView T view; 这时候就是一个TypeKind.TYPEVAR类型</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">elementType</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TypeKind</span><span class="o">.</span><span class="na">TYPEVAR</span><span class="o">)</span> <span class="o">{</span><span class="c1">//泛型类型</span>
      <span class="nc">TypeVariable</span> <span class="n">typeVariable</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeVariable</span><span class="o">)</span> <span class="n">elementType</span><span class="o">;</span>
      <span class="n">elementType</span> <span class="o">=</span> <span class="n">typeVariable</span><span class="o">.</span><span class="na">getUpperBound</span><span class="o">();</span><span class="c1">//获取上边界</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">isSubtypeOfType</span><span class="o">(</span><span class="n">elementType</span><span class="o">,</span> <span class="no">VIEW_TYPE</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isInterface</span><span class="o">(</span><span class="n">elementType</span><span class="o">))</span> <span class="o">{</span><span class="c1">//判断field的类型</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">elementType</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TypeKind</span><span class="o">.</span><span class="na">ERROR</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">note</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s field with unresolved type (%s) "</span>
                <span class="o">+</span> <span class="s">"must elsewhere be generated as a View or interface. (%s.%s)"</span><span class="o">,</span>
            <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">elementType</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
            <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s fields must extend from View or be an interface. (%s.%s)"</span><span class="o">,</span>
            <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
            <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
        <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasError</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">value</span><span class="o">();</span><span class="c1">//获取id</span>
    <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">builderMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span><span class="c1">//创建  BindingSet.Builder</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">builder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ViewBindings</span> <span class="n">viewBindings</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">getViewBinding</span><span class="o">(</span><span class="n">getId</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>
      <span class="c1">//当FieldBinding已经存在说明已经绑定过了。重复绑定将抛异常</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">viewBindings</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">viewBindings</span><span class="o">.</span><span class="na">getFieldBinding</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">FieldViewBinding</span> <span class="n">existingBinding</span> <span class="o">=</span> <span class="n">viewBindings</span><span class="o">.</span><span class="na">getFieldBinding</span><span class="o">();</span>

        <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span><span class="o">,</span>
            <span class="nc">BindView</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">id</span><span class="o">,</span> <span class="n">existingBinding</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
            <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">builder</span> <span class="o">=</span> <span class="n">getOrCreateBindingBuilder</span><span class="o">(</span><span class="n">builderMap</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span><span class="c1">//获取FieldName</span>
    <span class="nc">TypeName</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">TypeName</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">elementType</span><span class="o">);</span><span class="c1">//获取Field的Type</span>
    <span class="kt">boolean</span> <span class="n">required</span> <span class="o">=</span> <span class="n">isFieldRequired</span><span class="o">(</span><span class="n">element</span><span class="o">);</span><span class="c1">//是否必须</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addField</span><span class="o">(</span><span class="n">getId</span><span class="o">(</span><span class="n">id</span><span class="o">),</span> <span class="k">new</span> <span class="nc">FieldViewBinding</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">required</span><span class="o">));</span>
    <span class="c1">// Add the type-erased version to the valid binding targets set.</span>
    <span class="n">erasedTargetNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span>
<span class="o">}</span>

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">isInaccessibleViaGeneratedCode</code>方法用于通过修饰符来判断字段是否能够被生成的代码访问。由于ButterKnife的原理是通过辅助类来完成findViewById的操作，所以必须引用原来的的字段，因此不能设置为private</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">target</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="nc">Utils</span><span class="o">.</span><span class="na">findRequiredViewAsType</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">title</span><span class="o">,</span> <span class="s">"field 'title'"</span><span class="o">,</span> <span class="nc">TextView</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></table></code></div></div><p>isInaccessibleViaGeneratedCode方法的源码</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isInaccessibleViaGeneratedCode</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotationClass</span><span class="o">,</span>
  <span class="nc">String</span> <span class="n">targetThing</span><span class="o">,</span> <span class="nc">Element</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">hasError</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">TypeElement</span> <span class="n">enclosingElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeElement</span><span class="o">)</span> <span class="n">element</span><span class="o">.</span><span class="na">getEnclosingElement</span><span class="o">();</span>
    <span class="c1">// Verify method modifiers.</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Modifier</span><span class="o">&gt;</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">modifiers</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="no">PRIVATE</span><span class="o">)</span> <span class="o">||</span> <span class="n">modifiers</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="no">STATIC</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s %s must not be private or static. (%s.%s)"</span><span class="o">,</span>
          <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">targetThing</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
          <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// Verify containing type.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">enclosingElement</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">!=</span> <span class="no">CLASS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">,</span> <span class="s">"@%s %s may only be contained in classes. (%s.%s)"</span><span class="o">,</span>
          <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">targetThing</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
          <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// Verify containing class visibility is not private.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">enclosingElement</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="no">PRIVATE</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">,</span> <span class="s">"@%s %s may not be contained in private classes. (%s.%s)"</span><span class="o">,</span>
          <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">targetThing</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
          <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">hasError</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h5 id="解析方法注解">解析方法注解</h5><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">listener</span> <span class="o">:</span> <span class="no">LISTENERS</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">findAndParseListener</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">listener</span><span class="o">,</span> <span class="n">builderMap</span><span class="o">,</span> <span class="n">erasedTargetNames</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">findAndParseListener</span><span class="o">(</span><span class="nc">RoundEnvironment</span> <span class="n">env</span><span class="o">,</span>
      <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotationClass</span><span class="o">,</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Element</span> <span class="n">element</span> <span class="o">:</span> <span class="n">env</span><span class="o">.</span><span class="na">getElementsAnnotatedWith</span><span class="o">(</span><span class="n">annotationClass</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="nc">SuperficialValidation</span><span class="o">.</span><span class="na">validateElement</span><span class="o">(</span><span class="n">element</span><span class="o">))</span> <span class="k">continue</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">parseListenerAnnotation</span><span class="o">(</span><span class="n">annotationClass</span><span class="o">,</span> <span class="n">element</span><span class="o">,</span> <span class="n">builderMap</span><span class="o">,</span> <span class="n">erasedTargetNames</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">StringWriter</span> <span class="n">stackTrace</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="o">();</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">stackTrace</span><span class="o">));</span>

        <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"Unable to generate view binder for @%s.\n\n%s"</span><span class="o">,</span>
            <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">stackTrace</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
</pre><td class="rouge-code"><pre>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseListenerAnnotation</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotationClass</span><span class="o">,</span> <span class="nc">Element</span> <span class="n">element</span><span class="o">,</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// This should be guarded by the annotation's @Target but it's worth a check for safe casting.</span>
    <span class="k">if</span> <span class="o">(!(</span><span class="n">element</span> <span class="k">instanceof</span> <span class="nc">ExecutableElement</span><span class="o">)</span> <span class="o">||</span> <span class="n">element</span><span class="o">.</span><span class="na">getKind</span><span class="o">()</span> <span class="o">!=</span> <span class="no">METHOD</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
          <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"@%s annotation must be on a method."</span><span class="o">,</span> <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nc">ExecutableElement</span> <span class="n">executableElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ExecutableElement</span><span class="o">)</span> <span class="n">element</span><span class="o">;</span>
    <span class="nc">TypeElement</span> <span class="n">enclosingElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeElement</span><span class="o">)</span> <span class="n">element</span><span class="o">.</span><span class="na">getEnclosingElement</span><span class="o">();</span>
    <span class="c1">// Assemble information on the method.</span>
    <span class="nc">Annotation</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">annotationClass</span><span class="o">);</span>
    <span class="nc">Method</span> <span class="n">annotationValue</span> <span class="o">=</span> <span class="n">annotationClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"value"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">annotationValue</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">!=</span> <span class="kt">int</span><span class="o">[].</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
          <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"@%s annotation value() type not int[]."</span><span class="o">,</span> <span class="n">annotationClass</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">ids</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">[])</span> <span class="n">annotationValue</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">annotation</span><span class="o">);</span><span class="c1">//通过反射获取值</span>
    <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">executableElement</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span><span class="c1">//方法名</span>
    <span class="kt">boolean</span> <span class="n">required</span> <span class="o">=</span> <span class="n">isListenerRequired</span><span class="o">(</span><span class="n">executableElement</span><span class="o">);</span>
    <span class="c1">// Verify that the method and its containing class are accessible via generated code.</span>
    <span class="kt">boolean</span> <span class="n">hasError</span> <span class="o">=</span> <span class="n">isInaccessibleViaGeneratedCode</span><span class="o">(</span><span class="n">annotationClass</span><span class="o">,</span> <span class="s">"methods"</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
    <span class="n">hasError</span> <span class="o">|=</span> <span class="n">isBindingInWrongPackage</span><span class="o">(</span><span class="n">annotationClass</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
    <span class="c1">//发现重复的id</span>
    <span class="nc">Integer</span> <span class="n">duplicateId</span> <span class="o">=</span> <span class="n">findDuplicate</span><span class="o">(</span><span class="n">ids</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">duplicateId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s annotation for method contains duplicate ID %d. (%s.%s)"</span><span class="o">,</span>
          <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">duplicateId</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
          <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nc">ListenerClass</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">annotationClass</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">ListenerClass</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">listener</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
          <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"No @%s defined on @%s."</span><span class="o">,</span> <span class="nc">ListenerClass</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
              <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">id</span> <span class="o">:</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="no">NO_ID</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ids</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">required</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"ID-free binding must not be annotated with @Optional. (%s.%s)"</span><span class="o">,</span>
                <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
            <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s annotation contains invalid ID %d. (%s.%s)"</span><span class="o">,</span>
              <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">id</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
              <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
          <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">ListenerMethod</span> <span class="n">method</span><span class="o">;</span>
    <span class="nc">ListenerMethod</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="na">method</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Multiple listener methods specified on @%s."</span><span class="o">,</span>
          <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">callbacks</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">ListenerClass</span><span class="o">.</span><span class="na">NONE</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
            <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Both method() and callback() defined on @%s."</span><span class="o">,</span>
                <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()));</span>
      <span class="o">}</span>
      <span class="n">method</span> <span class="o">=</span> <span class="n">methods</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">Method</span> <span class="n">annotationCallback</span> <span class="o">=</span> <span class="n">annotationClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"callback"</span><span class="o">);</span>
      <span class="nc">Enum</span><span class="o">&lt;?&gt;</span> <span class="n">callback</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Enum</span><span class="o">&lt;?&gt;)</span> <span class="n">annotationCallback</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">annotation</span><span class="o">);</span>
      <span class="nc">Field</span> <span class="n">callbackField</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getField</span><span class="o">(</span><span class="n">callback</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
      <span class="n">method</span> <span class="o">=</span> <span class="n">callbackField</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">ListenerMethod</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">method</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
            <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"No @%s defined on @%s's %s.%s."</span><span class="o">,</span> <span class="nc">ListenerMethod</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
                <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">callback</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
                <span class="n">callback</span><span class="o">.</span><span class="na">name</span><span class="o">()));</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Verify that the method has equal to or less than the number of parameters as the listener.</span>
    <span class="nc">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">VariableElement</span><span class="o">&gt;</span> <span class="n">methodParameters</span> <span class="o">=</span> <span class="n">executableElement</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">methodParameters</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">().</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s methods can have at most %s parameter(s). (%s.%s)"</span><span class="o">,</span>
          <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">().</span><span class="na">length</span><span class="o">,</span>
          <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// Verify method return type matches the listener.</span>
    <span class="nc">TypeMirror</span> <span class="n">returnType</span> <span class="o">=</span> <span class="n">executableElement</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">returnType</span> <span class="k">instanceof</span> <span class="nc">TypeVariable</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">TypeVariable</span> <span class="n">typeVariable</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeVariable</span><span class="o">)</span> <span class="n">returnType</span><span class="o">;</span>
      <span class="n">returnType</span> <span class="o">=</span> <span class="n">typeVariable</span><span class="o">.</span><span class="na">getUpperBound</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">returnType</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">returnType</span><span class="o">()))</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s methods must have a '%s' return type. (%s.%s)"</span><span class="o">,</span>
          <span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">method</span><span class="o">.</span><span class="na">returnType</span><span class="o">(),</span>
          <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasError</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Parameter</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="nc">Parameter</span><span class="o">.</span><span class="na">NONE</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">methodParameters</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Parameter</span><span class="o">[</span><span class="n">methodParameters</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
      <span class="nc">BitSet</span> <span class="n">methodParameterUsed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BitSet</span><span class="o">(</span><span class="n">methodParameters</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
      <span class="nc">String</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">();</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">methodParameters</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">VariableElement</span> <span class="n">methodParameter</span> <span class="o">=</span> <span class="n">methodParameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="nc">TypeMirror</span> <span class="n">methodParameterType</span> <span class="o">=</span> <span class="n">methodParameter</span><span class="o">.</span><span class="na">asType</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">methodParameterType</span> <span class="k">instanceof</span> <span class="nc">TypeVariable</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">TypeVariable</span> <span class="n">typeVariable</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeVariable</span><span class="o">)</span> <span class="n">methodParameterType</span><span class="o">;</span>
          <span class="n">methodParameterType</span> <span class="o">=</span> <span class="n">typeVariable</span><span class="o">.</span><span class="na">getUpperBound</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">methodParameterUsed</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">continue</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">isSubtypeOfType</span><span class="o">(</span><span class="n">methodParameterType</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="n">j</span><span class="o">])</span>
              <span class="o">||</span> <span class="n">isInterface</span><span class="o">(</span><span class="n">methodParameterType</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">parameters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Parameter</span><span class="o">(</span><span class="n">j</span><span class="o">,</span> <span class="nc">TypeName</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">methodParameterType</span><span class="o">));</span>
            <span class="n">methodParameterUsed</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parameters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
          <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"Unable to match @"</span><span class="o">)</span>
              <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">annotationClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">())</span>
              <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" method arguments. ("</span><span class="o">)</span>
              <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">())</span>
              <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'.'</span><span class="o">)</span>
              <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">())</span>
              <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">')'</span><span class="o">);</span>
          <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Parameter</span> <span class="n">parameter</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n\n  Parameter #"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">": "</span><span class="o">)</span>
                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">methodParameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">).</span><span class="na">asType</span><span class="o">().</span><span class="na">toString</span><span class="o">())</span>
                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n    "</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parameter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"did not match any listener parameters"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"matched listener parameter #"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">parameter</span><span class="o">.</span><span class="na">getListenerPosition</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">": "</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">parameter</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
            <span class="o">}</span>
          <span class="o">}</span>
          <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n\nMethods may have up to "</span><span class="o">)</span>
              <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">().</span><span class="na">length</span><span class="o">)</span>
              <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" parameter(s):\n"</span><span class="o">);</span>
          <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">parameterType</span> <span class="o">:</span> <span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n  "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">parameterType</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span>
              <span class="s">"\n\nThese may be listed in any order but will be searched for from top to bottom."</span><span class="o">);</span>
          <span class="n">error</span><span class="o">(</span><span class="n">executableElement</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
          <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">MethodViewBinding</span> <span class="n">binding</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MethodViewBinding</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">parameters</span><span class="o">),</span> <span class="n">required</span><span class="o">);</span>
    <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">getOrCreateBindingBuilder</span><span class="o">(</span><span class="n">builderMap</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">id</span> <span class="o">:</span> <span class="n">ids</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">builder</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">getId</span><span class="o">(</span><span class="n">id</span><span class="o">),</span> <span class="n">listener</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">binding</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"Multiple listener methods with return value specified for ID %d. (%s.%s)"</span><span class="o">,</span>
            <span class="n">id</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// Add the type-erased version to the valid binding targets set.</span>
    <span class="n">erasedTargetNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span>
  <span class="o">}</span>
</pre></table></code></div></div><h5 id="解析资源绑定">解析资源绑定</h5><p>解析资源的代码基本都差不多。这里只给出parseResourceString的源码和注释。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseResourceString</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">builderMap</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">&gt;</span> <span class="n">erasedTargetNames</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">hasError</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">TypeElement</span> <span class="n">enclosingElement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TypeElement</span><span class="o">)</span> <span class="n">element</span><span class="o">.</span><span class="na">getEnclosingElement</span><span class="o">();</span>

    <span class="c1">// Verify that the target type is String.</span>
    <span class="k">if</span> <span class="o">(!</span><span class="no">STRING_TYPE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">asType</span><span class="o">().</span><span class="na">toString</span><span class="o">()))</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="s">"@%s field type must be 'String'. (%s.%s)"</span><span class="o">,</span>
          <span class="nc">BindString</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">enclosingElement</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(),</span>
          <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
      <span class="n">hasError</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Verify common generated code restrictions.</span>
    <span class="n">hasError</span> <span class="o">|=</span> <span class="n">isInaccessibleViaGeneratedCode</span><span class="o">(</span><span class="nc">BindString</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"fields"</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
    <span class="n">hasError</span> <span class="o">|=</span> <span class="n">isBindingInWrongPackage</span><span class="o">(</span><span class="nc">BindString</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">hasError</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Assemble information on the field.</span>
    <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">BindString</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>

    <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">getOrCreateBindingBuilder</span><span class="o">(</span><span class="n">builderMap</span><span class="o">,</span> <span class="n">enclosingElement</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addResource</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">FieldResourceBinding</span><span class="o">(</span><span class="n">getId</span><span class="o">(</span><span class="n">id</span><span class="o">),</span> <span class="n">name</span><span class="o">,</span> <span class="nc">FieldResourceBinding</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">STRING</span><span class="o">));</span>

    <span class="n">erasedTargetNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">enclosingElement</span><span class="o">);</span>
  <span class="o">}</span>

</pre></table></code></div></div><h5 id="设置parentbinding">设置parentBinding</h5><p>在findAndParseTargets最后几行代码的作用是为解析出来的BindingSet.Builder设置parentBinding</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre> <span class="nc">Deque</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;&gt;</span> <span class="n">entries</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nc">ArrayDeque</span><span class="o">&lt;&gt;(</span><span class="n">builderMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">());</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">&gt;</span> <span class="n">bindingMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">entries</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">TypeElement</span><span class="o">,</span> <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">entries</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
      <span class="nc">TypeElement</span> <span class="n">type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
      <span class="nc">BindingSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
      <span class="nc">TypeElement</span> <span class="n">parentType</span> <span class="o">=</span> <span class="n">findParentType</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">erasedTargetNames</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">parentType</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//没有parentBinding，不是某各类的子类</span>
        <span class="n">bindingMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">BindingSet</span> <span class="n">parentBinding</span> <span class="o">=</span> <span class="n">bindingMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">parentType</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">builder</span><span class="o">.</span><span class="na">setParent</span><span class="o">(</span><span class="n">parentBinding</span><span class="o">);</span>
          <span class="n">bindingMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="c1">// Has a superclass binding but we haven't built it yet. Re-enqueue for later.</span>
          <span class="n">entries</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><h4 id="生成代码">生成代码</h4><p>生成代码主要由BindingSet的brewJava方法完成。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>   <span class="nc">JavaFile</span> <span class="nf">brewJava</span><span class="o">(</span><span class="kt">int</span> <span class="n">sdk</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">JavaFile</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">bindingClassName</span><span class="o">.</span><span class="na">packageName</span><span class="o">(),</span> <span class="n">createType</span><span class="o">(</span><span class="n">sdk</span><span class="o">))</span>
                <span class="o">.</span><span class="na">addFileComment</span><span class="o">(</span><span class="s">"Generated code from Butter Knife. Do not modify!"</span><span class="o">)</span><span class="c1">//添加注释</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">TypeSpec</span> <span class="nf">createType</span><span class="o">(</span><span class="kt">int</span> <span class="n">sdk</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TypeSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">TypeSpec</span><span class="o">.</span><span class="na">classBuilder</span><span class="o">(</span><span class="n">bindingClassName</span><span class="o">.</span><span class="na">simpleName</span><span class="o">())</span><span class="c1">//类名</span>
                <span class="o">.</span><span class="na">addModifiers</span><span class="o">(</span><span class="no">PUBLIC</span><span class="o">);</span><span class="c1">//修饰符</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isFinal</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addModifiers</span><span class="o">(</span><span class="no">FINAL</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">superclass</span><span class="o">(</span><span class="n">parentBinding</span><span class="o">.</span><span class="na">bindingClassName</span><span class="o">);</span><span class="c1">//添加父类</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addSuperinterface</span><span class="o">(</span><span class="no">UNBINDER</span><span class="o">);</span><span class="c1">//添加接口UnBinder</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">hasTargetField</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addField</span><span class="o">(</span><span class="n">targetTypeName</span><span class="o">,</span> <span class="s">"target"</span><span class="o">,</span> <span class="no">PRIVATE</span><span class="o">);</span><span class="c1">//添加字段target</span>
        <span class="o">}</span>
        <span class="c1">//</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// Add a delegating constructor with a target type + view signature for reflective use.</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingViewDelegateConstructor</span><span class="o">(</span><span class="n">targetTypeName</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingConstructor</span><span class="o">(</span><span class="n">targetTypeName</span><span class="o">,</span> <span class="n">sdk</span><span class="o">));</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">hasViewBindings</span><span class="o">()</span> <span class="o">||</span> <span class="n">parentBinding</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">createBindingUnbindMethod</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">targetTypeName</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>createBindingConstructor创建构造函数</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">MethodSpec</span> <span class="nf">createBindingConstructor</span><span class="o">(</span><span class="nc">TypeName</span> <span class="n">targetType</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sdk</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">constructor</span> <span class="o">=</span> <span class="nc">MethodSpec</span><span class="o">.</span><span class="na">constructorBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">addAnnotation</span><span class="o">(</span><span class="no">UI_THREAD</span><span class="o">)</span><span class="c1">//添加注解</span>
            <span class="o">.</span><span class="na">addModifiers</span><span class="o">(</span><span class="no">PUBLIC</span><span class="o">);</span><span class="c1">//添加修饰符</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasMethodBindings</span><span class="o">())</span> <span class="o">{</span><span class="c1">//如果没有MethodBinding就不用声明成final类型</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="n">targetType</span><span class="o">,</span> <span class="s">"target"</span><span class="o">,</span> <span class="no">FINAL</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="n">targetType</span><span class="o">,</span> <span class="s">"target"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span><span class="c1">//当构造函数需要View</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="no">VIEW</span><span class="o">,</span> <span class="s">"source"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="no">CONTEXT</span><span class="o">,</span> <span class="s">"context"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">hasUnqualifiedResourceBindings</span><span class="o">())</span> <span class="o">{</span><span class="c1">//添加SuppressWarnings注解</span>
        <span class="c1">// Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">addAnnotation</span><span class="o">(</span><span class="nc">AnnotationSpec</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="nc">SuppressWarnings</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">addMember</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span> <span class="s">"$S"</span><span class="o">,</span> <span class="s">"ResourceType"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//添加父类构造方法的调用</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parentBinding</span><span class="o">.</span><span class="na">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"super(target, source)"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"super(target, source.getContext())"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"super(target, context)"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">addCode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasTargetField</span><span class="o">())</span> <span class="o">{</span><span class="c1">//</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"this.target = target"</span><span class="o">);</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">addCode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">hasViewBindings</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasViewLocal</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// Local variable in which all views will be temporarily stored.</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$T view"</span><span class="o">,</span> <span class="no">VIEW</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ViewBindings</span> <span class="n">bindings</span> <span class="o">:</span> <span class="n">viewBindings</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">addViewBindings</span><span class="o">(</span><span class="n">constructor</span><span class="o">,</span> <span class="n">bindings</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">FieldCollectionViewBinding</span> <span class="n">binding</span> <span class="o">:</span> <span class="n">collectionBindings</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L"</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">render</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">resourceBindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addCode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">resourceBindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">constructorNeedsView</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$T context = source.getContext()"</span><span class="o">,</span> <span class="no">CONTEXT</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasResourceBindingsNeedingResource</span><span class="o">(</span><span class="n">sdk</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$T res = context.getResources()"</span><span class="o">,</span> <span class="no">RESOURCES</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ResourceBinding</span> <span class="n">binding</span> <span class="o">:</span> <span class="n">resourceBindings</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">constructor</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L"</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">sdk</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">constructor</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><p>addViewBindings用于添加ViewBindings对象所对应的表达式。当只有FieldViewBinding时直接生成代码 <code class="language-plaintext highlighter-rouge">target.title = Utils.findRequiredViewAsType(source, R.id.title, "field 'title'", TextView.class);</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addViewBindings</span><span class="o">(</span><span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ViewBindings</span> <span class="n">bindings</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bindings</span><span class="o">.</span><span class="na">isSingleFieldBinding</span><span class="o">())</span> <span class="o">{</span><span class="c1">//如果只有FieldBinding</span>
        <span class="c1">// Optimize the common case where there's a single binding directly to a field.</span>
        <span class="nc">FieldViewBinding</span> <span class="n">fieldBinding</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getFieldBinding</span><span class="o">();</span>
        <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"target.$L = "</span><span class="o">,</span> <span class="n">fieldBinding</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="c1">//当type是View类型不需要强制转换</span>
        <span class="kt">boolean</span> <span class="n">requiresCast</span> <span class="o">=</span> <span class="n">requiresCast</span><span class="o">(</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">requiresCast</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">isRequired</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"source.findViewById($L)"</span><span class="o">,</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"$T.find"</span><span class="o">,</span> <span class="no">UTILS</span><span class="o">);</span><span class="c1">//Utils.findRequiredViewAsType(source,12345,</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">isRequired</span><span class="o">()</span> <span class="o">?</span> <span class="s">"RequiredView"</span> <span class="o">:</span> <span class="s">"OptionalView"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">requiresCast</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"AsType"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"(source, $L"</span><span class="o">,</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">isRequired</span><span class="o">()</span> <span class="o">||</span> <span class="n">requiresCast</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">", $S"</span><span class="o">,</span> <span class="n">asHumanDescription</span><span class="o">(</span><span class="n">singletonList</span><span class="o">(</span><span class="n">fieldBinding</span><span class="o">)));</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">requiresCast</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">", $T.class"</span><span class="o">,</span> <span class="n">fieldBinding</span><span class="o">.</span><span class="na">getRawType</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">")"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L"</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="c1">//如同时存在FieldViewBinding和MethodViewBinding</span>
  <span class="c1">//先生成    view = Utils.findRequiredView(source, R.id.hello, "field 'hello', method 'sayHello', method 'sayHello2', and method 'sayGetOffMe'");</span>
<span class="c1">//调用addFieldBindings方法生成    target.hello = Utils.castView(view, R.id.hello, "field 'hello'", Button.class);</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ViewBinding</span><span class="o">&gt;</span> <span class="n">requiredViewBindings</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getRequiredBindings</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">requiredViewBindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"view = source.findViewById($L)"</span><span class="o">,</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">bindings</span><span class="o">.</span><span class="na">isBoundToRoot</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"view = $T.findRequiredView(source, $L, $S)"</span><span class="o">,</span> <span class="no">UTILS</span><span class="o">,</span>
                <span class="n">bindings</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">,</span> <span class="n">asHumanDescription</span><span class="o">(</span><span class="n">requiredViewBindings</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">addFieldBindings</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">bindings</span><span class="o">);</span>
    <span class="n">addMethodBindings</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">bindings</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addFieldBindings</span><span class="o">(</span><span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ViewBindings</span> <span class="n">bindings</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">FieldViewBinding</span> <span class="n">fieldBinding</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getFieldBinding</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fieldBinding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">requiresCast</span><span class="o">(</span><span class="n">fieldBinding</span><span class="o">.</span><span class="na">getType</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"target.$L = $T.castView(view, $L, $S, $T.class)"</span><span class="o">,</span>
                    <span class="n">fieldBinding</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="no">UTILS</span><span class="o">,</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">code</span><span class="o">,</span>
                    <span class="n">asHumanDescription</span><span class="o">(</span><span class="n">singletonList</span><span class="o">(</span><span class="n">fieldBinding</span><span class="o">)),</span> <span class="n">fieldBinding</span><span class="o">.</span><span class="na">getRawType</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"target.$L = view"</span><span class="o">,</span> <span class="n">fieldBinding</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre><td class="rouge-code"><pre> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addMethodBindings</span><span class="o">(</span><span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">result</span><span class="o">,</span> <span class="nc">ViewBindings</span> <span class="n">bindings</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerClass</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerMethod</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodViewBinding</span><span class="o">&gt;&gt;&gt;</span> <span class="n">classMethodBindings</span> <span class="o">=</span>
            <span class="n">bindings</span><span class="o">.</span><span class="na">getMethodBindings</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">classMethodBindings</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// We only need to emit the null check if there are zero required bindings.</span>
    <span class="kt">boolean</span> <span class="n">needsNullChecked</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getRequiredBindings</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">needsNullChecked</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">beginControlFlow</span><span class="o">(</span><span class="s">"if (view != null)"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Add the view reference to the binding.</span>
    <span class="nc">String</span> <span class="n">fieldName</span> <span class="o">=</span> <span class="s">"viewSource"</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">bindName</span> <span class="o">=</span> <span class="s">"source"</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">bindings</span><span class="o">.</span><span class="na">isBoundToRoot</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">fieldName</span> <span class="o">=</span> <span class="s">"view"</span> <span class="o">+</span> <span class="n">bindings</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">value</span><span class="o">;</span>
        <span class="n">bindName</span> <span class="o">=</span> <span class="s">"view"</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L = $N"</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">bindName</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">ListenerClass</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerMethod</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodViewBinding</span><span class="o">&gt;&gt;&gt;</span> <span class="n">e</span>
            <span class="o">:</span> <span class="n">classMethodBindings</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">ListenerClass</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ListenerMethod</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodViewBinding</span><span class="o">&gt;&gt;</span> <span class="n">methodBindings</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>

        <span class="nc">TypeSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">callback</span> <span class="o">=</span> <span class="nc">TypeSpec</span><span class="o">.</span><span class="na">anonymousClassBuilder</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
                <span class="o">.</span><span class="na">superclass</span><span class="o">(</span><span class="nc">ClassName</span><span class="o">.</span><span class="na">bestGuess</span><span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">type</span><span class="o">()));</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">ListenerMethod</span> <span class="n">method</span> <span class="o">:</span> <span class="n">getListenerMethods</span><span class="o">(</span><span class="n">listener</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">MethodSpec</span><span class="o">.</span><span class="na">Builder</span> <span class="n">callbackMethod</span> <span class="o">=</span> <span class="nc">MethodSpec</span><span class="o">.</span><span class="na">methodBuilder</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">addAnnotation</span><span class="o">(</span><span class="nc">Override</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addModifiers</span><span class="o">(</span><span class="no">PUBLIC</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">returns</span><span class="o">(</span><span class="n">bestGuess</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">returnType</span><span class="o">()));</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">callbackMethod</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="n">bestGuess</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]),</span> <span class="s">"p"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kt">boolean</span> <span class="n">hasReturnType</span> <span class="o">=</span> <span class="o">!</span><span class="s">"void"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">returnType</span><span class="o">());</span>
            <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">CodeBlock</span><span class="o">.</span><span class="na">builder</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hasReturnType</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"return "</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">methodBindings</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">MethodViewBinding</span> <span class="n">binding</span> <span class="o">:</span> <span class="n">methodBindings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"target.$L("</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Parameter</span><span class="o">&gt;</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
                    <span class="nc">String</span><span class="o">[]</span> <span class="n">listenerParameters</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">parameters</span><span class="o">();</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">", "</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="nc">Parameter</span> <span class="n">parameter</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                        <span class="kt">int</span> <span class="n">listenerPosition</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="na">getListenerPosition</span><span class="o">();</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">parameter</span><span class="o">.</span><span class="na">requiresCast</span><span class="o">(</span><span class="n">listenerParameters</span><span class="o">[</span><span class="n">listenerPosition</span><span class="o">]))</span> <span class="o">{</span>
                            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"$T.&lt;$T&gt;castParam(p$L, $S, $L, $S, $L)"</span><span class="o">,</span> <span class="no">UTILS</span><span class="o">,</span> <span class="n">parameter</span><span class="o">.</span><span class="na">getType</span><span class="o">(),</span>
                                    <span class="n">listenerPosition</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="n">listenerPosition</span><span class="o">,</span> <span class="n">binding</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">i</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"p$L"</span><span class="o">,</span> <span class="n">listenerPosition</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">");\n"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">hasReturnType</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"$L;\n"</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">defaultReturn</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="n">callbackMethod</span><span class="o">.</span><span class="na">addCode</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
            <span class="n">callback</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">callbackMethod</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">requiresRemoval</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="na">remover</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">listenerField</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">requiresRemoval</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TypeName</span> <span class="n">listenerClassName</span> <span class="o">=</span> <span class="n">bestGuess</span><span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">type</span><span class="o">());</span>
            <span class="n">listenerField</span> <span class="o">=</span> <span class="n">fieldName</span> <span class="o">+</span> <span class="o">((</span><span class="nc">ClassName</span><span class="o">)</span> <span class="n">listenerClassName</span><span class="o">).</span><span class="na">simpleName</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$L = $L"</span><span class="o">,</span> <span class="n">listenerField</span><span class="o">,</span> <span class="n">callback</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="no">VIEW_TYPE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">targetType</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"(($T) $N).$L($L)"</span><span class="o">,</span> <span class="n">bestGuess</span><span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">targetType</span><span class="o">()),</span> <span class="n">bindName</span><span class="o">,</span>
                    <span class="n">listener</span><span class="o">.</span><span class="na">setter</span><span class="o">(),</span> <span class="n">requiresRemoval</span> <span class="o">?</span> <span class="n">listenerField</span> <span class="o">:</span> <span class="n">callback</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">addStatement</span><span class="o">(</span><span class="s">"$N.$L($L)"</span><span class="o">,</span> <span class="n">bindName</span><span class="o">,</span> <span class="n">listener</span><span class="o">.</span><span class="na">setter</span><span class="o">(),</span>
                    <span class="n">requiresRemoval</span> <span class="o">?</span> <span class="n">listenerField</span> <span class="o">:</span> <span class="n">callback</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">needsNullChecked</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">endControlFlow</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="调用辅助方法">调用辅助方法</h4><p>我们在类中通过调用ButterKnife的bind方法来调用辅助类的。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="nd">@NonNull</span> <span class="nd">@UiThread</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">bind</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">View</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">createBinding</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Unbinder</span> <span class="nf">createBinding</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">View</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Looking up binding for "</span> <span class="o">+</span> <span class="n">targetClass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">findBindingConstructorForClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">constructor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Unbinder</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to invoke "</span> <span class="o">+</span> <span class="n">constructor</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to invoke "</span> <span class="o">+</span> <span class="n">constructor</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="nc">RuntimeException</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="o">(</span><span class="nc">RuntimeException</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="nc">Error</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="o">(</span><span class="nc">Error</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to create binding instance."</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
 <span class="nd">@Nullable</span> <span class="nd">@CheckResult</span> <span class="nd">@UiThread</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="nf">findBindingConstructorForClass</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;</span> <span class="n">bindingCtor</span> <span class="o">=</span> <span class="no">BINDINGS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bindingCtor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"HIT: Cached in binding map."</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">bindingCtor</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">String</span> <span class="n">clsName</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">clsName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"android."</span><span class="o">)</span> <span class="o">||</span> <span class="n">clsName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"java."</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"MISS: Reached framework class. Abandoning search."</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">bindingClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">clsName</span> <span class="o">+</span> <span class="s">"_ViewBinding"</span><span class="o">);</span>
      <span class="c1">//noinspection unchecked</span>
      <span class="n">bindingCtor</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Unbinder</span><span class="o">&gt;)</span> <span class="n">bindingClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span> <span class="nc">View</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"HIT: Loaded binding class and constructor."</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">debug</span><span class="o">)</span> <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Not found. Trying superclass "</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">bindingCtor</span> <span class="o">=</span> <span class="n">findBindingConstructorForClass</span><span class="o">(</span><span class="n">cls</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Unable to find binding constructor for "</span> <span class="o">+</span> <span class="n">clsName</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="no">BINDINGS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cls</span><span class="o">,</span> <span class="n">bindingCtor</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">bindingCtor</span><span class="o">;</span>
  <span class="o">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-tag no-text-decoration" >源码分析</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=ButterKnife源码分析 - malinkang&url=https://malinkang.cn/posts/butterknife-source-analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=ButterKnife源码分析 - malinkang&u=https://malinkang.cn/posts/butterknife-source-analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=ButterKnife源码分析 - malinkang&url=https://malinkang.cn/posts/butterknife-source-analysis/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dagger-guide/">Dagger使用指南</a><li><a href="/posts/understanding-the-jvm-runtime-data-areas/">《深入理解JVM》第2章Java内存区域与内存溢出异常</a><li><a href="/posts/understanding-the-jvm-garbage-collection/">《深入理解JVM》第3章垃圾收集器</a><li><a href="/posts/understanding-the-jvm-class-file-structure/">《深入理解JVM》第6章类文件结构</a><li><a href="/posts/understanding-the-jvm-class-loader/">《深入理解JVM》第7章虚拟机类加载机制</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/arouter-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 24, 2020 <i class="unloaded">2020-11-24T19:14:29+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ARouter源码分析</h3><div class="text-muted small"><p> ARouter原理如下 编译期，会扫描@Route注解，将注解里的信息封装成一个RouteMeta对象。并生成一个辅助类ARouter$$Group$$groupName，groupName即分组的名字，这也意味着同一个group只会生成一个辅助类。该类继承自IRouteGroup，有一个loadInto()方法。在运行时，调用loadInto()方法，将@Route中的path作为k...</p></div></div></a></div><div class="card"> <a href="/posts/okhttp-source-analysis/"><div class="card-body"> <span class="timeago small" > Nov 26, 2020 <i class="unloaded">2020-11-26T04:01:47+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Okhttp源码分析</h3><div class="text-muted small"><p> Okhttp基本流程分析 基本流程 创建RequestBody 创建Request 创建OkhttpClient 调用newCall创建Call对象 执行异步或同步操作。 创建Socket连接 发送请求并处理返回结果 创建RequestBody RequestBody主要通过writeTo方法将请求内容写入到BufferedSink。RequestBo...</p></div></div></a></div><div class="card"> <a href="/posts/retrofit-source-analysis/"><div class="card-body"> <span class="timeago small" > Jul 26, 2017 <i class="unloaded">2017-07-26T04:07:22+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Retrofit源码分析</h3><div class="text-muted small"><p> Retrofit源码分析 流程分析 Retrofit执行流程可以分为两部分： 创建ServiceMethod。 调用ServiceMethod的invoke()。 下图中，黑线部分是创建ServiceMethod的过程，红线部分是invoke()的调用过程。 ServiceMethod创建过程： 通过动态代理，获取到我们定义的接口里的所有Method，调用S...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/rxjava-source-analysis/" class="btn btn-outline-primary" prompt="Older"><p>RxJava源码分析</p></a> <a href="/posts/workmanager-source-analysis/" class="btn btn-outline-primary" prompt="Newer"><p>WorkManager源码分析</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//malinkang-cn.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'ButterKnife源码分析'; this.page.url = 'https://malinkang.cn/posts/butterknife-source-analysis/'; this.page.identifier = '/posts/butterknife-source-analysis/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/malinkang">malinkang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a> <a class="post-tag" href="/tags/thinking-in-java/">Thinking in Java</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/effective-java/">Effective Java</a> <a class="post-tag" href="/tags/kotlin/">Kotlin</a> <a class="post-tag" href="/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/">Java并发编程实战</a> <a class="post-tag" href="/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/">深入理解JVM</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/databinding/">databinding</a> <a class="post-tag" href="/tags/recyclerview/">RecyclerView</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://malinkang.cn{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
