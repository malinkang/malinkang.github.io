<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Glide源码分析 - 人生最可悲的事情，莫过于胸怀大志，却又虚度光阴。</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="malinkang" /><meta name="description" content="Glide源码分析 Glide的使用非常简单只需要调用with、load into三个方法。 1 2 3 GlideApp.with(this) .load(url) .into(imageView); 接下来，我们依次分析这三个方法。 with() 1 2 3" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.80.0 with theme even" />


<link rel="canonical" href="https://malinkang.cn/post/glide-source-analysis/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c12ac5d6e912b28ec1fcd71d47773cc8112a03296d4ff03660135b54f0923299.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Glide源码分析" />
<meta property="og:description" content="Glide源码分析 Glide的使用非常简单只需要调用with、load into三个方法。 1 2 3 GlideApp.with(this) .load(url) .into(imageView); 接下来，我们依次分析这三个方法。 with() 1 2 3" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://malinkang.cn/post/glide-source-analysis/" />
<meta property="article:published_time" content="2020-11-25T20:07:31+00:00" />
<meta property="article:modified_time" content="2020-11-25T20:07:31+00:00" />
<meta itemprop="name" content="Glide源码分析">
<meta itemprop="description" content="Glide源码分析 Glide的使用非常简单只需要调用with、load into三个方法。 1 2 3 GlideApp.with(this) .load(url) .into(imageView); 接下来，我们依次分析这三个方法。 with() 1 2 3">
<meta itemprop="datePublished" content="2020-11-25T20:07:31+00:00" />
<meta itemprop="dateModified" content="2020-11-25T20:07:31+00:00" />
<meta itemprop="wordCount" content="6276">



<meta itemprop="keywords" content="源码分析," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Glide源码分析"/>
<meta name="twitter:description" content="Glide源码分析 Glide的使用非常简单只需要调用with、load into三个方法。 1 2 3 GlideApp.with(this) .load(url) .into(imageView); 接下来，我们依次分析这三个方法。 with() 1 2 3"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Malinkang&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Malinkang&#39;s Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Glide源码分析</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-11-25 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#with">with()</a>
      <ul>
        <li><a href="#get">get()</a></li>
        <li><a href="#apiglidemodule">ApiGlideModule</a></li>
        <li><a href="#checkandinitializeglide">checkAndInitializeGlide()</a></li>
        <li><a href="#initializeglide">initializeGlide()</a></li>
        <li><a href="#glidebuilder">GlideBuilder</a></li>
        <li><a href="#glideexecutor">GlideExecutor</a></li>
        <li><a href="#memorysizecalculator">MemorySizeCalculator</a></li>
        <li><a href="#磁盘缓存">磁盘缓存</a></li>
        <li><a href="#get-1">get()</a></li>
        <li><a href="#lifecycle">Lifecycle</a></li>
        <li><a href="#lifecyclelistener">LifecycleListener</a></li>
        <li><a href="#requestmanager">RequestManager</a></li>
      </ul>
    </li>
    <li><a href="#load">load()</a>
      <ul>
        <li><a href="#requestbuilder">RequestBuilder</a></li>
      </ul>
    </li>
    <li><a href="#into">into()</a>
      <ul>
        <li><a href="#obtainrequest">obtainRequest()</a></li>
        <li><a href="#request">Request</a></li>
        <li><a href="#缓存过程">缓存过程</a></li>
        <li><a href="#modelloader">ModelLoader</a></li>
        <li><a href="#getloaddata">getLoadData()</a></li>
        <li><a href="#getmodelloaders">getModelLoaders()</a></li>
        <li><a href="#加载到内存的图片大小">加载到内存的图片大小</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="glide源码分析">Glide源码分析</h1>
<p><code>Glide</code>的使用非常简单只需要调用<code>with</code>、<code>load</code> <code>into</code>三个方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">GlideApp</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
        <span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
        <span class="o">.</span><span class="na">into</span><span class="o">(</span><span class="n">imageView</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>接下来，我们依次分析这三个方法。</p>
<h2 id="with">with()</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//Glide.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">RequestManager</span> <span class="nf">with</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//先获取RequestManagerRetriever对象
</span><span class="c1"></span>  <span class="c1">//调用RequestManagerRetriever的get方法获取RequestManager
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">getRetriever</span><span class="o">(</span><span class="n">activity</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span> 
<span class="o">}</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="n">RequestManagerRetriever</span> <span class="nf">getRetriever</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// Context could be null for other reasons (ie the user passes in null), but in practice it will
</span><span class="c1"></span>  <span class="c1">// only occur due to errors with the Fragment lifecycle.
</span><span class="c1"></span>  <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span>
      <span class="n">context</span><span class="o">,</span>
      <span class="s">&#34;You cannot start a load on a not yet attached View or a Fragment where getActivity() &#34;</span>
          <span class="o">+</span> <span class="s">&#34;returns null (which usually occurs when getActivity() is called before the Fragment &#34;</span>
          <span class="o">+</span> <span class="s">&#34;is attached or after the Fragment is destroyed).&#34;</span><span class="o">);</span>
  
  <span class="k">return</span> <span class="n">Glide</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getRequestManagerRetriever</span><span class="o">();</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="get">get()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@NonNull</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Glide</span> <span class="nf">get</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">glide</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取生成的GdlieModule类
</span><span class="c1"></span>    <span class="n">GeneratedAppGlideModule</span> <span class="n">annotationGeneratedModule</span> <span class="o">=</span>
        <span class="n">getAnnotationGeneratedGlideModules</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">());</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Glide</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">glide</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//初始化Glide
</span><span class="c1"></span>        <span class="n">checkAndInitializeGlide</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">annotationGeneratedModule</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">glide</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="apiglidemodule">ApiGlideModule</h3>
<p><code>ApiGlideModule</code>定义了在应用程序中初始化 <code>Glide</code> 时要使用的一系列依赖关系和选项。</p>
<p><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/ApiGlideModule.png" alt="ApiGlideModule"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//GeneratedAppGlideModuleImpl
</span><span class="c1"></span> <span class="nd">@Override</span>
 <span class="nd">@NonNull</span>
 <span class="n">GeneratedRequestManagerFactory</span> <span class="nf">getRequestManagerFactory</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="n">GeneratedRequestManagerFactory</span><span class="o">();</span>
 <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="checkandinitializeglide">checkAndInitializeGlide()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">&#34;Glide.class&#34;</span><span class="o">)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">checkAndInitializeGlide</span><span class="o">(</span>
    <span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">GeneratedAppGlideModule</span> <span class="n">generatedAppGlideModule</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// In the thread running initGlide(), one or more classes may call Glide.get(context).
</span><span class="c1"></span>    <span class="c1">// Without this check, those calls could trigger infinite recursion.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">isInitializing</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
            <span class="s">&#34;You cannot call Glide.get() in registerComponents(),&#34;</span>
                <span class="o">+</span> <span class="s">&#34; use the provided Glide instance instead&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">isInitializing</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">initializeGlide</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">generatedAppGlideModule</span><span class="o">);</span>
    <span class="n">isInitializing</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="initializeglide">initializeGlide()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">initializeGlide</span><span class="o">(</span>
    <span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">GeneratedAppGlideModule</span> <span class="n">generatedAppGlideModule</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">initializeGlide</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">new</span> <span class="n">GlideBuilder</span><span class="o">(),</span> <span class="n">generatedAppGlideModule</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">initializeGlide</span><span class="o">(</span>
    <span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span>
    <span class="nd">@NonNull</span> <span class="n">GlideBuilder</span> <span class="n">builder</span><span class="o">,</span>
    <span class="nd">@Nullable</span> <span class="n">GeneratedAppGlideModule</span> <span class="n">annotationGeneratedModule</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">Context</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">();</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">com</span><span class="o">.</span><span class="na">bumptech</span><span class="o">.</span><span class="na">glide</span><span class="o">.</span><span class="na">module</span><span class="o">.</span><span class="na">GlideModule</span><span class="o">&gt;</span> <span class="n">manifestModules</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">annotationGeneratedModule</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">annotationGeneratedModule</span><span class="o">.</span><span class="na">isManifestParsingEnabled</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">//解析ManifestParser 老的Glide版本需要在清单文件中注册GlideModule
</span><span class="c1"></span>    <span class="n">manifestModules</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManifestParser</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">).</span><span class="na">parse</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">annotationGeneratedModule</span> <span class="o">!=</span> <span class="kc">null</span>
      <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">annotationGeneratedModule</span><span class="o">.</span><span class="na">getExcludedModuleClasses</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">excludedModuleClasses</span> <span class="o">=</span> <span class="n">annotationGeneratedModule</span><span class="o">.</span><span class="na">getExcludedModuleClasses</span><span class="o">();</span>
    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">com</span><span class="o">.</span><span class="na">bumptech</span><span class="o">.</span><span class="na">glide</span><span class="o">.</span><span class="na">module</span><span class="o">.</span><span class="na">GlideModule</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">manifestModules</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">com</span><span class="o">.</span><span class="na">bumptech</span><span class="o">.</span><span class="na">glide</span><span class="o">.</span><span class="na">module</span><span class="o">.</span><span class="na">GlideModule</span> <span class="n">current</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">excludedModuleClasses</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">current</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span> <span class="o">{</span>
        <span class="k">continue</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">//获取RequestManagerFactory即GeneratedRequestManagerFactory
</span><span class="c1"></span>  <span class="n">RequestManagerRetriever</span><span class="o">.</span><span class="na">RequestManagerFactory</span> <span class="n">factory</span> <span class="o">=</span>
      <span class="n">annotationGeneratedModule</span> <span class="o">!=</span> <span class="kc">null</span>
          <span class="o">?</span> <span class="n">annotationGeneratedModule</span><span class="o">.</span><span class="na">getRequestManagerFactory</span><span class="o">()</span>
          <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
  <span class="c1">//为GlideBuilder设置RequestManagerFactory
</span><span class="c1"></span>  <span class="n">builder</span><span class="o">.</span><span class="na">setRequestManagerFactory</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">bumptech</span><span class="o">.</span><span class="na">glide</span><span class="o">.</span><span class="na">module</span><span class="o">.</span><span class="na">GlideModule</span> <span class="n">module</span> <span class="o">:</span> <span class="n">manifestModules</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">module</span><span class="o">.</span><span class="na">applyOptions</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">,</span> <span class="n">builder</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">annotationGeneratedModule</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">annotationGeneratedModule</span><span class="o">.</span><span class="na">applyOptions</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">,</span> <span class="n">builder</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//调用build方法创建Glide对象
</span><span class="c1"></span>  <span class="n">Glide</span> <span class="n">glide</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">);</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">bumptech</span><span class="o">.</span><span class="na">glide</span><span class="o">.</span><span class="na">module</span><span class="o">.</span><span class="na">GlideModule</span> <span class="n">module</span> <span class="o">:</span> <span class="n">manifestModules</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">module</span><span class="o">.</span><span class="na">registerComponents</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">,</span> <span class="n">glide</span><span class="o">,</span> <span class="n">glide</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AbstractMethodError</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
          <span class="s">&#34;Attempting to register a Glide v3 module. If you see this, you or one of your&#34;</span>
              <span class="o">+</span> <span class="s">&#34; dependencies may be including Glide v3 even though you&#39;re using Glide v4.&#34;</span>
              <span class="o">+</span> <span class="s">&#34; You&#39;ll need to find and remove (or update) the offending dependency.&#34;</span>
              <span class="o">+</span> <span class="s">&#34; The v3 module name is: &#34;</span>
              <span class="o">+</span> <span class="n">module</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span>
          <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">annotationGeneratedModule</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">annotationGeneratedModule</span><span class="o">.</span><span class="na">registerComponents</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">,</span> <span class="n">glide</span><span class="o">,</span> <span class="n">glide</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">applicationContext</span><span class="o">.</span><span class="na">registerComponentCallbacks</span><span class="o">(</span><span class="n">glide</span><span class="o">);</span>
  <span class="n">Glide</span><span class="o">.</span><span class="na">glide</span> <span class="o">=</span> <span class="n">glide</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="glidebuilder">GlideBuilder</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@NonNull</span>
  <span class="n">Glide</span> <span class="nf">build</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sourceExecutor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">sourceExecutor</span> <span class="o">=</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">newSourceExecutor</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//执行硬盘缓存的线程池
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">diskCacheExecutor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">diskCacheExecutor</span> <span class="o">=</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">newDiskCacheExecutor</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//动画线程池
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">animationExecutor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">animationExecutor</span> <span class="o">=</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">newAnimationExecutor</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//内存大小计算
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">memorySizeCalculator</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">memorySizeCalculator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemorySizeCalculator</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//创建默认连接监听工厂
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">connectivityMonitorFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">connectivityMonitorFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultConnectivityMonitorFactory</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//除了ArrayPool之外每个缓存都有两个版本。
</span><span class="c1"></span>    <span class="c1">//LruBitmapPool BitmapPoolAdapter
</span><span class="c1"></span>    <span class="c1">//LruResourceCache MemoryCacheAdapter
</span><span class="c1"></span>    <span class="c1">//DiskLruCacheWrapper DiskCacheAdapter
</span><span class="c1"></span>    <span class="c1">//当内存不足的时候调用XXAdapter，put方法里什么也不做
</span><span class="c1"></span>    <span class="c1">// 正常调用LruXX
</span><span class="c1"></span>    <span class="c1">//BitmapPool
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">bitmapPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memorySizeCalculator</span><span class="o">.</span><span class="na">getBitmapPoolSize</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bitmapPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LruBitmapPool</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">bitmapPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BitmapPoolAdapter</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//ArrayPool
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">arrayPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">arrayPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LruArrayPool</span><span class="o">(</span><span class="n">memorySizeCalculator</span><span class="o">.</span><span class="na">getArrayPoolSizeInBytes</span><span class="o">());</span>
    <span class="o">}</span>
   <span class="c1">//MemoryCache
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">memoryCache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">memoryCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LruResourceCache</span><span class="o">(</span><span class="n">memorySizeCalculator</span><span class="o">.</span><span class="na">getMemoryCacheSize</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">//DiskCacheFactory
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">diskCacheFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">diskCacheFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InternalCacheDiskCacheFactory</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//创建Engine
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">engine</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">engine</span> <span class="o">=</span>
          <span class="k">new</span> <span class="n">Engine</span><span class="o">(</span>
              <span class="n">memoryCache</span><span class="o">,</span>
              <span class="n">diskCacheFactory</span><span class="o">,</span>
              <span class="n">diskCacheExecutor</span><span class="o">,</span>
              <span class="n">sourceExecutor</span><span class="o">,</span>
              <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">newUnlimitedSourceExecutor</span><span class="o">(),</span><span class="c1">//无限制缓存池
</span><span class="c1"></span>              <span class="n">animationExecutor</span><span class="o">,</span>
              <span class="n">isActiveResourceRetentionAllowed</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">defaultRequestListeners</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">defaultRequestListeners</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">defaultRequestListeners</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">defaultRequestListeners</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//创建RequestManagerRetriever
</span><span class="c1"></span>    <span class="n">RequestManagerRetriever</span> <span class="n">requestManagerRetriever</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">RequestManagerRetriever</span><span class="o">(</span>
            <span class="n">requestManagerFactory</span><span class="o">,</span> <span class="n">waitForFirstFrameBeforeEnablingHardwareBitmaps</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="n">blockHardwareBitmaps</span> <span class="o">=</span>
        <span class="n">waitForFirstFrameBeforeEnablingHardwareBitmaps</span> <span class="o">||</span> <span class="n">waitForCallBeforeEnablingHardwareBitmaps</span><span class="o">;</span>
    <span class="c1">//调用Glide构造函数创建Glide对象
</span><span class="c1"></span>    <span class="k">return</span> <span class="k">new</span> <span class="n">Glide</span><span class="o">(</span>
        <span class="n">context</span><span class="o">,</span>
        <span class="n">engine</span><span class="o">,</span>
        <span class="n">memoryCache</span><span class="o">,</span>
        <span class="n">bitmapPool</span><span class="o">,</span>
        <span class="n">arrayPool</span><span class="o">,</span>
        <span class="n">requestManagerRetriever</span><span class="o">,</span>
        <span class="n">connectivityMonitorFactory</span><span class="o">,</span>
        <span class="n">logLevel</span><span class="o">,</span>
        <span class="n">defaultRequestOptionsFactory</span><span class="o">,</span>
        <span class="n">defaultTransitionOptions</span><span class="o">,</span>
        <span class="n">defaultRequestListeners</span><span class="o">,</span>
        <span class="n">isLoggingRequestOriginsEnabled</span><span class="o">,</span>
        <span class="n">isImageDecoderEnabledForBitmaps</span><span class="o">,</span>
        <span class="n">blockHardwareBitmaps</span><span class="o">,</span>
        <span class="n">manualOverrideHardwareBitmapMaxFdCount</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="glideexecutor">GlideExecutor</h3>
<p>在<code>build()</code>中一共创建了4个线程池</p>
<p><code>newDiskCacheExecutor()</code>创建磁盘缓存的线程池</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_DISK_CACHE_EXECUTOR_THREADS</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">GlideExecutor</span> <span class="nf">newDiskCacheExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">newDiskCacheBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">newDiskCacheBuilder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="cm">/*preventNetworkOperations=*/</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setThreadCount</span><span class="o">(</span><span class="n">DEFAULT_DISK_CACHE_EXECUTOR_THREADS</span><span class="o">)</span> <span class="c1">//线程数1
</span><span class="c1"></span>        <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">DEFAULT_DISK_CACHE_EXECUTOR_NAME</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其余三个线程池都是负责下载和解码的<code>newAnimationBuilder</code>是用来处理gif的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GlideExecutor</span> <span class="kd">implements</span> <span class="n">ExecutorService</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAXIMUM_AUTOMATIC_THREAD_COUNT</span> <span class="o">=</span> <span class="n">4</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">GlideExecutor</span> <span class="nf">newSourceExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">newSourceBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">newSourceBuilder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="cm">/*preventNetworkOperations=*/</span> <span class="kc">false</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setThreadCount</span><span class="o">(</span><span class="n">calculateBestThreadCount</span><span class="o">())</span>
        <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">DEFAULT_SOURCE_EXECUTOR_NAME</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//计算最佳的线程数量
</span><span class="c1"></span>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">calculateBestThreadCount</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bestThreadCount</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//cpu内核数量和4取最小值
</span><span class="c1"></span>      <span class="n">bestThreadCount</span> <span class="o">=</span>
          <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">MAXIMUM_AUTOMATIC_THREAD_COUNT</span><span class="o">,</span> <span class="n">RuntimeCompat</span><span class="o">.</span><span class="na">availableProcessors</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">bestThreadCount</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">public</span> <span class="kd">static</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">newAnimationBuilder</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">bestThreadCount</span> <span class="o">=</span> <span class="n">calculateBestThreadCount</span><span class="o">();</span>
    <span class="c1">// We don&#39;t want to add a ton of threads running animations in parallel with our source and
</span><span class="c1"></span>    <span class="c1">// disk cache executors. Doing so adds unnecessary CPU load and can also dramatically increase
</span><span class="c1"></span>    <span class="c1">// our maximum memory usage. Typically one thread is sufficient here, but for higher end devices
</span><span class="c1"></span>    <span class="c1">// with more cores, two threads can provide better performance if lots of GIFs are showing at
</span><span class="c1"></span>    <span class="c1">// once.
</span><span class="c1"></span>    <span class="c1">//我们不希望增加大量线程来并行运行动画，我们的源代码和磁盘缓存执行器。
</span><span class="c1"></span>    <span class="c1">//这样做增加了不必要的CPU负载，也会大大增加了我们的最大内存使用量。
</span><span class="c1"></span>    <span class="c1">//通常情况下，一个线程就足够了，但对于更高端的设备来说。
</span><span class="c1"></span>    <span class="c1">//如果有更多的核心，两个线程可以提供更好的性能，如果大量的GIF显示一次。
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">maximumPoolSize</span> <span class="o">=</span> <span class="n">bestThreadCount</span> <span class="o">&gt;=</span> <span class="n">4</span> <span class="o">?</span> <span class="n">2</span> <span class="o">:</span> <span class="n">1</span><span class="o">;</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">GlideExecutor</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="cm">/*preventNetworkOperations=*/</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setThreadCount</span><span class="o">(</span><span class="n">maximumPoolSize</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">DEFAULT_ANIMATION_EXECUTOR_NAME</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/** Shortcut for calling {@link Builder#build()} on {@link #newAnimationBuilder()}. */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">GlideExecutor</span> <span class="nf">newAnimationExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">newAnimationBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">public</span> <span class="kd">static</span> <span class="n">GlideExecutor</span> <span class="nf">newUnlimitedSourceExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">GlideExecutor</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span>
            <span class="n">0</span><span class="o">,</span>
            <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
            <span class="n">KEEP_ALIVE_TIME_MS</span><span class="o">,</span>
            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
            <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;(),</span>
            <span class="k">new</span> <span class="n">DefaultThreadFactory</span><span class="o">(</span>
                <span class="n">DEFAULT_SOURCE_UNLIMITED_EXECUTOR_NAME</span><span class="o">,</span> <span class="n">UncaughtThrowableStrategy</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">,</span> <span class="kc">false</span><span class="o">)));</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这三个线程池选用哪个呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="c1">//EngineJob.java
</span><span class="c1"></span>  <span class="kd">private</span> <span class="n">GlideExecutor</span> <span class="nf">getActiveSourceExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">useUnlimitedSourceGeneratorPool</span>
        <span class="o">?</span> <span class="n">sourceUnlimitedExecutor</span>
        <span class="o">:</span> <span class="o">(</span><span class="n">useAnimationPool</span> <span class="o">?</span> <span class="n">animationExecutor</span> <span class="o">:</span> <span class="n">sourceExecutor</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>useUnlimitedSourceGeneratorsPool</code>和<code>useAnimationPool</code>可以通过<code>BaseRequestOptions</code>进行配置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">useUnlimitedSourceGeneratorsPool</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">useAnimationPool</span><span class="o">;</span>
  <span class="nd">@NonNull</span>
  <span class="nd">@CheckResult</span>
  <span class="kd">public</span> <span class="n">T</span> <span class="nf">useAnimationPool</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">flag</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isAutoCloneEnabled</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">clone</span><span class="o">().</span><span class="na">useAnimationPool</span><span class="o">(</span><span class="n">flag</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">useAnimationPool</span> <span class="o">=</span> <span class="n">flag</span><span class="o">;</span>
    <span class="n">fields</span> <span class="o">|=</span> <span class="n">USE_ANIMATION_POOL</span><span class="o">;</span>

    <span class="k">return</span> <span class="n">selfOrThrowIfLocked</span><span class="o">();</span>
  <span class="o">}</span>
  
</code></pre></td></tr></table>
</div>
</div><p><code>useAnimationPool</code>默认不需要配置。系统默认会在处理gif的时候设置为true。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="c1">//GifFrameLoader.java
</span><span class="c1"></span>  <span class="kd">private</span> <span class="kd">static</span> <span class="n">RequestBuilder</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;</span> <span class="nf">getRequestBuilder</span><span class="o">(</span>
      <span class="n">RequestManager</span> <span class="n">requestManager</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">requestManager</span>
        <span class="o">.</span><span class="na">asBitmap</span><span class="o">()</span>
        <span class="o">.</span><span class="na">apply</span><span class="o">(</span>
            <span class="n">diskCacheStrategyOf</span><span class="o">(</span><span class="n">DiskCacheStrategy</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span>
                <span class="o">.</span><span class="na">useAnimationPool</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">skipMemoryCache</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">override</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">));</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="memorysizecalculator">MemorySizeCalculator</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="o">{</span>
    <span class="nd">@VisibleForTesting</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MEMORY_CACHE_TARGET_SCREENS</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * On Android O+, we use {@link android.graphics.Bitmap.Config#HARDWARE} for all reasonably
</span><span class="cm">     * sized images unless we&#39;re creating thumbnails for the first time. As a result, the Bitmap
</span><span class="cm">     * pool is much less important on O than it was on previous versions.
</span><span class="cm">     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">BITMAP_POOL_TARGET_SCREENS</span> <span class="o">=</span>
        <span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&lt;</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">O</span> <span class="o">?</span> <span class="n">4</span> <span class="o">:</span> <span class="n">1</span><span class="o">;</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="n">MAX_SIZE_MULTIPLIER</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">4f</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="n">LOW_MEMORY_MAX_SIZE_MULTIPLIER</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">33f</span><span class="o">;</span>
    <span class="c1">// 4MB.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ARRAY_POOL_SIZE_BYTES</span> <span class="o">=</span> <span class="n">4</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span><span class="o">;</span>

    <span class="nd">@Synthetic</span> <span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">;</span>

    <span class="c1">// Modifiable (non-final) for testing.
</span><span class="c1"></span>    <span class="nd">@Synthetic</span> <span class="n">ActivityManager</span> <span class="n">activityManager</span><span class="o">;</span>
    <span class="nd">@Synthetic</span> <span class="n">ScreenDimensions</span> <span class="n">screenDimensions</span><span class="o">;</span>

    <span class="nd">@Synthetic</span> <span class="kt">float</span> <span class="n">memoryCacheScreens</span> <span class="o">=</span> <span class="n">MEMORY_CACHE_TARGET_SCREENS</span><span class="o">;</span>
    <span class="nd">@Synthetic</span> <span class="kt">float</span> <span class="n">bitmapPoolScreens</span> <span class="o">=</span> <span class="n">BITMAP_POOL_TARGET_SCREENS</span><span class="o">;</span>
    <span class="nd">@Synthetic</span> <span class="kt">float</span> <span class="n">maxSizeMultiplier</span> <span class="o">=</span> <span class="n">MAX_SIZE_MULTIPLIER</span><span class="o">;</span>
    <span class="nd">@Synthetic</span> <span class="kt">float</span> <span class="n">lowMemoryMaxSizeMultiplier</span> <span class="o">=</span> <span class="n">LOW_MEMORY_MAX_SIZE_MULTIPLIER</span><span class="o">;</span>
    <span class="nd">@Synthetic</span> <span class="kt">int</span> <span class="n">arrayPoolSizeBytes</span> <span class="o">=</span> <span class="n">ARRAY_POOL_SIZE_BYTES</span><span class="o">;</span>
 <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Package private to avoid PMD warning.
</span><span class="c1"></span>  <span class="n">MemorySizeCalculator</span><span class="o">(</span><span class="n">MemorySizeCalculator</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">context</span><span class="o">;</span>
    <span class="c1">//4M 低内存设备2M
</span><span class="c1"></span>    <span class="n">arrayPoolSize</span> <span class="o">=</span>
        <span class="n">isLowMemoryDevice</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">activityManager</span><span class="o">)</span>
            <span class="o">?</span> <span class="n">builder</span><span class="o">.</span><span class="na">arrayPoolSizeBytes</span> <span class="o">/</span> <span class="n">LOW_MEMORY_BYTE_ARRAY_POOL_DIVISOR</span>
            <span class="o">:</span> <span class="n">builder</span><span class="o">.</span><span class="na">arrayPoolSizeBytes</span><span class="o">;</span>
    <span class="c1">//计算最大大小
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">maxSize</span> <span class="o">=</span>
        <span class="n">getMaxSize</span><span class="o">(</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">activityManager</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">maxSizeMultiplier</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">lowMemoryMaxSizeMultiplier</span><span class="o">);</span>

    <span class="kt">int</span> <span class="n">widthPixels</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">screenDimensions</span><span class="o">.</span><span class="na">getWidthPixels</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">heightPixels</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">screenDimensions</span><span class="o">.</span><span class="na">getHeightPixels</span><span class="o">();</span>
    <span class="c1">//计算一张格式为 ARGB_8888 ，大小为屏幕大小的图片的占用内存大小
</span><span class="c1"></span>    <span class="c1">//BYTES_PER_ARGB_8888_PIXEL 值为 4
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">screenSize</span> <span class="o">=</span> <span class="n">widthPixels</span> <span class="o">*</span> <span class="n">heightPixels</span> <span class="o">*</span> <span class="n">BYTES_PER_ARGB_8888_PIXEL</span><span class="o">;</span>
    <span class="c1">//BitmapPool大小
</span><span class="c1"></span>    <span class="c1">//BitmapPool和MemoryCache的大小依赖当前屏幕分辨率
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">targetBitmapPoolSize</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">screenSize</span> <span class="o">*</span> <span class="n">builder</span><span class="o">.</span><span class="na">bitmapPoolScreens</span><span class="o">);</span>
    <span class="c1">//MemoryCache大小 
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">targetMemoryCacheSize</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">screenSize</span> <span class="o">*</span> <span class="n">builder</span><span class="o">.</span><span class="na">memoryCacheScreens</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">availableSize</span> <span class="o">=</span> <span class="n">maxSize</span> <span class="o">-</span> <span class="n">arrayPoolSize</span><span class="o">;</span>
    <span class="c1">//小于可用大小 按照计算的值分配
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">targetMemoryCacheSize</span> <span class="o">+</span> <span class="n">targetBitmapPoolSize</span> <span class="o">&lt;=</span> <span class="n">availableSize</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">memoryCacheSize</span> <span class="o">=</span> <span class="n">targetMemoryCacheSize</span><span class="o">;</span>
      <span class="n">bitmapPoolSize</span> <span class="o">=</span> <span class="n">targetBitmapPoolSize</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">//将可用的分配
</span><span class="c1"></span>      <span class="kt">float</span> <span class="n">part</span> <span class="o">=</span> <span class="n">availableSize</span> <span class="o">/</span> <span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">bitmapPoolScreens</span> <span class="o">+</span> <span class="n">builder</span><span class="o">.</span><span class="na">memoryCacheScreens</span><span class="o">);</span>
      <span class="n">memoryCacheSize</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">part</span> <span class="o">*</span> <span class="n">builder</span><span class="o">.</span><span class="na">memoryCacheScreens</span><span class="o">);</span>
      <span class="n">bitmapPoolSize</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">part</span> <span class="o">*</span> <span class="n">builder</span><span class="o">.</span><span class="na">bitmapPoolScreens</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getMaxSize</span><span class="o">(</span>
      <span class="n">ActivityManager</span> <span class="n">activityManager</span><span class="o">,</span> <span class="kt">float</span> <span class="n">maxSizeMultiplier</span><span class="o">,</span> <span class="kt">float</span> <span class="n">lowMemoryMaxSizeMultiplier</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">memoryClassBytes</span> <span class="o">=</span> <span class="n">activityManager</span><span class="o">.</span><span class="na">getMemoryClass</span><span class="o">()</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isLowMemoryDevice</span> <span class="o">=</span> <span class="n">isLowMemoryDevice</span><span class="o">(</span><span class="n">activityManager</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span>
        <span class="n">memoryClassBytes</span> <span class="o">*</span> <span class="o">(</span><span class="n">isLowMemoryDevice</span> <span class="o">?</span> <span class="n">lowMemoryMaxSizeMultiplier</span> <span class="o">:</span> <span class="n">maxSizeMultiplier</span><span class="o">));</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="磁盘缓存">磁盘缓存</h3>
<p><img src="/Users/malinkang/Downloads/DiskCache.png" alt="DiskCache类图"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">InternalCacheDiskCacheFactory</span> <span class="kd">extends</span> <span class="n">DiskLruCacheFactory</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nf">InternalCacheDiskCacheFactory</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span>
        <span class="n">context</span><span class="o">,</span>
        <span class="n">DiskCache</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">DEFAULT_DISK_CACHE_DIR</span><span class="o">,</span>
        <span class="n">DiskCache</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">DEFAULT_DISK_CACHE_SIZE</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">InternalCacheDiskCacheFactory</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">long</span> <span class="n">diskCacheSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">DiskCache</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">DEFAULT_DISK_CACHE_DIR</span><span class="o">,</span> <span class="n">diskCacheSize</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">InternalCacheDiskCacheFactory</span><span class="o">(</span>
      <span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">diskCacheName</span><span class="o">,</span> <span class="kt">long</span> <span class="n">diskCacheSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">CacheDirectoryGetter</span><span class="o">()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="n">File</span> <span class="nf">getCacheDirectory</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">File</span> <span class="n">cacheDirectory</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getCacheDir</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cacheDirectory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">diskCacheName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">return</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">cacheDirectory</span><span class="o">,</span> <span class="n">diskCacheName</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">cacheDirectory</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">},</span>
        <span class="n">diskCacheSize</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">Factory</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">DEFAULT_DISK_CACHE_SIZE</span> <span class="o">=</span> <span class="n">250</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span><span class="o">;</span><span class="c1">//默认250M
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">DEFAULT_DISK_CACHE_DIR</span> <span class="o">=</span> <span class="s">&#34;image_manager_disk_cache&#34;</span><span class="o">;</span> <span class="c1">//默认存储文件夹
</span><span class="c1"></span>    <span class="nd">@Nullable</span>
    <span class="n">DiskCache</span> <span class="nf">build</span><span class="o">();</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="get-1">get()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@NonNull</span>
  <span class="kd">public</span> <span class="n">RequestManager</span> <span class="nf">get</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取RequestManager
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">Util</span><span class="o">.</span><span class="na">isOnBackgroundThread</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">get</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="k">instanceof</span> <span class="n">FragmentActivity</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">get</span><span class="o">((</span><span class="n">FragmentActivity</span><span class="o">)</span> <span class="n">activity</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">assertNotDestroyed</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
      <span class="n">maybeRegisterFirstFrameWaiter</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
      <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">FragmentManager</span> <span class="n">fm</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="na">getFragmentManager</span><span class="o">();</span>
      <span class="k">return</span> <span class="n">fragmentGet</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="n">fm</span><span class="o">,</span> <span class="cm">/*parentHint=*/</span> <span class="kc">null</span><span class="o">,</span> <span class="n">isActivityVisible</span><span class="o">(</span><span class="n">activity</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="lifecycle">Lifecycle</h3>
<p>Glide会添加一个透明的Fragment，当Fragment执行生命周期方法时，回调<code>Lifecycle</code>注册的<code>LifecycleListener</code>。</p>
<p><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/Glide-Lifecycle.png" alt="Glide-Lifecycle"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Deprecated</span>
  <span class="nd">@NonNull</span>
  <span class="kd">private</span> <span class="n">RequestManager</span> <span class="nf">fragmentGet</span><span class="o">(</span>
      <span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span>
      <span class="nd">@NonNull</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">FragmentManager</span> <span class="n">fm</span><span class="o">,</span>
      <span class="nd">@Nullable</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Fragment</span> <span class="n">parentHint</span><span class="o">,</span>
      <span class="kt">boolean</span> <span class="n">isParentVisible</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//创建RequestManagerFragment
</span><span class="c1"></span>    <span class="n">RequestManagerFragment</span> <span class="n">current</span> <span class="o">=</span> <span class="n">getRequestManagerFragment</span><span class="o">(</span><span class="n">fm</span><span class="o">,</span> <span class="n">parentHint</span><span class="o">);</span>
    <span class="n">RequestManager</span> <span class="n">requestManager</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="na">getRequestManager</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">requestManager</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// TODO(b/27524013): Factor out this Glide.get() call.
</span><span class="c1"></span>      <span class="n">Glide</span> <span class="n">glide</span> <span class="o">=</span> <span class="n">Glide</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
      <span class="c1">//将Lifecycle和RequestManagerTreeNode传递给RequestManager
</span><span class="c1"></span>      <span class="n">requestManager</span> <span class="o">=</span>
          <span class="n">factory</span><span class="o">.</span><span class="na">build</span><span class="o">(</span>
              <span class="n">glide</span><span class="o">,</span> <span class="n">current</span><span class="o">.</span><span class="na">getGlideLifecycle</span><span class="o">(),</span> <span class="n">current</span><span class="o">.</span><span class="na">getRequestManagerTreeNode</span><span class="o">(),</span> <span class="n">context</span><span class="o">);</span>
      <span class="c1">// This is a bit of hack, we&#39;re going to start the RequestManager, but not the
</span><span class="c1"></span>      <span class="c1">// corresponding Lifecycle. It&#39;s safe to start the RequestManager, but starting the
</span><span class="c1"></span>      <span class="c1">// Lifecycle might trigger memory leaks. See b/154405040
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">isParentVisible</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">requestManager</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">current</span><span class="o">.</span><span class="na">setRequestManager</span><span class="o">(</span><span class="n">requestManager</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">requestManager</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">RequestManagerFragment</span> <span class="nf">getRequestManagerFragment</span><span class="o">(</span>
    <span class="nd">@NonNull</span> <span class="kd">final</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">FragmentManager</span> <span class="n">fm</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Fragment</span> <span class="n">parentHint</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">RequestManagerFragment</span> <span class="n">current</span> <span class="o">=</span> <span class="o">(</span><span class="n">RequestManagerFragment</span><span class="o">)</span> <span class="n">fm</span><span class="o">.</span><span class="na">findFragmentByTag</span><span class="o">(</span><span class="n">FRAGMENT_TAG</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//从Map中获取RequestManagerFragment
</span><span class="c1"></span>    <span class="n">current</span> <span class="o">=</span> <span class="n">pendingRequestManagerFragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fm</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//创建ReqeustManagerFragment
</span><span class="c1"></span>      <span class="c1">//创建Fragment的时候创建Lifecycle
</span><span class="c1"></span>      <span class="n">current</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestManagerFragment</span><span class="o">();</span>
      <span class="n">current</span><span class="o">.</span><span class="na">setParentFragmentHint</span><span class="o">(</span><span class="n">parentHint</span><span class="o">);</span>
      <span class="n">pendingRequestManagerFragments</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">fm</span><span class="o">,</span> <span class="n">current</span><span class="o">);</span>
      <span class="c1">//添加fragment
</span><span class="c1"></span>      <span class="n">fm</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">FRAGMENT_TAG</span><span class="o">).</span><span class="na">commitAllowingStateLoss</span><span class="o">();</span>
      <span class="n">handler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">ID_REMOVE_FRAGMENT_MANAGER</span><span class="o">,</span> <span class="n">fm</span><span class="o">).</span><span class="na">sendToTarget</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">current</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">RequestManagerFragment</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">ActivityFragmentLifecycle</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="lifecyclelistener">LifecycleListener</h3>
<p><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/LifecycleListener.png" alt="LifecycleListener"></p>
<h3 id="requestmanager">RequestManager</h3>
<p>在<code>RequestManager</code>中将当前对象和<code>DefaultConnectivityMonitor</code>和注册到<code>Lifecycle</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">addSelfToLifecycle</span> <span class="o">=</span>
      <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">lifecycle</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">RequestManager</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">};</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ConnectivityMonitor</span> <span class="n">connectivityMonitor</span><span class="o">;</span>
  <span class="c1">// Adding default listeners should be much less common than starting new requests. We want
</span><span class="c1"></span>  <span class="c1">// some way of making sure that requests don&#39;t mutate our listeners without creating a new copy of
</span><span class="c1"></span>  <span class="c1">// the list each time a request is started.
</span><span class="c1"></span>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="n">RequestListener</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="n">defaultRequestListeners</span><span class="o">;</span>

  <span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">&#34;this&#34;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">RequestOptions</span> <span class="n">requestOptions</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">pauseAllRequestsOnTrimMemoryModerate</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">RequestManager</span><span class="o">(</span>
      <span class="nd">@NonNull</span> <span class="n">Glide</span> <span class="n">glide</span><span class="o">,</span>
      <span class="nd">@NonNull</span> <span class="n">Lifecycle</span> <span class="n">lifecycle</span><span class="o">,</span>
      <span class="nd">@NonNull</span> <span class="n">RequestManagerTreeNode</span> <span class="n">treeNode</span><span class="o">,</span>
      <span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span>
        <span class="n">glide</span><span class="o">,</span>
        <span class="n">lifecycle</span><span class="o">,</span>
        <span class="n">treeNode</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">RequestTracker</span><span class="o">(),</span>
        <span class="n">glide</span><span class="o">.</span><span class="na">getConnectivityMonitorFactory</span><span class="o">(),</span>
        <span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// Our usage is safe here.
</span><span class="c1"></span>  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;PMD.ConstructorCallsOverridableMethod&#34;</span><span class="o">)</span>
  <span class="n">RequestManager</span><span class="o">(</span>
      <span class="n">Glide</span> <span class="n">glide</span><span class="o">,</span>
      <span class="n">Lifecycle</span> <span class="n">lifecycle</span><span class="o">,</span>
      <span class="n">RequestManagerTreeNode</span> <span class="n">treeNode</span><span class="o">,</span>
      <span class="n">RequestTracker</span> <span class="n">requestTracker</span><span class="o">,</span>
      <span class="n">ConnectivityMonitorFactory</span> <span class="n">factory</span><span class="o">,</span>
      <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">glide</span> <span class="o">=</span> <span class="n">glide</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lifecycle</span> <span class="o">=</span> <span class="n">lifecycle</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">treeNode</span> <span class="o">=</span> <span class="n">treeNode</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">requestTracker</span> <span class="o">=</span> <span class="n">requestTracker</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>

    <span class="n">connectivityMonitor</span> <span class="o">=</span>
        <span class="n">factory</span><span class="o">.</span><span class="na">build</span><span class="o">(</span>
            <span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">(),</span>
            <span class="k">new</span> <span class="n">RequestManagerConnectivityListener</span><span class="o">(</span><span class="n">requestTracker</span><span class="o">));</span>

    <span class="c1">// If we&#39;re the application level request manager, we may be created on a background thread.
</span><span class="c1"></span>    <span class="c1">// In that case we cannot risk synchronously pausing or resuming requests, so we hack around the
</span><span class="c1"></span>    <span class="c1">// issue by delaying adding ourselves as a lifecycle listener by posting to the main thread.
</span><span class="c1"></span>    <span class="c1">// This should be entirely safe.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">Util</span><span class="o">.</span><span class="na">isOnBackgroundThread</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">Util</span><span class="o">.</span><span class="na">postOnUiThread</span><span class="o">(</span><span class="n">addSelfToLifecycle</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">lifecycle</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//添加
</span><span class="c1"></span>    <span class="n">lifecycle</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">connectivityMonitor</span><span class="o">);</span>

    <span class="n">defaultRequestListeners</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;(</span><span class="n">glide</span><span class="o">.</span><span class="na">getGlideContext</span><span class="o">().</span><span class="na">getDefaultRequestListeners</span><span class="o">());</span>
    <span class="n">setRequestOptions</span><span class="o">(</span><span class="n">glide</span><span class="o">.</span><span class="na">getGlideContext</span><span class="o">().</span><span class="na">getDefaultRequestOptions</span><span class="o">());</span>

    <span class="n">glide</span><span class="o">.</span><span class="na">registerRequestManager</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="load">load()</h2>
<p>通过<code>with()</code>方法返回了一个<code>RequestManager</code>对象，所以<code>load()</code>方法调用的是<code>RequestManager</code>的<code>load()</code>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@NonNull</span>
<span class="nd">@CheckResult</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">RequestBuilder</span><span class="o">&lt;</span><span class="n">Drawable</span><span class="o">&gt;</span> <span class="nf">load</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">asDrawable</span><span class="o">().</span><span class="na">load</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
<span class="nd">@NonNull</span>
<span class="nd">@CheckResult</span>
<span class="kd">public</span> <span class="n">RequestBuilder</span><span class="o">&lt;</span><span class="n">Drawable</span><span class="o">&gt;</span> <span class="nf">asDrawable</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">as</span><span class="o">(</span><span class="n">Drawable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
<span class="nd">@NonNull</span>
<span class="nd">@CheckResult</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="n">ResourceType</span><span class="o">&gt;</span> <span class="n">RequestBuilder</span><span class="o">&lt;</span><span class="n">ResourceType</span><span class="o">&gt;</span> <span class="nf">as</span><span class="o">(</span>
    <span class="nd">@NonNull</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">ResourceType</span><span class="o">&gt;</span> <span class="n">resourceClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//创建RequestBuilder
</span><span class="c1"></span>  <span class="k">return</span> <span class="k">new</span> <span class="n">RequestBuilder</span><span class="o">&lt;&gt;(</span><span class="n">glide</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">resourceClass</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="requestbuilder">RequestBuilder</h3>
<p><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/Glide-RequestBuilder.png" alt="Glide-RequestBuilder"></p>
<h2 id="into">into()</h2>
<p><code>load()</code>比较简单就是创建一个<code>RequestBuilder</code>对象。<code>into()</code>方法就是调用<code>RequestBuilder</code>的<code>into()</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="nd">@NonNull</span>
  <span class="kd">public</span> <span class="n">ViewTarget</span><span class="o">&lt;</span><span class="n">ImageView</span><span class="o">,</span> <span class="n">TranscodeType</span><span class="o">&gt;</span> <span class="nf">into</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">ImageView</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Util</span><span class="o">.</span><span class="na">assertMainThread</span><span class="o">();</span>
    <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>

    <span class="n">BaseRequestOptions</span><span class="o">&lt;?&gt;</span> <span class="n">requestOptions</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">requestOptions</span><span class="o">.</span><span class="na">isTransformationSet</span><span class="o">()</span>
        <span class="o">&amp;&amp;</span> <span class="n">requestOptions</span><span class="o">.</span><span class="na">isTransformationAllowed</span><span class="o">()</span>
        <span class="o">&amp;&amp;</span> <span class="n">view</span><span class="o">.</span><span class="na">getScaleType</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Clone in this method so that if we use this RequestBuilder to load into a View and then
</span><span class="c1"></span>      <span class="c1">// into a different target, we don&#39;t retain the transformation applied based on the previous
</span><span class="c1"></span>      <span class="c1">// View&#39;s scale type.
</span><span class="c1"></span>      <span class="k">switch</span> <span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">getScaleType</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">CENTER_CROP</span><span class="o">:</span>
          <span class="n">requestOptions</span> <span class="o">=</span> <span class="n">requestOptions</span><span class="o">.</span><span class="na">clone</span><span class="o">().</span><span class="na">optionalCenterCrop</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">CENTER_INSIDE</span><span class="o">:</span>
          <span class="n">requestOptions</span> <span class="o">=</span> <span class="n">requestOptions</span><span class="o">.</span><span class="na">clone</span><span class="o">().</span><span class="na">optionalCenterInside</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">FIT_CENTER</span><span class="o">:</span>
        <span class="k">case</span> <span class="n">FIT_START</span><span class="o">:</span>
        <span class="k">case</span> <span class="n">FIT_END</span><span class="o">:</span>
          <span class="n">requestOptions</span> <span class="o">=</span> <span class="n">requestOptions</span><span class="o">.</span><span class="na">clone</span><span class="o">().</span><span class="na">optionalFitCenter</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">FIT_XY</span><span class="o">:</span>
          <span class="n">requestOptions</span> <span class="o">=</span> <span class="n">requestOptions</span><span class="o">.</span><span class="na">clone</span><span class="o">().</span><span class="na">optionalCenterInside</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">CENTER</span><span class="o">:</span>
        <span class="k">case</span> <span class="n">MATRIX</span><span class="o">:</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="c1">// Do nothing.
</span><span class="c1"></span>      <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">into</span><span class="o">(</span>
        <span class="n">glideContext</span><span class="o">.</span><span class="na">buildImageViewTarget</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">transcodeClass</span><span class="o">),</span>
        <span class="cm">/*targetListener=*/</span> <span class="kc">null</span><span class="o">,</span>
        <span class="n">requestOptions</span><span class="o">,</span>
        <span class="n">Executors</span><span class="o">.</span><span class="na">mainThreadExecutor</span><span class="o">());</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="o">&lt;</span><span class="n">Y</span> <span class="kd">extends</span> <span class="n">Target</span><span class="o">&lt;</span><span class="n">TranscodeType</span><span class="o">&gt;&gt;</span> <span class="n">Y</span> <span class="nf">into</span><span class="o">(</span>
      <span class="nd">@NonNull</span> <span class="n">Y</span> <span class="n">target</span><span class="o">,</span>
      <span class="nd">@Nullable</span> <span class="n">RequestListener</span><span class="o">&lt;</span><span class="n">TranscodeType</span><span class="o">&gt;</span> <span class="n">targetListener</span><span class="o">,</span>
      <span class="n">BaseRequestOptions</span><span class="o">&lt;?&gt;</span> <span class="n">options</span><span class="o">,</span>
      <span class="n">Executor</span> <span class="n">callbackExecutor</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">isModelSet</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;You must call #load() before calling #into()&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//构建Request
</span><span class="c1"></span>    <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="n">buildRequest</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">targetListener</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="n">callbackExecutor</span><span class="o">);</span>

    <span class="n">Request</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">isEquivalentTo</span><span class="o">(</span><span class="n">previous</span><span class="o">)</span>
        <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isSkipMemoryCacheWithCompletePreviousRequest</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">previous</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// If the request is completed, beginning again will ensure the result is re-delivered,
</span><span class="c1"></span>      <span class="c1">// triggering RequestListeners and Targets. If the request is failed, beginning again will
</span><span class="c1"></span>      <span class="c1">// restart the request, giving it another chance to complete. If the request is already
</span><span class="c1"></span>      <span class="c1">// running, we can let it continue running without interruption.
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(!</span><span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">previous</span><span class="o">).</span><span class="na">isRunning</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// Use the previous request rather than the new one to allow for optimizations like skipping
</span><span class="c1"></span>        <span class="c1">// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions
</span><span class="c1"></span>        <span class="c1">// that are done in the individual Request.
</span><span class="c1"></span>        <span class="n">previous</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">requestManager</span><span class="o">.</span><span class="na">clear</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
    <span class="n">target</span><span class="o">.</span><span class="na">setRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="c1">//追踪Request
</span><span class="c1"></span>    <span class="n">requestManager</span><span class="o">.</span><span class="na">track</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">target</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="obtainrequest">obtainRequest()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">private</span> <span class="n">Request</span> <span class="nf">obtainRequest</span><span class="o">(</span>
      <span class="n">Object</span> <span class="n">requestLock</span><span class="o">,</span>
      <span class="n">Target</span><span class="o">&lt;</span><span class="n">TranscodeType</span><span class="o">&gt;</span> <span class="n">target</span><span class="o">,</span>
      <span class="n">RequestListener</span><span class="o">&lt;</span><span class="n">TranscodeType</span><span class="o">&gt;</span> <span class="n">targetListener</span><span class="o">,</span>
      <span class="n">BaseRequestOptions</span><span class="o">&lt;?&gt;</span> <span class="n">requestOptions</span><span class="o">,</span>
      <span class="n">RequestCoordinator</span> <span class="n">requestCoordinator</span><span class="o">,</span>
      <span class="n">TransitionOptions</span><span class="o">&lt;?,</span> <span class="o">?</span> <span class="kd">super</span> <span class="n">TranscodeType</span><span class="o">&gt;</span> <span class="n">transitionOptions</span><span class="o">,</span>
      <span class="n">Priority</span> <span class="n">priority</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">overrideWidth</span><span class="o">,</span>
      <span class="kt">int</span> <span class="n">overrideHeight</span><span class="o">,</span>
      <span class="n">Executor</span> <span class="n">callbackExecutor</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">SingleRequest</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span>
        <span class="n">context</span><span class="o">,</span>
        <span class="n">glideContext</span><span class="o">,</span>
        <span class="n">requestLock</span><span class="o">,</span>
        <span class="n">model</span><span class="o">,</span>
        <span class="n">transcodeClass</span><span class="o">,</span>
        <span class="n">requestOptions</span><span class="o">,</span>
        <span class="n">overrideWidth</span><span class="o">,</span>
        <span class="n">overrideHeight</span><span class="o">,</span>
        <span class="n">priority</span><span class="o">,</span>
        <span class="n">target</span><span class="o">,</span>
        <span class="n">targetListener</span><span class="o">,</span>
        <span class="n">requestListeners</span><span class="o">,</span>
        <span class="n">requestCoordinator</span><span class="o">,</span>
        <span class="n">glideContext</span><span class="o">.</span><span class="na">getEngine</span><span class="o">(),</span>
        <span class="n">transitionOptions</span><span class="o">.</span><span class="na">getTransitionFactory</span><span class="o">(),</span>
        <span class="n">callbackExecutor</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="request">Request</h3>
<p><img src="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/Glide%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B.png" alt="Glide请求过程"></p>
<p>![Glide编码过程 ](<a href="https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/Glide">https://malinkang-1253444926.cos.ap-beijing.myqcloud.com/blog/images/Glide</a>编码过程 .png)</p>
<h3 id="缓存过程">缓存过程</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//从缓存中获取
</span><span class="c1"></span><span class="nd">@Nullable</span>
<span class="kd">private</span> <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">loadFromMemory</span><span class="o">(</span>
    <span class="n">EngineKey</span> <span class="n">key</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isMemoryCacheable</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//内存缓存不可用直接返回null
</span><span class="c1"></span>  <span class="k">if</span> <span class="o">(!</span><span class="n">isMemoryCacheable</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">//先从弱引用中获取，如果获取不到则从LruResourceCache中获取缓存
</span><span class="c1"></span>  <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">active</span> <span class="o">=</span> <span class="n">loadFromActiveResources</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">active</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">VERBOSE_IS_LOGGABLE</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logWithTimeAndKey</span><span class="o">(</span><span class="s">&#34;Loaded resource from active resources&#34;</span><span class="o">,</span> <span class="n">startTime</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">active</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">loadFromCache</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">cached</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">VERBOSE_IS_LOGGABLE</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logWithTimeAndKey</span><span class="o">(</span><span class="s">&#34;Loaded resource from cache&#34;</span><span class="o">,</span> <span class="n">startTime</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">cached</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
<span class="nd">@Nullable</span>
<span class="kd">private</span> <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">loadFromActiveResources</span><span class="o">(</span><span class="n">Key</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//从弱引用中获取
</span><span class="c1"></span>  <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">active</span> <span class="o">=</span> <span class="n">activeResources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">active</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">active</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">active</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">loadFromCache</span><span class="o">(</span><span class="n">Key</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">getEngineResourceFromCache</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">cached</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">cached</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
    <span class="n">activeResources</span><span class="o">.</span><span class="na">activate</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">cached</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">cached</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">getEngineResourceFromCache</span><span class="o">(</span><span class="n">Key</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//从LruResourceCache中获取缓存
</span><span class="c1"></span>  <span class="n">Resource</span><span class="o">&lt;?&gt;</span> <span class="n">cached</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="kd">final</span> <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">result</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">cached</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cached</span> <span class="k">instanceof</span> <span class="n">EngineResource</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Save an object allocation if we&#39;ve cached an EngineResource (the typical case).
</span><span class="c1"></span>    <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">EngineResource</span><span class="o">&lt;?&gt;)</span> <span class="n">cached</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">result</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">EngineResource</span><span class="o">&lt;&gt;(</span>
            <span class="n">cached</span><span class="o">,</span> <span class="cm">/*isMemoryCacheable=*/</span> <span class="kc">true</span><span class="o">,</span> <span class="cm">/*isRecyclable=*/</span> <span class="kc">true</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="cm">/*listener=*/</span> <span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//写入缓存
</span><span class="c1"></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">onResourceReleased</span><span class="o">(</span><span class="n">Key</span> <span class="n">cacheKey</span><span class="o">,</span> <span class="n">EngineResource</span><span class="o">&lt;?&gt;</span> <span class="n">resource</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">activeResources</span><span class="o">.</span><span class="na">deactivate</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">isMemoryCacheable</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">resourceRecycler</span><span class="o">.</span><span class="na">recycle</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="modelloader">ModelLoader</h3>
<p><code>ModelLoader</code>类负责将<code>model</code>转换为<code>data</code>。<code>model</code>就是我们在调用<code>load</code>方法传入的值。</p>
<h3 id="getloaddata">getLoadData()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">LoadData</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getLoadData</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">isLoadDataSet</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">isLoadDataSet</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//获取成功之后设置为true 避免多次获取
</span><span class="c1"></span>    <span class="n">loadData</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="c1">//根据Model获取ModelLoader
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">modelLoaders</span> <span class="o">=</span> <span class="n">glideContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">().</span><span class="na">getModelLoaders</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
    <span class="c1">//noinspection ForLoopReplaceableByForEach to improve perf
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">modelLoaders</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">modelLoader</span> <span class="o">=</span> <span class="n">modelLoaders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="n">LoadData</span><span class="o">&lt;?&gt;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">modelLoader</span><span class="o">.</span><span class="na">buildLoadData</span><span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">loadData</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">loadData</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="getmodelloaders">getModelLoaders()</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@NonNull</span>
  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">getModelLoaders</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">modelLoaderRegistry</span><span class="o">.</span><span class="na">getModelLoaders</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@NonNull</span>
  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">getModelLoaders</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">A</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">modelLoaders</span> <span class="o">=</span> <span class="n">getModelLoadersForClass</span><span class="o">(</span><span class="n">getClass</span><span class="o">(</span><span class="n">model</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">modelLoaders</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">NoModelLoaderAvailableException</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">modelLoaders</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">isEmpty</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">filteredLoaders</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="c1">//noinspection ForLoopReplaceableByForEach to improve perf
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">modelLoaders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">loader</span><span class="o">.</span><span class="na">handles</span><span class="o">(</span><span class="n">model</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">filteredLoaders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">size</span> <span class="o">-</span> <span class="n">i</span><span class="o">);</span>
          <span class="n">isEmpty</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
         <span class="c1">//根据ModelLoader的handles方法，过滤掉不匹配的
</span><span class="c1"></span>        <span class="c1">//假设传入的是url，则过滤掉DataUrlLoader
</span><span class="c1"></span>        <span class="n">filteredLoaders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">loader</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">filteredLoaders</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">NoModelLoaderAvailableException</span><span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="n">modelLoaders</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">filteredLoaders</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@NonNull</span>
  <span class="kd">private</span> <span class="kd">synchronized</span> <span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">getModelLoadersForClass</span><span class="o">(</span>
      <span class="nd">@NonNull</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">modelClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//从缓存中取
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">A</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">loaders</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">modelClass</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">loaders</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//调用MultiModelLoaderFactory的build方法
</span><span class="c1"></span>      <span class="n">loaders</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">multiModelLoaderFactory</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">modelClass</span><span class="o">));</span>
      <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">modelClass</span><span class="o">,</span> <span class="n">loaders</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">loaders</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@NonNull</span>
  <span class="kd">synchronized</span> <span class="o">&lt;</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">build</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">modelClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">loaders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">entries</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Avoid stack overflow recursively creating model loaders by only creating loaders in
</span><span class="c1"></span>        <span class="c1">// recursive requests if they haven&#39;t been created earlier in the chain. For example:
</span><span class="c1"></span>        <span class="c1">// A Uri loader may translate to another model, which in turn may translate back to a Uri.
</span><span class="c1"></span>        <span class="c1">// The original Uri loader won&#39;t be provided to the intermediate model loader, although
</span><span class="c1"></span>        <span class="c1">// other Uri loaders will be.
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">alreadyUsedEntries</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">entry</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//根据ModelClass进行判断
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">handles</span><span class="o">(</span><span class="n">modelClass</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">alreadyUsedEntries</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
          <span class="c1">//调用Factory创建Loader
</span><span class="c1"></span>          <span class="n">loaders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span><span class="n">build</span><span class="o">(</span><span class="n">entry</span><span class="o">));</span>
          <span class="n">alreadyUsedEntries</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">loaders</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">alreadyUsedEntries</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
      <span class="k">throw</span> <span class="n">t</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//StringLoader先将String转化为Uri
</span><span class="c1">//通过MultiModelLoaderFactory获取一个MultiModelLoader对象
</span><span class="c1">//内部调用的MultiModelLoader
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StreamFactory</span> <span class="kd">implements</span> <span class="n">ModelLoaderFactory</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">InputStream</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@NonNull</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">InputStream</span><span class="o">&gt;</span> <span class="nf">build</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">MultiModelLoaderFactory</span> <span class="n">multiFactory</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">StringLoader</span><span class="o">&lt;&gt;(</span><span class="n">multiFactory</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">Uri</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">InputStream</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">teardown</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// Do nothing.
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="nd">@NonNull</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="n">Data</span><span class="o">&gt;</span> <span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="n">Data</span><span class="o">&gt;</span> <span class="nf">build</span><span class="o">(</span>
      <span class="nd">@NonNull</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">&gt;</span> <span class="n">modelClass</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span> <span class="n">dataClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="n">Data</span><span class="o">&gt;&gt;</span> <span class="n">loaders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
      <span class="kt">boolean</span> <span class="n">ignoredAnyEntries</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">entries</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Avoid stack overflow recursively creating model loaders by only creating loaders in
</span><span class="c1"></span>        <span class="c1">// recursive requests if they haven&#39;t been created earlier in the chain. For example:
</span><span class="c1"></span>        <span class="c1">// A Uri loader may translate to another model, which in turn may translate back to a Uri.
</span><span class="c1"></span>        <span class="c1">// The original Uri loader won&#39;t be provided to the intermediate model loader, although
</span><span class="c1"></span>        <span class="c1">// other Uri loaders will be.
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">alreadyUsedEntries</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">entry</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">ignoredAnyEntries</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">handles</span><span class="o">(</span><span class="n">modelClass</span><span class="o">,</span> <span class="n">dataClass</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">alreadyUsedEntries</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
          <span class="n">loaders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="n">Data</span><span class="o">&gt;</span><span class="n">build</span><span class="o">(</span><span class="n">entry</span><span class="o">));</span>
          <span class="n">alreadyUsedEntries</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="c1">//如果存在多个就构建成一个MultiModelLoader
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">loaders</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">factory</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">loaders</span><span class="o">,</span> <span class="n">throwableListPool</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">loaders</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">loaders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Avoid crashing if recursion results in no loaders available. The assertion is supposed to
</span><span class="c1"></span>        <span class="c1">// catch completely unhandled types, recursion may mean a subtype isn&#39;t handled somewhere
</span><span class="c1"></span>        <span class="c1">// down the stack, which is often ok.
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">ignoredAnyEntries</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">emptyModelLoader</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">NoModelLoaderAvailableException</span><span class="o">(</span><span class="n">modelClass</span><span class="o">,</span> <span class="n">dataClass</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">alreadyUsedEntries</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
      <span class="k">throw</span> <span class="n">t</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="o">{</span>
    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="n">Data</span><span class="o">&gt;</span> <span class="n">MultiModelLoader</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="n">Data</span><span class="o">&gt;</span> <span class="nf">build</span><span class="o">(</span>
        <span class="nd">@NonNull</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ModelLoader</span><span class="o">&lt;</span><span class="n">Model</span><span class="o">,</span> <span class="n">Data</span><span class="o">&gt;&gt;</span> <span class="n">modelLoaders</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="n">Pool</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;&gt;</span> <span class="n">throwableListPool</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">MultiModelLoader</span><span class="o">&lt;&gt;(</span><span class="n">modelLoaders</span><span class="o">,</span> <span class="n">throwableListPool</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="加载到内存的图片大小">加载到内存的图片大小</h3>
<p>默认大小为<code>ImageView</code>的大小。设置了<code>override</code>，则是设置的大小。如果设置值为<code>Target.SIZE_ORIGINAL</code>，则使用图片原始大小。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//SingleRequest begin方法
</span><span class="c1"></span><span class="k">if</span> <span class="o">(</span><span class="n">Util</span><span class="o">.</span><span class="na">isValidDimensions</span><span class="o">(</span><span class="n">overrideWidth</span><span class="o">,</span> <span class="n">overrideHeight</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">onSizeReady</span><span class="o">(</span><span class="n">overrideWidth</span><span class="o">,</span> <span class="n">overrideHeight</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">target</span><span class="o">.</span><span class="na">getSize</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//ViewTarget getSize方法
</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">getSize</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">SizeReadyCallback</span> <span class="n">cb</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sizeDeterminer</span><span class="o">.</span><span class="na">getSize</span><span class="o">(</span><span class="n">cb</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//SizeDeterminer getSize方法
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">getSize</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">SizeReadyCallback</span> <span class="n">cb</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">currentWidth</span> <span class="o">=</span> <span class="n">getTargetWidth</span><span class="o">();</span> <span class="c1">//获取宽
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">currentHeight</span> <span class="o">=</span> <span class="n">getTargetHeight</span><span class="o">();</span> <span class="c1">//获取高
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">isViewStateAndSizeValid</span><span class="o">(</span><span class="n">currentWidth</span><span class="o">,</span> <span class="n">currentHeight</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">cb</span><span class="o">.</span><span class="na">onSizeReady</span><span class="o">(</span><span class="n">currentWidth</span><span class="o">,</span> <span class="n">currentHeight</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// We want to notify callbacks in the order they were added and we only expect one or two
</span><span class="c1"></span>    <span class="c1">// callbacks to be added a time, so a List is a reasonable choice.
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">cbs</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">cb</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">cbs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">cb</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">layoutListener</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ViewTreeObserver</span> <span class="n">observer</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="na">getViewTreeObserver</span><span class="o">();</span>
        <span class="n">layoutListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SizeDeterminerLayoutListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">observer</span><span class="o">.</span><span class="na">addOnPreDrawListener</span><span class="o">(</span><span class="n">layoutListener</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//CustomTarget默认是原图大小
</span><span class="c1"></span><span class="kd">public</span> <span class="nf">CustomTarget</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">SIZE_ORIGINAL</span><span class="o">,</span> <span class="n">Target</span><span class="o">.</span><span class="na">SIZE_ORIGINAL</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//Downsampler decodeFromWrappedStreams方法
</span><span class="c1">//获取图片的原始宽高
</span><span class="c1"></span><span class="kt">int</span><span class="o">[]</span> <span class="n">sourceDimensions</span> <span class="o">=</span> <span class="n">getDimensions</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="n">callbacks</span><span class="o">,</span> <span class="n">bitmapPool</span><span class="o">);</span>
<span class="kt">int</span> <span class="n">sourceWidth</span> <span class="o">=</span> <span class="n">sourceDimensions</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
<span class="kt">int</span> <span class="n">sourceHeight</span> <span class="o">=</span> <span class="n">sourceDimensions</span><span class="o">[</span><span class="n">1</span><span class="o">];</span>
<span class="c1">//如果设置Target.SIZE_ORIGINAL 则为原始宽高
</span><span class="c1"></span><span class="kt">int</span> <span class="n">targetWidth</span> <span class="o">=</span> <span class="n">requestedWidth</span> <span class="o">==</span> <span class="n">Target</span><span class="o">.</span><span class="na">SIZE_ORIGINAL</span> <span class="o">?</span> <span class="n">sourceWidth</span> <span class="o">:</span> <span class="n">requestedWidth</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">targetHeight</span> <span class="o">=</span> <span class="n">requestedHeight</span> <span class="o">==</span> <span class="n">Target</span><span class="o">.</span><span class="na">SIZE_ORIGINAL</span> <span class="o">?</span> <span class="n">sourceHeight</span> <span class="o">:</span> <span class="n">requestedHeight</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://muyangmin.github.io/glide-docs-cn/">Glide中文文档</a></li>
<li><a href="https://juejin.im/post/6844903986412126216">面试官：简历上最好不要写Glide，不是问源码那么简单</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">malinkang</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-11-25
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/leakcanary-source-analysis/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Leakcanary源码分析</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/okio-source-analysis/">
            <span class="next-text nav-default">Okio源码分析</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'malinkang-cn';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://twitter.com/malinkang" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/malinkang" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/malinkang" class="iconfont icon-weibo" title="weibo"></a>
  <a href="https://malinkang.cn/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">malinkang</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
